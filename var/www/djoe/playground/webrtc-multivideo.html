<html>

<head>

  <meta charset="UTF-8">

  <link rel="stylesheet" type="text/css" href="../jquery.xmppinspector/jquery.xmppinspector.css"/>
  <link rel="stylesheet" type="text/css" href="../jsxc/lib/jquery-ui/themes/base/jquery-ui.css"/>

  <script src="../jsxc/lib/jquery/dist/jquery.js"></script>
  <script src="../jsxc/lib/jquery-ui/jquery-ui.js"></script>

  <script src="bower_components/urijs/src/URI.js"></script>

  <script src="../jquery.xmppinspector/jquery.xmppinspector.js"></script>
  <script src="../jquery.eventconsole/jquery.eventconsole.js"></script>

  <script src="../jsxc/lib/strophe.js/strophe.js"></script>
  <script src="../jsxc/lib/strophe.disco.js"></script>
  <script src="../jsxc/lib/strophe.caps.js"></script>
  <script src="../jsxc/lib/strophe.jinglejs/strophe.jinglejs-bundle.js"></script>

  <!--<script src="bower_components/webrtc-adapter/adapter-1.2.0.js"></script>-->

  <script type="text/javascript">

    "use strict";

    $(function() {

      console.log("Initialisation");

      multimediaStreamManager.init();

    });

    /**
     * Test object for webrtc connexions
     *
     * Connection with account:
     * http://127.0.0.1/djoe/var/www/djoe/playground/webrtc-multivideo.html?jid=nicolas@im.silverpeas.net&pwd=azerty
     *
     * @type {{sessionJid: string, sessionPassword: string, boshUrl: string, recipients: Array, conn: null, connected: multivideo.connected, onIceConnectionStateChanged: multivideo.onIceConnectionStateChanged, init: multivideo.init}}
     */
    var multimediaStreamManager = {

      /**
       * DEFAULTS Credentials for XMPP connexion
       *
       * others can be specified in url: .....?jid=jid@domain&pwd=azerty
       *
       */
      sessionJid : "remi@im.silverpeas.net",

      sessionPassword : "azerty",


      /** required disco features for video call */
      reqVideoFeatures: ['urn:xmpp:jingle:apps:rtp:video', 'urn:xmpp:jingle:apps:rtp:audio', 'urn:xmpp:jingle:transports:ice-udp:1', 'urn:xmpp:jingle:apps:dtls:0'],

      /** required disco features for file transfer */
      reqFileFeatures: ['urn:xmpp:jingle:1', 'urn:xmpp:jingle:apps:file-transfer:3'],


      boshUrl : "https://im.silverpeas.net/http-bind/",

      iceServers : [

        {urls : "stun:turn1.silverpeas.net:80"},

        {
          urls : "turns:turn1.silverpeas.net:443",
          credential : "orv227EAdGEZ_ldSMadxhmbSxtnmvnMx",
          credentialType : "password",
          username : "djoe"
        }

      ],

      /**
       * Were are stored last people who call (id and time)
       */
      lastCallers : [],

      /**
       *  Current remote session and stream objects
       */
      remoteSessions : [],

      /**
       * Recipients for call
       *
       */
      recipients : [],

      /**
       *
       * Video dialogs
       *
       */
      videoDialogs : [],

      /**
       *
       * XMPP connexion
       *
       */
      conn : null,

      /**
       * Called when connected to XMPP server
       * @param conn
       */
      onConnected : function() {

        console.log("Connected");

        var self = multimediaStreamManager;
        var manager = self.conn.jingle.manager;

        // send a frist presence
        self.conn.send($pres());

        // listen for incoming calls
        manager.on('incoming', self._onIncomingJingleSession.bind(self));

        manager.on('peerStreamAdded', self._onRemoteStreamAdded.bind(self));
        manager.on('peerStreamRemoved', self._onRemoteStreamRemoved.bind(self));

      },

      /**
       *  Called when receive incoming media session
       *
       */
      _onIncomingJingleSession : function(session) {

        console.log("[INCOMING - JINGLE]", arguments);

        var self = multimediaStreamManager;
        var type = (session.constructor) ? session.constructor.name : null;

        if (type === 'FileTransferSession') {
          self._onIncomingFileTransfer(session);
        } else if (type === 'MediaSession') {
          self._onIncomingCall(session);
        } else {
          console.error("Unknown session type: " + type, session);
        }

      },

      /**
       * Called when incoming file transfer
       */
      _onIncomingFileTransfer : function() {
        //TODO
      },

      /**
       * Called when incoming call
       */
      _onIncomingCall : function(session) {

        var self = multimediaStreamManager;

        // send signal to partner
        session.ring();

        self.lastCallers.push({
          id : session.peerID, when : new Date()
        });

        var constraints = {
          audio : true, video : true
        };

        // Open Jingle session
        self.conn.jingle.RTC.getUserMedia(constraints,

            function(localStream) {

              // accept automatically calls
              session.addStream(localStream);
              session.accept();

              self._newVideoDialog(localStream)
            },

            function(error) {
              session.decline();
              console.error(error);
            });

      },

      _onRemoteStreamAdded(session, stream){

        var self = multimediaStreamManager;

        // keep trace of session
        self.remoteSessions.push({
          session : session, stream : stream
        });

        // var isVideoDevice = stream.getVideoTracks().length > 0;
        // var isAudioDevice = stream.getAudioTracks().length > 0;

        self._newVideoDialog(stream, "Stream from: " + session.peerID);

      },

      _onRemoteStreamRemoved(session, stream){

        console.error("Stream removed !");

        var self = multimediaStreamManager;

        var sessionFound = false;
        var sid = session.sid;

        // found session and remove it
        for (var i = 0; i < self.remoteSessions.length; i++) {
          var rsid = self.remoteSessions[i].session.sid;
          if (rsid === sid) {
            self.remoteSessions.splice(i, 1);
            sessionFound = true;
            break;
          }
        }

        if(sessionFound !== true){
          console.error("No session found");
        }

      },

      /**
       * Create and show a new dialog displaying video stream
       *
       */
      _newVideoDialog : function(stream, title) {

        var self = multimediaStreamManager;

        title = title || "";

        // create and append dialog to body
        var dialog = $("<video></video>");
        dialog.appendTo($("body"));

        dialog.dialog({
          title : title, height : 400, width : 'auto'
        });

        self.videoDialogs.push(dialog);

        console.log(dialog);

        // attach stream
        self.conn.jingle.RTC.attachMediaStream(dialog.get(0), stream);

      },

      videoCall : function(fullJid) {

        var self = multimediaStreamManager;
        var manager = self.conn.jingle.manager;

        if (Strophe.getResourceFromJid(fullJid) === null) {
          throw "JID must be full jid";
        }

        // ice configuration
        self.conn.jingle.setICEServers(self.iceServers);

        // requesting user media
        var constraints = {
          audio : true, video : true
        };

        // Open Jingle session
        self.conn.jingle.RTC.getUserMedia(constraints, function(stream) {

              console.log('onUserMediaSuccess');

              self._newVideoDialog(stream, "Local stream");

              // here we must verify if tracks are enought
              var audioTracks = stream.getAudioTracks();
              var videoTracks = stream.getVideoTracks();

              console.log("Audio / video tracks: ")
              console.log(audioTracks);
              console.log(videoTracks);

              // openning jingle session
              var session = self.conn.jingle.initiate(fullJid, stream);

              session.on('change:connectionState', function() {
                console.log("change:connectionState");
                console.log(arguments);
              });

            },

            function(error) {

              console.error('Failed to get access to local media. Error ', error);

            });

      },

      /**
       * Configure and connect
       */
      init : function() {

        var self = multimediaStreamManager;

        self.checkUriParameters();

        // create strophe connexion
        self.conn = new Strophe.Connection(self.boshUrl);

        if (!self.conn.jingle) {
          jsxc.error('No jingle plugin found!');
          return;
        }



        self.enableLog(true);

        // connexion to XMPP server
        self.conn.connect(self.sessionJid, self.sessionPassword, function(status) {

          if (status === Strophe.Status.CONNECTED) {

            $("#connexionStatus").text("Connected. JID: " + self.conn.jid);
            $("#recipients").text(self.recipients.join(", "));

            self.onConnected();

            // call first recipient if necessary
            for (var recip of self.recipients) {
              self.videoCall(recip);
            }

          } else if (status === Strophe.Status.DISCONNECTED) {

            $("#connexionStatus").text("Disconnected. JID: " + self.sessionJid);

            console.error("Disconnected");

          }
        });

      },

      /**
       * For debug purpose only.
       *
       * Enable log
       */
      enableLog : function(state) {

        var self = multimediaStreamManager;
        var manager = self.conn.jingle.manager;

        if (state) {

          // afficher les erreurs de Strophe, indispensable
          var stLogLevel = Strophe.LogLevel.WARN;

          Strophe.log = function(level, msg) {
            if (level >= stLogLevel) {
              console.error("Strophe [" + level + "] " + msg);
              console.error((new Error()).stack);
            }
          };

          // log jingle plugin activity
          //manager.on('*', function(level, msg) {
          //  console.log('----------------- [JINGLE]', arguments);
          //});

          // monitor traffic
          $("#xmppInspector").xmppInspector(self.conn);

        }

      },

      /**
       * For debug purpose only.
       *
       * Affect sender and recipient jid found in uri
       */
      checkUriParameters : function() {

        var self = multimediaStreamManager;

        // check if credentials are found in url
        var parameters = URI(window.location.href).search(true);

        self.sessionJid = parameters.jid || self.sessionJid;
        self.sessionPassword = parameters.pwd || self.sessionPassword;

        if (parameters.recipient) {
          if (parameters.recipient.constructor === Array) {
            self.recipients = parameters.recipient;
          }

          else {
            self.recipients.push(parameters.recipient);
          }
        }
      }

    };


  </script>

</head>

<body>

<h1>Test platform for multi video channels using WebRTC / Jingle</h1>

<div>
  <div>Status: <span id="connexionStatus"></span></div>
  <div>Recipients: <span id="recipients"></span></div>
</div>

<div id="xmppInspector"></div>

<div>&nbsp;</div>
<div>&nbsp;</div>

<div id="eventConsole"></div>

<script>$("#eventConsole").eventConsole();</script>


</body>

</html>