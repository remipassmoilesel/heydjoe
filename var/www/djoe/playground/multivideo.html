<html>

<head>

  <link rel="stylesheet" type="text/css" href="../jquery.xmppinspector/jquery.xmppinspector.css"/>
  <link rel="stylesheet" type="text/css" href="../jsxc/lib/jquery-ui/themes/base/jquery-ui.css"/>

  <script src="../jsxc/lib/jquery/dist/jquery.js"></script>
  <script src="../jsxc/lib/jquery-ui/jquery-ui.js"></script>
  <script src="../jquery.xmppinspector/jquery.xmppinspector.js"></script>
  <script src="../jquery.eventconsole/jquery.eventconsole.js"></script>

  <script src="../jsxc/lib/strophe.js/strophe.js"></script>
  <script src="../jsxc/lib/strophe.disco.js"></script>
  <script src="../jsxc/lib/strophe.caps.js"></script>
  <script src="../jsxc/lib/strophe.jinglejs/strophe.jinglejs-bundle.js"></script>

  <script type="text/javascript">

    /**
     * Voir: http://www.rtcmulticonnection.org/docs/getting-started/
     *
     *
     */

    var multivideo = {

      /**
       * Configure and connect
       */
      init : function() {

        // afficher les erreurs de Strophe, indispensable
        var stLogLevel = Strophe.LogLevel.WARN;

        Strophe.log = function(level, msg) {
          if (level >= stLogLevel) {
            console.error("Strophe [" + level + "] " + msg);
            console.error((new Error()).stack);
          }
        };

        // surveillance du trafic
        var conn = new Strophe.Connection("https://im.silverpeas.net/http-bind/");
        $("#xmppInspector").xmppInspector(conn);

        // connexion
        conn.connect("remi@im.silverpeas.net", "azerty", function(status) {
          if (status === Strophe.Status.CONNECTED) {

            multivideo.connected(conn);

          } else if (status === Strophe.Status.DISCONNECTED) {
            console.log("Disconnected");
          }
        });

      },

      /**
       * Called when connected
       * @param conn
       */
      connected : function(conn) {

        console.log("Connected");

        if (typeof MediaStreamTrack !== 'undefined' &&
            typeof MediaStreamTrack.getSources !== 'undefined') {

          MediaStreamTrack.getSources(function(sourceInfo) {

            var availableDevices = sourceInfo.map(function(el) {

              return el.kind;
            });

            um = um.filter(function(el) {
              return availableDevices.indexOf(el) !== -1;
            });

            jsxc.webrtc.getUserMedia(um);
          });
        }

//        var session = conn.jingle.initiate("nicolas@im.silverpeas.net");

        console.log(session);

      }

    };

    $(function() {

      console.log("Initialisation");

      multivideo.init();

    });


  </script>

</head>

<body>

<div id="xmppInspector"></div>

<div>&nbsp;</div>
<div>&nbsp;</div>

<div id="eventConsole"></div>

<script>$("#eventConsole").eventConsole();</script>


</body>

</html>