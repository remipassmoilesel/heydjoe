/*!
 * djoe v1.0.0 - 2016-09-22
 * 
 * Copyright (c) 2016  <br>
 * Released under the GPL-3.0 license
 * 
 * Please see 
 * 
 * @author 
 * @version 1.0.0
 * @license MIT
 */
!function(modules){function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={exports:{},id:moduleId,loaded:!1};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.loaded=!0,module.exports}var installedModules={};return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.p="",__webpack_require__(0)}([function(module,exports,__webpack_require__){/*! This file is concatenated for the browser. */
window.jsxc=null,window.RTC=null,window.RTCPeerconnection=null,function($){"use strict";jsxc={version:"1.0.0",master:!1,role_allocation:!1,to:[],toBusy:null,toNotification:null,toNotificationDelay:500,keepalive:null,reconnect:!1,restoreCompleted:!1,triggeredFromBox:!1,triggeredFromLogout:!1,ls:[],stats:null,storageNotConform:null,toSNC:null,bid:null,CONST:{NOTIFICATION_DEFAULT:"default",NOTIFICATION_GRANTED:"granted",NOTIFICATION_DENIED:"denied",STATUS:["offline","dnd","xa","away","chat","online"],SOUNDS:{MSG:"incomingMessage.wav",CALL:"Rotary-Phone6.mp3",NOTICE:"Ping1.mp3"},REGEX:{JID:new RegExp("\\b[^\"&'\\/:<>@\\s]+@[\\w-_.]+\\b","ig"),URL:new RegExp(/(https?:\/\/|www\.)[^\s<>'"]+/gi)},NS:{CARBONS:"urn:xmpp:carbons:2",FORWARD:"urn:xmpp:forward:0"},HIDDEN:"hidden",SHOWN:"shown"},getFormattedTime:function(unixtime){var msgDate=new Date(parseInt(unixtime)),day=("0"+msgDate.getDate()).slice(-2),month=("0"+(msgDate.getMonth()+1)).slice(-2),year=msgDate.getFullYear(),hours=("0"+msgDate.getHours()).slice(-2),minutes=("0"+msgDate.getMinutes()).slice(-2),dateNow=new Date,date="function"==typeof msgDate.toLocaleDateString?msgDate.toLocaleDateString():day+"."+month+"."+year,time="function"==typeof msgDate.toLocaleTimeString?msgDate.toLocaleTimeString():hours+":"+minutes;return dateNow.setHours(0,0,0,0),msgDate.setHours(0,0,0,0),dateNow.getTime()!==msgDate.getTime()?date+" "+time:time},throwOnStropheErrors:function(){var stLogLevel=Strophe.LogLevel.WARN;Strophe.log=function(level,msg){if(level>=stLogLevel){var txtLevel=Object.keys(Strophe.LogLevel)[level]||level,error=new Error("Strophe ["+txtLevel+"] "+msg);setTimeout(function(){throw error},0)}}},getCurrentActiveJidForBid:function(bid){var fulljid=null;if(!bid)throw new Error("Invalid argument: "+bid);bid=jsxc.jidToBid(bid);var buddy=jsxc.storage.getUserItem("buddy",bid);if(!buddy)throw new Error("Invalid buddy: "+bid);if(buddy.type&&"groupchat"===buddy.type)throw new Error("Cannot update groupchat resource: "+bid);return buddy.jid&&null!==Strophe.getResourceFromJid(buddy.jid)?buddy.jid:buddy.res&&buddy.res.length>0?(fulljid=buddy.jid+"/"+buddy.res[0],buddy.jid=fulljid,jsxc.storage.setUserItem("buddy",bid,buddy),fulljid):null},debug:function(msg,data,level){level=(level||"INFO").trim().toUpperCase();var formatted_msg="["+level+"] "+msg,d="";if(data)try{d=$("<span>").prepend($(data).clone()).html()}catch(err){try{d=JSON.stringify(data)}catch(err2){d="error while stringify, see js console"}}"ERROR"===level?console.error(formatted_msg,data||""):console.log(formatted_msg,data||""),jsxc.stats&&jsxc.stats.addLogEntry&&jsxc.stats.addLogEntry(msg,level,data),jsxc.log=jsxc.log+"$ "+formatted_msg+": "+d+"\n";var oversize=jsxc.log.length-1e4;oversize>200&&(jsxc.log=".... [log truncated] \n"+jsxc.log.substring(oversize,jsxc.log.length))},warn:function(msg,data){jsxc.debug(msg,data,"WARN")},error:function(msg,data){jsxc.debug(msg,data,"ERROR")},log:"",_disconnectBeforeUnload:function(){jsxc.master===!0&&window.addEventListener("beforeunload",function(e){jsxc.xmpp.logout(!1),jsxc.xmpp.disconnected(),jsxc.error("Disconnected before leaving page")},!1)},stripHtml:function(html){var tmp=document.createElement("div");return tmp.innerHTML=html,tmp.textContent||tmp.innerText||""},isBuddyOnline:function(fjid){var buddy=jsxc.storage.getUserItem("buddy",jsxc.jidToBid(fjid));return buddy&&jsxc.CONST.STATUS.indexOf("offline")!==buddy.status},isLocalStorageAvailable:function(){try{if("undefined"==typeof localStorage)return jsxc.error("Browser doesn't support localStorage."),!1}catch(e){return jsxc.error("Browser doesn't support localStorage.",e),!1}return!0},init:function(options){if(jsxc.throwOnStropheErrors(),jsxc.isLocalStorageAvailable()!==!0){var showHeader=function(){if($("jsxc_noStorageWarning").length<1){var header='<div id="jsxc_noStorageWarning">Le stockage local de votre navigateur est indisponible. Utilisez un navigateur compatible (Firefox, Brave, Opera, Chrome) et utilisez une connexion sécurisée (https://...).</div>';$("body").prepend(header),jsxc.error("No local storage available.")}};return void setTimeout(showHeader,500)}options&&options.loginForm&&"boolean"==typeof options.loginForm.attachIfFound&&!options.loginForm.ifFound&&(options.loginForm.ifFound=options.loginForm.attachIfFound?"attach":"pause"),options&&$.extend(!0,jsxc.options,options),jsxc.api.callback("onInit"),jsxc.options.get=function(key){if(jsxc.bid){var local=jsxc.storage.getUserItem("options")||{};return"undefined"!=typeof local[key]?local[key]:jsxc.options[key]}return jsxc.options[key]},jsxc.options.set=function(key,value){jsxc.storage.updateItem("options",key,value,!0)},jsxc.storageNotConform=jsxc.storage.getItem("storageNotConform"),null===jsxc.storageNotConform&&(jsxc.storageNotConform=2),jsxc.localization.init(),jsxc.stats.init(),jsxc.stats.addEvent("jsxc.init"),jsxc.storage.getItem("debug")===!0&&(jsxc.options.otr.debug=!0),jsxc.sha1=__webpack_require__(1),jsxc.rest.init(),jsxc.help.init(),window.addEventListener("storage",jsxc.storage.onStorage,!1),$(document).on("attached.jsxc",function(){if(null!==jsxc.options.logoutElement&&$(jsxc.options.logoutElement).length>0){var logout=function(ev){jsxc.xmpp.conn&&jsxc.xmpp.conn.authenticated&&(ev.stopPropagation(),ev.preventDefault(),jsxc.options.logoutElement=$(this),jsxc.triggeredFromLogout=!0,jsxc.xmpp.logout())};jsxc.options.logoutElement=$(jsxc.options.logoutElement),jsxc.options.logoutElement.off("click",null,logout).one("click",logout)}});var isStorageAttachParameters=jsxc.storage.getItem("rid")&&jsxc.storage.getItem("sid")&&jsxc.storage.getItem("jid"),isOptionsAttachParameters=jsxc.options.xmpp.rid&&jsxc.options.xmpp.sid&&jsxc.options.xmpp.jid,isForceLoginForm=jsxc.options.loginForm&&"force"===jsxc.options.loginForm.ifFound&&jsxc.isLoginForm();if(!isStorageAttachParameters&&!isOptionsAttachParameters||isForceLoginForm){if(jsxc.storage.removeItem("rid"),jsxc.storage.removeItem("sid"),!jsxc.isLoginForm())return void(jsxc.options.displayRosterMinimized()&&(jsxc.storage.setUserItem("roster","hidden"),jsxc.gui.roster.init(),jsxc.gui.roster.noConnection()));"function"==typeof jsxc.options.formFound&&jsxc.options.formFound.call();var form=jsxc.options.loginForm.form=$(jsxc.options.loginForm.form),events=form.data("events")||{submit:[]},submits=[];$.each(events.submit,function(index,val){submits.push(val.handler)}),form.data("submits",submits),form.off("submit"),form.submit(function(){return jsxc.prepareLogin(function(settings){if(settings!==!1){var enabled=settings.loginForm&&settings.loginForm.enable||settings.xmpp&&settings.xmpp.onlogin;enabled="true"===enabled||enabled===!0,enabled&&(jsxc.options.loginForm.triggered=!0,jsxc.xmpp.login(jsxc.options.xmpp.jid,jsxc.options.xmpp.password))}else jsxc.submitLoginForm()}),!1})}else(!jsxc.isLoginForm()||jsxc.options.loginForm&&"attach"===jsxc.options.loginForm.ifFound)&&("number"!=typeof jsxc.storage.getItem("alive")?jsxc.onMaster():jsxc.checkMaster())},start:function(){var args=arguments;return jsxc.role_allocation&&!jsxc.master?(jsxc.debug("There is an other master tab"),!1):jsxc.xmpp.conn&&jsxc.xmpp.connected?(jsxc.debug("We are already connected"),!1):(3===args.length&&$(document).one("attached.jsxc",function(){jsxc.xmpp.onRidChange(jsxc.xmpp.conn._proto.rid),jsxc.onMaster()}),void jsxc.checkMaster(function(){jsxc.xmpp.login.apply(this,args)}))},isLoginForm:function(){return jsxc.options.loginForm.form&&jsxc.el_exists(jsxc.options.loginForm.form)&&jsxc.el_exists(jsxc.options.loginForm.jid)&&jsxc.el_exists(jsxc.options.loginForm.pass)},prepareLogin:function(username,password,cb){"function"==typeof username&&(cb=username,username=null),username=username||$(jsxc.options.loginForm.jid).val(),password=password||$(jsxc.options.loginForm.pass).val(),jsxc.triggeredFromBox||"dialog"!==jsxc.options.loginForm.onConnecting&&"undefined"!=typeof jsxc.options.loginForm.onConnecting||jsxc.gui.showWaitAlert(jsxc.t("Logging_in"));var settings;"function"==typeof jsxc.options.loadSettings?(settings=jsxc.options.loadSettings.call(this,username,password,function(s){jsxc._prepareLogin(username,password,cb,s)}),"undefined"!=typeof settings&&jsxc._prepareLogin(username,password,cb,settings)):jsxc._prepareLogin(username,password,cb)},_prepareLogin:function(username,password,cb,loadedSettings){if(loadedSettings===!1)return jsxc.warn("No settings provided"),void cb(!1);var settings=$.extend(!0,{},jsxc.options);loadedSettings?settings=$.extend(!0,settings,loadedSettings):loadedSettings={},"string"==typeof settings.xmpp.username&&(username=settings.xmpp.username);var jid,resource=settings.xmpp.resource?"/"+settings.xmpp.resource:"",domain=settings.xmpp.domain;jid=username.match(/@(.*)$/)?username.match(/\/(.*)$/)?username:username+resource:username+"@"+domain+resource,"function"==typeof jsxc.options.loginForm.preJid&&(jid=jsxc.options.loginForm.preJid(jid)),jsxc.bid=jsxc.jidToBid(jid),settings.xmpp.username=jid.split("@")[0],settings.xmpp.domain=jid.split("@")[1].split("/")[0],settings.xmpp.resource=jid.split("@")[1].split("/")[1]||"",loadedSettings.xmpp||(loadedSettings.xmpp={}),$.each(loadedSettings,function(key){var old=jsxc.options.get(key),val=settings[key];val=$.extend(!0,old,val),jsxc.options.set(key,val)}),jsxc.options.xmpp.jid=jid,jsxc.options.xmpp.password=password,cb(settings)},onSlave:function(){if(jsxc.debug("I am the slave."),jsxc.role_allocation=!0,jsxc.xmpp.conn&&jsxc.xmpp.logout(!0),$("#jsxc_slaveClientWarning").length<1){var header='<div id="jsxc_slaveClientWarning">La messagerie est disponible dans un autre onglet</div>';$("body").prepend(header)}},onMaster:function(){jsxc.debug("I am master."),jsxc.master=!0,jsxc.storage.setItem("alive",0),jsxc.storage.setItem("alive_busy",0),jsxc.startKeepAlive(),jsxc.role_allocation=!0,jsxc._disconnectBeforeUnload()},checkMaster:function(cb){jsxc.debug("check master"),cb=cb&&"function"==typeof cb?cb:jsxc.onMaster,"number"!=typeof jsxc.storage.getItem("alive")?cb.call():(jsxc.to.push(window.setTimeout(cb,1e3)),jsxc.storage.ink("alive"))},masterActions:function(){if(jsxc.xmpp.conn&&jsxc.xmpp.conn.authenticated){var noti=jsxc.storage.getUserItem("notification");noti="number"==typeof noti?noti:2,jsxc.options.notification&&noti>0&&jsxc.notification.hasSupport()?jsxc.notification.hasPermission()?jsxc.notification.init():jsxc.notification.prepareRequest():jsxc.options.notification=!1,jsxc.options.get("otr").enable&&jsxc.otr.createDSA()}},startKeepAlive:function(){jsxc.keepalive=window.setInterval(jsxc.keepAlive,jsxc.options.timeout-1e3)},keepAlive:function(){jsxc.storage.ink("alive")},keepBusyAlive:function(){jsxc.toBusy&&window.clearTimeout(jsxc.toBusy),jsxc.keepalive&&window.clearInterval(jsxc.keepalive),jsxc.storage.ink("alive_busy"),jsxc.toBusy=window.setTimeout(jsxc.startKeepAlive,jsxc.options.busyTimeout-1e3)},random:function(max){return Math.floor(Math.random()*max)},el_exists:function(selector){return $(selector).length>0},jidToCid:function(jid){jsxc.warn("jsxc.jidToCid is deprecated!");var cid=Strophe.getBareJidFromJid(jid).replace("@","-").replace(/\./g,"-").toLowerCase();return cid},jidToBid:function(jid){return Strophe.unescapeNode(Strophe.getBareJidFromJid(jid).toLowerCase())},restoreRoster:function(){var buddies=jsxc.storage.getUserItem("buddylist");return buddies&&0!==buddies.length?($.each(buddies,function(index,value){jsxc.gui.roster.add(value)}),jsxc.gui.roster.loaded=!0,void $(document).trigger("cloaded.roster.jsxc")):(jsxc.debug("No saved buddylist."),void jsxc.gui.roster.empty())},restoreWindows:function(){var windows=jsxc.storage.getUserItem("windowlist");null!==windows&&$.each(windows,function(index,bid){var win=jsxc.storage.getUserItem("window",bid);return win?(jsxc.gui.window.init(bid),win.minimize?jsxc.gui.window.hide(bid):jsxc.gui.window.show(bid),void jsxc.gui.window.setText(bid,win.text)):(jsxc.debug("Associated window-element is missing: "+bid),!0)})},submitLoginForm:function(){var form=jsxc.options.loginForm.form.off("submit"),submits=form.data("submits")||[];$.each(submits,function(index,val){form.submit(val)}),form.find("#submit").length>0?form.find("#submit").click():form.submit()},escapeHTML:function(text){return text=text.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">"),text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},removeHTML:function(text){return $("<span>").html(text).text()},switchEvents:function(obj){var ns=Math.random().toString(36).substr(2,12),self=this;return $.each(obj,function(key,val){$(document).one(key+"."+ns,function(){$(document).off("."+ns),val.apply(self,arguments)})}),ns},isHidden:function(){var hidden=!1;return"undefined"!=typeof document.hidden?hidden=document.hidden:"undefined"!=typeof document.webkitHidden?hidden=document.webkitHidden:"undefined"!=typeof document.mozHidden?hidden=document.mozHidden:"undefined"!=typeof document.msHidden&&(hidden=document.msHidden),hidden&&jsxc.master?jsxc.storage.ink("hidden",0):hidden||jsxc.master||jsxc.storage.ink("hidden"),hidden},hasFocus:function(){var focus=!0;return"function"==typeof document.hasFocus&&(focus=document.hasFocus()),!focus&&jsxc.master?jsxc.storage.ink("focus",0):focus&&!jsxc.master&&jsxc.storage.ink("focus"),focus},exec:function(fnName,fnParams){var i,fnList=fnName.split("."),fn=jsxc[fnList[0]];for(i=1;i<fnList.length;i++)fn=fn[fnList[i]];return"function"==typeof fn?fn.apply(null,fnParams):void 0},hashStr:function(str){var i,hash=0;if(!str||0===str.length)return hash;for(i=0;i<str.length;i++)hash=(hash<<5)-hash+str.charCodeAt(i),hash|=0;return hash},isExtraSmallDevice:function(){return $(window).width()<500},stackTrace:function(){var time=(new Date).getTime();console.error("Stack trace"),console.error("Time: "+time),console.error((new Error).stack)}},jsxc.xmpp={conn:null,_showPresences:!1,_sentPresences:0,_receivedPresences:0,AUTO_PRESENCE_SENDING_INTERVAL:4e3,LOW_PRESENCE_SENDING_INTERVAL:12e3,AUTO_PRESENCE_SENDING_MAX:-1,_autoPresenceSend:null,getCurrentNode:function(){return Strophe.getNodeFromJid(jsxc.xmpp.conn.jid)},login:function(){var self=jsxc.xmpp;if(jsxc.xmpp.conn&&jsxc.xmpp.conn.authenticated)return void jsxc.debug("Connection already authenticated.");var jid=null,password=null,sid=null,rid=null;switch(arguments.length){case 2:jid=arguments[0],password=arguments[1];break;case 3:jid=arguments[0],sid=arguments[1],rid=arguments[2];break;default:sid=jsxc.storage.getItem("sid"),rid=jsxc.storage.getItem("rid"),null!==sid&&null!==rid?jid=jsxc.storage.getItem("jid"):(sid=jsxc.options.xmpp.sid||null,rid=jsxc.options.xmpp.rid||null,jid=jsxc.options.xmpp.jid)}if(!jid)return void jsxc.warn("Jid required for login");jsxc.bid||(jsxc.bid=jsxc.jidToBid(jid));var url=jsxc.options.get("xmpp").url;if(!url)return void jsxc.warn("xmpp.url required for login");jsxc.xmpp.conn&&jsxc.xmpp.conn.connected||($(document).on("connected.jsxc",jsxc.xmpp.connected),$(document).on("attached.jsxc",jsxc.xmpp.attached),$(document).on("disconnected.jsxc",jsxc.xmpp.disconnected),$(document).on("connfail.jsxc",jsxc.xmpp.onConnfail),$(document).on("authfail.jsxc",jsxc.xmpp.onAuthFail),Strophe.addNamespace("RECEIPTS","urn:xmpp:receipts")),jsxc.xmpp.conn=new Strophe.Connection(url),jsxc.storage.getItem("debug")===!0&&(jsxc.xmpp.conn.xmlInput=function(data){jsxc.debug("<",data)},jsxc.xmpp.conn.xmlOutput=function(data){jsxc.debug(">",data)}),jsxc.xmpp.conn.nextValidRid=jsxc.xmpp.onRidChange;var callback=function(status,condition){switch(jsxc.debug("Strophe connexion changed: "+Object.getOwnPropertyNames(Strophe.Status)[status],{status:status,condition:condition}),status){case Strophe.Status.CONNECTING:$(document).trigger("connecting.jsxc");break;case Strophe.Status.CONNECTED:jsxc.bid=jsxc.jidToBid(jsxc.xmpp.conn.jid.toLowerCase()),$(document).trigger("connected.jsxc"),jsxc.master===!0&&(self.enableOnGuiActivityPresenceSending(),self.enableLowPresenceTimer());break;case Strophe.Status.ATTACHED:$(document).trigger("attached.jsxc");break;case Strophe.Status.DISCONNECTED:$(document).trigger("disconnected.jsxc"),self.disableAutoPresenceSending(),self.disableLowPresenceTimer();break;case Strophe.Status.CONNFAIL:$(document).trigger("connfail.jsxc");break;case Strophe.Status.AUTHFAIL:$(document).trigger("authfail.jsxc")}};jsxc.xmpp.conn.caps&&(jsxc.xmpp.conn.caps.node="djoe-jsxc-client"),sid&&rid?(jsxc.debug("Try to attach"),jsxc.debug("SID: "+sid),jsxc.reconnect=!0,jsxc.xmpp.conn.attach(jid,sid,rid,callback)):(jsxc.debug("New connection"),jsxc.xmpp.conn.caps&&jsxc.xmpp.conn._addSysHandler(function(stanza){var from=jsxc.xmpp.conn.domain,c=stanza.querySelector("c"),ver=c.getAttribute("ver"),node=c.getAttribute("node"),_jidNodeIndex=JSON.parse(localStorage.getItem("strophe.caps._jidNodeIndex"))||{};jsxc.xmpp.conn.caps._jidVerIndex[from]=ver,_jidNodeIndex[from]=node,localStorage.setItem("strophe.caps._jidVerIndex",JSON.stringify(jsxc.xmpp.conn.caps._jidVerIndex)),localStorage.setItem("strophe.caps._jidNodeIndex",JSON.stringify(_jidNodeIndex))},Strophe.NS.CAPS),jsxc.xmpp.conn.connect(jid,password||jsxc.options.xmpp.password,callback))},_debugPresences:!1,_lastAutoPresenceSent:-1,launchAutoPresenceTimer:function(){var self=jsxc.xmpp;self._debugPresences===!0&&jsxc.debug(" ...Starting auto presence sending timer",{interval:self.AUTO_PRESENCE_SENDING_INTERVAL,max:self.AUTO_PRESENCE_SENDING_MAX});var i=0;self._autoPresenceSend&&clearInterval(self._autoPresenceSend);var autosend=function(){if(!jsxc.xmpp.conn)return void clearInterval(self._autoPresenceSend);var now=(new Date).getTime();now-self._lastAutoPresenceSent<self.AUTO_PRESENCE_SENDING_INTERVAL||(self._lastAutoPresenceSent=now,self.sendPres(!0),i+=1,self.AUTO_PRESENCE_SENDING_MAX>0&&i>self.AUTO_PRESENCE_SENDING_MAX&&self.disableAutoPresenceSending())};self._autoPresenceSend=setInterval(autosend,self.AUTO_PRESENCE_SENDING_INTERVAL),autosend()},enableOnGuiActivityPresenceSending:function(){var self=jsxc.xmpp,gui=$("#jsxc-chat-sidebar");jsxc.debug("Sending presences on gui activity"),jsxc.master&&(gui.off("mouseover","*",self.launchAutoPresenceTimer),gui.off("mouseout","*",self.disableAutoPresenceSending),gui.mouseover(self.launchAutoPresenceTimer),gui.mouseout(self.disableAutoPresenceSending))},_lowPresenceTimer:null,enableLowPresenceTimer:function(){var self=jsxc.xmpp;self._lowPresenceTimer=setInterval(function(){jsxc.xmpp.sendPres(!0)},self.LOW_PRESENCE_SENDING_INTERVAL)},disableLowPresenceTimer:function(){var self=jsxc.xmpp;clearInterval(self._lowPresenceTimer)},disableAutoPresenceSending:function(){var self=jsxc.xmpp;self._debugPresences===!0&&jsxc.debug("Stopping auto presence sending timer",{interval:self.AUTO_PRESENCE_SENDING_INTERVAL,max:self.AUTO_PRESENCE_SENDING_MAX}),clearInterval(self._autoPresenceSend)},logout:function(){var self=jsxc.xmpp;if(jsxc.master===!0&&self.conn&&self.conn.send($pres({type:"unavailable"})),jsxc.storage.removeItem("sid"),jsxc.storage.removeUserItem("buddylist"),jsxc.storage.removeUserItem("windowlist"),jsxc.storage.removeUserItem("unreadMsg"),null===jsxc.xmpp.conn)return!0;$("body").click(),$.each(jsxc.storage.getUserItem("otrlist")||{},function(i,val){jsxc.otr.create(val)});var numOtr=Object.keys(jsxc.otr.objects||{}).length+1,disReady=function(){--numOtr<=0&&(jsxc.xmpp.conn.flush(),setTimeout(function(){jsxc.xmpp.conn&&jsxc.xmpp.conn.disconnect()},600))};return $.each(jsxc.otr.objects||{},function(key,obj){obj.msgstate===OTR.CONST.MSGSTATE_ENCRYPTED?obj.endOtr.call(obj,function(){obj.init.call(obj),jsxc.otr.backup(key),disReady()}):disReady()}),disReady(),!1},connected:function(){if(jsxc.xmpp.conn.pause(),jsxc.xmpp.initNewConnection(),jsxc.xmpp.saveSessionParameter(),jsxc.options.loginForm.triggered)switch(jsxc.options.loginForm.onConnected||"submit"){case"submit":return void jsxc.submitLoginForm();case!1:return}jsxc.gui.dialog.close(),jsxc.xmpp.conn.resume(),jsxc.onMaster(),$(document).trigger("attached.jsxc")},attached:function(){jsxc.xmpp.conn.addHandler(jsxc.xmpp.onRosterChanged,"jabber:iq:roster","iq","set"),jsxc.xmpp.conn.addHandler(jsxc.xmpp.onMessage,null,"message","chat"),jsxc.xmpp.conn.addHandler(jsxc.xmpp.onReceived,null,"message"),jsxc.xmpp.conn.addHandler(jsxc.xmpp.onPresence,null,"presence"),jsxc.gui.init();var caps=jsxc.xmpp.conn.caps,domain=jsxc.xmpp.conn.domain;if(caps){var conditionalEnable=function(){};if(jsxc.options.get("carbons").enable&&(conditionalEnable=function(){jsxc.xmpp.conn.caps.hasFeatureByJid(domain,jsxc.CONST.NS.CARBONS)&&jsxc.xmpp.carbons.enable()},$(document).on("caps.strophe",function onCaps(ev,from){from===domain&&(conditionalEnable(),$(document).off("caps.strophe",onCaps))})),"undefined"==typeof caps._knownCapabilities[caps._jidVerIndex[domain]]){var _jidNodeIndex=JSON.parse(localStorage.getItem("strophe.caps._jidNodeIndex"))||{};jsxc.debug("Request server capabilities"),caps._requestCapabilities(jsxc.xmpp.conn.domain,_jidNodeIndex[domain],caps._jidVerIndex[domain])}else conditionalEnable()}if(jsxc.reconnect&&jsxc.storage.getUserItem("buddylist"))jsxc.xmpp.sendPres(),jsxc.restoreCompleted||(jsxc.restoreRoster(),jsxc.restoreWindows(),jsxc.restoreCompleted=!0,$(document).trigger("restoreCompleted.jsxc"));else{$(document).one("cloaded.roster.jsxc",jsxc.xmpp.sendPres);var iq=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"});jsxc.xmpp.conn.sendIQ(iq,jsxc.xmpp.onRoster)}jsxc.xmpp.saveSessionParameter(),jsxc.masterActions()},saveSessionParameter:function(){var nomJid=jsxc.jidToBid(jsxc.xmpp.conn.jid).toLowerCase()+"/"+Strophe.getResourceFromJid(jsxc.xmpp.conn.jid);jsxc.storage.setItem("sid",jsxc.xmpp.conn._proto.sid),jsxc.storage.setItem("jid",nomJid)},initNewConnection:function(){jsxc.storage.removeUserItem("buddylist"),jsxc.storage.removeUserItem("windowlist"),jsxc.storage.removeUserItem("own"),jsxc.storage.removeUserItem("avatar","own"),jsxc.storage.removeUserItem("otrlist"),jsxc.storage.removeUserItem("unreadMsg"),jsxc.storage.removeUserElement("options","RTCPeerConfig")},sendPres:function(lightPresence){var self=jsxc.xmpp;self._sentPresences+=1,jsxc.xmpp.conn.disco&&!lightPresence&&(jsxc.xmpp.conn.disco.addIdentity("client","web","heyDjoe"),jsxc.xmpp.conn.disco.addFeature(Strophe.NS.DISCO_INFO),jsxc.xmpp.conn.disco.addFeature(Strophe.NS.RECEIPTS));var pres=$pres();jsxc.xmpp.conn.caps&&!lightPresence&&pres.c("c",jsxc.xmpp.conn.caps.generateCapsAttrs()).up();var presState=jsxc.storage.getUserItem("presence")||"online";"online"!==presState&&pres.c("show").t(presState).up();var priority=jsxc.options.get("priority");priority&&"undefined"!=typeof priority[presState]&&0!==parseInt(priority[presState])&&pres.c("priority").t(priority[presState]).up(),self._showPresences===!0&&jsxc.debug("Send presence",{count:self._sentPresences}),jsxc.xmpp.conn.send(pres)},disconnected:function(){jsxc.debug("disconnected"),jsxc.storage.removeItem("jid"),jsxc.storage.removeItem("sid"),jsxc.storage.removeItem("rid"),jsxc.storage.removeItem("hidden"),jsxc.storage.removeUserItem("avatar","own"),jsxc.storage.removeUserItem("otrlist"),$(document).off("connected.jsxc",jsxc.xmpp.connected),$(document).off("attached.jsxc",jsxc.xmpp.attached),$(document).off("disconnected.jsxc",jsxc.xmpp.disconnected),$(document).off("connfail.jsxc",jsxc.xmpp.onConnfail),$(document).off("authfail.jsxc",jsxc.xmpp.onAuthFail),jsxc.xmpp.conn=null,jsxc.gui.roster.noConnection(),window.clearInterval(jsxc.keepalive),jsxc.role_allocation=!1,jsxc.master=!1,jsxc.storage.removeItem("alive"),jsxc.error("Disconnected from JSXC")},onConnfail:function(ev,condition){jsxc.debug("XMPP connection failed: "+condition),jsxc.options.loginForm.triggered&&jsxc.submitLoginForm()},onAuthFail:function(){if(jsxc.options.loginForm.triggered)switch(jsxc.options.loginForm.onAuthFail||"ask"){case"ask":jsxc.gui.showAuthFail();break;case"submit":jsxc.submitLoginForm();break;case"quiet":case!1:return}},onRoster:function(iq){jsxc.debug("Load roster",iq);var buddies=[];$(iq).find("item").each(function(){var jid=$(this).attr("jid"),name=$(this).attr("name")||jid,bid=jsxc.jidToBid(jid),sub=$(this).attr("subscription");buddies.push(bid),jsxc.storage.removeUserItem("res",bid),jsxc.storage.saveBuddy(bid,{jid:jid,name:name,status:0,sub:sub,res:[]}),jsxc.gui.roster.add(bid)}),0===buddies.length&&jsxc.gui.roster.empty(),jsxc.storage.setUserItem("buddylist",buddies),jsxc.xmpp.bookmarks.load(),jsxc.gui.roster.loaded=!0,jsxc.debug("Roster loaded"),$(document).trigger("cloaded.roster.jsxc")},onRosterChanged:function(iq){return jsxc.debug("onRosterChanged",iq),$(iq).find("item").each(function(){var jid=$(this).attr("jid"),name=$(this).attr("name")||jid,bid=jsxc.jidToBid(jid),sub=$(this).attr("subscription");if("remove"===sub)jsxc.gui.roster.purge(bid);else{var bl=jsxc.storage.getUserItem("buddylist");bl.indexOf(bid)<0&&(bl.push(bid),jsxc.storage.setUserItem("buddylist",bl)),jsxc.storage.saveBuddy(bid,{jid:jid,name:name,sub:sub}),jsxc.gui.roster.getItem(bid).length<1?jsxc.gui.roster.add(bid):(jsxc.gui.update(bid),jsxc.gui.roster.reorder(bid))}if("from"===sub||"both"===sub){var notice,notices=jsxc.storage.getUserItem("notices"),noticeKey=null;for(noticeKey in notices)notice=notices[noticeKey],"gui.showApproveDialog"===notice.fnName&&notice.fnParams[0]===jid&&(jsxc.debug("Remove notice with key "+noticeKey),jsxc.notice.remove(noticeKey))}}),jsxc.storage.getUserItem("buddylist")&&0!==jsxc.storage.getUserItem("buddylist").length||jsxc.gui.roster.empty(),!0},changeOwnPresence:function(pres,external){if("undefined"==typeof pres)throw new Error("Presence cannot be undefined: "+pres);external!==!0&&jsxc.storage.setUserItem("presence",pres),jsxc.master&&jsxc.xmpp.sendPres(),$(document).trigger("ownpresence.jsxc",pres)},onPresence:function(presence){var self=jsxc.xmpp;self._showPresences===!0&&jsxc.debug("onPresence",{presence:presence,count:self._receivedPresences}),self._receivedPresences+=1;var ptype=$(presence).attr("type"),from=$(presence).attr("from"),jid=from.toLowerCase(),r=Strophe.getResourceFromJid(from),bid=jsxc.jidToBid(jid);if(bid===jsxc.jidToBid(jsxc.xmpp.conn.jid))return!0;var data=jsxc.storage.getUserItem("buddy",bid)||{},res=jsxc.storage.getUserItem("res",bid)||{},status=null,xVCard=$(presence).find('x[xmlns="vcard-temp:x:update"]');if("error"===ptype){$(document).trigger("error.presence.jsxc",[from,presence]);var error=$(presence).find("error");return jsxc.error("[XMPP] "+error.attr("code")+" "+error.find(">:first-child").prop("tagName")),!0}if("subscribe"===ptype){var bl=jsxc.storage.getUserItem("buddylist");return null===bl?!0:bl.indexOf(bid)>-1?(jsxc.debug("Auto approve contact request, because he is already in our contact list."),jsxc.xmpp.resFriendReq(jid,!0),"to"!==data.sub&&jsxc.xmpp.addBuddy(jid,data.name),!0):(jsxc.storage.setUserItem("friendReq",{jid:jid,approve:-1}),jsxc.notice.add(jsxc.t("Friendship_request"),jsxc.t("from")+" "+jid,"gui.showApproveDialog",[jid]),!0)}if("unavailable"===ptype||"unsubscribed"===ptype)status=jsxc.CONST.STATUS.indexOf("offline");else{var show=$(presence).find("show").text();status=""===show?jsxc.CONST.STATUS.indexOf("online"):jsxc.CONST.STATUS.indexOf(show)}res[r]=status;var maxStatus=0,sortedRes=[];if($.each(res,function(resource,status){return null===resource||"null"===resource||0===status?(delete res[resource],!0):(status>maxStatus&&(maxStatus=status),void(resource!==r&&sortedRes.push(resource)))}),0!==status&&sortedRes.unshift(r),data.res=sortedRes,0===data.status&&maxStatus>0&&"groupchat"!==data.type&&jsxc.notification.notify({title:data.name,msg:"Est connecté",source:bid,force:!0}),"groupchat"===data.type?data.status=status:data.status=maxStatus,null!==r&&"null"!==r&&r.length>1&&0!==status&&"groupchat"!==data.type&&(data.jid=jid,jsxc.gui.window.get(bid).length>0&&jsxc.gui.window.get(bid).data("jid",jid)),xVCard.length>0&&"groupchat"!==data.type){var photo=xVCard.find("photo");photo.length>0&&photo.text()!==data.avatar&&(jsxc.storage.removeUserItem("avatar",data.avatar),data.avatar=photo.text())}return jsxc.storage.setUserItem("buddy",bid,data),jsxc.storage.setUserItem("res",bid,res),self._showPresences===!0&&jsxc.debug("Presence ("+from+"): "+status),jsxc.gui.update(bid),jsxc.gui.window.checkBuddy(bid),jsxc.gui.roster.reorder(bid),$(document).trigger("presence.jsxc",[from,status,presence]),!0},onMessage:function(stanza){var message,carbon,forwarded=$(stanza).find('forwarded[xmlns="'+jsxc.CONST.NS.FORWARD+'"]');forwarded.length>0?(message=forwarded.find("> message"),forwarded=!0,carbon=$(stanza).find('> [xmlns="'+jsxc.CONST.NS.CARBONS+'"]'),0===carbon.length&&(carbon=!1),jsxc.debug("Incoming forwarded message",message)):(message=stanza,forwarded=!1,carbon=!1,jsxc.debug("Incoming message",message));var body=$(message).find("body:first").text();if(!body||body.match(/\?OTR/i)&&forwarded)return!0;var bid,type=$(message).attr("type"),from=$(message).attr("from"),mid=$(message).attr("id"),delay=$(message).find('delay[xmlns="urn:xmpp:delay"]'),stamp=delay.length>0?new Date(delay.attr("stamp")):new Date;if(stamp=stamp.getTime(),carbon){var direction="sent"===carbon.prop("tagName")?jsxc.Message.OUT:jsxc.Message.IN;return bid=jsxc.jidToBid("out"===direction?$(message).attr("to"):from),jsxc.gui.window.postMessage({bid:bid,direction:direction,msg:body,encrypted:!1,forwarded:forwarded,stamp:stamp}),!0}forwarded&&(body=from+" "+jsxc.t("to")+" "+$(stanza).attr("to")+'"'+body+'"',from=$(stanza).attr("from"));var jid=jsxc.jidToBid(from);bid=jsxc.jidToBid(jid);var data=jsxc.storage.getUserItem("buddy",bid),request=$(message).find("request[xmlns='urn:xmpp:receipts']");if(null===data){var unknownHistory=jsxc.storage.getUserItem("unknown-user-chat-history",bid)||[];unknownHistory.length<1&&jsxc.notice.add("Utilisateur inconnu","Vous avez reçu un message d'un utilisateur inconnu: "+Strophe.getNodeFromJid(bid),"gui.showUnknownSender",[bid]);var messageToPost={bid:bid,direction:jsxc.Message.IN,msg:body,encrypted:!1,forwarded:forwarded,stamp:stamp};return unknownHistory.push(messageToPost),jsxc.storage.setUserItem("unknown-user-chat-history",bid,unknownHistory.slice(-10)),!0}var win=jsxc.gui.window.init(bid);return"chat"===type&&null!==Strophe.getResourceFromJid(from)&&(win.data("jid",from),jsxc.storage.updateUserItem("buddy",bid,{jid:from})),$(document).trigger("message.jsxc",[from,body]),jsxc.master&&!jsxc.otr.objects[bid]&&jsxc.otr.create(bid),forwarded||null===mid||!request.length||null===data||"both"!==data.sub&&"from"!==data.sub||"chat"!==type||jsxc.xmpp.conn.send($msg({to:from}).c("received",{xmlns:"urn:xmpp:receipts",id:mid})),jsxc.otr.objects.hasOwnProperty(bid)?jsxc.otr.objects[bid].receiveMsg(body,{stamp:stamp,forwarded:forwarded}):jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.IN,msg:body,encrypted:!1,forwarded:forwarded,stamp:stamp}),!0},onRidChange:function(rid){jsxc.storage.setItem("rid",rid)},resFriendReq:function(from,approve){jsxc.master?(jsxc.xmpp.conn.send($pres({to:from,type:approve?"subscribed":"unsubscribed"})),approve===!0&&jsxc.api.callback("onBuddyAccepted",[from]),jsxc.storage.removeUserItem("friendReq"),jsxc.gui.dialog.close()):jsxc.storage.updateUserItem("friendReq","approve",approve)},addBuddy:function(username,alias){var bid=jsxc.jidToBid(username);if(jsxc.master){var iq=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:username,name:alias||""});jsxc.xmpp.conn.sendIQ(iq),jsxc.xmpp.conn.send($pres({to:username,type:"subscribe"})),jsxc.api.callback("onBuddyAdded",[username]),jsxc.storage.removeUserItem("add_"+bid)}else jsxc.storage.setUserItem("add_"+bid,{username:username,alias:alias||null})},removeBuddy:function(jid){var bid=jsxc.jidToBid(jid),iq=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:jsxc.jidToBid(jid),subscription:"remove"});jsxc.xmpp.conn.sendIQ(iq),jsxc.gui.roster.purge(bid)},onReceived:function(stanza){var composing=$(stanza).find("composing[xmlns='http://jabber.org/protocol/chatstates']");if(composing.length>0){var type=$(stanza).attr("type"),from=$(stanza).attr("from");return"groupchat"===type&&Strophe.getResourceFromJid(from)===jsxc.xmpp.getCurrentNode()?!0:(jsxc.gui.window.showComposingPresence(from,type),
!0)}var invitation=$(stanza).find("x[xmlns='jabber:x:conference']");if(invitation.length>0){var buddyName=Strophe.getNodeFromJid($(stanza).attr("from")),roomjid=invitation.attr("jid"),reason=invitation.attr("reason");return reason=reason?"Motif: "+reason:"",jsxc.notice.add(buddyName+" vous invite à participer à une conversation","","gui.showJoinConversationDialog",[roomjid,buddyName]),!0}var received=$(stanza).find("received[xmlns='urn:xmpp:receipts']");if(received.length){var receivedId=received.attr("id"),message=new jsxc.Message(receivedId);message.received()}return!0},sendMessage:function(bid,msg,uid){jsxc.otr.objects.hasOwnProperty(bid)?jsxc.otr.objects[bid].sendMsg(msg,uid):jsxc.xmpp._sendMessage(jsxc.gui.window.get(bid).data("jid"),msg,uid)},_sendMessage:function(jid,msg,uid){var data=jsxc.storage.getUserItem("buddy",jsxc.jidToBid(jid))||{},isBar=jsxc.jidToBid(jid)===jid,type=data.type||"chat",xmlMsg=$msg({to:jid,type:type,id:uid}).c("body").t(msg);jsxc.xmpp.carbons.enabled&&msg.match(/^\?OTR/)&&xmlMsg.up().c("private",{xmlns:jsxc.CONST.NS.CARBONS}),"chat"===type&&(isBar||jsxc.xmpp.conn.caps.hasFeatureByJid(jid,Strophe.NS.RECEIPTS))&&xmlMsg.up().c("request",{xmlns:"urn:xmpp:receipts"}),jsxc.xmpp.conn.send(xmlMsg)},loadVcard:function(bid,cb,error_cb){jsxc.master?jsxc.xmpp.conn.vcard.get(cb,bid,error_cb):(jsxc.storage.setUserItem("vcard",bid,"request:"+(new Date).getTime()),$(document).one("loaded.vcard.jsxc",function(ev,result){result&&"success"===result.state?cb($(result.data).get(0)):error_cb()}))},getCapabilitiesByJid:function(jid){if(jsxc.xmpp.conn)return jsxc.xmpp.conn.caps.getCapabilitiesByJid(jid);var jidVerIndex=JSON.parse(localStorage.getItem("strophe.caps._jidVerIndex"))||{},knownCapabilities=JSON.parse(localStorage.getItem("strophe.caps._knownCapabilities"))||{};return jidVerIndex[jid]?knownCapabilities[jidVerIndex[jid]]:null},hasFeatureByJid:function(jid,feature,cb){var conn=jsxc.xmpp.conn;if(cb=cb||function(){},!feature)return!1;$.isArray(feature)||(feature=$.makeArray(feature));var check=function(knownCapabilities){if(jsxc.debug("knownCapabilities",knownCapabilities),!knownCapabilities)return null;var i;for(i=0;i<feature.length;i++)if(knownCapabilities.features.indexOf(feature[i])<0)return!1;return!0};if(conn.caps._jidVerIndex[jid]&&conn.caps._knownCapabilities[conn.caps._jidVerIndex[jid]]){var hasFeature=check(conn.caps._knownCapabilities[conn.caps._jidVerIndex[jid]]);return cb(hasFeature),hasFeature}return $(document).on("strophe.caps",function(ev,j,capabilities){j===jid&&(cb(check(capabilities)),$(document).off(ev))}),null}},jsxc.xmpp.carbons={enabled:!1,enable:function(cb){var iq=$iq({type:"set"}).c("enable",{xmlns:jsxc.CONST.NS.CARBONS});jsxc.xmpp.conn.sendIQ(iq,function(){jsxc.xmpp.carbons.enabled=!0,jsxc.debug("Carbons enabled"),cb&&cb.call(this)},function(stanza){jsxc.warn("Could not enable carbons",stanza)})},disable:function(cb){var iq=$iq({type:"set"}).c("disable",{xmlns:jsxc.CONST.NS.CARBONS});jsxc.xmpp.conn.sendIQ(iq,function(){jsxc.xmpp.carbons.enabled=!1,jsxc.debug("Carbons disabled"),cb&&cb.call(this)},function(stanza){jsxc.warn("Could not disable carbons",stanza)})},refresh:function(err){return err!==!1?jsxc.options.get("carbons").enable?jsxc.xmpp.carbons.enable():jsxc.xmpp.carbons.disable():void 0}},jsxc.mmstream={debug:!0,VIDEOCONFERENCE_MAX_PARTICIPANTS:6,auto_accept_debug:!1,HANGUP_IF_NO_RESPONSE:2e4,XMPP_VIDEOCONFERENCE:{ELEMENT_NAME:"videoconference",STATUS_ATTR:"status",USERS_ATTR:"users",DATETIME_ATTR:"datetime",ID_ATTR:"id",INITIATOR_ATTR:"initiator",MESSAGE_ATTR:"message",REINVITE_ATTR:"reinvite",STATUS:{INIT:"initiate",ACCEPTED:"accepted",ABORT:"abort",REINVITATION:"reinvitation"}},SCREENSHARING_INVITATION_EXPIRATION:1e4,XMPP_SCREENSHARING:{ELEMENT_NAME:"screensharing",STATUS_ATTR:"status",DATETIME_ATTR:"datetime",STATUS:{INIT:"init",REINVITE:"reinvite",DECLINED:"declined",ACCEPT:"accept"}},autoHangupCalls:{},multimediacache:{lastLaunch:-1,occupied:!1,accepted:!1,screenStream:null,localStream:null,users:{},userList:[]},USER_TYPE:{SELF:"SELF",VIDEOCONF_INITIATOR:"VIDEOCONF_INITIATOR",VIDEOCONF_PARTICIPANT:"VIDEOCONF_PARTICIPANT",SIMPLE_VIDEO_CALL:"SIMPLE_VIDEO_CALL",SCREENSHARING_INITITATOR:"SCREENSHARING_INITITATOR",SCREENSHARING_RECIPIENT:"SCREENSHARING_RECIPIENT"},USER_STATUS:{SELF:"SELF",DISCONNECTED:"DISCONNECTED",NOT_READY:"NOT_READY",READY:"READY",CONNECTING:"CONNECTING",CONNECTED:"CONNECTED",CONNEXION_DISTURBED:"CONNEXION_DISTURBED",HAS_DECLINED_VIDEOCONFERENCE:"HAS_DECLINED_VIDEOCONFERENCE",HAS_REJECT_CALL:"HAS_REJECT_CALL"},reqVideoFeatures:["urn:xmpp:jingle:apps:rtp:video","urn:xmpp:jingle:apps:rtp:audio","urn:xmpp:jingle:transports:ice-udp:1","urn:xmpp:jingle:apps:dtls:0"],reqFileFeatures:["urn:xmpp:jingle:1","urn:xmpp:jingle:apps:file-transfer:3"],chromeExtensionMessages:{isAvailable:"djoe.screencapture-extension.is-available",available:"djoe.screencapture-extension.available",getScreenSourceId:"djoe.screencapture-extension.get-screen-source-id",getAPTSourceId:"djoe.screencapture-extension.get-audio-plus-tab-source-id"},conn:null,init:function(){var self=jsxc.mmstream;if(self.conn=jsxc.xmpp.conn,self.updateTurnCredentials(),!self.conn.jingle)return void self._log("No jingle plugin found!",null,"ERROR");self.messageHandler=self.conn.addHandler(jsxc.mmstream._onMessageReceived,null,"message"),self._registerListenersOnAttached(),self._isNavigatorChrome()===!0&&self.isChromeExtensionInstalled();var manager=self.conn.jingle.manager;manager.on("incoming",self._onIncomingJingleSession.bind(self)),manager.on("peerStreamAdded",self._onRemoteStreamAdded.bind(self)),manager.on("peerStreamRemoved",self._onRemoteStreamRemoved.bind(self)),self._log("MMStream module init"),jsxc.tests.runTests(jsxc.mmstream.testCases)},_log:function(message,data,level){jsxc.debug("[MMSTREAM] "+message,data,level)},_notifyMultimediacacheChanged:function(userArray){$(document).trigger("multimediacache-changed.jsxc",userArray?{users:userArray}:null)},_createUserEntry:function(fulljid){var self=jsxc.mmstream;if(!fulljid||!Strophe.getResourceFromJid(fulljid))throw new Error("Incorrect JID, must be full: "+fulljid);self.multimediacache.users[fulljid]={node:Strophe.getNodeFromJid(fulljid),type:self.USER_TYPE.SIMPLE_VIDEO_CALL,status:self.USER_STATUS.DISCONNECTED,session:null,stream:null,jingleState:null}},_setUserStatus:function(fulljid,status,overwrite){var self=jsxc.mmstream;if(overwrite="undefined"!=typeof overwrite?overwrite:!0,"undefined"==typeof fulljid)throw new Error("fulljid cannot be undefined: "+fulljid);if(-1===Object.keys(self.USER_STATUS).indexOf(status))throw new Error("Invalid status: "+status);self.multimediacache.users[fulljid]?overwrite===!0&&(self.multimediacache.users[fulljid].status=status):(self._log("Status change: user was created",fulljid,"INFO"),self._createUserEntry(fulljid),self.multimediacache.users[fulljid].status=status)},_setUserType:function(fulljid,type,overwrite){var self=jsxc.mmstream;if("undefined"==typeof fulljid)throw new Error("fulljid cannot be undefined: "+fulljid);if(-1===Object.keys(self.USER_TYPE).indexOf(type))throw new Error("Invalid type: "+type);overwrite="undefined"!=typeof overwrite?overwrite:!0,self.multimediacache.users[fulljid]?overwrite===!0&&(self.multimediacache.users[fulljid].type=type):(self._log("Type change: user was created",fulljid,"INFO"),self._createUserEntry(fulljid),self.multimediacache.users[fulljid].type=type)},_isScreensharingInitiator:function(fulljid){var self=jsxc.mmstream;return self.multimediacache.users[fulljid]&&self.multimediacache.users[fulljid].type===self.USER_TYPE.SCREENSHARING_INITITATOR},_updateAllVideoconferenceUsers:function(fulljidArray,status,type,overwrite){var self=jsxc.mmstream,triggeredDatas=[];$.each(fulljidArray,function(index,element){status&&self._setUserStatus(element,status,overwrite),type&&self._setUserType(element,type,overwrite),triggeredDatas.push({fulljid:element,status:status})}),self._notifyMultimediacacheChanged(triggeredDatas)},getUserStatus:function(fulljid){var self=jsxc.mmstream;if(!fulljid||!Strophe.getResourceFromJid(fulljid))throw new Error("Incorrect JID, must be full: "+fulljid);return self.multimediacache.users[fulljid]&&self.multimediacache.users[fulljid].status?self.multimediacache.users[fulljid].status:null},getUserType:function(fulljid){var self=jsxc.mmstream;if(!fulljid||!Strophe.getResourceFromJid(fulljid))throw new Error("Incorrect JID, must be full: "+fulljid);return self.multimediacache.users[fulljid]&&self.multimediacache.users[fulljid].type?self.multimediacache.users[fulljid].type:null},_isBuddyReady:function(fulljid){var self=jsxc.mmstream;if(!fulljid||!Strophe.getResourceFromJid(fulljid))throw new Error("Incorrect JID, must be full: "+fulljid);return self.multimediacache.users[fulljid]&&self.multimediacache.users[fulljid].status&&self.multimediacache.users[fulljid].status===self.USER_STATUS.READY},_isBuddyConnectingOrConnected:function(fulljid){var self=jsxc.mmstream;if(!fulljid||!Strophe.getResourceFromJid(fulljid))throw new Error("Incorrect JID, must be full: "+fulljid);return self.multimediacache.users[fulljid]&&self.multimediacache.users[fulljid].status&&(self.multimediacache.users[fulljid].status===self.USER_STATUS.CONNECTED||self.multimediacache.users[fulljid].status===self.USER_STATUS.CONNECTING)},_isBuddyScreensharingRecipient:function(fulljid){var self=jsxc.mmstream;if(!fulljid||!Strophe.getResourceFromJid(fulljid))throw new Error("Incorrect JID, must be full: "+fulljid);return self.multimediacache.users[fulljid]&&self.multimediacache.users[fulljid].type&&self.multimediacache.users[fulljid].type===self.USER_TYPE.SCREENSHARING_RECIPIENT},_isBuddyParticipatingToVideoconference:function(fulljid){var self=jsxc.mmstream;if(!fulljid||!Strophe.getResourceFromJid(fulljid))throw new Error("Incorrect JID, must be full: "+fulljid);return self.multimediacache.users[fulljid]&&self.multimediacache.users[fulljid].type&&(self.multimediacache.users[fulljid].type===self.USER_TYPE.VIDEOCONF_INITIATOR||self.multimediacache.users[fulljid].type===self.USER_TYPE.VIDEOCONF_PARTICIPANT)&&self.multimediacache.users[fulljid].status&&self.multimediacache.users[fulljid].status!==self.USER_STATUS.HAS_REJECT_CALL},_clearMultimediacache:function(){var self=jsxc.mmstream;jsxc.mmstream.debug===!0&&self._log("Multimedia cache cleared"),self.multimediacache.lastLaunch=-1,self.multimediacache.users={},self.multimediacache.accepted=!1,self.multimediacache.occupied=!1,$(document).trigger("multimediacache-changed.jsxc")},_purgeVideoconferenceCache:function(fulljidArray,mode){var self=jsxc.mmstream;if(mode=mode||"purge","others"!==mode&&"purge"!==mode)throw new Error("Unknown mode in _purgeVideoconferenceCache: "+mode);self.multimediacache.lastLaunch=-1,$.each(self.multimediacache.users,function(fulljid){fulljidArray.indexOf(fulljid)>-1&&"purge"===mode?delete self.multimediacache.users[fulljid]:fulljidArray.indexOf(fulljid)<0&&"others"===mode&&delete self.multimediacache.users[fulljid]})},_unserializeJidList:function(stringList){var res=stringList.split(","),finalRes=[];return $.each(res,function(index,elmt){finalRes.push(elmt.trim().toLowerCase())}),finalRes},_onMessageReceived:function(stanza){var self=jsxc.mmstream,from=$(stanza).attr("from");if(from===self.conn.jid)return!0;var status,video=$(stanza).find(self.XMPP_VIDEOCONFERENCE.ELEMENT_NAME),screen=$(stanza).find(self.XMPP_SCREENSHARING.ELEMENT_NAME);return video.length>0?(status=video.attr(self.XMPP_VIDEOCONFERENCE.STATUS_ATTR),jsxc.mmstream.debug&&self._log("_onMessageReceived: "+status,{status:status,stanza:stanza}),status===self.XMPP_VIDEOCONFERENCE.STATUS.INIT?(jsxc.stats.addEvent("jsxc.mmstream.videoconference.invitationReceived"),self._onVideoconferenceInvitationReceived(stanza,video)):status===self.XMPP_VIDEOCONFERENCE.STATUS.ACCEPTED?self._onVideoconferenceAccepted(stanza,video):status===self.XMPP_VIDEOCONFERENCE.STATUS.ABORT?self._onVideoconferenceDeclined(stanza,video):status===self.XMPP_VIDEOCONFERENCE.STATUS.REINVITATION?(jsxc.stats.addEvent("jsxc.mmstream.videoconference.re-invitationReceived"),self._onReinvitationReceived(stanza,video)):self._log("Invalid videoconference message: ",stanza,"ERROR")):screen.length>0&&(status=screen.attr(self.XMPP_SCREENSHARING.STATUS_ATTR),status===self.XMPP_SCREENSHARING.STATUS.INIT?(jsxc.stats.addEvent("jsxc.mmstream.screensharing.invitationReceived"),self._onScreensharingInvitationReceived(stanza,screen)):status===self.XMPP_SCREENSHARING.STATUS.ACCEPT?self._onScreensharingAcceptReceived(stanza,screen):status===self.XMPP_SCREENSHARING.STATUS.DECLINED?self._onScreensharingDeclineReceived(stanza,screen):status===self.XMPP_SCREENSHARING.STATUS.REINVITE?(jsxc.stats.addEvent("jsxc.mmstream.screensharing.re-invitationReceived"),self._onScreensharingInvitationReceived(stanza,screen)):self._log("Invalid screensharing message: ",stanza,"ERROR")),!0},_onScreensharingInvitationReceived:function(stanza,screen){var self=jsxc.mmstream,datetime=screen.attr(self.XMPP_SCREENSHARING.DATETIME_ATTR),now=(new Date).getTime(),from=$(stanza).attr("from"),node=Strophe.getNodeFromJid(from),decline=function(){self._sendScreensharingConfirmationMessage(self.XMPP_SCREENSHARING.STATUS.DECLINED,datetime,from)};return self._isNavigatorChrome()===!1?(jsxc.gui.feedback("<b>"+node+"</b> a éssayé de vous inviter à partager son écran, mais cette option n'est disponible que sur Chromium ou Chrome."),void decline()):self.isVideoCallsDisabled()===!0?(jsxc.gui.feedback("<b>"+node+"</b> a éssayé de vous inviter à partager son écran, mais les appels multimédia sont désactivés."),void decline()):self._isClientOccupied(from)!==!1?void decline():now-datetime>self.SCREENSHARING_INVITATION_EXPIRATION?(jsxc.gui.feedback("Vous avez reçu une invitation de partage d'écran, mais elle est périmée"),void decline()):void self.gui._showIncomingScreensharingDialog(from).then(function(){jsxc.gui.feedback("Partage d'écran accepté"),self._setUserType(from,self.USER_TYPE.SCREENSHARING_INITITATOR),self._sendScreensharingConfirmationMessage(self.XMPP_SCREENSHARING.STATUS.ACCEPT,datetime,from)}).fail(function(){jsxc.gui.feedback("Partage d'écran refusé"),decline()})},_sendScreensharingConfirmationMessage:function(status,datetime,to){if(!status||!datetime||!to)throw new Error("Invalid argument: "+status+" / "+datetime+" / "+to);var self=jsxc.mmstream,screen={};screen[self.XMPP_SCREENSHARING.DATETIME_ATTR]=datetime,screen[self.XMPP_SCREENSHARING.STATUS_ATTR]=status;var msg=$msg({from:self.conn.jid,to:to}).c(self.XMPP_SCREENSHARING.ELEMENT_NAME,screen);self.conn.send(msg),jsxc.mmstream.debug===!0&&self._log("_sendAcceptScreensharingMessage",{to:to,datetime:datetime,status:status})},_onScreensharingDeclineReceived:function(stanza){var self=jsxc.mmstream,from=$(stanza).attr("from");self._setUserStatus(from,self.USER_STATUS.HAS_REJECT_CALL),jsxc.gui.feedback("Partage d'écran refusé par <b>"+Strophe.getNodeFromJid(from)+"</b>")},_onScreensharingAcceptReceived:function(stanza){var self=jsxc.mmstream,from=$(stanza).attr("from");if(null===self.multimediacache.screenStream)throw new Error("Screen stream is null");var session=self.conn.jingle.initiate(from,self.multimediacache.screenStream);session.on("change:connectionState",self._onVideoSessionStateChanged)},_onReinvitationReceived:function(stanza,video){var self=jsxc.mmstream;self._log("_onReinvitation");var target=video.attr(self.XMPP_VIDEOCONFERENCE.REINVITE_ATTR),target_node=Strophe.getNodeFromJid(target),from=$(stanza).attr("from"),initiator=video.attr(self.XMPP_VIDEOCONFERENCE.INITIATOR_ATTR),participants=self._unserializeJidList(video.attr(self.XMPP_VIDEOCONFERENCE.USERS_ATTR)||""),datetime=video.attr(self.XMPP_VIDEOCONFERENCE.DATETIME_ATTR),invitationId=video.attr(self.XMPP_VIDEOCONFERENCE.ID_ATTR);target===self.conn.jid?(self.multimediacache.occupied=!0,jsxc.mmstream.debug===!0&&self._log("I have to join videoconference"),self.gui._showReinviteUserConfirmationDialog(from,"received").then(function(){self._requireLocalStream().done(function(){self._log("Local stream sharing accepted"),self._acceptVideoconference(initiator,participants,invitationId,datetime,!0)}).fail(function(error){jsxc.gui.feedback("Accès à la caméra refusé"+(error?": "+error:"")),self.multimediacache.occupied=!1})}).fail(function(){jsxc.gui.feedback("Invitation refusée"),self.multimediacache.occupied=!1})):jsxc.gui.feedback(target_node+" à été ré-invité dans la vidéoconférence par "+Strophe.getNodeFromJid(from))},_onVideoconferenceInvitationReceived:function(stanza,video){var self=jsxc.mmstream,invitationId=$(stanza).attr(self.XMPP_VIDEOCONFERENCE.ID_ATTR),initiator=video.attr(self.XMPP_VIDEOCONFERENCE.INITIATOR_ATTR),initiator_node=Strophe.getNodeFromJid(initiator),participants=self._unserializeJidList(video.attr(self.XMPP_VIDEOCONFERENCE.USERS_ATTR)||""),datetime=video.attr(self.XMPP_VIDEOCONFERENCE.DATETIME_ATTR);if(self.isVideoCallsDisabled()===!0)return jsxc.gui.feedback("<b>"+initiator_node+"</b> a éssayé de vous inviter à une vidéoconférence, mais les appels multimédia sont désactivés."),void self._declineVideconference(initiator,participants,invitationId,"Occupé !");if(self._isClientOccupied(initiator)!==!1)return void self._declineVideconference(initiator,participants,invitationId,"Occupé !");if(participants.length<1)return self._log("Too few participants",{stanza:stanza,participants:participants},"ERROR"),void jsxc.gui.feedback("Vous avez reçu une invitation à une vidéoconférence de <b>"+initiator_node+"</b>, mais elle est invalide.");self.multimediacache.accepted=!1,jsxc.mmstream.debug===!0&&self._log("_onVideoconferenceInvitationReceived",{fulljid:initiator,videoconference:self.multimediacache});var decline=function(message,error){jsxc.error("Videoconference declined: ",error),jsxc.gui.feedback(message),self._declineVideconference(initiator,participants,invitationId,error),self.multimediacache.occupied=!1};self.gui._showIncomingVideoconferenceDialog(Strophe.getNodeFromJid(initiator)).done(function(){self._log("Videoconference accepted"),self._requireLocalStream().done(function(){self._log("Local stream sharing accepted"),self._acceptVideoconference(initiator,participants,invitationId,datetime)}).fail(function(error){decline("Accès à la caméra refusé",error)})}).fail(function(error){decline("Vidéo conférence rejetée",error)})},reinviteUserInVideoconference:function(fulljid){var self=jsxc.mmstream;if(null===Strophe.getResourceFromJid(fulljid))throw new Error("JID must be full jid");var node=Strophe.getNodeFromJid(fulljid),error="";return self.multimediacache.userList.indexOf(fulljid)<0&&self.multimediacache.initiator!==fulljid&&(error="'"+node+"' ne participe pas à la vidéo conférence en cours."),self._isBuddyConnectingOrConnected(fulljid)===!0&&(error=node+" est déjà connecté ou en cours de connexion"),""!==error?void jsxc.gui.feedback(error):void self.gui._showReinviteUserConfirmationDialog(Strophe.getNodeFromJid(fulljid),"emit").then(function(){var participants=self.multimediacache.userList,initiator=self.multimediacache.initiator,node=Strophe.getNodeFromJid(self.conn.jid);self._sendVideoconferenceInvitations(participants,node+" vous invite à revenir dans la vidéoconférence",initiator,self.XMPP_VIDEOCONFERENCE.STATUS.REINVITATION,fulljid),jsxc.gui.feedback("L'invitation à été envoyée.")}).fail(function(error){throw new Error(error)})},_acceptVideoconference:function(initiator,participants,invitationId,datetime,reaccept){var self=jsxc.mmstream;jsxc.stats.addEvent("jsxc.mmstream.multimediacache.accepted"),reaccept="undefined"!=typeof reaccept?reaccept:!1,self._hangUpAll(),self._purgeVideoconferenceCache(participants.concat([initiator]),"others"),self.multimediacache.userList=participants,self.multimediacache.initiator=initiator;var alreadyReady=[];if($.each(self.multimediacache.users,function(fulljid){self._isBuddyReady(fulljid)===!0&&alreadyReady.push(fulljid)}),self._updateAllVideoconferenceUsers(participants,self.USER_STATUS.NOT_READY,self.USER_TYPE.VIDEOCONF_PARTICIPANT),$.each(alreadyReady,function(index,fulljid){self._setUserStatus(fulljid,self.USER_STATUS.READY)}),self._setUserType(initiator,self.USER_TYPE.VIDEOCONF_INITIATOR),self._setUserStatus(initiator,self.USER_STATUS.READY),self._setUserType(self.conn.jid,self.USER_TYPE.SELF),self._setUserStatus(self.conn.jid,self.USER_STATUS.SELF),self.multimediacache.lastLaunch=datetime,self.multimediacache.accepted=!0,reaccept===!0){var usersToCall=self._whichUsersMustWeCall(initiator,participants,self.conn.jid);$.each(usersToCall,function(index,fulljid){self._setUserStatus(fulljid,self.USER_STATUS.READY)})}self._notifyMultimediacacheChanged(),self._sendAcceptVideoconferenceMessage(initiator,invitationId,participants),self._videoconferenceCallUsersReady(initiator,participants)},_declineVideconference:function(initiator,participants,invitationId,error){var self=jsxc.mmstream;jsxc.stats.addEvent("jsxc.mmstream.multimediacache.decline"),self._log("declineVideconference",error),self._sendDeclineVideoconferenceMessage(initiator,invitationId,participants)},_videoconferenceCallUsersReady:function(initiator,participants,ownJid){var self=jsxc.mmstream,usersToCall=self._whichUsersMustWeCall(initiator,participants,ownJid),called=[];$.each(self.multimediacache.users,function(fulljid){-1!==usersToCall.indexOf(fulljid)&&self._isBuddyReady(fulljid)===!0&&(self._startVideoCall(fulljid,self.USER_TYPE.VIDEOCONF_PARTICIPANT),called.push(fulljid))}),jsxc.mmstream.debug===!0&&self._log("_videoconferenceCallUsersReady",called)},_onVideoconferenceAccepted:function(stanza,video){var self=jsxc.mmstream,initiator=video.attr(self.XMPP_VIDEOCONFERENCE.INITIATOR_ATTR),participants=self._unserializeJidList(video.attr(self.XMPP_VIDEOCONFERENCE.USERS_ATTR)||""),user=$(stanza).attr("from");jsxc.mmstream.debug===!0&&self._log("_onVideoconferenceAccepted",{initiator:initiator,from:user,participants:participants}),self._setUserStatus(user,self.USER_STATUS.READY),self._notifyMultimediacacheChanged(),self.multimediacache.accepted===!0&&self._videoconferenceCallUsersReady(initiator,participants)},_onVideoconferenceDeclined:function(stanza,video){var self=jsxc.mmstream,from=$(stanza).attr("from"),initiator=video.attr("initiator");jsxc.mmstream.debug===!0&&self._log("_onVideoconferenceDeclined",{initiator:initiator,from:from}),self._setUserStatus(initiator,self.USER_STATUS.HAS_DECLINED_VIDEOCONFERENCE),self._notifyMultimediacacheChanged(),self._hangUpAll(),jsxc.gui.dialog.close("video_conference_incoming"),jsxc.gui.feedback("La videoconférence à été annulée par "+Strophe.getNodeFromJid(from)),setTimeout(function(){self._clearMultimediacache()},1e3)},_sendAcceptVideoconferenceMessage:function(initiator,conferenceId,participants){var self=jsxc.mmstream;if(-1!==participants.indexOf(initiator))throw new Error("Participants list must not contain initiator: "+initiator+" / "+participants.join(","));var video={};video[self.XMPP_VIDEOCONFERENCE.USERS_ATTR]=participants.join(","),video[self.XMPP_VIDEOCONFERENCE.STATUS_ATTR]=self.XMPP_VIDEOCONFERENCE.STATUS.ACCEPTED,video[self.XMPP_VIDEOCONFERENCE.ID_ATTR]=conferenceId,video[self.XMPP_VIDEOCONFERENCE.INITIATOR_ATTR]=initiator,video[self.XMPP_VIDEOCONFERENCE.DATETIME_ATTR]=(new Date).toISOString().slice(0,19).replace("T"," "),video[self.XMPP_VIDEOCONFERENCE.MESSAGE_ATTR]="Vidéoconférence acceptée par "+Strophe.getNodeFromJid(self.conn.jid);var msg=$msg({from:self.conn.jid}).c(self.XMPP_VIDEOCONFERENCE.ELEMENT_NAME,video),sent=[];$.each(participants.concat([initiator]),function(index,fulljid){if(fulljid!==self.conn.jid){var adressedMessage=$(msg.toString()).attr("to",fulljid);self.conn.send(adressedMessage),sent.push(fulljid)}}),jsxc.mmstream.debug===!0&&self._log("_sendAcceptVideoconferenceMessage",{to:sent})},_sendDeclineVideoconferenceMessage:function(initiator,conferenceId,participants){var self=jsxc.mmstream;if(-1!==participants.indexOf(initiator))throw new Error("Participants list must not contain initiator: "+initiator+" / "+participants.join(","));var video={};video[self.XMPP_VIDEOCONFERENCE.USERS_ATTR]=participants.join(","),video[self.XMPP_VIDEOCONFERENCE.STATUS_ATTR]=self.XMPP_VIDEOCONFERENCE.STATUS.ABORT,video[self.XMPP_VIDEOCONFERENCE.ID_ATTR]=conferenceId,video[self.XMPP_VIDEOCONFERENCE.INITIATOR_ATTR]=initiator,video[self.XMPP_VIDEOCONFERENCE.DATETIME_ATTR]=(new Date).toISOString().slice(0,19).replace("T"," "),video[self.XMPP_VIDEOCONFERENCE.MESSAGE_ATTR]="Vidéoconférence rejetée par "+Strophe.getNodeFromJid(self.conn.jid);var msg=$msg({from:self.conn.jid}).c(self.XMPP_VIDEOCONFERENCE.ELEMENT_NAME,video),sent=[];$.each(participants.concat([initiator]),function(index,fulljid){if(fulljid!==self.conn.jid){var adressedMessage=$(msg.toString()).attr("to",fulljid);self.conn.send(adressedMessage),sent.push(fulljid)}}),jsxc.mmstream.debug===!0&&self._log("_sendDeclineVideoconferenceMessage",{to:sent})},_sendVideoconferenceInvitations:function(participants,messageTxt,initiator,status,reinvitationTarget){var self=jsxc.mmstream;if(initiator=initiator||self.conn.jid,status=status||self.XMPP_VIDEOCONFERENCE.STATUS.INIT,$.each(participants,function(index,element){var res=Strophe.getResourceFromJid(element);if(null===res||""===res||"null"===res)throw new Error("Only full jid are permitted: "+element)}),-1!==participants.indexOf(initiator))throw new Error("Participants list must not contain initiator: "+initiator+" / "+participants.join(","));var conferenceId=self.conn.getUniqueId(),datetime=(new Date).toISOString().slice(0,19).replace("T"," "),video={};video[self.XMPP_VIDEOCONFERENCE.USERS_ATTR]=participants.join(","),video[self.XMPP_VIDEOCONFERENCE.STATUS_ATTR]=status,video[self.XMPP_VIDEOCONFERENCE.ID_ATTR]=conferenceId,video[self.XMPP_VIDEOCONFERENCE.INITIATOR_ATTR]=initiator,video[self.XMPP_VIDEOCONFERENCE.DATETIME_ATTR]=datetime,video[self.XMPP_VIDEOCONFERENCE.MESSAGE_ATTR]=messageTxt||"Vidéoconférence organisée par "+Strophe.getNodeFromJid(initiator),reinvitationTarget&&(video[self.XMPP_VIDEOCONFERENCE.REINVITE_ATTR]=reinvitationTarget);var msg=$msg({from:self.conn.jid}).c(self.XMPP_VIDEOCONFERENCE.ELEMENT_NAME,video),sent=[];return $.each(participants.concat(initiator),function(index,fulljid){if(jsxc.stats.addEvent("jsxc.mmstream.videoconference.sendInvitation"),fulljid!==self.conn.jid){var adressedMessage=$(msg.toString()).attr("to",fulljid);self.conn.send(adressedMessage),sent.push(fulljid)}}),jsxc.mmstream.debug===!0&&self._log("_sendVideoconferenceInvitations",{to:sent}),{conferenceId:conferenceId,datetime:datetime}},startVideoconference:function(fulljidArray,message){var self=jsxc.mmstream;if(jsxc.stats.addEvent("jsxc.mmstream.multimediacache.start"),self.isVideoCallsDisabled()===!0)return jsxc.gui.feedback("Les appels multimédia sont désactivés."),void self._log("Calls are disabled");if(!fulljidArray||fulljidArray.constructor!==Array)throw new Error("Illegal argument: "+fulljidArray);if(fulljidArray.length>self.VIDEOCONFERENCE_MAX_PARTICIPANTS)throw new Error("Too much participants. Number: "+fulljidArray.length+" / Max: "+self.VIDEOCONFERENCE_MAX_PARTICIPANTS);self.checkNavigatorCompatibility("videoconference"),jsxc.mmstream.debug===!0&&self._log("startVideoconference",[fulljidArray,message]),self._isClientOccupied(null,!0)===!1&&(self.multimediacache.accepted=!1,self._requireLocalStream().then(function(){self._clearMultimediacache(),self.multimediacache.accepted=!0,self._updateAllVideoconferenceUsers(fulljidArray,self.USER_STATUS.NOT_READY),self._setUserStatus(self.conn.jid,self.USER_STATUS.SELF),self._setUserType(self.conn.jid,self.USER_TYPE.SELF),self._notifyMultimediacacheChanged(),self.multimediacache.userList=fulljidArray,self.multimediacache.initiator=self.conn.jid;try{var ret=self._sendVideoconferenceInvitations(fulljidArray,message);self.multimediacache.lastLaunch=ret.datetime,jsxc.gui.feedback("La vidéoconférence va bientôt commencer ...")}catch(error){self._log("Error while starting videoconference: ",error,"ERROR"),jsxc.gui.feedback("Erreur lors de l'envoi des invitations."),self.multimediacache.occupied=!1}}).fail(function(error){jsxc.gui.feedback("Accès à la caméra refusé"+(error?": "+error:"")),self.multimediacache.occupied=!1}))},_whichUsersMustWeCall:function(initiator,participants,ownJid){var self=jsxc.mmstream;if(ownJid=ownJid||self.conn.jid,-1!==participants.indexOf(initiator))throw new Error("Participants list must not contain initiator: "+initiator+" / "+participants.join(","));var res=[],fulllist=participants.concat([initiator]);fulllist.sort(),fulllist=fulllist.concat(fulllist);var ownIndex=fulllist.indexOf(ownJid);if(0>ownIndex)throw new Error("Invalid jid: "+ownJid);for(var i=ownIndex+1;i<fulllist.length&&fulllist[i]!==initiator;i++)res.push(fulllist[i]);return res},startScreenSharingMultiPart:function(fulljidArray,message){var self=jsxc.mmstream;return jsxc.mmstream.debug===!0&&self._log("startScreenSharingMultiPart",[fulljidArray,message]),self.isVideoCallsDisabled()===!0?(jsxc.gui.feedback("Les appels multimédia sont désactivés."),void self._log("Calls are disabled")):(jsxc.stats.addEvent("jsxc.mmstream.screensharing.multipart.start"),self.checkNavigatorCompatibility("videoconference"),void(self._isClientOccupied(null,!0)===!1&&(jsxc.gui.feedback("Le partage d'écran va bientôt commencer ..."),self.conn.jingle.setICEServers(self.iceServers),self._getUserScreenStream().then(function(stream){self._clearMultimediacache(),self._updateAllVideoconferenceUsers(fulljidArray,self.USER_STATUS.NOT_READY,self.USER_TYPE.SCREENSHARING_RECIPIENT),self._setUserStatus(self.conn.jid,self.USER_STATUS.SELF),self._setUserType(self.conn.jid,self.USER_TYPE.SELF),self._notifyMultimediacacheChanged(),self.multimediacache.screenStream=stream,self.multimediacache.userList=fulljidArray,self._sendScreensharingInvitations(fulljidArray),self.gui.showLocalScreenStream()}).fail(function(){jsxc.gui.feedback("Impossible d'accéder à votre écran, veuillez autoriser l'accès, installer l'extension si nécéssaire et réessayer."),self.multimediacache.occupied=!1}))))},reinviteUserInScreensharing:function(fulljid){var self=jsxc.mmstream;if(!fulljid||null===Strophe.getResourceFromJid(fulljid))throw new Error("Invalid argument: "+fulljid);var node=Strophe.getNodeFromJid(fulljid);self._isBuddyConnectingOrConnected(fulljid)===!0&&jsxc.gui.feedback(node+" est déjà connecté ou en cours de connexion"),self.gui._showReinviteUserConfirmationDialog(Strophe.getNodeFromJid(fulljid),"emit").then(function(){jsxc.gui.feedback("Invitation envoyée"),self._sendScreensharingInvitations([fulljid],!0)}).fail(function(){jsxc.gui.feedback("Opération annulée")})},_sendScreensharingInvitations:function(participants,reinvitation){var self=jsxc.mmstream;reinvitation="undefined"!=typeof reinvitation?reinvitation:!1,$.each(participants,function(index,element){var res=Strophe.getResourceFromJid(element);if(null===res||""===res||"null"===res)throw new Error("Only full jid are permitted: "+element)});var datetime=(new Date).getTime(),screen={};screen[self.XMPP_SCREENSHARING.DATETIME_ATTR]=datetime,reinvitation?screen[self.XMPP_SCREENSHARING.STATUS_ATTR]=self.XMPP_SCREENSHARING.STATUS.REINVITE:screen[self.XMPP_SCREENSHARING.STATUS_ATTR]=self.XMPP_SCREENSHARING.STATUS.INIT;var msg=$msg({from:self.conn.jid}).c(self.XMPP_SCREENSHARING.ELEMENT_NAME,screen),sent=[];$.each(participants,function(index,fulljid){if(jsxc.stats.addEvent("jsxc.mmstream.screenSharing.sendInvitation"),fulljid!==self.conn.jid){var adressedMessage=$(msg.toString()).attr("to",fulljid);self.conn.send(adressedMessage),sent.push(fulljid)}}),jsxc.mmstream.debug===!0&&self._log("_sendScreensharingInvitations",{to:sent})},_isNavigatorFirefox:function(){return"undefined"!=typeof InstallTrigger},_isNavigatorChrome:function(){return!!window.chrome&&!!window.chrome.webstore},_isNavigatorInternetExplorer:function(){var ua=window.navigator.userAgent;return ua.indexOf("MSIE ")>0||ua.indexOf("Trident/")>0||ua.indexOf(!1)},checkNavigatorCompatibility:function(task){
var self=jsxc.mmstream,message="";if("videoconference"===task)self._isNavigatorInternetExplorer()===!0&&(message="La vidéo conférence n'est pas disponible avec Internet Explorer. Utilisez Firefox, Brave, Opera ou Chrome.");else{if("screensharing"!==task)throw new Error("Unknown task: "+task);self._isNavigatorChrome()!==!0&&(message="Le partage d'écran n'est pas disponible avec votre navigateur. Utilisez Chromium ou Chrome.")}if(""!==message)throw jsxc.gui.feedback(message),new Error(message)},isChromeExtensionInstalled:function(){var self=jsxc.mmstream,messages=self.chromeExtensionMessages,defer=$.Deferred();return self._isNavigatorChrome()===!0?(window.addEventListener("message",function(event){event&&event.data&&event.data===messages.available&&defer.resolve()}),setTimeout(function(){defer.reject("NoResponseFromExtension")},3e3),window.postMessage(messages.isAvailable,"*")):defer.reject("InvalidNavigator"),defer.promise()},_getUserScreenStream:function(){var self=jsxc.mmstream,defer=$.Deferred(),messages=self.chromeExtensionMessages,screenStreamListener=function(event){if(!event||!event.data)return void self._log("Invalid event",event);var data=event.data;if(data.sourceId){var constraints={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:screen.width>1920?screen.width:1920,maxHeight:screen.height>1080?screen.height:1080,chromeMediaSourceId:data.sourceId}}};navigator.webkitGetUserMedia(constraints,function(stream){self._log("Screen capture accepted"),jsxc.stats.addEvent("jsxc.mmstream.screensharing.streamAcquired"),window.removeEventListener("message",screenStreamListener),defer.resolve(stream)},function(error){jsxc.error("Screen stream refused",{error:error}),self._log("Screen capture declined"),jsxc.stats.addEvent("jsxc.mmstream.screensharing.streamRefused"),window.removeEventListener("message",screenStreamListener),defer.reject(error)})}};return window.addEventListener("message",screenStreamListener),window.postMessage(messages.getScreenSourceId,"*"),defer.promise()},_onIncomingJingleSession:function(session){var self=jsxc.mmstream;if(jsxc.mmstream.debug===!0&&self._log("_onIncomingJingleSession",{session:session}),self.isVideoCallsDisabled()===!0){var node=Strophe.getNodeFromJid(session.peerID);return jsxc.gui.feedback("<b>"+node+"</b> a éssayé de vous contacter, mais les appels multimédia sont désactivés."),void session.end("decline",!1)}session.on("change:connectionState",self._onVideoSessionStateChanged);var type=session.constructor?session.constructor.name:null;"FileTransferSession"===type?self._onIncomingFileTransfer(session):"MediaSession"===type?self._onIncomingCall(session):console.error("Unknown session type: "+type,session)},_onIncomingFileTransfer:function(){throw jsxc.gui.feedback("Transfert de fichier à l'arrivée. Cette fonctionnalité n'est pas encore disponible."),new Error("Not implemented yet")},_onIncomingCall:function(session){var self=jsxc.mmstream;jsxc.mmstream.debug===!0&&self._log("_onIncomingCall",{videoconference:self.multimediacache}),session.ring();var fulljid=session.peerID,bid=jsxc.jidToBid(fulljid),acceptRemoteSession=function(localStream){jsxc.mmstream.debug===!0&&self._log("Call accepted",session),session.addStream(localStream),session.accept()},declineRemoteSession=function(){jsxc.mmstream.debug===!0&&self._log("Call declined",session),session.end("decline",!1),self._setUserStatus(fulljid,self.USER_STATUS.HAS_REJECT_CALL),self._notifyMultimediacacheChanged(),self.multimediacache.occupied=!1},errorWhileAccessingLocalStream=function(error){jsxc.gui.feedback("Erreur lors de l'accès à la caméra et au micro: "+error),self._log("Error while using audio/video",error)};if(self.auto_accept_debug===!0)jsxc.mmstream.debug===!0&&self._log("Auto accept call - debug mode"),jsxc.notification.notify("Appel vidéo","L'appel a été accepté automatiquement: "+bid),self._requireLocalStream().done(function(localStream){acceptRemoteSession(localStream)}).fail(function(error){declineRemoteSession(),errorWhileAccessingLocalStream(error)});else if(self._isBuddyParticipatingToVideoconference(fulljid)===!0)self._log("Participant accepted",{session:session,videoconference:self.multimediacache}),jsxc.mmstream.debug===!0&&self._log("Buddy accepted ",{fulljid:fulljid,videoconference:self.multimediacache}),self._requireLocalStream().done(function(localStream){acceptRemoteSession(localStream)}).fail(function(error){declineRemoteSession(),errorWhileAccessingLocalStream(error)});else if(self._isScreensharingInitiator(fulljid))acceptRemoteSession(new MediaStream);else{if(jsxc.notification.notify(jsxc.t("Incoming_call"),jsxc.t("from_sender",{sender:bid})),self._log("Incoming call ",session),self._isClientOccupied(fulljid)!==!1)return void declineRemoteSession();self._setUserType(fulljid,self.USER_TYPE.SIMPLE_VIDEO_CALL),self._notifyMultimediacacheChanged(),self.gui._showIncomingCallDialog(bid).done(function(){self._requireLocalStream().done(function(localStream){acceptRemoteSession(localStream)}).fail(function(error){declineRemoteSession(),errorWhileAccessingLocalStream(error)})}).fail(function(){jsxc.gui.feedback("Appel rejeté"),declineRemoteSession()})}},_requireLocalStream:function(){var self=jsxc.mmstream,defer=$.Deferred();if(null!==self.multimediacache.localStream&&self.multimediacache.localStream.active)return defer.resolve(self.multimediacache.localStream),defer.promise();var constraints;return constraints=self._isNavigatorFirefox()?{audio:!0,video:!0}:{audio:!0,video:{mandatory:{minWidth:320,maxWidth:640,minHeight:180,maxHeight:480,minFrameRate:10,maxFrameRate:20},optional:[]}},self.conn.jingle.RTC.getUserMedia(constraints,function(localStream){self.multimediacache.localStream=localStream,defer.resolve(localStream)},function(error){self._log("Error while getting local stream",error,"ERROR"),defer.reject(error)}),defer.promise()},_onRemoteStreamAdded:function(session,stream){var self=jsxc.mmstream;if(jsxc.mmstream.debug===!0&&self._log("_onRemoteStreamAdded",[session,stream]),self.isVideoCallsDisabled()===!0)return void self._log("Calls are disabled");var fulljid=session.peerID;self.gui._showVideoStream(stream,fulljid),jsxc.newgui.toggleMediapanel(!0),self.multimediacache.users[fulljid]||self._createUserEntry(fulljid),self.multimediacache.users[fulljid].session=session,self.multimediacache.users[fulljid].stream=stream,self.gui.isLocalVideoShown()!==!0&&self.getUserType(fulljid)!==self.USER_TYPE.SCREENSHARING_INITITATOR&&self.gui.showLocalVideo()},getActiveSession:function(fulljid){var self=jsxc.mmstream;return self.multimediacache.users[fulljid]&&self.multimediacache.users[fulljid].session?self.multimediacache.users[fulljid].session:null},getActiveStream:function(fulljid){var self=jsxc.mmstream;return self.multimediacache.users[fulljid]&&self.multimediacache.users[fulljid].stream?self.multimediacache.users[fulljid].stream:null},_onRemoteStreamRemoved:function(session,stream){var self=jsxc.mmstream;jsxc.mmstream.debug===!0&&self._log("_onRemoteStreamRemoved",[session,stream]);var fulljid=session.peerID;self._stopStream(stream),self.multimediacache.users[fulljid]?(delete self.multimediacache.users[fulljid].session,delete self.multimediacache.users[fulljid].stream):self._log("No session found",null,"ERROR"),self.gui._hideVideoStream(fulljid),self.getCurrentVideoSessions().length<1&&(self.multimediacache.occupied=!1)},getCurrentVideoSessions:function(){var self=jsxc.mmstream,res=[];return $.each(self.multimediacache.users,function(index,item){item.session&&res.push(item.session)}),res},startSimpleVideoCall:function(fulljid){var self=jsxc.mmstream,node=Strophe.getNodeFromJid(fulljid);return self.isVideoCallsDisabled()===!0?(jsxc.gui.feedback("Les appels multimédia sont désactivés."),void self._log("Calls are disabled")):(jsxc.stats.addEvent("jsxc.mmstream.videocall.simplecall"),self._isBuddyConnectingOrConnected(fulljid)===!0?void jsxc.gui.feedback(node+" est déjà connecté ou en cours de connexion"):void(self._isClientOccupied(null,!0)===!1&&(self.checkNavigatorCompatibility("videoconference"),self._startVideoCall(fulljid))))},_startVideoCall:function(fulljid,userType){var self=jsxc.mmstream;if(null===Strophe.getResourceFromJid(fulljid))throw new Error("JID must be full jid");jsxc.mmstream.debug===!0&&self._log("_startVideoCall ",fulljid),userType="undefined"!=typeof userType?userType:self.USER_TYPE.SIMPLE_VIDEO_CALL,self._setUserStatus(fulljid,self.USER_STATUS.CONNECTING),self._setUserType(fulljid,userType),self._notifyMultimediacacheChanged(),self.conn.jingle.setICEServers(self.iceServers),self._requireLocalStream().done(function(localStream){var session=self.conn.jingle.initiate(fulljid,localStream);session.on("change:connectionState",self._onVideoSessionStateChanged),self._addAutoHangup(session.sid,fulljid)}).fail(function(error){self._log("Failed to get access to local media.",error,"ERROR"),jsxc.gui.feedback("Impossible d'accéder à votre webcam, veuillez autoriser l'accès et réessayer."+(error?"Message: "+error:""))})},_removeAutoHangup:function(sessionid){var self=jsxc.mmstream;clearTimeout(self.autoHangupCalls[sessionid]),delete self.autoHangupCalls[sessionid],self._log("Clear auto hangup",sessionid)},_addAutoHangup:function(sessionid,fulljid){var self=jsxc.mmstream;if(Object.keys(self.autoHangupCalls).indexOf(sessionid)>-1)return void self._log("Call already exist",sessionid,"ERROR");var timeout=setTimeout(function(){self.hangupCall(fulljid),jsxc.gui.feedback("Pas de réponse de "+Strophe.getNodeFromJid(fulljid)+" au bout de "+self.HANGUP_IF_NO_RESPONSE/1e3+" s., l'appel est abandonné.")},self.HANGUP_IF_NO_RESPONSE);self.autoHangupCalls[sessionid]=timeout},_onVideoSessionStateChanged:function(session,state){var self=jsxc.mmstream;self._log("[JINGLE] _onVideoSessionStateChanged",{state:state,session:session});var fulljid=session.peerID;self.multimediacache.users[fulljid]||self._createUserEntry(fulljid),self.multimediacache.users[fulljid].jingleState=state;var status;"interrupted"===state?(jsxc.gui.feedback("Problème de connexion avec "+Strophe.getNodeFromJid(fulljid)),status=self.USER_STATUS.CONNEXION_DISTURBED):"connecting"===state?self._removeAutoHangup(session.sid):"connected"===state?(self._removeAutoHangup(session.sid),status=self.USER_STATUS.CONNECTED):"disconnected"===state&&(status=self.USER_STATUS.DISCONNECTED,self._removeAutoHangup(session.sid),self.getCurrentVideoSessions().length<1&&(self.stopLocalStream(),self.multimediacache.occupied=!1)),status&&(self._setUserStatus(fulljid,status),self._notifyMultimediacacheChanged([{fulljid:fulljid,status:status}]))},_isClientOccupied:function(fulljid,isInitiator){var message,self=jsxc.mmstream,node=fulljid?Strophe.getNodeFromJid(fulljid):"";return message=isInitiator===!0?"Vous ne pouvez pas effectuer cette action avant d'avoir terminé tous vos appels multimédia":"<b>"+node+"</b> a éssayé de vous contacter mais vous êtes occupé.",self.multimediacache.occupied!==!1?(jsxc.gui.feedback(message),!0):(self.multimediacache.occupied=!0,jsxc.mmstream.debug&&self._log("Occupied: "+self.multimediacache.occupied,{fulljid:fulljid}),!1)},_onConnectionStateChanged:function(session,state){var self=jsxc.mmstream;self._log("[JINGLE] _onConnectionStateChanged",{state:state,session:session,arguments:arguments})},_hangUpAll:function(){var self=this;self.debug===!0&&self._log("Hangup all calls"),$.each(self.multimediacache.users,function(fulljid){self.hangupCall(fulljid)})},hangupCall:function(fulljid){jsxc.stats.addEvent("jsxc.mmstream.videocall.hangupcall");var self=jsxc.mmstream;if(null===Strophe.getResourceFromJid(fulljid))throw new Error("JID must be full jid");self.debug===!0&&self._log("Hang up call: "+fulljid),self.conn.jingle.terminate(fulljid,"gone")},_stopStream:function(stream){var self=jsxc.mmstream;self._log("Stop stream",stream),$.each(stream.getTracks(),function(index,track){track.stop()})},stopLocalStream:function(){var self=jsxc.mmstream;jsxc.mmstream.debug===!0&&self._log("Stop local stream",[self.multimediacache.localStream,self.conn.jingle.localStream]),self.multimediacache.localStream&&(self._stopStream(self.multimediacache.localStream),self.multimediacache.localStream=null),self.conn.jingle.localStream&&(self._stopStream(self.conn.jingle.localStream),self.conn.jingle.localStream=null);var localVideo=$("#jsxc-media-panel #jsxc-local-video").get(0);localVideo&&localVideo.pause()},attachMediaStream:function(video,stream){var self=jsxc.mmstream,attach=function(){jsxc.debug("Attach media stream to video element",{element:video,stream:stream}),self.conn.jingle.RTC.attachMediaStream(video.get(0),stream);try{video.get(0).play()}catch(e){jsxc.error("Error while attaching video",{error:e})}jsxc.debug("Stream attached to element",{video:video,stream:stream})};if(video.is(":visible"))attach();else var interv=setInterval(function(){video.is(":visible")&&(clearInterval(interv),attach())},800)},getCapableRes:function(jid,features){var self=jsxc.mmstream,bid=jsxc.jidToBid(jid),res=Object.keys(jsxc.storage.getUserItem("res",bid)||{})||[];if(!features)return res;"string"==typeof features&&(features=[features]);var available=[];return $.each(res,function(i,r){self.conn.caps.hasFeatureByJid(bid+"/"+r,features)&&available.push(r)}),available},_videoCallsDisabled:!1,disableVideoCalls:function(){jsxc.mmstream._videoCallsDisabled=!0},enableVideoCalls:function(){jsxc.mmstream._videoCallsDisabled=!1},isVideoCallsDisabled:function(){return jsxc.mmstream._videoCallsDisabled},updateTurnCredentials:function(url){var peerConfig=jsxc.options.get("RTCPeerConfig");if(url=url||peerConfig.url,"string"!=typeof url)throw new Error("Invalid URL for retrieve turn credentials");var req=$.ajax(url,{async:!0,dataType:"json",success:function(data){peerConfig.iceServers=data,jsxc.options.set("RTCPeerConfig",peerConfig)},error:function(){jsxc.error("Unable to find TURN credentials",{arguments:arguments})}});return req},_registerListenersOnAttached:function(){var self=jsxc.mmstream;$(document).on("init.window.jsxc",self.gui._initChatWindow)},_onDisconnected:function(){var self=jsxc.mmstream;self.conn.deleteHandler(self.messageHandler),self.stopLocalStream(),self._clearMultimediacache()}},$(function(){var self=jsxc.mmstream;$(document).on("attached.jsxc",self.init),$(document).on("disconnected.jsxc",self._onDisconnected),$(document).on("removed.gui.jsxc",self.gui.removeGui)}),jsxc.mmstream.gui={mediapanel:null,_log:function(message,data,level){jsxc.debug("[MMSTREAM GUI] "+message,data,level)},_initGui:function(){var self=jsxc.mmstream.gui,mmstream=jsxc.mmstream;$(document).on("multimediacache-changed.jsxc",self._multimediacacheChanged),self.mediapanel=$("#jsxc-mediapanel"),self.mediapanel.find(".jsxc_mmstreamTerminateAll").click(function(){mmstream._hangUpAll(),setTimeout(function(){mmstream._clearMultimediacache(),jsxc.gui.feedback("Appels terminés, système réinitialisé")},800)})},_multimediacacheChanged:function(event,data){var self=jsxc.mmstream.gui,mmstream=jsxc.mmstream;jsxc.mmstream.debug===!0&&self._log("On multimedia cache changed",{event:event,data:data}),self._updateVideoconferenceIndicator(),data&&data.users&&$.each(data.users,function(index,element){var node=Strophe.getNodeFromJid(element.fulljid);if(element.status===mmstream.USER_STATUS.DISCONNECTED)jsxc.gui.dialog.close("incoming_call_dialog"),jsxc.gui.dialog.close("video_conference_incoming"),setTimeout(function(){jsxc.gui.feedback("Connexion interrompue avec "+node)},700);else if(element.status===mmstream.USER_STATUS.CONNECTED){var mediaress=self.getRemoteVideoContainer(element.fulljid);mediaress.find(".jsxc_connectionInProgress").animate({opacity:0},jsxc.newgui.OPACITY_ANIMATION_DURATION)}})},getRemoteVideoContainer:function(fulljid){if(null===Strophe.getResourceFromJid(fulljid))throw new Error("Invalid argument: "+fulljid);return $('video[data-fromjid="'+fulljid+'"]').parents(".jsxc-media-ressource")},_updateVideoconferenceIndicator:function(){var self=jsxc.mmstream.gui,mmstream=jsxc.mmstream,list=self.mediapanel.find(".jsxc_videoconferenceUsers");if(list.find("li").remove(),Object.keys(mmstream.multimediacache.users)<1){var it=$("<li>");return it.text("Aucune connexion en cours"),void list.append(it)}$.each(mmstream.multimediacache.users,function(fulljid,item){var it=$("<li>");it.addClass("jsxcVideoConf_"+item.status),it.addClass("jsxcVideoConf_"+item.type),it.attr("title",item.type+": "+item.status);var link;mmstream._isBuddyParticipatingToVideoconference(fulljid)===!0?(link=$("<a>").click(function(){mmstream.reinviteUserInVideoconference(fulljid)}),link.text(item.node),list.append(it.append(link))):mmstream._isBuddyScreensharingRecipient(fulljid)===!0?(link=$("<a>").click(function(){mmstream.reinviteUserInScreensharing(fulljid)}),link.text(item.node),list.append(it.append(link))):(it.text(item.node),list.append(it))})},showLocalScreenStream:function(){var mmstream=jsxc.mmstream,self=mmstream.gui,newgui=jsxc.newgui;if(mmstream.isVideoCallsDisabled()===!0)return void self._log("Calls are disabled");if(null===mmstream.multimediacache.screenStream)throw new Error("Screen stream is null");var videoCtr=$("<div>").addClass("jsxc_screenStreamContainer"),video=$("<video>").addClass("jsxc_mediaPanelLocalScreenStream");videoCtr.append(video);var hangup=$("<div>").addClass("jsxc_hangUpControl jsxc_videoControl").click(function(){mmstream._hangUpAll(),jsxc.newgui.removeMediaRessource($(this).parents(".jsxc-media-ressource"))});jsxc.newgui.addMediaRessource(videoCtr,"Votre écran",{titleControls:[hangup]}),mmstream.attachMediaStream(video,mmstream.multimediacache.screenStream),newgui.toggleMediapanel(!0)},showInstallScreenSharingExtensionDialog:function(){jsxc.gui.dialog.open(jsxc.gui.template.get("installChromeExtension"),{noClose:!0}),$("#jsxc-chrome-extension-link").click(function(){window.open(jsxc.options.get("chromeExtensionURL"))}),$("#jsxc_dialog .jsxc_closeInstallChromeExtension").click(function(){jsxc.gui.dialog.close()}),$("#jsxc_dialog .jsxc_reloadInstallChromeExtension").click(function(){location.reload()}),$("#jsxc_installationIllustration").show().attr("src",jsxc.options.root+"/img/install-chrome-extension.gif")},isLocalVideoShown:function(){var self=jsxc.mmstream.gui,local=self.mediapanel.find("#jsxc-local-video");return"undefined"!=typeof local.attr("src")&&local.attr("src")},_isVideoStreamDisplayed:function(fulljid){return jsxc.mmstream.gui.getRemoteVideoContainer(fulljid).length>0},_showVideoStream:function(stream,fulljid){if(null===Strophe.getResourceFromJid(fulljid))throw new Error("JID must be full jid");var mmstream=jsxc.mmstream,self=mmstream.gui,node=Strophe.getNodeFromJid(fulljid);if(self._isVideoStreamDisplayed(fulljid)!==!0){var videoCtr=$("<div>").addClass("jsxc_videoCallContainer"),video=$("<video>").addClass("jsxc_mediaPanelRemoteVideo");video.data("fromjid",fulljid),video.attr("data-fromjid",fulljid),videoCtr.append(video),videoCtr.append('<div class="jsxc_connectionInProgress">Connexion en cours ...</div>');var hangup=$("<div>").addClass("jsxc_hangUpControl jsxc_videoControl").click(function(){mmstream.hangupCall(fulljid),jsxc.newgui.removeMediaRessource($(this).parents(".jsxc-media-ressource"))}),fullscreen=$("<div>").addClass("jsxc_fullscreenControl jsxc_videoControl").click(function(){mmstream.gui._showVideoFullscreen(fulljid)});jsxc.newgui.addMediaRessource(videoCtr," Vidéo de "+node,{titleControls:[hangup,fullscreen]}),mmstream.attachMediaStream(video,stream)}},_hideVideoStream:function(fulljid){if(null===Strophe.getResourceFromJid(fulljid))throw new Error("JID must be full jid");$("video").each(function(){$(this).data("fromjid")===fulljid&&jsxc.newgui.removeMediaRessource($(this).parents(".jsxc-media-ressource"))})},showLocalVideo:function(){var self=jsxc.mmstream.gui,mmstream=jsxc.mmstream;return self._log("Show local stream"),mmstream.isVideoCallsDisabled()===!0?void self._log("Calls are disabled"):void mmstream._requireLocalStream().done(function(localStream){mmstream.attachMediaStream($("#jsxc-local-video"),localStream)}).fail(function(error){jsxc.gui.feedback("Erreur lors de l'accès à la caméra et au micro: "+error),jsxc.error("Error while using audio/video",error)})},_initChatWindow:function(event,win){var mmstream=jsxc.mmstream,self=jsxc.mmstream.gui;if(self._log("_initChatWindow",[event,win]),!win.hasClass("jsxc_groupchat")){var bid=win.data("bid");if(win.find(".jsxc_video").length>0)return void self._log("Video icon already exist, skip",event);if(!mmstream.conn)return void $(document).one("attached.jsxc",function(){self._initChatWindow(null,win)});var div=$("<div>").addClass("jsxc_video");div.click(function(){jsxc.api.startSimpleVideoCall(bid)}),win.find(".jsxc_tools .jsxc_settings").after(div)}},_ringOnIncoming:function(){jsxc.notification.playSound(jsxc.CONST.SOUNDS.CALL,!0,!0)},_stopRinging:function(){jsxc.notification.stopSound()},_showIncomingCallDialog:function(bid){var self=jsxc.mmstream.gui,defer=$.Deferred();bid=jsxc.jidToBid(bid);var dialog=jsxc.gui.dialog.open(jsxc.gui.template.get("incomingCall",bid),{noClose:!0,name:"incoming_call_dialog"});return self._ringOnIncoming(),dialog.find(".jsxc_accept").click(function(){self._stopRinging(),defer.resolve("ACCEPT"),jsxc.gui.dialog.close()}),dialog.find(".jsxc_reject").click(function(){self._stopRinging(),defer.reject("REJECT"),jsxc.gui.dialog.close()}),defer.promise()},_showIncomingScreensharingDialog:function(bid){if(!bid)throw new Error("Invalid argument: "+bid);var self=jsxc.mmstream.gui,defer=$.Deferred();bid=jsxc.jidToBid(bid);var dialog=jsxc.gui.dialog.open(jsxc.gui.template.get("incomingScreensharing",bid),{noClose:!0,name:"incoming_screensharing"});return self._ringOnIncoming(),dialog.find(".jsxc_accept").click(function(){self._stopRinging(),defer.resolve("ACCEPT"),jsxc.gui.dialog.close()}),dialog.find(".jsxc_reject").click(function(){self._stopRinging(),defer.reject("REJECT"),jsxc.gui.dialog.close()}),defer.promise()},_showReinviteUserConfirmationDialog:function(bid,mode){var defer=$.Deferred();if("received"!==mode&&"emit"!==mode)throw new Error("Unkown mode: "+mode);bid=jsxc.jidToBid(bid);var dialog=jsxc.gui.dialog.open(jsxc.gui.template.get("reinviteUser_"+mode,Strophe.getNodeFromJid(bid)),{noClose:!0,name:"reinvite_user"});return dialog.find(".jsxc_accept").click(function(){defer.resolve("ACCEPT"),jsxc.gui.dialog.close()}),dialog.find(".jsxc_reject").click(function(){defer.reject("REJECT"),jsxc.gui.dialog.close()}),defer.promise()},_showIncomingVideoconferenceDialog:function(bid){var self=jsxc.mmstream.gui,defer=$.Deferred(),dialog=jsxc.gui.dialog.open(jsxc.gui.template.get("incomingVideoconference",bid),{noClose:!0,name:"video_conference_incoming"});return self._ringOnIncoming(),dialog.find(".jsxc_accept").click(function(){self._stopRinging(),defer.resolve("User accepted videoconference"),jsxc.gui.dialog.close()}),dialog.find(".jsxc_reject").click(function(){self._stopRinging(),defer.reject("User rejected videoconference"),jsxc.gui.dialog.close()}),defer.promise()},_showVideoFullscreen:function(fulljid){var mmstream=jsxc.mmstream,self=mmstream.gui,newgui=jsxc.newgui;if(null===Strophe.getResourceFromJid(fulljid))throw new Error("JID must be full jid");newgui.toggleChatSidebar(!1),newgui.toggleMediapanel(!1),jsxc.gui.dialog.open(jsxc.gui.template.get("videoStreamDialog"),{noClose:!0}),$("#jsxc_dialog .jsxc_from_jid").text(fulljid),$("#jsxc_dialog .jsxc_hangUpCall").click(function(){jsxc.mmstream.hangupCall(fulljid),jsxc.gui.dialog.close()}),$("#jsxc_dialog .jsxc_closeVideoDialog").click(function(){jsxc.gui.dialog.close(),jsxc.newgui.toggleMediapanel(!0)});var video=$("#jsxc_dialog video"),stream=jsxc.mmstream.getActiveStream(fulljid);stream?mmstream.attachMediaStream(video,stream):($("#jsxc_dialog h3").text("Vidéo indisponible"),self._log("Stream is null",{fulljid:fulljid,stream:stream},"ERROR"))}},jsxc.gui={emotions:[["O:-) O:)","innocent"],[">:-( >:( &gt;:-( &gt;:(","angry"],[":-) :)","slight_smile"],[":-D :D","grin"],[":-( :(","disappointed"],[";-) ;)","wink"],[":-P :P","stuck_out_tongue"],["=-O","astonished"],[":kiss: :-*","kissing_heart"],["8-) :cool:","sunglasses"],[":-X :X","zipper_mouth"],[":yes:","thumbsup"],[":no:","thumbsdown"],[":beer:","beer"],[":coffee:","coffee"],[":devil:","smiling_imp"],[":kiss: :kissing:","kissing"],["@->-- @-&gt;--","rose"],[":music:","musical_note"],[":love:","heart_eyes"],[":heart:","heart"],[":brokenheart:","broken_heart"],[":zzz:","zzz"],[":wait:","hand_splayed"]],favicon:null,regShortNames:null,emoticonList:{core:{":klaus:":["klaus"],":jabber:":["jabber"],":xmpp:":["xmpp"],":jsxc:":["jsxc"],":owncloud:":["owncloud"]},emojione:emojione.emojioneList},queryActions:{message:function(jid,params){var win=jsxc.gui.window.open(jsxc.jidToBid(jid));params&&"string"==typeof params.body&&win.find(".jsxc_textinput").val(params.body)},remove:function(jid){jsxc.gui.showRemoveDialog(jsxc.jidToBid(jid))},subscribe:function(jid,params){jsxc.gui.showContactDialog(jid),params&&$("#jsxc_alias").val(params.name)},vcard:function(jid){jsxc.gui.showVcard(jid)},join:function(jid,params){var password=params&&params.password?params.password:null;jsxc.muc.showJoinChat(jid,password)}},init:function(){if(!($("#jsxc-root").length>0)){jsxc.gui.windowTemplate=$(jsxc.gui.template.get("chatWindow")),jsxc.gui.buddyTemplate=$(jsxc.gui.template.get("rosterBuddy")),jsxc.debug("Adding GUI and roster init");var skeleton=$("<div id='jsxc-root'></div>");skeleton.append($(jsxc.gui.template.get("newgui_chatsidebar"))),skeleton.append($(jsxc.gui.template.get("newgui_mediapanel"))),$(jsxc.options.rosterAppend+":first").append(skeleton),$(jsxc.options.rosterAppend+":first").append($(jsxc.gui.template.get("windowList"))),jsxc.newgui.init(),jsxc.gui.interactions.init(),jsxc.gui.roster.init(),jsxc.gui.tooltip("#jsxc-root"),jsxc.gui.tooltip("#jsxc_windowList"),jsxc.gui.regShortNames=new RegExp(emojione.regShortNames.source+"|("+Object.keys(jsxc.gui.emoticonList.core).join("|")+")","gi"),$(window).resize(jsxc.gui.updateWindowListSB),$("#jsxc_windowList").resize(jsxc.gui.updateWindowListSB),$("#jsxc_windowListSB .jsxc_scrollLeft").click(function(){jsxc.gui.scrollWindowListBy(-200)}),$("#jsxc_windowListSB .jsxc_scrollRight").click(function(){jsxc.gui.scrollWindowListBy(200)}),$("#jsxc_windowListSB .jsxc_closeAllWindows").click(function(){jsxc.gui.closeAllChatWindows()}),$("#jsxc_windowList").on("wheel",function(ev){$("#jsxc_windowList").data("isOver")&&jsxc.gui.scrollWindowListBy(ev.originalEvent.wheelDelta>0?200:-200)});var fo=jsxc.options.get("favicon");fo&&fo.enable&&(jsxc.gui.favicon=new Favico({animation:"pop",bgColor:fo.bgColor,textColor:fo.textColor}),jsxc.gui.favicon.badge(jsxc.storage.getUserItem("unreadMsg")||0)),$.each(jsxc.gui.emotions,function(i,val){var reg=val[0].replace(/(\/|\||\*|\.|\+|\?|\^|\$|\(|\)|\[|\]|\{|\})/g,"\\$1");reg="("+reg.split(" ").join("|")+")",jsxc.gui.emotions[i][2]=new RegExp(reg,"g")});var updatePresenceInformations=function(event,pres){jsxc.gui.updatePresence("own",pres)};$(document).on("ownpresence.jsxc",updatePresenceInformations),$(document).on("disconnected.jsxc",function(){$(document).off("ownpresence.jsxc",updatePresenceInformations)}),$(document).on("disconnected.jsxc",function(){jsxc.gui.closeAllChatWindows()})}},closeAllChatWindows:function(){var defer=$.Deferred(),wins=$("#jsxc_windowList .jsxc_windowItem"),toClose=wins.length,closed=0;return wins.length<1?defer.resolve():($("#jsxc_windowList .jsxc_windowItem").each(function(){jsxc.gui.window.close($(this).data("bid"),function(){closed++,closed>=toClose&&defer.resolve()})}),$("#jsxc_windowList ul").css("right","0px")),defer.promise()},tooltip:function(selector){$(selector).tooltip({tooltipClass:"jsxc-custom-tooltip",show:{delay:1e3},content:function(){return $(this).attr("title").replace(/\n/g,"<br />")}})},update:function(bid){var data=jsxc.storage.getUserItem("buddy",bid);if(!data)return void jsxc.debug("No data for "+bid);var ri=jsxc.gui.roster.getItem(bid),we=jsxc.gui.window.get(bid),ue=ri.add(we),spot=$('.jsxc_spot[data-bid="'+bid+'"]');ri.data(data),jsxc.gui.updatePresence(bid,jsxc.CONST.STATUS[data.status]);var max=21,dspName="";switch(data.name&&(dspName=data.name.length>max?data.name.substring(0,max-3)+"...":data.name),ue.find(".jsxc_name:first").add(spot).text(dspName).attr("title",jsxc.t("is_",{status:jsxc.t(jsxc.CONST.STATUS[data.status])})),data.msgstate){case 0:we.find(".jsxc_transfer").removeClass("jsxc_enc jsxc_fin").attr("title",jsxc.t("your_connection_is_unencrypted")),we.find(".jsxc_settings .jsxc_verification").addClass("jsxc_disabled"),we.find(".jsxc_settings .jsxc_transfer").text(jsxc.t("start_private"));break;case 1:we.find(".jsxc_transfer").addClass("jsxc_enc").attr("title",jsxc.t("your_connection_is_encrypted")),we.find(".jsxc_settings .jsxc_verification").removeClass("jsxc_disabled"),we.find(".jsxc_settings .jsxc_transfer").text(jsxc.t("close_private"));break;case 2:we.find(".jsxc_settings .jsxc_verification").addClass("jsxc_disabled"),we.find(".jsxc_transfer").removeClass("jsxc_enc").addClass("jsxc_fin").attr("title",jsxc.t("your_buddy_closed_the_private_connection")),we.find(".jsxc_settings .jsxc_transfer").text(jsxc.t("close_private"))}data.trust?we.find(".jsxc_transfer").addClass("jsxc_trust").attr("title",jsxc.t("your_buddy_is_verificated")):we.find(".jsxc_transfer").removeClass("jsxc_trust"),data.sub&&"both"!==data.sub?ue.addClass("jsxc_oneway"):ue.removeClass("jsxc_oneway");var info=jsxc.jidToBid(data.jid)+"\n";info+=jsxc.t("Subscription")+": "+jsxc.t(data.sub)+"\n",info+=jsxc.t("Status")+": "+jsxc.t(jsxc.CONST.STATUS[data.status]),ri.find(".jsxc_name").attr("title",info),jsxc.gui.updateAvatar(ri.add(we.find(".jsxc_bar")),data.jid,data.avatar)},updateAvatar:function(el,jid,aid){var setAvatar=function(src){return 0===src||"0"===src?"function"==typeof jsxc.options.defaultAvatar?void jsxc.options.defaultAvatar.call(el,jid):void jsxc.gui.avatarPlaceholder(el.find(".jsxc_avatar"),jid):(el.find(".jsxc_avatar").removeAttr("style"),void el.find(".jsxc_avatar").css({"background-image":"url("+src+")","text-indent":"999px"}))};if("undefined"==typeof aid)return void setAvatar(0);var avatarSrc=jsxc.storage.getUserItem("avatar",aid);if(null!==avatarSrc)setAvatar(avatarSrc);else{var handler_cb=function(stanza){jsxc.debug("vCard",stanza);var src,vCard=$(stanza).find("vCard > PHOTO");if(0===vCard.length)jsxc.debug("No photo provided"),src="0";else if(vCard.find("EXTVAL").length>0)src=vCard.find("EXTVAL").text();else{var img=vCard.find("BINVAL").text(),type=vCard.find("TYPE").text();src="data:"+type+";base64,"+img}src=src.replace(/[\t\r\n\f]/gi,""),jsxc.storage.setUserItem("avatar",aid,src),setAvatar(src)},error_cb=function(msg){jsxc.warn("Could not load vcard.",msg),jsxc.storage.setUserItem("avatar",aid,0),setAvatar(0)};jsxc.jidToBid(jid)===jsxc.jidToBid(jsxc.xmpp.conn.jid)?jsxc.xmpp.conn.vcard.get(handler_cb,error_cb):jsxc.xmpp.conn.vcard.get(handler_cb,jsxc.jidToBid(jid),error_cb)}},updateWindowListSB:function(){var newgui=jsxc.newgui,wins=$("#jsxc_windowList .jsxc_window"),sb=$("#jsxc_windowListSB");wins.length>1?"block"!==sb.css("display")&&sb.css({opacity:0,display:"block"}).animate({opacity:1},newgui.OPACITY_ANIMATION_DURATION):"block"===sb.css("display")&&sb.animate({opacity:0},newgui.OPACITY_ANIMATION_DURATION,function(){sb.css({display:"none"})})},scrollWindowListBy:function(offset){var scrollWidth=$("#jsxc_windowList>ul").width(),width=$("#jsxc_windowList").width(),el=$("#jsxc_windowList>ul"),right=parseInt(el.css("right"))-offset,padding=$("#jsxc_windowListSB").width();width>scrollWidth||(right>0&&(right=0),width-scrollWidth-padding>right&&(right=width-scrollWidth-padding),el.css("right",right+"px"))},getWindow:function(bid){return jsxc.warn("jsxc.gui.getWindow is deprecated!"),jsxc.gui.window.get(bid)},toggleList:function(el){var self=el||$(this);self.disableSelection(),self.addClass("jsxc_list");var ul=self.find("ul"),slideUp=null;slideUp=function(){self.removeClass("jsxc_opened"),
$("body").off("click",null,slideUp)},$(this).click(function(){return self.hasClass("jsxc_opened")?$("body").off("click",null,slideUp):($("body").click(),$("body").one("click",slideUp)),window.clearTimeout(ul.data("timer")),self.toggleClass("jsxc_opened"),!1}).mouseleave(function(){ul.data("timer",window.setTimeout(slideUp,2e3))}).mouseenter(function(){window.clearTimeout(ul.data("timer"))})},showLoginBox:function(){function onAuthFail(){alert.show(),jsxc.gui.dialog.resize(),$("#jsxc_dialog").find("button").trigger("btnfinished.jsxc"),$("#jsxc_dialog").find("input").one("keypress",function(){alert.hide(),jsxc.gui.dialog.resize()})}$(document).on("complete.dialog.jsxc",function(){$("#jsxc_password").focus()}),jsxc.gui.dialog.open(jsxc.gui.template.get("loginBox"));var alert=$("#jsxc_dialog").find(".jsxc_alert");alert.hide(),$("#jsxc_dialog").find("form").submit(function(ev){ev.preventDefault(),$(this).find("button[data-jsxc-loading-text]").trigger("btnloading.jsxc"),jsxc.options.loginForm.form=$(this),jsxc.options.loginForm.jid=$(this).find("#jsxc_username"),jsxc.options.loginForm.pass=$(this).find("#jsxc_password"),jsxc.triggeredFromBox=!0,jsxc.options.loginForm.triggered=!1,jsxc.prepareLogin(function(settings){settings===!1?onAuthFail():($(document).on("authfail.jsxc",onAuthFail),jsxc.xmpp.login())})})},showFingerprints:function(bid){jsxc.gui.dialog.open(jsxc.gui.template.get("fingerprintsDialog",bid))},showVerification:function(bid){return $("#jsxc_dialog").length>0?void setTimeout(function(){jsxc.gui.showVerification(bid)},3e3):jsxc.storage.getUserItem("buddy",bid).msgstate!==OTR.CONST.MSGSTATE_ENCRYPTED?void jsxc.warn("Connection not encrypted"):(jsxc.gui.dialog.open(jsxc.gui.template.get("authenticationDialog",bid),{name:"smp"}),$("#jsxc_dialog > div:gt(0)").hide(),$("#jsxc_dialog > div:eq(0) button").click(function(){$(this).siblings().removeClass("active"),$(this).addClass("active"),$(this).get(0).blur(),$("#jsxc_dialog > div:gt(0)").hide(),$("#jsxc_dialog > div:eq("+($(this).index()+1)+")").show().find("input:first").focus()}),$("#jsxc_dialog > div:eq(1) .jsxc_submit").click(function(){jsxc.master&&(jsxc.otr.objects[bid].trust=!0),jsxc.storage.updateUserItem("buddy",bid,"trust",!0),jsxc.gui.dialog.close("smp"),jsxc.storage.updateUserItem("buddy",bid,"trust",!0),jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.SYS,msg:jsxc.t("conversation_is_now_verified")}),jsxc.gui.update(bid)}),$("#jsxc_dialog > div:eq(2) .jsxc_submit").click(function(){var div=$("#jsxc_dialog > div:eq(2)"),sec=div.find("#jsxc_secret2").val(),quest=div.find("#jsxc_quest").val();return""===sec||""===quest?void div.find('input[value=""]').addClass("jsxc_invalid").keyup(function(){$(this).val().match(/.*/)&&$(this).removeClass("jsxc_invalid")}):(jsxc.master?jsxc.otr.sendSmpReq(bid,sec,quest):jsxc.storage.setUserItem("smp",bid,{sec:sec,quest:quest}),jsxc.gui.dialog.close("smp"),void jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.SYS,msg:jsxc.t("authentication_query_sent")}))}),void $("#jsxc_dialog > div:eq(3) .jsxc_submit").click(function(){var div=$("#jsxc_dialog > div:eq(3)"),sec=div.find("#jsxc_secret").val();return""===sec?void div.find("#jsxc_secret").addClass("jsxc_invalid").keyup(function(){$(this).val().match(/.*/)&&$(this).removeClass("jsxc_invalid")}):(jsxc.master?jsxc.otr.sendSmpReq(bid,sec):jsxc.storage.setUserItem("smp",bid,{sec:sec,quest:null}),jsxc.gui.dialog.close("smp"),void jsxc.gui.window.postMessage({bid:bid,direction:"sys",msg:jsxc.t("authentication_query_sent")}))}))},showApproveDialog:function(from){jsxc.gui.dialog.open(jsxc.gui.template.get("approveDialog"),{noClose:!0}),$("#jsxc_dialog .jsxc_their_jid").text(Strophe.getNodeFromJid(from)),$("#jsxc_dialog .jsxc_deny").click(function(ev){ev.stopPropagation(),jsxc.xmpp.resFriendReq(from,!1),jsxc.gui.dialog.close()}),$("#jsxc_dialog .jsxc_approve").click(function(ev){ev.stopPropagation();var data=jsxc.storage.getUserItem("buddy",jsxc.jidToBid(from));jsxc.xmpp.resFriendReq(from,!0),data&&"both"===data.sub||jsxc.gui.showContactDialog(from)})},showJoinConversationDialog:function(roomjid,buddyName){jsxc.gui.dialog.open(jsxc.gui.template.get("joinConversationDialog"),{noClose:!0}),$("#jsxc_dialog .jsxc_buddyName").text(Strophe.getNodeFromJid(buddyName)),$("#jsxc_dialog .jsxc_deny").click(function(ev){ev.stopPropagation(),jsxc.gui.feedback("Invitation refusée"),jsxc.gui.dialog.close()}),$("#jsxc_dialog .jsxc_approve").click(function(ev){ev.stopPropagation(),jsxc.gui.dialog.close(),jsxc.gui.window.clear(roomjid),jsxc.storage.setUserItem("member",roomjid,{}),jsxc.muc.join(roomjid,jsxc.xmpp.getCurrentNode(),null,null,null,!0,!0),jsxc.gui.window.open(roomjid)})},showContactDialog:function(username){jsxc.gui.dialog.open(jsxc.gui.template.get("contactDialog")),username&&$("#jsxc_username").val(username),$("#jsxc_username").keyup(function(){if("function"==typeof jsxc.options.getUsers){var val=$(this).val();$("#jsxc_userlist").empty(),""!==val&&jsxc.options.getUsers.call(this,val,function(list){$.each(list||{},function(uid,displayname){var option=$("<option>");option.attr("data-username",uid),option.attr("data-alias",displayname),option.attr("value",uid).appendTo("#jsxc_userlist"),uid!==displayname&&option.clone().attr("value",displayname).appendTo("#jsxc_userlist")})})}}),$("#jsxc_username").on("input",function(){var val=$(this).val(),option=$("#jsxc_userlist").find('option[data-username="'+val+'"], option[data-alias="'+val+'"]');option.length>0&&($("#jsxc_username").val(option.attr("data-username")),$("#jsxc_alias").val(option.attr("data-alias")))}),$("#jsxc_dialog form").submit(function(ev){ev.preventDefault();var username=$("#jsxc_username").val(),alias=$("#jsxc_alias").val();return username.match(/@(.*)$/)||(username+="@"+Strophe.getDomainFromJid(jsxc.storage.getItem("jid"))),username&&username.match(jsxc.CONST.REGEX.JID)?(jsxc.xmpp.addBuddy(username,alias),jsxc.gui.dialog.close(),!1):($("#jsxc_username").addClass("jsxc_invalid").keyup(function(){$(this).val().match(jsxc.CONST.REGEX.JID)&&$(this).removeClass("jsxc_invalid")}),!1)})},showRemoveDialog:function(bid){jsxc.gui.dialog.open(jsxc.gui.template.get("removeDialog",bid));var data=jsxc.storage.getUserItem("buddy",bid);$("#jsxc_dialog .jsxc_remove").click(function(ev){ev.stopPropagation(),jsxc.master?jsxc.xmpp.removeBuddy(data.jid):jsxc.storage.setUserItem("deletebuddy",bid,{jid:data.jid}),jsxc.gui.dialog.close()})},showRemoveManyDialog:function(bidArray){jsxc.gui.dialog.open(jsxc.gui.template.get("removeManyDialog"),{noClose:!0});var templateList=$("#jsxc_dialog .jsxc_elementsToRemove");$.each(bidArray,function(index,element){templateList.append($("<li>").text(element))}),$("#jsxc_dialog .jsxc_remove").click(function(ev){ev.stopPropagation(),$.each(bidArray,function(index,element){jsxc.xmpp.removeBuddy(element);var data=jsxc.storage.getUserItem("buddy",element),type=data?data.type:null;"groupchat"===type&&jsxc.xmpp.bookmarks["delete"](element,!1)}),jsxc.gui.dialog.close(),jsxc.gui.feedback(bidArray.length+" éléments ont été supprimés")}),$("#jsxc_dialog .jsxc_cancel").click(function(){jsxc.gui.dialog.close(),jsxc.gui.feedback("Opération annulée")})},feedback:function(message,type,timeout){var defaultType="info",bgColors={info:"#1a1a1a",warn:"#520400"},icons={info:"info",warn:"warning"};$.toast({text:message,icon:icons[type||defaultType],showHideTransition:"slide",allowToastClose:!0,hideAfter:timeout||3e3,stack:3,position:"top-center",textAlign:"left",loader:!1,bgColor:bgColors[type||defaultType]})},showEtherpadCreationDialog:function(selectedJids){var defer=$.Deferred();jsxc.gui.dialog.open(jsxc.gui.template.get("etherpadCreation"),{noClose:!0});var buddyList=jsxc.gui.widgets.createBuddyList("#jsxc_dialog #jsxc-etherpad-dialog-buddylist",selectedJids);return $("#jsxc_dialog .jsxc_confirm").click(function(ev){ev.stopPropagation();var name=$("#jsxc_dialog .jsxc-etherpad-name").val(),jids=[],selectedItems=$("#jsxc_dialog #jsxc-etherpad-dialog-buddylist .jsxc-checked");$.each(selectedItems,function(index,item){jids.push($(item).data("bid"))}),jsxc.gui.dialog.close(),defer.resolve({name:name,buddies:jids})}),$("#jsxc_dialog .jsxc_cancel").click(function(ev){ev.stopPropagation(),jsxc.gui.dialog.close(),defer.reject("user canceled")}),$("#jsxc_dialog .jsxc_refresh").click(function(ev){ev.stopPropagation(),jsxc.gui.feedback("Mise à jour en cours ..."),buddyList.updateBuddyList()}),defer.promise()},showSelectContactsDialog:function(){var defer=$.Deferred();jsxc.gui.dialog.open(jsxc.gui.template.get("selectContacts"),{noClose:!0});var buddyList=jsxc.gui.widgets.createBuddyList("#jsxc_dialog #jsxc-invite-dialog-buddylist");return $("#jsxc_dialog .jsxc_confirm").click(function(ev){ev.stopPropagation();var jids=[],selectedItems=$("#jsxc_dialog #jsxc-invite-dialog-buddylist .jsxc-checked");$.each(selectedItems,function(index,item){jids.push($(item).data("bid"))}),jsxc.gui.dialog.close(),defer.resolve(jids)}),$("#jsxc_dialog .jsxc_cancel").click(function(ev){ev.stopPropagation(),jsxc.gui.dialog.close(),defer.reject("user canceled")}),$("#jsxc_dialog .jsxc_refresh").click(function(ev){ev.stopPropagation(),jsxc.gui.feedback("Mise à jour en cours ..."),buddyList.updateBuddyList()}),defer.promise()},showIncomingEtherpadDialog:function(from,padId,invitationId){var defer=$.Deferred();return jsxc.gui.dialog.open(jsxc.gui.template.get("incomingEtherpad",Strophe.getNodeFromJid(from))),$("#jsxc_dialog .jsxc_confirm").click(function(ev){ev.stopPropagation(),jsxc.gui.dialog.close(),jsxc.gui.feedback("Le document va être ouvert"),jsxc.etherpad.openpad(padId),defer.resolve("accepted")}),$("#jsxc_dialog .jsxc_cancel").click(function(ev){ev.stopPropagation(),jsxc.gui.dialog.close(),jsxc.etherpad._sendEtherpadRefusedMessage(from,padId,invitationId),jsxc.gui.feedback("Le document a été refusé")}),defer.promise()},showConversationSelectionDialog:function(){var defer=$.Deferred();jsxc.gui.dialog.open(jsxc.gui.template.get("selectConversations"));var conversList=jsxc.gui.widgets.createConversationList("#jsxc_dialogConversationList");return $("#jsxc_dialog .jsxc_confirm").click(function(ev){ev.stopPropagation();var selItems=$("#jsxc_dialogConversationList .jsxc-checked"),res=[];$.each(selItems,function(index,element){res.push($(element).data("conversjid"))}),jsxc.gui.dialog.close(),defer.resolve(res)}),$("#jsxc_dialog .jsxc_cancel").click(function(ev){ev.stopPropagation(),defer.reject("user canceled")}),$("#jsxc_dialog .jsxc_refresh").click(function(ev){ev.stopPropagation(),jsxc.gui.feedback("Mise à jour en cours ..."),conversList.updateConversationList()}),defer.promise()},showWaitAlert:function(msg){jsxc.gui.dialog.open(jsxc.gui.template.get("waitAlert",null,msg),{noClose:!0})},showAlert:function(msg){jsxc.gui.dialog.open(jsxc.gui.template.get("alert",null,msg))},showAuthFail:function(){jsxc.gui.dialog.open(jsxc.gui.template.get("authFailDialog")),jsxc.options.loginForm.triggered!==!1&&$("#jsxc_dialog .jsxc_cancel").hide(),$("#jsxc_dialog .jsxc_retry").click(function(){jsxc.gui.dialog.close()}),$("#jsxc_dialog .jsxc_cancel").click(function(){jsxc.submitLoginForm()})},showConfirmDialog:function(msg,confirm,dismiss){jsxc.gui.dialog.open(jsxc.gui.template.get("confirmDialog",null,msg),{noClose:!0}),confirm&&$("#jsxc_dialog .jsxc_confirm").click(confirm),dismiss&&$("#jsxc_dialog .jsxc_dismiss").click(dismiss)},showAboutDialog:function(){jsxc.gui.dialog.open(jsxc.gui.template.get("aboutDialog")),$("#jsxc_dialog .jsxc_debuglog").click(function(){jsxc.gui.showDebugLog()}),$("#jsxc_dialog .jsxc_spaceInvasion").click(function(){jsxc.api.spaceInvasion()})},showDebugLog:function(){var userInfo="<h3>User information</h3>";if(navigator){var key;for(key in navigator)"string"==typeof navigator[key]&&(userInfo+="<b>"+key+":</b> "+navigator[key]+"<br />")}$.fn&&$.fn.jquery&&(userInfo+="<b>jQuery:</b> "+$.fn.jquery+"<br />"),window.screen&&(userInfo+="<b>Height:</b> "+window.screen.height+"<br />",userInfo+="<b>Width:</b> "+window.screen.width+"<br />"),userInfo+="<b>jsxc version:</b> "+jsxc.version+"<br />",jsxc.gui.dialog.open('<div class="jsxc_log">'+userInfo+"<h3>Log</h3><pre>"+jsxc.escapeHTML(jsxc.log)+"</pre></div>")},showVcard:function(jid){var bid=jsxc.jidToBid(jid);jsxc.gui.dialog.open(jsxc.gui.template.get("vCard",bid));var data=jsxc.storage.getUserItem("buddy",bid);if(data){var i,j,res,identities,cap,client,identity=null;for(i=0;i<data.res.length;i++){for(res=data.res[i],identities=[],cap=jsxc.xmpp.getCapabilitiesByJid(bid+"/"+res),null!==cap&&null!==cap.identities&&(identities=cap.identities),client="",j=0;j<identities.length;j++)identity=identities[j],"client"===identity.category&&(""!==client&&(client+=",\n"),client+=identity.name+" ("+identity.type+")");var status=jsxc.storage.getUserItem("res",bid)[res];$("#jsxc_dialog ul.jsxc_vCard").append('<li class="jsxc_sep"><strong>'+jsxc.t("Resource")+":</strong> "+res+"</li>"),$("#jsxc_dialog ul.jsxc_vCard").append("<li><strong>"+jsxc.t("Client")+":</strong> "+client+"</li>"),$("#jsxc_dialog ul.jsxc_vCard").append("<li><strong>"+jsxc.t("Status")+":</strong> "+jsxc.t(jsxc.CONST.STATUS[status])+"</li>")}}var printProp=function(el,depth){var content="";return el.each(function(){var item=$(this),children=$(this).children();content+="<li>";var prop=jsxc.t(item[0].tagName);" "!==prop&&(content+="<strong>"+prop+":</strong> "),"PHOTO"===item[0].tagName||(children.length>0?(content+="<ul>",content+=printProp(children,depth+1),content+="</ul>"):""!==item.text()&&(content+=jsxc.escapeHTML(item.text()))),content+="</li>",0===depth&&$("#jsxc_dialog ul.jsxc_vCard").length>0&&($("#jsxc_dialog ul.jsxc_vCard li.jsxc_sep:first").length>0?$("#jsxc_dialog ul.jsxc_vCard li.jsxc_sep:first").before(content):$("#jsxc_dialog ul.jsxc_vCard").append(content),content="")}),depth>0?content:void 0},failedToLoad=function(){if(0!==$("#jsxc_dialog ul.jsxc_vCard").length){$("#jsxc_dialog p").remove();var content="<p>";content+=jsxc.t("Sorry_your_buddy_doesnt_provide_any_information"),content+="</p>",$("#jsxc_dialog").append(content)}};jsxc.xmpp.loadVcard(bid,function(stanza){if(0!==$("#jsxc_dialog ul.jsxc_vCard").length){$("#jsxc_dialog p").remove();var photo=$(stanza).find("vCard > PHOTO");if(photo.length>0){var img=photo.find("BINVAL").text(),type=photo.find("TYPE").text(),src="data:"+type+";base64,"+img;photo.find("EXTVAL").length>0&&(src=photo.find("EXTVAL").text()),src=src.replace(/[\t\r\n\f]/gi,"");var img_el=$('<img class="jsxc_vCard" alt="avatar" />');img_el.attr("src",src),$("#jsxc_dialog h3").before(img_el)}return 0===$(stanza).find("vCard").length||1===$(stanza).find("vcard > *").length&&1===photo.length?void failedToLoad():void printProp($(stanza).find("vcard > *"),0)}},failedToLoad)},showSettings:function(){jsxc.gui.dialog.open(jsxc.gui.template.get("settings")),"false"!==jsxc.options.get("xmpp").overwrite&&jsxc.options.get("xmpp").overwrite!==!1||$(".jsxc_fieldsetXmpp").parent().hide(),$("#jsxc_dialog form").each(function(){var self=$(this);self.find('input[type!="submit"]').each(function(){var id=this.id.split("-"),prop=id[0],key=id[1],type=this.type,data=jsxc.options.get(prop);data&&"undefined"!=typeof data[key]&&("checkbox"===type?"false"!==data[key]&&data[key]!==!1&&(this.checked="checked"):$(this).val(data[key]))})}),$("#jsxc_dialog form").submit(function(){var self=$(this),data={};self.find('input[type!="submit"]').each(function(){var val,id=this.id.split("-"),prop=id[0],key=id[1],type=this.type;val="checkbox"===type?this.checked:$(this).val(),data[prop]||(data[prop]={}),data[prop][key]=val}),$.each(data,function(key,val){jsxc.options.set(key,val)});var cb=function(success){"string"==typeof self.attr("data-onsubmit")&&jsxc.exec(self.attr("data-onsubmit"),[success]),setTimeout(function(){success?self.find('button[type="submit"]').switchClass("btn-primary","btn-success"):self.find('button[type="submit"]').switchClass("btn-primary","btn-danger"),setTimeout(function(){self.find('button[type="submit"]').switchClass("btn-danger btn-success","btn-primary")},2e3)},200)};return jsxc.options.saveSettinsPermanent.call(this,data,cb),!1})},showRequestNotification:function(){jsxc.switchEvents({"notificationready.jsxc":function(){jsxc.gui.dialog.close(),jsxc.notification.init(),jsxc.storage.setUserItem("notification",1)},"notificationfailure.jsxc":function(){jsxc.gui.dialog.close(),jsxc.options.notification=!1,jsxc.storage.setUserItem("notification",0)}}),jsxc.gui.showConfirmDialog(jsxc.t("Should_we_notify_you_"),function(){jsxc.gui.dialog.open(jsxc.gui.template.get("pleaseAccept"),{noClose:!0}),jsxc.notification.requestPermission()},function(){$(document).trigger("notificationfailure.jsxc")})},showUnknownSender:function(bid){var confirmationText="Vous avez reçu un message d'un expéditeur inconnu: <b>"+bid+"</b><br/> Voulez vous l'afficher ?";jsxc.gui.showConfirmDialog(confirmationText,function(){jsxc.gui.dialog.close();var node=Strophe.getNodeFromJid(bid);jsxc.storage.saveBuddy(bid,{jid:bid,name:node,status:0,sub:"none",res:[]}),jsxc.gui.window.init(bid);var history=jsxc.storage.getUserItem("unknown-user-chat-history",bid);jsxc.storage.setUserItem("unknown-user-chat-history",bid,[]),$.each(history,function(index,message){jsxc.gui.window.postMessage(message)}),jsxc.gui.window.open(bid)},function(){jsxc.storage.setUserItem("unknown-user-chat-history",bid,[])})},updatePresence:function(bid,pres){"own"===bid&&("dnd"===pres?($("#jsxc_menu .jsxc_muteNotification").addClass("jsxc_disabled"),jsxc.notification.muteSound(!0)):($("#jsxc_menu .jsxc_muteNotification").removeClass("jsxc_disabled"),jsxc.options.get("muteNotification")||jsxc.notification.unmuteSound(!0))),$('[data-bid="'+bid+'"]').each(function(){var el=$(this);el.attr("data-status",pres),el.find(".jsxc_avatar").length>0&&(el=el.find(".jsxc_avatar")),el.removeClass("jsxc_"+jsxc.CONST.STATUS.join(" jsxc_")).addClass("jsxc_"+pres)})},unreadMsg:function(bid){var winData=jsxc.storage.getUserItem("window",bid)||{},count=winData&&winData.unread||0;count=count===!0?1:count+1,winData.unread=count,jsxc.storage.setUserItem("window",bid,winData);var total=jsxc.storage.getUserItem("unreadMsg")||0;total++,jsxc.storage.setUserItem("unreadMsg",total),jsxc.gui.favicon&&jsxc.gui.favicon.badge(total),jsxc.gui._unreadMsg(bid,count)},_unreadMsg:function(bid,count){var win=jsxc.gui.window.get(bid);if("number"!=typeof count){var winData=jsxc.storage.getUserItem("window",bid);count=winData&&winData.unread||1,count=count===!0?1:count}var el=jsxc.gui.roster.getItem(bid).add(win);el.addClass("jsxc_unreadMsg"),el.find(".jsxc_unread").text(count)},readMsg:function(bid){var win=jsxc.gui.window.get(bid),winData=jsxc.storage.getUserItem("window",bid),count=winData&&winData.unread||0;count=count===!0?0:count;var el=jsxc.gui.roster.getItem(bid).add(win);if(el.removeClass("jsxc_unreadMsg"),el.find(".jsxc_unread").text(0),count>0){var total=jsxc.storage.getUserItem("unreadMsg")||0;total-=count,jsxc.storage.setUserItem("unreadMsg",total),jsxc.gui.favicon&&jsxc.gui.favicon.badge(total),jsxc.storage.updateUserItem("window",bid,"unread",0)}},detectUriScheme:function(container){container=$(container?container:"body"),container.find("a[href^='xmpp:']").each(function(){var action,element=$(this),href=element.attr("href").replace(/^xmpp:/,""),jid=href.split("?")[0],params={};if(href.indexOf("?")<0)action="message";else{var pairs=href.substring(href.indexOf("?")+1).split(";");action=pairs[0];var i,key,value;for(i=1;i<pairs.length;i++)key=pairs[i].split("=")[0],value=pairs[i].indexOf("=")>0?pairs[i].substring(pairs[i].indexOf("=")+1):null,params[decodeURIComponent(key)]=decodeURIComponent(value)}"function"==typeof jsxc.gui.queryActions[action]&&(element.addClass("jsxc_uriScheme jsxc_uriScheme_"+action),element.off("click").click(function(ev){return ev.stopPropagation(),jsxc.gui.queryActions[action].call(jsxc,jid,params),!1}))})},detectEmail:function(container){container=$(container?container:"body"),container.find('a[href^="mailto:"],a[href^="xmpp:"]').each(function(){var spot=$("<span>X</span>").addClass("jsxc_spot"),href=$(this).attr("href").replace(/^ *(mailto|xmpp):/,"").trim();if(""!==href&&href!==jsxc.jidToBid(jsxc.storage.getItem("jid"))){var bid=jsxc.jidToBid(href),self=$(this),s=self.prev();s.hasClass("jsxc_spot")||(s=spot.clone().attr("data-bid",bid),self.before(s)),s.off("click"),jsxc.storage.getUserItem("buddy",bid)?(jsxc.gui.update(bid),s.click(function(){return jsxc.gui.window.open(bid),!1})):s.click(function(){return jsxc.gui.showContactDialog(href),!1})}})},avatarPlaceholder:function(el,seed,text){text=text||seed;var options=jsxc.options.get("avatarplaceholder")||{},hash=jsxc.hashStr(seed),hue=Math.abs(hash)%360,saturation=options.saturation||90,lightness=options.lightness||65;el.css({"background-color":"hsl("+hue+", "+saturation+"%, "+lightness+"%)",color:"#fff","font-weight":"bold","text-align":"center","line-height":el.height()+"px","font-size":.6*el.height()+"px"}),"string"==typeof text&&text.length>0&&el.text(text[0].toUpperCase())},shortnameToImage:function(str){return str=str.replace(jsxc.gui.regShortNames,function(shortname){if(!("undefined"!=typeof shortname&&""!==shortname&&(shortname in jsxc.gui.emoticonList.emojione||shortname in jsxc.gui.emoticonList.core)))return shortname;var src,filename;jsxc.gui.emoticonList.core[shortname]?(filename=jsxc.gui.emoticonList.core[shortname][jsxc.gui.emoticonList.core[shortname].length-1].replace(/^:([^:]+):$/,"$1"),src=jsxc.options.root+"/img/emotions/"+filename+".svg"):jsxc.gui.emoticonList.emojione[shortname]&&(filename=jsxc.gui.emoticonList.emojione[shortname][jsxc.gui.emoticonList.emojione[shortname].length-1],src=jsxc.options.root+"/lib/emojione/assets/svg/"+filename+".svg");var div=$("<div>");return div.addClass("jsxc_emoticon"),div.css("background-image","url("+src+")"),div.attr("title",shortname),div.prop("outerHTML")})}},jsxc.gui.dialog={open:function(data,o){var opt=$.extend({name:""},o);return $.magnificPopup.open({items:{src:'<div data-name="'+opt.name+'" id="jsxc_dialog">'+data+"</div>"},type:"inline",modal:opt.noClose,callbacks:{beforeClose:function(){$(document).trigger("cleanup.dialog.jsxc")},afterClose:function(){$(document).trigger("close.dialog.jsxc")},open:function(){$("#jsxc_dialog .jsxc_close").click(function(ev){ev.preventDefault(),jsxc.gui.dialog.close()}),$("#jsxc_dialog form").each(function(){var form=$(this);form.find("button[data-jsxc-loading-text]").each(function(){var btn=$(this);btn.on("btnloading.jsxc",function(){btn.prop("disabled")||(btn.prop("disabled",!0),btn.data("jsxc_value",btn.text()),btn.text(btn.attr("data-jsxc-loading-text")))}),btn.on("btnfinished.jsxc",function(){btn.prop("disabled")&&(btn.prop("disabled",!1),btn.text(btn.data("jsxc_value")))})})}),jsxc.gui.dialog.resize(),$(document).trigger("complete.dialog.jsxc")}}}),$("#jsxc_dialog")},close:function(name){jsxc.debug("close dialog"),"string"==typeof name&&name.length>0&&!jsxc.el_exists("#jsxc_dialog[data-name="+name+"]")||$.magnificPopup.close()},resize:function(){}},jsxc.Message=function(){this._uid=null,this._received=!1,this.encrypted=!1,this.forwarded=!1,this.stamp=(new Date).getTime(),"string"==typeof arguments[0]&&arguments[0].length>0&&1===arguments.length?(this._uid=arguments[0],this.load(this._uid)):"object"==typeof arguments[0]&&null!==arguments[0]&&$.extend(this,arguments[0]),this._uid||(this._uid=(new Date).getTime()+":msg")},jsxc.Message.prototype.load=function(uid){var data=jsxc.storage.getUserItem("msg",uid);data||jsxc.debug("Could not load message with uid "+uid),$.extend(this,data)},jsxc.Message.prototype.save=function(){var history;if(this.bid&&(history=jsxc.storage.getUserItem("history",this.bid)||[],history.indexOf(this._uid)<0?history.length>jsxc.options.get("numberOfMsg")&&jsxc.Message["delete"](history.pop()):history=null),Image&&this.attachment&&this.attachment.type.match(/^image\//i)&&this.attachment.data){var sHeight,sWidth,sx,sy,dHeight=100,dWidth=100,canvas=$("<canvas>").get(0);canvas.width=dWidth,canvas.height=dHeight;var ctx=canvas.getContext("2d"),img=new Image;img.src=this.attachment.data,img.height>img.width?(sHeight=img.width,sWidth=img.width,sx=0,sy=(img.height-img.width)/2):(sHeight=img.height,sWidth=img.height,sx=(img.width-img.height)/2,sy=0),ctx.drawImage(img,sx,sy,sWidth,sHeight,0,0,dWidth,dHeight),this.attachment.thumbnail=canvas.toDataURL(),"out"===this.direction&&(this.attachment.data=null)}var data;return this.attachment&&this.attachment.size>jsxc.options.maxStorableSize&&"in"===this.direction&&(jsxc.debug("Attachment to large to store"),data=this.attachment.data,this.attachment.data=null,this.attachment.persistent=!1),jsxc.storage.setUserItem("msg",this._uid,this),history&&(history.unshift(this._uid),jsxc.storage.setUserItem("history",this.bid,history)),data&&this.attachment&&(this.attachment.data=data),this},jsxc.Message.prototype["delete"]=function(){jsxc.Message["delete"](this._uid)},jsxc.Message.prototype.getDOM=function(){return jsxc.Message.getDOM(this._uid)},jsxc.Message.prototype.received=function(){this._received=!0,this.save(),this.getDOM().addClass("jsxc_received")},jsxc.Message.prototype.isReceived=function(){return this._received},jsxc.Message["delete"]=function(uid){var data=jsxc.storage.getUserItem("msg",uid);if(data&&(jsxc.storage.removeUserItem("msg",uid),data.bid)){var history=jsxc.storage.getUserItem("history",data.bid)||[];history=$.grep(history,function(el){return el!==uid}),jsxc.storage.setUserItem("history",data.bid)}},jsxc.Message.getDOM=function(uid){return $("#"+uid.replace(/:/g,"-"))},jsxc.Message.IN="in",jsxc.Message.OUT="out",jsxc.Message.SYS="sys",jsxc.api={_availableEvents:["onReconnectRequest","onBuddyAdded","onBuddyAccepted","onInit"],_callbacks:{},registerCallbacks:function(callbacks){var self=jsxc.api;$.each(callbacks,function(event,element){if(self._availableEvents.indexOf(event)<0)throw new Error("Unknown event: "+event+" / Availables: "+self._availableEvents);if("function"!=typeof element)throw new Error("Invalid callback, must be a function: "+typeof element)}),self._callbacks=callbacks},registerCustomModule:function(module){var self=jsxc.api;if("undefined"!=typeof self[module.name])throw new Error("Module already exist: "+module.name);self[module.name]=module.module},callback:function(targetEvent,targetArguments){var self=jsxc.api,called=0;if(self._availableEvents.indexOf(targetEvent)<0)throw new Error("Unknown event: "+targetEvent+" / Availables: "+self._availableEvents);if(targetArguments=targetArguments||[],targetArguments.constructor!==Array)throw new Error("Invalid arguments specified (must provide an array): "+targetArguments);return $.each(self._callbacks,function(event,callback){if(event===targetEvent)try{callback.apply(callback,targetArguments),called++}catch(e){jsxc.error("Error in jsxc.api.callback",e)}}),called},feedback:function(message,type,timeout){jsxc.gui.feedback(message,type,timeout)},openChatWindow:function(jid){jid||jsxc.gui.feedback("Utilisateur invalide: "+jid);var self=jsxc.api,bid=jsxc.jidToBid(jid),node=Strophe.getNodeFromJid(jid);node||jsxc.gui.feedback("Utilisateur invalide: "+jid),self.checkIfConnectedOrThrow();var bl=jsxc.storage.getUserItem("buddylist");bl.indexOf(jid)<0&&(jsxc.storage.setUserItem("buddy",bid,{jid:jid,name:node,status:0,sub:"none",msgstate:0,transferReq:-1,trust:!1,res:[],type:"chat"}),jsxc.gui.roster.add(bid)),jsxc.gui.window.open(bid)},createNewConversationWith:function(jidArray){var createAndInvite=!0;if(!jidArray||"undefined"==typeof jidArray.length)throw new Error("Invalid argument: "+jidArray);return jidArray.length<1?void jsxc.gui.feedback("Vous devez sélectionner au moins un interlocuteur"):($.each(jidArray,function(index,element){null===element.match(/.+@.+\..+/i)&&(jsxc.gui.feedback("Impossible de joindre: "+element),createAndInvite=!1)}),void(createAndInvite===!0&&jsxc.muc.createNewConversationWith(jidArray)))},getBuddyList:function(){return jsxc.storage.getUserItem("buddylist")||[]},isConnected:function(){return null!==jsxc.xmpp.conn},checkIfConnectedOrThrow:function(){var self=jsxc.api;if(self.isConnected()!==!0)throw self.feedback("Vous n'êtes pas connecté au client de messagerie"),new Error("Not connected to JSXC client")},spaceInvasion:function(){var self=jsxc.help,root=jsxc.options.root+"/lib/AlienInvasion/";if(jsxc.gui.dialog.close(),!self._alreadyInitalized||self._alreadyInitalized!==!0){self._alreadyInitalized=!0;var template=$("<div id='alienInvasionContainer'></div>");template.css({display:"none"}),template.append("<canvas id='alienInvasionCanvas' width='320' height='480'></canvas>"),template.append("<div><a href='https://github.com/cykod/AlienInvasion/' target='_blank' style='font-size: 0.7em'>Thanks to https://github.com/cykod/AlienInvasion/</a></div>"),template.append("<script src='"+root+"engine.js'></script><script src='"+root+"game.js'></script>"),$("body").append(template),setTimeout(function(){Game.initialize("alienInvasionCanvas",sprites,startGame,root)},1e3),template.on("dialogopen",function(){template.css({display:"block"})}),template.on("dialogclose",function(){template.css({display:"none"})})}$("#alienInvasionContainer").dialog({title:"Alien invasion !",width:353,height:600,resizable:!1})},disconnect:function(){jsxc.gui.feedback("Déconnexion en cours"),jsxc.xmpp.logout(!1)},reconnect:function(){var newgui=jsxc.newgui,called=jsxc.api.callback("onReconnectRequest");1>called&&(newgui.toggleChatSidebar(!0),newgui.isConnexionMenuShown()!==!0&&newgui.toggleConnexionMenu())},startSimpleVideoCall:function(bid){var node=Strophe.getNodeFromJid(bid),buddy=jsxc.storage.getUserItem("buddy",bid);if(!buddy)return void jsxc.gui.feedback("<b>"+node+"</b> n'est pas un utilisateur valide");if(buddy.status===jsxc.CONST.STATUS.indexOf("offline"))return void jsxc.gui.feedback("<b>"+node+"</b> n'est pas connecté");var jid=jsxc.getCurrentActiveJidForBid(bid);return null===jid?void jsxc.gui.feedback("<b>"+node+"</b> n'est pas disponible"):(jsxc.gui.feedback("Appel vidéo en cours"),void jsxc.mmstream.startSimpleVideoCall(jid))}},jsxc.etherpad={XMPP_INVITATIONS:{XMPP_ELEMENT_NAME:"etherpad",PADID_ATTR:"padid",ALL_USERS_ATTR:"allusers",INVITATIONID_ATTR:"id",STATUS_ATTR:"status",STATUS_INVITATION:"invitation",STATUS_REFUSED:"refused"},_init:function(){var self=jsxc.etherpad;self.conn=jsxc.xmpp.conn,self._messageHandler=self.conn.addHandler(jsxc.etherpad._onMessageReceived,null,"message")},isEtherpadEnabled:function(){var opts=jsxc.options.get("etherpad");return opts.enabled===!0},getEtherpadLinkFor:function(padId){if("undefined"==typeof padId)throw new Error("Invalid pad id: "+padId);var opts=jsxc.options.get("etherpad");return opts.ressource+"p/"+padId+"?showControls=true&showChat=false&showLineNumbers=true&useMonospaceFont=true"},_getEmbeddedCode:function(padId){return'<iframe class="jsxc-etherpad-frame" name="embed_readwrite" src="'+jsxc.etherpad.getEtherpadLinkFor(padId)+'" style="width: 750px; height: 85%"></iframe>'},openpad:function(padId){var self=jsxc.etherpad,newgui=jsxc.newgui;if(jsxc.stats.addEvent("jsxc.etherpad.openpad"),self.isEtherpadEnabled()===!1)return jsxc.warn("Etherpad not enabled"),void jsxc.gui.feedback("Etherpad n'est pas activé.");jsxc.debug("Openning new pad",padId);var embedded=self._getEmbeddedCode(padId),link=$('<a class="jsxc-etherpad-new-window-link">Ouvrir dans une nouvelle fenêtre...</a>');link.click(function(){window.open(self.getEtherpadLinkFor(padId),"_blank"),jsxc.newgui.removeMediaRessource($(this).parents(".jsxc-media-ressource"))}),newgui.addMediaRessource(embedded+link.toString(),"Etherpad: "+padId),newgui.toggleMediapanel(!0)},sendInvitations:function(padId,jidArray){jsxc.debug("Sending etherpad invitations",{padId:padId,jidArray:jidArray});var self=jsxc.etherpad;if(null===self.conn)throw new Error("Disconnected");if(!padId)throw new Error("Invalid argument: "+padId);if(!jidArray||!jidArray.length)throw new Error("Invalid argument: "+jidArray);var invitation={};
invitation[self.XMPP_INVITATIONS.PADID_ATTR]=padId,invitation[self.XMPP_INVITATIONS.ALL_USERS_ATTR]=jidArray.join(","),invitation[self.XMPP_INVITATIONS.STATUS_ATTR]=self.XMPP_INVITATIONS.STATUS_INVITATION,invitation[self.XMPP_INVITATIONS.INVITATIONID_ATTR]=self.conn.getUniqueId();var msg=$msg({from:self.conn.jid}).c(self.XMPP_INVITATIONS.XMPP_ELEMENT_NAME,invitation),sent=[];$.each(jidArray,function(index,jid){if(jid!==self.conn.jid){var adressedMessage=$(msg.toString()).attr("to",jid);self.conn.send(adressedMessage),sent.push(jid)}}),jsxc.stats.addEvent("jsxc.etherpad.invitationsSent")},_sendEtherpadRefusedMessage:function(to,padId,invitationId){jsxc.debug("Sending etherpad refused message",{invitationId:invitationId});var self=jsxc.etherpad;if(!to)throw new Error("Invalid argument: "+padId);if(!padId)throw new Error("Invalid argument: "+padId);if(!invitationId)throw new Error("Invalid argument: "+invitationId);var message={};message[self.XMPP_INVITATIONS.PADID_ATTR]=padId,message[self.XMPP_INVITATIONS.STATUS_ATTR]=self.XMPP_INVITATIONS.STATUS_REFUSED,message[self.XMPP_INVITATIONS.INVITATIONID_ATTR]=invitationId;var msg=$msg({from:self.conn.jid,to:to}).c(self.XMPP_INVITATIONS.XMPP_ELEMENT_NAME,message);self.conn.send(msg)},_onMessageReceived:function(stanza){var self=jsxc.etherpad;if($(stanza).attr("from")===self.conn.jid)return!0;var etherpad=$(stanza).find(self.XMPP_INVITATIONS.XMPP_ELEMENT_NAME);if(etherpad.length>0){var from=$(stanza).attr("from"),node=Strophe.getNodeFromJid(from),padId=etherpad.attr(self.XMPP_INVITATIONS.PADID_ATTR),invitationId=etherpad.attr(self.XMPP_INVITATIONS.INVITATIONID_ATTR),status=(etherpad.attr("status")||"").trim();self.XMPP_INVITATIONS.STATUS_INVITATION===status?jsxc.notice.add(node+" vous invite à partager un document Etherpad","","gui.showIncomingEtherpadDialog",[from,padId,invitationId]):self.XMPP_INVITATIONS.STATUS_REFUSED===status&&jsxc.gui.feedback("<b>"+node+"</b> a refusé le document")}return!0},_onDisconnected:function(){var self=jsxc.etherpad;self.conn.deleteHandler(self._messageHandler)}},$(function(){var self=jsxc.etherpad;$(document).on("attached.jsxc",self._init),$(document).on("disconnected.jsxc",self._onDisconnected)}),jsxc.gui.interactions={init:function(){var self=jsxc.gui.interactions;self._initSettingsMenu(),self._initHelpMenu(),self._initActionMenu(),self._initSearchMenu(),self._initStatusMenu(),self._initNotificationsMenu()},_addAttachedListener:function(callback){$(document).on("attached.jsxc",callback),$(document).on("disconnected.jsxc",function(){$(document).off("attached.jsxc",callback)})},_getCheckedSearchUsers:function(){return $(".jsxc-search-users-results .jsxc-checked")},_initStatusMenu:function(){var newgui=jsxc.newgui,loginBtn=$("#jsxc-status-bar .jsxc-login-button"),logoutBtn=$("#jsxc-status-bar .jsxc-logout-button");$(document).on("ownpresence.jsxc",function(){newgui.updateOwnPresenceIndicator()}),$(document).on("attached.jsxc",function(){newgui.updateOwnPresenceIndicator()}),$(document).on("disconnected.jsxc",function(){newgui.updateOwnPresenceIndicator(!0),newgui.hideAndShow(loginBtn,logoutBtn)}),$(document).on("connected.jsxc",function(){newgui.hideAndShow(logoutBtn,loginBtn)}),newgui.updateOwnPresenceIndicator(),logoutBtn.click(function(){jsxc.api.disconnect(),jsxc.newgui.toggleBuddyList()}),loginBtn.click(function(){jsxc.api.reconnect()}),jsxc.xmpp.conn&&newgui.hideAndShow(logoutBtn,loginBtn);var statusSelect=$("#jsxc-status-bar .jsxc-select-status");statusSelect.change(function(){jsxc.xmpp.changeOwnPresence(statusSelect.val()),jsxc.gui.feedback("Statut mis à jour")})},_initActionMenu:function(){var mmstream=jsxc.mmstream,newgui=jsxc.newgui;$("#jsxc-chat-sidebar .jsxc-action_new-conversation").click(function(){var selected=[];newgui.getCheckedBuddiesOrAskFor().then(function(results){$.each(results,function(index,element){selected.push(element)}),jsxc.api.createNewConversationWith(selected)}).fail(function(){jsxc.gui.feedback("Opération annulée")})}),$(".jsxc-action_delete-buddies").click(function(){newgui.getCheckedElementsOrAskFor().then(function(buddies){if(buddies.length<1)return void jsxc.gui.feedback("Vous devez sélectionner un élément au moins");var bidArray=[];$.each(buddies,function(index,element){bidArray.push(element)}),jsxc.gui.showRemoveManyDialog(bidArray)}).fail(function(){jsxc.gui.feedback("Opération annulée")})}),$("#jsxc-main-menu .jsxc-action_invite-in-conversation").click(function(){newgui.getCheckedBuddiesOrAskFor().then(function(buddies){if(buddies.length<1)return void jsxc.gui.feedback("Vous devez sélectionner au moins un contact");var toInvite=[];$.each(buddies,function(index,element){toInvite.push(element)}),jsxc.gui.showConversationSelectionDialog().done(function(conversations){return conversations.length<1?void jsxc.gui.feedback("Vous devez sélectionner au moins un contact"):($.each(conversations,function(index,cjid){jsxc.muc.inviteParticipants(cjid,toInvite)}),void jsxc.gui.feedback("Les utilisateurs ont été invités"))}).fail(function(){jsxc.gui.feedback("Opération annulée")})}).fail(function(){jsxc.gui.feedback("Opération annulée")})}),$("#jsxc-main-menu .jsxc-action_new-etherpad-document").click(function(){var selected=newgui.getCheckedBuddies();jsxc.gui.showEtherpadCreationDialog(selected).then(function(res){jsxc.gui.feedback("Le document va être ouvert"),jsxc.etherpad.openpad(res.name),res.buddies.length>0&&jsxc.etherpad.sendInvitations(res.name,res.buddies)}).fail(function(){jsxc.gui.feedback("Opération annulée")})}),$("#jsxc-main-menu .jsxc-action_video-call").click(function(){newgui.getCheckedBuddiesOrAskFor().then(function(buddies){if(buddies.length<1)return void jsxc.gui.feedback("Vous devez sélectionner au moins un contact");var fjidArray=[],unavailables=[];return $.each(buddies,function(index,element){var fjid=jsxc.getCurrentActiveJidForBid(element);null===fjid||jsxc.isBuddyOnline(element)===!1?unavailables.push(Strophe.getNodeFromJid(element)):fjidArray.push(jsxc.getCurrentActiveJidForBid(element))}),1===unavailables.length?void jsxc.gui.feedback("<b>"+unavailables[0]+"</b> n'est pas disponible"):unavailables.length>1?void jsxc.gui.feedback("<b>"+unavailables.join(", ")+"</b> ne sont pas disponibles"):void $.each(fjidArray,function(index,fjid){mmstream.startSimpleVideoCall(fjid)})}).fail(function(){jsxc.gui.feedback("Opération annulée")})}),$("#jsxc-main-menu .jsxc-action_videoconference").click(function(){newgui.getCheckedBuddiesOrAskFor().then(function(buddies){if(buddies.length<1)return void jsxc.gui.feedback("Vous devez sélectionner au moins un contact");if(buddies.length>mmstream.VIDEOCONFERENCE_MAX_PARTICIPANTS)return void jsxc.gui.feedback("La vidéoconférence est limitée à 6 participants");var fjidArray=[],unavailables=[];return $.each(buddies,function(index,element){var fjid=jsxc.getCurrentActiveJidForBid(element);null===fjid||jsxc.isBuddyOnline(element)===!1?unavailables.push(Strophe.getNodeFromJid(element)):fjidArray.push(jsxc.getCurrentActiveJidForBid(element))}),1===unavailables.length?void jsxc.gui.feedback("<b>"+unavailables[0]+"</b> n'est pas disponible"):unavailables.length>1?void jsxc.gui.feedback("<b>"+unavailables.join(", ")+"</b> ne sont pas disponibles"):void mmstream.startVideoconference(fjidArray)}).fail(function(){jsxc.gui.feedback("Opération annulée")})}),$("#jsxc-main-menu .jsxc-action_screensharing").click(function(){newgui.getCheckedBuddiesOrAskFor().then(function(buddies){return buddies.length<1?void jsxc.gui.feedback("Vous devez sélectionner au moins un contact"):(mmstream.checkNavigatorCompatibility("screensharing"),void mmstream.isChromeExtensionInstalled().fail(function(){mmstream.gui.showInstallScreenSharingExtensionDialog()}).then(function(){var fjidArray=[],unavailables=[];return $.each(buddies,function(index,element){var fjid=jsxc.getCurrentActiveJidForBid(element);null===fjid||jsxc.isBuddyOnline(element)===!1?unavailables.push(Strophe.getNodeFromJid(element)):fjidArray.push(jsxc.getCurrentActiveJidForBid(element))}),1===unavailables.length?void jsxc.gui.feedback("<b>"+unavailables[0]+"</b> n'est pas disponible"):unavailables.length>1?void jsxc.gui.feedback("<b>"+unavailables.join(", ")+"</b> ne sont pas disponibles"):void mmstream.startScreenSharingMultiPart(fjidArray)}))})})},_initHelpMenu:function(){var tutorials=jsxc.help.getAllTutorials(),list=$("#jsxc-help-tutorial-list");$.each(tutorials,function(id,element){var li=$("<li>").text(element.description).click(function(){jsxc.help.launchTutorial(id)});list.append(li)})},_initSettingsMenu:function(){var newgui=jsxc.newgui,mmstream=jsxc.mmstream,notification=jsxc.notification;$("#jsxc-chat-sidebar .jsxc-toggle-settings").click(function(event){newgui.toggleSettingsMenu(),event.stopPropagation()}),$("#jsxc-chat-sidebar .jsxc-toggle-help").click(function(event){newgui.toggleHelpMenu(),event.stopPropagation()}),$("#jsxc-chat-sidebar .jsxc-action_showCollectedDatas").click(function(event){window.open(jsxc.options.stats.destinationUrl+"/visualization/"),event.stopPropagation()}),$("#jsxc-settings-menu .jsxc-action_clearLocalHistory").click(function(){var buddies=jsxc.storage.getUserItem("buddylist")||[];$.each(buddies,function(index,jid){jsxc.gui.window.clear(jid)}),jsxc.gui.feedback("L'historique a été éffacé avec succès")}),$("#jsxc-settings-menu .jsxc-action_installScreenSharingExtension").click(function(){mmstream.gui.showInstallScreenSharingExtensionDialog()}),$("#jsxc-settings-menu .jsxc-show-about-dialog").click(function(){jsxc.gui.showAboutDialog()});var muteIndicator=jsxc.newgui.createStateIndicator(".jsxc-action_toggleMuteMode");muteIndicator.toggleState(!notification.isSoundMuted()),$("#jsxc-settings-menu .jsxc-action_toggleMuteMode").click(function(){muteIndicator.toggleState(),muteIndicator.getState()===!1?notification.muteSound():notification.unmuteSound()});var notifIndicator=jsxc.newgui.createStateIndicator(".jsxc-action_toggleNotifications");notifIndicator.toggleState(notification.isNotificationShowed()),$("#jsxc-settings-menu .jsxc-action_toggleNotifications").click(function(){notifIndicator.toggleState(),notifIndicator.getState()===!0?(notification.hasPermission()!==!0&&jsxc.gui.showRequestNotification(),notification.showNotifications()):notification.hideNotifications()});var videoIndicator=jsxc.newgui.createStateIndicator(".jsxc-action_disableVideoCalls");videoIndicator.toggleState(mmstream.isVideoCallsDisabled()),$("#jsxc-settings-menu .jsxc-action_disableVideoCalls").click(function(){videoIndicator.toggleState(),videoIndicator.getState()===!0?mmstream.disableVideoCalls():mmstream.enableVideoCalls()})},_initSearchMenu:function(){var self=jsxc.gui.interactions;$("#jsxc-chat-sidebar-search-invite").click(function(){var checkedElements=self._getCheckedSearchUsers();if(checkedElements.length<1)return jsxc.gui.feedback("Vous devez choisir au moins un contact"),!1;var invited=[];$.each(checkedElements,function(index,element){var jqi=$(element),i=jqi.data("jid");jsxc.xmpp.addBuddy(i),invited.push(Strophe.getNodeFromJid(i)),jqi.removeClass("jsxc-checked")}),invited.length<2?jsxc.gui.feedback("<b>"+invited[0]+"</b> a été invité"):jsxc.gui.feedback("Ces utilisateurs ont été invité: <b>"+invited.join(", ")+"</b>");var entries=$(".jsxc-search-users-results .jsxc-search-user-entry");entries.animate({opacity:"0"},700,function(){entries.remove()})}),$("#jsxc-chat-sidebar-search-chat").click(function(){var checkedElements=self._getCheckedSearchUsers();if(checkedElements.length<1)return jsxc.gui.feedback("Vous devez choisir au moins un contact"),!1;$.each(checkedElements,function(index,element){var jid=$(element).data("jid");jsxc.api.openChatWindow(jid)});var entries=$(".jsxc-search-users-results .jsxc-search-user-entry");entries.animate({opacity:"0"},700,function(){entries.remove()})})},_initNotificationsMenu:function(){$("#jsxc-manage-notifications .jsxc-action_rejectAllNotifications").click(function(){return $("#jsxc-notifications ul li[data-nid]").length<1?void jsxc.gui.feedback("Aucune notification à rejeter"):void jsxc.gui.showConfirmDialog("Etes vous sur de vouloir rejeter toutes les notifications ?",function(){jsxc.gui.dialog.close(),$("#jsxc-notifications ul li[data-nid]").each(function(){jsxc.notice.remove($(this).data("nid"))}),jsxc.gui.feedback("Notifications rejetées")},function(){jsxc.gui.feedback("Opération annulée")})}),$("#jsxc-manage-notifications .jsxc-action_notificationsParameters").click(function(){jsxc.newgui.toggleSettingsMenu()})}},jsxc.newgui={SIDEBAR_CONTENT_HEIGHT:"480px",MEDIAPANEL_HEIGHT:"550px",SIDEBAR_ANIMATION_DURATION:"1500",SCROLL_ANIMATION_DURATION:"500",FLOATING_MENU_ANIMATION_DURATION:"800",OPACITY_ANIMATION_DURATION:"500",STATE_INDICATOR_ANIMATION_DURATION:100,_log:function(message,data,level){jsxc.debug("[NGUI] "+message,data,level)},_selectionMode:!0,_searchTimer:0,init:function(){var self=jsxc.newgui,togglevideo=$("#jsxc-chat-sidebar-header .jsxc-toggle-mediapanel");togglevideo.click(function(event){self.toggleMediapanel(),event.stopPropagation()});var buddyFilter=$("#jsxc-new-gui-filter-users"),conversationFilter=$("#jsxc-new-gui-filter-conversations");buddyFilter.click(function(){self.toggleBuddyFilter("buddies"),buddyFilter.addClass("jsxc-active-filter"),conversationFilter.removeClass("jsxc-active-filter")}),conversationFilter.click(function(){self.toggleBuddyFilter("conversations"),conversationFilter.addClass("jsxc-active-filter"),buddyFilter.removeClass("jsxc-active-filter")}),self.toggleBuddyFilter("buddies"),buddyFilter.addClass("jsxc-active-filter"),$("#jsxc-select-buddies").click(function(){self.toggleSelectionMode()}),$("#jsxc-chat-sidebar-header").click(function(){self.chatSidebarContent.isMainContentVisible()===!1&&self.isChatSidebarShown()===!1&&self.chatSidebarContent.showMainContent(),self.toggleChatSidebar()}),$("#jsxc-mediapanel .jsxc-close-mediapanel").click(function(){self.toggleMediapanel()}),$("#jsxc-chat-sidebar .jsxc-close-chatsidebar").click(function(){self.toggleChatSidebar()}),$("#jsxc-toggle-actions").click(function(){self.toggleActionsMenu()}),self._initSearchPanel(),self._initNotificationsPanel(),self._initConnexionMenu(),self.toggleBuddyFilter("buddies"),$(document).on("attached.jsxc",function(){self.updateStatusBarUserName()}),self.updateStatusBarUserName(),jsxc.options.etherpad.enabled!==!0&&$(".jsxc-action_new-etherpad-document").css({display:"none"}),$(document).on("presence.jsxc",self.updateChatSidebarHeader),$(document).on("notice.jsxc",self.updateChatSidebarHeader),$(document).on("attached.jsxc",self.updateChatSidebarHeader),$(document).on("disconnected.jsxc",self.updateChatSidebarHeader.bind(self,!0)),self.updateChatSidebarHeader(),jsxc.mmstream.gui._initGui()},_toggleFloatingMenu:function(menuSelector,buttonSelector,attachment,targetAttachment,offset){var self=jsxc.newgui,menu=$(menuSelector);menu.hasClass("jsxc-deploy")===!1?(menu.addClass("jsxc-deploy"),menu.css({opacity:"0",display:"block"}),new Tether({element:menuSelector,target:buttonSelector,attachment:attachment,targetAttachment:targetAttachment,offset:offset||"5px 5px"}),menu.animate({opacity:1},self.FLOATING_MENU_ANIMATION_DURATION,function(){})):(menu.removeClass("jsxc-deploy"),menu.animate({opacity:0},self.FLOATING_MENU_ANIMATION_DURATION,function(){menu.css({display:"none"})}))},hideAndShow:function(toShow,toHide){var self=jsxc.newgui;toHide.animate({opacity:0},self.OPACITY_ANIMATION_DURATION,function(){toHide.css("display","none"),toShow.css({display:"inline-block",opacity:0}),toShow.animate({opacity:"1"},self.OPACITY_ANIMATION_DURATION)})},createStateIndicator:function(selector){var self=jsxc.newgui;if(!selector)throw new Error("Invalid argument: "+selector);var root=$(selector),indicator=$('<span class="jsxc_stateIndicator">&nbsp;<span class="jsxc_stateIndicator_on">on</span> | <span class="jsxc_stateIndicator_off">off</span></span>');root.append(indicator);var on=indicator.find(".jsxc_stateIndicator_on"),off=indicator.find(".jsxc_stateIndicator_off"),duration=self.STATE_INDICATOR_ANIMATION_DURATION,indicatorState=!1,ret={root:indicator,getState:function(){return indicatorState},toggleState:function(state){"undefined"==typeof state&&(state=!indicatorState,indicatorState=state),state===!0?off.animate({color:"black",opacity:.3},duration,function(){on.animate({color:"blue",opacity:1},duration)}):on.animate({color:"black",opacity:.5},duration,function(){off.animate({color:"blue",opacity:1},duration)})}};return ret}},$.extend(jsxc.newgui,{getAllDisplayedMediaRessource:function(){return $("#jsxc-mediapanel .jsxc-media-ressource")},toggleMediapanel:function(state,callbackWhenFinished){var self=jsxc.newgui;if("undefined"!=typeof state&&null!==state||(state=!self.isMediapanelShown()),state===self.isMediapanelShown())return void(callbackWhenFinished&&callbackWhenFinished());var mediapanel=$("#jsxc-mediapanel");state===!0?(mediapanel.find(".jsxc-close-mediapanel").css({display:"block"}),mediapanel.css("box-shadow","3px 3px 3px 3px rgba(0, 0, 0, 0.1)"),mediapanel.animate({height:self.MEDIAPANEL_HEIGHT},self.SIDEBAR_ANIMATION_DURATION,function(){mediapanel.addClass("jsxc-deploy"),callbackWhenFinished&&callbackWhenFinished()})):(mediapanel.find(".jsxc-close-mediapanel").css({display:"none"}),mediapanel.animate({height:"0px"},self.SIDEBAR_ANIMATION_DURATION,function(){mediapanel.removeClass("jsxc-deploy"),mediapanel.css("box-shadow","none"),callbackWhenFinished&&callbackWhenFinished()}))},isMediapanelShown:function(){return $("#jsxc-mediapanel").hasClass("jsxc-deploy")},openMediaRessource:function(ressource){var self=jsxc.newgui,ress=jsxc.ressources;self.toggleMediapanel(!0);var prefix=ressource.substring(0,ressource.indexOf(":")),ressourceOnly=ressource.substring(prefix.length+1,ressource.length);self._log("openMediaRessource: ",{ressource:ressource,prefix:prefix,ressourceOnly:ressourceOnly});var embedded=ress.getEmbeddedFor(prefix,ressourceOnly);embedded&&self.addMediaRessource(embedded,"Vidéo: "+ressourceOnly)},removeMediaRessource:function(container){var self=jsxc.newgui;if(!container)throw new Error("Invalid argument: "+container);container.animate({opacity:"0"},self.OPACITY_ANIMATION_DURATION,function(){container.remove()})},addMediaRessource:function(htmlContent,title,options){var self=jsxc.newgui,defaultOptions={titleControls:null};options=$.extend(defaultOptions,options);var container=$('<div class="jsxc-media-ressource"></div>').append(htmlContent),dspTitle=title.length>30?title.substring(0,27)+"...":title,ressHeader=$("<h1 class='jsxc-title'>"+dspTitle+"</h1>").attr("title",title);if(container.prepend(ressHeader),options.titleControls)ressHeader.append(options.titleControls);else{var closeHeader=$("<span class='jsxc-close-ressource'></span>");closeHeader.click(function(){self.removeMediaRessource(container)}),ressHeader.append(closeHeader)}self._log("addMediaRessource",{title:title,container:container}),$("#jsxc-mediapanel-right").append(container)}}),$.extend(jsxc.newgui,{chatSidebarContent:{getAllContents:function(){return $("#jsxc-sidebar-content-viewport").find(".jsxc-viewport-content")},showMainContent:function(){var self=jsxc.newgui.chatSidebarContent;self._setContentVisible("jsxc-buddy-list-container")},showContent:function(contentId){var self=jsxc.newgui.chatSidebarContent;self._setContentVisible(contentId)},isMainContentVisible:function(){return jsxc.newgui.chatSidebarContent.isContentVisible("jsxc-buddy-list-container")},isContentVisible:function(contentId){var element=$("#"+contentId);if(element.length<1)throw new Error("Unable to find: "+contentId);return"block"===element.css("display")},toggleContent:function(contentId){var self=jsxc.newgui.chatSidebarContent,visible=self.isContentVisible(contentId);visible?self.showMainContent():self._setContentVisible(contentId)},_setContentVisible:function(contentId){var self=jsxc.newgui.chatSidebarContent;self.getAllContents().each(function(){$(this).css("display","none")});var toDisplay=$("#jsxc-sidebar-content-viewport #"+contentId);if(toDisplay.length<1)throw new Error("Unable to find ID: "+contentId);toDisplay.css({opacity:0,display:"block"}),toDisplay.animate({opacity:1},self.OPACITY_ANIMATION_DURATION)}},updateStatusBarUserName:function(){jsxc.xmpp.conn?$("#jsxc-status-bar .jsxc-user-name").text(Strophe.getNodeFromJid(jsxc.xmpp.conn.jid)):$("#jsxc-status-bar .jsxc-user-name").text("Déconnecté")},_initNotificationsPanel:function(){var self=jsxc.newgui;$("#jsxc-main-menu .jsxc-action_manage-notifications").click(function(){self.toggleNotificationsMenu()})},updateChatSidebarHeader:function(disconnected){var self=jsxc.newgui,headerContent=$("#jsxc-chat-sidebar-header .jsxc-header-content");if(headerContent.empty(),headerContent.off("click"),disconnected===!0)headerContent.append("<span>Déconnecté</span>");else if(jsxc.notice.getNotificationsNumber()>0)headerContent.append('<span><span class="jsxc_menu_notif_number"></span> notification(s)</span>'),headerContent.click(function(event){event.stopPropagation(),self.toggleChatSidebar(!0),self.toggleNotificationsMenu()}),jsxc.notice.updateNotificationNumbers();else{var message,online=$('#jsxc_buddylist li[data-status!="offline"][data-type="chat"]').length;message=0===online?"Aucune activité":1===online?"1 personne en ligne":online+" personnes en ligne",headerContent.append("<span>"+message+"</span>")}return!0},updateOwnPresenceIndicator:function(disconnection){var statusSelect=$("#jsxc-status-bar .jsxc-select-status"),username=$("#jsxc-status-bar .jsxc-user-name"),pres=jsxc.storage.getUserItem("presence")||"online",selectedPres=statusSelect?statusSelect.val():null;username.removeClass("jsxc_online jsxc_chat jsxc_away jsxc_xa jsxc_dnd jsxc_offline"),jsxc.xmpp.conn&&disconnection!==!0?(username.addClass("jsxc_"+pres),statusSelect&&("disabled"===statusSelect.attr("disabled")&&statusSelect.attr("disabled",!1),selectedPres!==pres&&statusSelect.val(pres))):(username.addClass("jsxc_offline"),username.addClass("user"),statusSelect&&(statusSelect.val("novalue"),statusSelect.attr("disabled",!0)))},_initSearchPanel:function(){var self=jsxc.newgui;$(".jsxc-action_search-user").click(function(){self.chatSidebarContent.showContent("jsxc-search-users")});var searchBar=$("#jsxc-chat-sidebar-search");searchBar.keyup(function(){var terms=searchBar.val();clearTimeout(self._searchTimer),self._searchTimer=setTimeout(function(){console.info("Search: "+terms),jsxc.xmpp.search.searchUsers(terms).then(function(results){self._displayUserSearchResults(results)}).fail(function(error){self._displayUserSearchError(error)})},700)})},_displayUserSearchResults:function(results){var list=$("#jsxc-chat-sidebar .jsxc-search-users-results");list.empty();var displayed=0,ownJid=jsxc.jidToBid(jsxc.xmpp.conn.jid);return $.each(results,function(index,element){if(element.jid===ownJid)return!0;var res=$("<div class='jsxc-search-user-entry'></div>").text(element.username);res.css({display:"block",opacity:0}),res.data("jid",element.jid),element._is_buddy===!0?(res.attr("title",element.username+" est dans vos contacts"),res.addClass("jsxc-search-result-buddie"),res.click(function(){res.hasClass("jsxc-search-result-buddie")?(res.removeClass("jsxc-search-result-buddie"),res.addClass("jsxc-checked")):(res.removeClass("jsxc-checked"),res.addClass("jsxc-search-result-buddie"))})):(res.attr("title",element.username+" n'est pas dans vos contacts"),res.click(function(){res.toggleClass("jsxc-checked")})),list.append(res),res.animate({opacity:1}),displayed++}),1>displayed?void list.append("<div class='jsxc-search-user-entry'>Aucun résultat</div>"):void 0},_displayUserSearchError:function(error){var list=$("#jsxc-chat-sidebar-search .jsxc-search-users-results");list.empty(),list.append("<div>Erreur lors de la recherche: "+error+"</div>")},toggleNotificationsMenu:function(){jsxc.newgui.chatSidebarContent.toggleContent("jsxc-manage-notifications")},_initConnexionMenu:function(){var self=jsxc.newgui,connexionTimerValueMs=12e3,connexionTimerId=-1,showStandBy=function(visible){var standby=$("#jsxc-connexion-menu #jsxc-login-standby");visible===!0?standby.css({display:"block",opacity:0}).animate({opacity:1},self.OPACITY_ANIMATION_DURATION):standby.css({display:"none",opacity:0})},showWarning=function(visible){var warning=$("#jsxc-connexion-menu #jsxc-login-warning");visible===!0?warning.css({display:"block",opacity:0}).animate({opacity:1},self.OPACITY_ANIMATION_DURATION):warning.css({display:"none",opacity:0})},watchConnexionTimer=function(){showStandBy(!1),showWarning(!0),jsxc.gui.feedback("Echec de la connexion"),jsxc.xmpp.logout(),jsxc.xmpp.disconnected()},authFail=function(){clearTimeout(connexionTimerId),jsxc.gui.feedback("Identifiants incorrects"),showStandBy(!1),jsxc.xmpp.logout(),jsxc.xmpp.disconnected()},connFail=function(){clearTimeout(connexionTimerId),jsxc.gui.feedback("Echec de la connexion"),showStandBy(!1),jsxc.xmpp.logout(),jsxc.xmpp.disconnected()},connSuccess=function(){clearTimeout(connexionTimerId),$("#jsxc-connexion-login").val(""),$("#jsxc-connexion-password").val(""),$(document).off("authfail.jsxc",authFail),$(document).off("disconnected.jsxc",connFail),$(document).off("connected.jsxc",connSuccess),jsxc.gui.feedback("Connexion réussie"),showStandBy(!1),self.toggleBuddyList()};$("#jsxc-connexion-menu #jsxc-connexion-submit").click(function(){if(jsxc.xmpp.conn)return void jsxc.gui.feedback("Vous êtes déjà connecté");var login=$("#jsxc-connexion-login").val(),password=$("#jsxc-connexion-password").val();if(!login||-1!==login.indexOf("@"))return void jsxc.gui.feedback("Identifiant incorrect");if(login=login+"@"+jsxc.options.xmpp.domain,!password)return void jsxc.gui.feedback("Mot de passe incorrect");showWarning(!1),showStandBy(!0),$(document).off("authfail.jsxc",authFail),$(document).one("authfail.jsxc",authFail),$(document).off("disconnected.jsxc",connFail),$(document).one("disconnected.jsxc",connFail),$(document).off("connected.jsxc",connSuccess),$(document).one("connected.jsxc",connSuccess);try{connexionTimerId=setTimeout(watchConnexionTimer,connexionTimerValueMs),jsxc.xmpp.login(login,password)}catch(e){console.error(e),jsxc.gui.feedback("Erreur lors de la connexion: "+e),showStandBy(!1)}})},toggleConnexionMenu:function(){jsxc.newgui.chatSidebarContent.toggleContent("jsxc-connexion-menu")},isConnexionMenuShown:function(){return jsxc.newgui.chatSidebarContent.isContentVisible("jsxc-connexion-menu")},toggleActionsMenu:function(){jsxc.newgui.chatSidebarContent.toggleContent("jsxc-main-menu")},initMediaPanelMouseNavigation:function(){var lastMove,mpanel=$("#jsxc-mediapanel-right");mpanel.mousemove(function(event){if(console.log(event.pageX,event.pageY),event.pageY>150)return!0;if(!lastMove)return lastMove=event.pageX,!0;var frameSize=mpanel.width(),viewportSize=0;if(mpanel.find("div.jsxc-media-ressource").each(function(){viewportSize+=$(this).width()}),viewportSize>frameSize){var factor=viewportSize/frameSize,direction=lastMove-event.pageX;mpanel.scrollLeft(mpanel.scrollLeft()-direction*factor)}lastMove=event.pageX})},toggleBuddyFilter:function(mode){var self=jsxc.newgui,roster=jsxc.gui.roster;self._log("toggleBuddyFilter: "+mode),self.toggleSelectionMode(!1),roster.setFilterMode(mode);var list=self._getBuddyList();list.each(function(){$(this).css({opacity:0})});var hideElement=function(element){element.css("display","none")},showElement=function(element){element.css({display:"block"}),element.animate({opacity:1},self.OPACITY_ANIMATION_DURATION)},applyBuddie="buddies"===mode?showElement:hideElement,applyConversation="conversations"===mode?showElement:hideElement;list.each(function(){var element=$(this);"chat"===element.data("type")?applyBuddie(element):applyConversation(element)}),self.chatSidebarContent.isMainContentVisible()!==!0&&self.chatSidebarContent.showMainContent()},unselectAllElements:function(){var self=jsxc.newgui;self._getBuddyList().find(".jsxc-checked").removeClass("jsxc-checked"),self._updateSelectedCount()},_updateSelectedCount:function(){var self=jsxc.newgui,count=self._getBuddyList().find(".jsxc-checked").length,text=count>0?"("+count+")":"";$("#jsxc-select-buddies .jsxc-selected-number").text(text)},toggleSelectionMode:function(enabled){var self=jsxc.newgui,list=self._getBuddyList();enabled="undefined"!=typeof enabled?enabled:!self._selectionMode,self._selectionMode=enabled,self.chatSidebarContent.isMainContentVisible()!==!0&&self.chatSidebarContent.showMainContent(),self._selectionMode===!0?($("#jsxc-select-buddies").addClass("jsxc-checked"),list.each(function(){var element=$(this);element.off("click"),element.on("click",function(){var toDecorate=$(this).find("div.jsxc_name");self._toggleBuddySelected(toDecorate),self._updateSelectedCount()})}),self._updateSelectedCount()):($("#jsxc-select-buddies").removeClass("jsxc-checked"),self.unselectAllElements(),list.each(function(){var element=$(this);element.off("click"),element.find(".jsxc-checked").removeClass("jsxc-checked"),element.click(function(){jsxc.gui.window.open(element.data("bid"))})}))},_toggleBuddySelected:function(toDecorate){var className="jsxc-checked";return toDecorate.hasClass(className)?toDecorate.removeClass(className):toDecorate.addClass(className),toDecorate},_getBuddyList:function(){return $("#jsxc_buddylist li.jsxc_rosteritem")},getCheckedElementsOrAskFor:function(buddiesOnly){var self=jsxc.newgui;buddiesOnly="undefined"!=typeof buddiesOnly?buddiesOnly:!1;var defer=$.Deferred(),rslt=self.getCheckedElements(buddiesOnly);return rslt.length>0?(self.unselectAllElements(),defer.resolve(rslt)):jsxc.gui.showSelectContactsDialog().then(function(result){defer.resolve(result)}).fail(function(){defer.reject("canceled")}),defer.promise()},getCheckedBuddiesOrAskFor:function(){return jsxc.newgui.getCheckedElementsOrAskFor(!0)},getCheckedElements:function(buddiesOnly){var self=jsxc.newgui;buddiesOnly="undefined"!=typeof buddiesOnly?buddiesOnly:!1;var all=self._getBuddyList(),rslt=[];return all.each(function(){var element=$(this);return buddiesOnly===!0&&"groupchat"===element.data("type")?!0:void(element.find(".jsxc-checked").length>0&&rslt.push(element.data("jid")))}),rslt},getCheckedBuddies:function(){var self=jsxc.newgui;return self.getCheckedElements(!0)},isChatSidebarShown:function(){return $("#jsxc-chat-sidebar-content").hasClass("jsxc-deploy")},toggleBuddyList:function(){jsxc.newgui.chatSidebarContent.toggleContent("jsxc-buddy-list-container")},toggleSettingsMenu:function(){jsxc.newgui.chatSidebarContent.toggleContent("jsxc-settings-menu")},toggleHelpMenu:function(){jsxc.newgui.chatSidebarContent.toggleContent("jsxc-help-menu")},toggleSearchPanel:function(){var self=jsxc.newgui;self.chatSidebarContent.isContentVisible("jsxc-search-users")!==!0?self.chatSidebarContent.showContent("jsxc-search-users"):self.chatSidebarContent.showMainContent()},toggleChatSidebar:function(state,callbackWhenFinished){var self=jsxc.newgui;if("undefined"!=typeof state&&null!==state||(state=!self.isChatSidebarShown()),state===self.isChatSidebarShown())return void(callbackWhenFinished&&callbackWhenFinished());var content=$("#jsxc-chat-sidebar-content"),settings=$("#jsxc-chat-sidebar .jsxc-toggle-settings"),help=$("#jsxc-chat-sidebar .jsxc-toggle-help"),closeCross=$("#jsxc-chat-sidebar .jsxc-close-chatsidebar");state===!0?(closeCross.css({opacity:"0",display:"inline-block"}),closeCross.animate({opacity:1}),settings.css({opacity:"0",display:"inline-block"}),settings.animate({opacity:1}),help.css({opacity:"0",display:"inline-block"}),help.animate({opacity:1}),content.animate({height:self.SIDEBAR_CONTENT_HEIGHT},self.SIDEBAR_ANIMATION_DURATION,function(){content.addClass("jsxc-deploy"),callbackWhenFinished&&callbackWhenFinished()})):(closeCross.animate({opacity:0}),settings.animate({opacity:0}),help.animate({opacity:0}),content.animate({height:"0px"},self.SIDEBAR_ANIMATION_DURATION,function(){content.removeClass("jsxc-deploy"),settings.css({display:"none"}),help.css({display:"none"}),closeCross.css({display:"none"}),callbackWhenFinished&&callbackWhenFinished();
}))}}),jsxc.gui.roster={ready:!1,loaded:!1,init:function(){jsxc.options.get("hideOffline")&&$("#jsxc_buddylist").addClass("jsxc_hideOffline"),jsxc.options.get("muteNotification")&&jsxc.notification.muteSound();var pres=jsxc.storage.getUserItem("presence")||"online";jsxc.xmpp.changeOwnPresence(pres),jsxc.notice.load(),jsxc.gui.roster.ready=!0,$(document).trigger("ready.roster.jsxc")},add:function(bid){var self=jsxc.gui.roster,data=jsxc.storage.getUserItem("buddy",bid);if(!data)throw new Error("Invalid buddy: "+bid);var bud=jsxc.gui.buddyTemplate.clone().attr("data-bid",bid).attr("data-type",data.type||"chat");self.setVisibilityByFilter(bud),jsxc.gui.roster.insert(bid,bud),bud.click(function(){jsxc.gui.window.open(bid)}),bud.find(".jsxc_msg").click(function(){return jsxc.gui.window.open(bid),!1}),jsxc.gui.update(bid);for(var history=jsxc.storage.getUserItem("history",bid)||[],i=0;history.length>i;){var message=new jsxc.Message(history[i]);if(message.direction!==jsxc.Message.SYS){$('[data-bid="'+bid+'"]').find(".jsxc_lastmsg .jsxc_text").html(jsxc.stripHtml(message.msg));break}i++}$(document).trigger("add.roster.jsxc",[bid,data,bud])},availablesFilterModes:["buddies","conversations"],filterMode:"buddies",setFilterMode:function(mode){var self=jsxc.gui.roster;if(-1===self.availablesFilterModes.indexOf(mode))throw new Error("Unknown mode: "+mode);self.filterMode=mode},setVisibilityByFilter:function(li){var self=jsxc.gui.roster,hideElement=function(element){element.css("display","none")},showElement=function(element){element.css({display:"block"})},type=li.data("type");if("chat"===type)"buddies"===self.filterMode?showElement(li):hideElement(li);else{if("groupchat"!==type)throw new Error("Unkown type: "+type);"buddies"===self.filterMode?hideElement(li):showElement(li)}},getItem:function(bid){return $("#jsxc_buddylist > li[data-bid='"+bid+"']")},insert:function(bid,li){var data=jsxc.storage.getUserItem("buddy",bid),listElements=$("#jsxc_buddylist > li"),insert=!1,status="both"===data.sub?data.status:-1;listElements.each(function(){var thisStatus="both"===$(this).data("sub")?$(this).data("status"):-1;return $(this).data("name").toLowerCase()>data.name.toLowerCase()&&thisStatus===status||status>thisStatus?($(this).before(li),insert=!0,!1):void 0}),insert||li.appendTo("#jsxc_buddylist")},reorder:function(bid){jsxc.gui.roster.insert(bid,jsxc.gui.roster.remove(bid))},remove:function(bid){var res=jsxc.gui.roster.getItem(bid).detach();return res},purge:function(bid){jsxc.master&&(jsxc.storage.removeUserItem("buddy",bid),jsxc.storage.removeUserItem("otr",bid),jsxc.storage.removeUserItem("otr_version_"+bid),jsxc.storage.removeUserItem("chat",bid),jsxc.storage.removeUserItem("window",bid),jsxc.storage.removeUserElement("buddylist",bid),jsxc.storage.removeUserElement("windowlist",bid)),jsxc.gui.window._close(bid),jsxc.gui.roster.remove(bid)},rename:function(bid){var name=jsxc.gui.roster.getItem(bid).find(".jsxc_name"),options=jsxc.gui.roster.getItem(bid).find(".jsxc_lastmsg, .jsxc_more"),input=$('<input type="text" name="name"/>');$("body").click(),options.hide(),name=name.replaceWith(input),input.val(name.text()),input.keypress(function(ev){13===ev.which&&(options.css("display",""),input.replaceWith(name),jsxc.gui.roster._rename(bid,$(this).val()),$("html").off("click"))}),input.click(function(){return!1}),$("html").one("click",function(){options.css("display",""),input.replaceWith(name),jsxc.gui.roster._rename(bid,input.val())})},_rename:function(bid,newname){if(jsxc.master){var d=jsxc.storage.getUserItem("buddy",bid)||{};if("chat"===d.type){var iq=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:jsxc.jidToBid(d.jid),name:newname});jsxc.xmpp.conn.sendIQ(iq)}else"groupchat"===d.type&&jsxc.xmpp.bookmarks.add(bid,newname,d.nickname,d.autojoin)}jsxc.storage.updateUserItem("buddy",bid,"name",newname),jsxc.gui.update(bid)},noConnection:function(){$("#jsxc_buddylist").empty(),$("#jsxc_buddylist").find(".jsxc_rosterIsEmptyMessage").remove();var reconnectMsg=$("<div class='jsxc-reconnect-message'>Vous êtes déconnecté</div>");reconnectMsg.click(function(){jsxc.api.reconnect()}),$("#jsxc_buddylist").append(reconnectMsg),$(document).one("attached.jsxc",function(){$("#jsxc_buddylist").find(".jsxc-reconnect-message").remove()})},empty:function(){var text=$('<p class="jsxc_rosterIsEmptyMessage">Votre liste est vide, invitez de nouveaux contacts !</p>');text.click(function(){jsxc.newgui.toggleSearchPanel()});var buddyList=$("#jsxc_buddylist");buddyList.find(".jsxc_rosterIsEmptyMessage").length<1&&(buddyList.prepend(text),$(document).one("add.roster.jsxc",function(){$("#jsxc_buddylist").find(".jsxc_rosterIsEmptyMessage").remove()}))}},jsxc.gui.template={},jsxc.gui.template.get=function(name,bid,msg){var ph={my_priv_fingerprint:jsxc.storage.getUserItem("priv_fingerprint")?jsxc.storage.getUserItem("priv_fingerprint").replace(/(.{8})/g,"$1 "):jsxc.t("not_available"),my_jid:jsxc.storage.getItem("jid")||"",my_node:Strophe.getNodeFromJid(jsxc.storage.getItem("jid")||"")||"",root:jsxc.options.root,app_name:jsxc.options.app_name,version:jsxc.version};if(bid){var data=jsxc.storage.getUserItem("buddy",bid);$.extend(ph,{bid_priv_fingerprint:data&&data.fingerprint?data.fingerprint.replace(/(.{8})/g,"$1 "):jsxc.t("not_available"),bid_jid:bid,bid_name:data&&data.name?data.name:bid})}msg&&$.extend(ph,{msg:msg});var ret=jsxc.gui.template[name];return"string"==typeof ret?(ret=ret.replace(/\{\{root\}\}/g,ph.root),ret=$("<div>").append(jsxc.localization.processHtmlString(ret)).html(),ret=ret.replace(/\{\{([a-zA-Z0-9_\-]+)\}\}/g,function(s,key){return"string"==typeof ph[key]?ph[key]:s})):(jsxc.debug("Template not available: "+name),name)},jsxc.gui.widgets={createConversationList:function(selector){var root=$(selector);root.empty(),root.addClass("jsxc_conversation-list-container");var list=$("<ul class='jsxc-conversation-list'></ul>");root.append(list);var updateConversationList=function(){list.empty();var conversList=jsxc.storage.getLocaleBuddyListBJID(),conversNumber=0;if($.each(conversList,function(index,jid){var infos=jsxc.storage.getUserItem("buddy",jsxc.jidToBid(jid));if("groupchat"===infos.type!=!0)return!0;var conversName=Strophe.getNodeFromJid(jid),li=$("<li></li>").text(conversName).data("conversjid",jid).click(function(){$(this).toggleClass("jsxc-checked")});list.append(li),conversNumber++}),1>conversNumber){var li=$("<li></li>").text("Aucune conversation").data("conversjid",null);list.append(li)}};return updateConversationList(),{root:root,updateConversationList:updateConversationList}},createBuddyList:function(selector,selectedJids){selectedJids=selectedJids||[];var root=$(selector);root.empty(),root.addClass("jsxc_buddy-list-container");var list=$("<ul class='jsxc-selectable-buddy-list'></ul>");root.append(list);var updateBuddyList=function(){list.empty();var buddyList=jsxc.storage.getLocaleBuddyListBJID(),buddyNumber=0;if($.each(buddyList,function(index,jid){var bid=jsxc.jidToBid(jid),infos=jsxc.storage.getUserItem("buddy",bid);if("groupchat"===infos.type)return!0;var buddyName=Strophe.getNodeFromJid(jid),li=$("<li></li>").text(buddyName).data("bid",bid).click(function(){$(this).toggleClass("jsxc-checked")});selectedJids.indexOf(jid)>-1&&li.addClass("jsxc-checked"),list.append(li),buddyNumber++}),1>buddyNumber){var li=$("<li></li>").text("Aucun contact").data("bid",null);list.append(li)}};return updateBuddyList(),{root:root,updateBuddyList:updateBuddyList}}},jsxc.gui.window={sendComposingIntervalMs:900,hideComposingNotifDelay:3e3,showComposingPresence:function(from,type){var bid=jsxc.jidToBid(from),user="chat"===type?Strophe.getNodeFromJid(from):Strophe.getResourceFromJid(from);$("#jsxc_windowList .jsxc_windowItem").each(function(){var self=$(this),winBid=self.data("bid");if(winBid===bid){var usersComposing=self.data("users-composing")||[];-1===usersComposing.indexOf(user)&&(usersComposing.push(user),self.data("users-composing",usersComposing));var textarea=self.find(".jsxc_textarea"),composingNotif=textarea.find(".jsxc_userComposing");jsxc.gui.window.scrollDown(winBid);var msg=usersComposing.length>1?" sont en train d'écrire ...":" est en train d'écrire ...";return composingNotif.length<1?(composingNotif=$("<div class='jsxc_userComposing jsxc_chatmessage jsxc_sys'></div>"),composingNotif.css({opacity:0,display:"block"}),composingNotif.html(usersComposing.join(", ")+msg),textarea.append(composingNotif),composingNotif.animate({opacity:1},600)):(composingNotif.html(usersComposing.join(", ")+msg),"1"!==composingNotif.css("opacity")&&composingNotif.animate({opacity:1},600)),$(this).data("composingTimeout")&&clearTimeout($(this).data("composingTimeout")),$(this).data("composingTimeout",setTimeout(function(){composingNotif.animate({opacity:0},600,function(){composingNotif.remove()}),self.data("usersComposing",[])},jsxc.gui.window.hideComposingNotifDelay)),!1}})},init:function(bid){if(jsxc.gui.window.get(bid).length>0)return jsxc.gui.window.get(bid);var win=jsxc.gui.windowTemplate.clone().attr("data-bid",bid).appendTo("#jsxc_windowList > ul"),data=jsxc.storage.getUserItem("buddy",bid);win.data("jid",data.jid);var expandClick=function(){return win.trigger("extra.jsxc"),$("body").click(),win.find(".jsxc_menu").hasClass("jsxc_open")||(win.find(".jsxc_menu").addClass("jsxc_open"),$("body").one("click",function(){win.find(".jsxc_menu").removeClass("jsxc_open")})),!1};if(win.find(".jsxc_more").click(expandClick),win.find(".jsxc_verification").click(function(){jsxc.gui.showVerification(bid)}),win.find(".jsxc_fingerprints").click(function(){jsxc.gui.showFingerprints(bid)}),win.find(".jsxc_transfer").click(function(){jsxc.otr.toggleTransfer(bid)}),win.find(".jsxc_bar").click(function(){jsxc.gui.window.toggle(bid)}),win.find(".jsxc_close").click(function(){jsxc.gui.window.close(bid)}),win.find(".jsxc_clear").click(function(){jsxc.gui.window.clear(bid)}),win.find(".jsxc_sendFile").click(function(){$("body").click(),jsxc.gui.window.sendFile(bid)}),win.find(".jsxc_tools").click(function(){return!1}),win.data("lastComposingStateSent",-1),win.find(".jsxc_textinput").keyup(function(ev){var body=$(this).val();if(13===ev.which&&(body=""),jsxc.storage.updateUserItem("window",bid,"text",body),27===ev.which&&jsxc.gui.window.close(bid),jsxc.xmpp.conn){var now=(new Date).getTime(),last=win.data("lastComposingStateSent");if("-1"===last||now-last>jsxc.gui.window.sendComposingIntervalMs){var type=win.hasClass("jsxc_groupchat")?"groupchat":"chat";jsxc.xmpp.conn.chatstates.sendComposing(bid,type),win.data("lastComposingStateSent",now)}}}).keypress(function(ev){13===ev.which&&$(this).val()&&(jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.OUT,msg:$(this).val()}),$(this).val(""))}).focus(function(){jsxc.gui.readMsg(bid)}).mouseenter(function(){$("#jsxc_windowList").data("isOver",!0)}).mouseleave(function(){$("#jsxc_windowList").data("isOver",!1)}),win.find(".jsxc_textarea").click(function(){"function"!=typeof getSelection||getSelection().toString()||win.find(".jsxc_textinput").focus()}),win.find(".jsxc_textarea").slimScroll({height:"234px",distance:"3px"}),win.find(".jsxc_name").disableSelection(),win.find(".slimScrollDiv").resizable({handles:"w, nw, n",minHeight:234,minWidth:250,resize:function(event,ui){jsxc.gui.window.resize(win,ui)},start:function(){win.removeClass("jsxc_normal")},stop:function(){win.addClass("jsxc_normal")}}),win.find(".jsxc_window").css("bottom",-1*win.find(".jsxc_fade").height()),$.inArray(bid,jsxc.storage.getUserItem("windowlist"))<0){var wl=jsxc.storage.getUserItem("windowlist")||[];wl.push(bid),jsxc.storage.setUserItem("windowlist",wl),jsxc.storage.setUserItem("window",bid,{minimize:!0,text:"",unread:0}),jsxc.gui.window.hide(bid)}else jsxc.storage.getUserItem("window",bid).unread&&jsxc.gui._unreadMsg(bid);return $.each(jsxc.gui.emotions,function(i,val){var ins=val[0].split(" ")[0],li=$("<li>");li.append(jsxc.gui.shortnameToImage(":"+val[1]+":")),li.find("div").attr("title",ins),li.click(function(){win.find("input").val(win.find("input").val()+ins),win.find("input").focus()}),win.find(".jsxc_emoticons ul").prepend(li)}),jsxc.gui.toggleList.call(win.find(".jsxc_emoticons")),jsxc.gui.window.restoreChat(bid),jsxc.gui.update(bid),jsxc.gui.updateWindowListSB(),jsxc.master&&!jsxc.otr.objects[bid]?jsxc.otr.create(bid):jsxc.otr.enable(bid),jsxc.gui.window.checkBuddy(bid),$(document).trigger("init.window.jsxc",[win]),win},checkBuddy:function(bid){if(!bid)throw new Error("Invalid argument: "+bid);var win=jsxc.gui.window.get(bid);if(!(win.length<1)){var node=Strophe.getNodeFromJid(bid),data=jsxc.storage.getUserItem("buddy",bid);win.find(".jsxc-warning-offline").remove(),win.find(".jsxc-warning-notbuddy").remove(),"both"!==data.sub?win.find(".jsxc_textarea").prepend("<div class='jsxc-warning-notbuddy'><i>"+node+"</i> n'est pas dans vos contacts. Votre interlocuteur est peut être déconnecté ou peut refuser de voir vos messages.</div>"):data.status===jsxc.CONST.STATUS.indexOf("offline")&&win.find(".jsxc_textarea").prepend("<div class='jsxc-warning-offline'><i>"+node+"</i> est à présent déconnecté</div>")}},resize:function(win,ui,outer){var bid;if("object"==typeof win)bid=win.attr("data-bid");else{if("string"!=typeof win)return void jsxc.warn("jsxc.gui.window.resize has to be called either with bid or window object.");bid=win,win=jsxc.gui.window.get(bid)}win.attr("data-default-height")||win.attr("data-default-height",win.find(".ui-resizable").height()),win.attr("data-default-width")||win.attr("data-default-width",win.find(".ui-resizable").width());var outer_height_diff=outer?win.find(".jsxc_window").outerHeight()-win.find(".ui-resizable").height():0;ui=$.extend({size:{width:parseInt(win.attr("data-default-width")),height:parseInt(win.attr("data-default-height"))+outer_height_diff}},ui||{}),outer&&(ui.size.height-=outer_height_diff),win.find(".slimScrollDiv").css({width:ui.size.width,height:ui.size.height}),win.width(ui.size.width),win.find(".jsxc_textarea").slimScroll({height:ui.size.height}),$(document).trigger("resize.window.jsxc",[win,bid,ui.size])},fullsize:function(bid){var win=jsxc.gui.window.get(bid),size=jsxc.options.viewport.getSize();size.width-=10,size.height-=win.find(".jsxc_bar").outerHeight()+win.find(".jsxc_textinput").outerHeight(),jsxc.gui.window.resize(win,{size:size})},get:function(id){return $("li.jsxc_windowItem[data-bid='"+jsxc.jidToBid(id)+"']")},open:function(bid){var win=jsxc.gui.window.init(bid);return jsxc.gui.window.show(bid),jsxc.gui.window.highlight(bid),win},close:function(bid,callBackWhenFinished){var win=jsxc.gui.window.get(bid);return 0===win.length?void jsxc.warn("Want to close a window, that is not open."):void win.find(".jsxc_window").animate({height:"0px"},500,function(){jsxc.storage.removeUserElement("windowlist",bid),jsxc.storage.removeUserItem("window",bid),jsxc.storage.getUserItem("buddylist")&&jsxc.storage.getUserItem("buddylist").indexOf(bid)<0&&(jsxc.storage.removeUserItem("buddy",bid),jsxc.storage.removeUserItem("chat",bid)),jsxc.gui.window._close(bid),callBackWhenFinished&&callBackWhenFinished()})},_close:function(bid){jsxc.gui.window.get(bid).remove(),jsxc.gui.updateWindowListSB()},toggle:function(bid){var win=jsxc.gui.window.get(bid);0!==win.parents("#jsxc_windowList").length&&(win.hasClass("jsxc_min")?jsxc.gui.window.show(bid):jsxc.gui.window.hide(bid),jsxc.gui.updateWindowListSB())},show:function(bid){return jsxc.storage.updateUserItem("window",bid,"minimize",!1),jsxc.gui.window._show(bid)},_show:function(bid){var win=jsxc.gui.window.get(bid),duration=0;win.removeClass("jsxc_min").addClass("jsxc_normal"),win.find(".jsxc_window").css("bottom","0"),setTimeout(function(){var padding=$("#jsxc_windowListSB").width(),innerWidth=$("#jsxc_windowList>ul").width(),outerWidth=$("#jsxc_windowList").width()-padding;if(innerWidth>outerWidth){var offset=parseInt($("#jsxc_windowList>ul").css("right")),width=win.outerWidth(!0),right=innerWidth-win.position().left-width+offset,left=outerWidth-(innerWidth-win.position().left)-offset;0>left&&jsxc.gui.scrollWindowListBy(-1*left),0>right&&jsxc.gui.scrollWindowListBy(right)}},duration),jsxc.gui.window.scrollDown(bid),jsxc.restoreCompleted&&win.find(".jsxc_textinput").focus(),win.trigger("show.window.jsxc")},hide:function(bid){var hide=function(bid){jsxc.storage.updateUserItem("window",bid,"minimize",!0),jsxc.gui.window._hide(bid)};bid?hide(bid):$("#jsxc_windowList > ul > li").each(function(){var el=$(this);el.hasClass("jsxc_min")||hide(el.attr("data-bid"))})},_hide:function(bid){var win=jsxc.gui.window.get(bid);win.removeClass("jsxc_normal").addClass("jsxc_min"),win.find(".jsxc_window").css("bottom",-1*win.find(".jsxc_fade").height()),win.trigger("hidden.window.jsxc")},highlight:function(bid){var el=jsxc.gui.window.get(bid).find(" .jsxc_bar");el.is(":animated")||el.effect("highlight",{color:"orange"},2e3)},scrollDown:function(bid){var chat=jsxc.gui.window.get(bid).find(".jsxc_textarea");0!==chat.length&&chat.slimScroll({scrollTo:chat.get(0).scrollHeight+"px"})},postMessage:function(message){"object"!=typeof message||message instanceof jsxc.Message||(message=new jsxc.Message(message));var data=jsxc.storage.getUserItem("buddy",message.bid),html_msg=message.msg;message.msg=jsxc.removeHTML(message.msg),message.msg=jsxc.escapeHTML(message.msg),message.direction===jsxc.Message.OUT&&data.msgstate===OTR.CONST.MSGSTATE_FINISHED&&message.forwarded!==!0&&(message.direction=jsxc.Message.SYS,message.msg=jsxc.t("your_message_wasnt_send_please_end_your_private_conversation")),message.direction===jsxc.Message.OUT&&data.msgstate===OTR.CONST.MSGSTATE_FINISHED&&(message.direction="sys",message.msg=jsxc.t("unencrypted_message_received")+" "+message.msg),message.encrypted=message.encrypted||data.msgstate===OTR.CONST.MSGSTATE_ENCRYPTED;try{message.save()}catch(err){jsxc.warn("Unable to save message.",err),message=new jsxc.Message({msg:"Unable to save that message. Please clear some chat histories.",direction:jsxc.Message.SYS})}return"in"!==message.direction||jsxc.gui.window.get(message.bid).find(".jsxc_textinput").is(":focus")||(jsxc.gui.unreadMsg(message.bid),$(document).trigger("postmessagein.jsxc",[message.bid,html_msg])),message.direction===jsxc.Message.OUT&&jsxc.master&&message.forwarded!==!0&&html_msg&&jsxc.xmpp.sendMessage(message.bid,html_msg,message._uid),jsxc.gui.window._postMessage(message),"out"===message.direction&&"?"===message.msg&&jsxc.options.get("theAnswerToAnything")!==!1&&("undefined"==typeof jsxc.options.get("theAnswerToAnything")||100*Math.random()%42<1)&&(jsxc.options.set("theAnswerToAnything",!0),jsxc.gui.window.postMessage(new jsxc.Message({bid:message.bid,direction:jsxc.Message.SYS,msg:"42"}))),message},_postMessage:function(message,restore){var bid=message.bid,win=jsxc.gui.window.get(bid),msg=message.msg,direction=message.direction,uid=message._uid;win.find(".jsxc_userComposing").remove(),win.find(".jsxc_textinput").is(":not(:focus)")&&direction===jsxc.Message.IN&&!restore&&jsxc.gui.window.highlight(bid),msg=jsxc.ressources.processRessourcesInText(msg),$.each(jsxc.gui.emotions,function(i,val){msg=msg.replace(val[2],":"+val[1]+":")}),msg=jsxc.gui.shortnameToImage(msg),msg=msg.replace(/(\r\n|\r|\n)/g,"<br />");var msgDiv=$("<div>"),msgTsDiv=$("<div>");if(msgDiv.addClass("jsxc_chatmessage jsxc_"+direction),msgDiv.attr("id",uid.replace(/:/g,"-")),msgDiv.html("<div>"+msg+"</div>"),msgTsDiv.addClass("jsxc_timestamp"),msgTsDiv.text(jsxc.getFormattedTime(message.stamp)),message.isReceived()&&msgDiv.addClass("jsxc_received"),message.forwarded&&msgDiv.addClass("jsxc_forwarded"),message.encrypted&&msgDiv.addClass("jsxc_encrypted"),message.attachment&&message.attachment.name){var attachment=$("<div>");attachment.addClass("jsxc_attachment"),attachment.addClass("jsxc_"+message.attachment.type.replace(/\//,"-")),attachment.addClass("jsxc_"+message.attachment.type.replace(/^([^\/]+)\/.*/,"$1")),message.attachment.persistent===!1&&attachment.addClass("jsxc_notPersistent"),message.attachment.data&&attachment.addClass("jsxc_data"),message.attachment.type.match(/^image\//)&&message.attachment.thumbnail?$('<img alt="preview">').attr("src",message.attachment.thumbnail).attr("title",message.attachment.name).appendTo(attachment):attachment.text(message.attachment.name),message.attachment.data&&(attachment=$("<a>").append(attachment),attachment.attr("href",message.attachment.data),attachment.attr("download",message.attachment.name)),msgDiv.find("div").first().append(attachment)}if("sys"===direction?jsxc.gui.window.get(bid).find(".jsxc_textarea").append('<div style="clear:both"/>'):"undefined"!=typeof message.stamp&&msgDiv.append(msgTsDiv),"sys"!==direction&&$('[data-bid="'+bid+'"]').find(".jsxc_lastmsg .jsxc_text").html(jsxc.stripHtml(msg)),jsxc.Message.getDOM(uid).length>0?jsxc.Message.getDOM(uid).replaceWith(msgDiv):win.find(".jsxc_textarea").append(msgDiv),"object"==typeof message.sender&&null!==message.sender){var title="",avatarDiv=$("<div>");if(avatarDiv.addClass("jsxc_avatar").prependTo(msgDiv),"string"==typeof message.sender.jid){msgDiv.attr("data-bid",jsxc.jidToBid(message.sender.jid));var data=jsxc.storage.getUserItem("buddy",jsxc.jidToBid(message.sender.jid))||{};jsxc.gui.updateAvatar(msgDiv,jsxc.jidToBid(message.sender.jid),data.avatar),title=jsxc.jidToBid(message.sender.jid)}"string"==typeof message.sender.name&&(msgDiv.attr("data-name",message.sender.name),"string"!=typeof message.sender.jid&&jsxc.gui.avatarPlaceholder(avatarDiv,message.sender.name),""!==title&&(title="\n"+title),title=message.sender.name+title,msgTsDiv.text(msgTsDiv.text()+" "+message.sender.name)),avatarDiv.attr("title",jsxc.escapeHTML(title)),msgDiv.prev().length>0&&msgDiv.prev().find(".jsxc_avatar").attr("title")===avatarDiv.attr("title")&&avatarDiv.css("visibility","hidden")}jsxc.gui.detectUriScheme(win),jsxc.gui.detectEmail(win),jsxc.gui.window.scrollDown(bid)},setText:function(bid,text){jsxc.gui.window.get(bid).find(".jsxc_textinput").val(text)},restoreChat:function(bid){var chat=jsxc.storage.getUserItem("chat",bid);if(chat){for(;null!==chat&&chat.length>0;){var c=chat.pop();c.bid=bid,c._uid=c.uid,delete c.uid;var message=new jsxc.Message(c);message.save(),jsxc.gui.window._postMessage(message,!0)}jsxc.storage.removeUserItem("chat",bid)}for(var history=jsxc.storage.getUserItem("history",bid);null!==history&&history.length>0;){var uid=history.pop();jsxc.gui.window._postMessage(new jsxc.Message(uid),!0)}},clear:function(bid){jsxc.storage.removeUserItem("chat",bid);var history=jsxc.storage.getUserItem("history",bid)||[];history.map(function(id){jsxc.storage.removeUserItem("msg",id)}),jsxc.storage.setUserItem("history",bid,[]);var win=jsxc.gui.window.get(bid);win.length>0&&win.find(".jsxc_textarea").empty()},receivedMessage:function(bid,uid){jsxc.warn("Using deprecated receivedMessage.");var message=new jsxc.Message(uid);message.received()},updateProgress:function(message,sent,size){var div=message.getDOM(),span=div.find(".jsxc_timestamp span");0===span.length&&(div.find(".jsxc_timestamp").append("<span>"),span=div.find(".jsxc_timestamp span")),span.text(" "+Math.round(sent/size*100)+"%"),sent===size&&(span.remove(),message.received())},showOverlay:function(bid,content,allowClose){var win=jsxc.gui.window.get(bid);win.find(".jsxc_overlay .jsxc_body").empty().append(content),win.find(".jsxc_overlay .jsxc_close").off("click").click(function(){jsxc.gui.window.hideOverlay(bid)}),allowClose!==!0?win.find(".jsxc_overlay .jsxc_close").hide():win.find(".jsxc_overlay .jsxc_close").show(),win.addClass("jsxc_showOverlay")},hideOverlay:function(bid){var win=jsxc.gui.window.get(bid);win.removeClass("jsxc_showOverlay")},selectResource:function(bid,text,cb,res){if(res=res||jsxc.storage.getUserItem("res",bid)||[],cb=cb||function(){},res.length>0){var i,li,content=$("<div>"),list=$("<ul>");for(i=0;i<res.length;i++)li=$("<li>"),li.append($("<a>").text(res[i])),li.appendTo(list);list.find("a").click(function(ev){ev.preventDefault(),jsxc.gui.window.hideOverlay(bid),cb({status:"selected",result:$(this).text()})}),text&&$("<p>").text(text).appendTo(content),list.appendTo(content),jsxc.gui.window.showOverlay(bid,content)}else cb({status:"unavailable"})},smpRequest:function(bid,question){var content=$("<div>"),p=$("<p>");p.text(jsxc.t("smpRequestReceived")),p.appendTo(content);var abort=$("<button>");abort.text(jsxc.t("Abort")),abort.click(function(){jsxc.gui.window.hideOverlay(bid),jsxc.storage.removeUserItem("smp",bid),jsxc.master&&jsxc.otr.objects[bid]&&jsxc.otr.objects[bid].sm.abort()}),abort.appendTo(content);var verify=$("<button>");verify.text(jsxc.t("Verify")),verify.addClass("jsxc_btn jsxc_btn-primary"),verify.click(function(){jsxc.gui.window.hideOverlay(bid),jsxc.otr.onSmpQuestion(bid,question)}),verify.appendTo(content),jsxc.gui.window.showOverlay(bid,content)},sendFile:function(jid){var bid=jsxc.jidToBid(jid),win=jsxc.gui.window.get(bid),res=Strophe.getResourceFromJid(jid);if(!res){jid=win.data("jid"),res=Strophe.getResourceFromJid(jid);var fileCapableRes=jsxc.webrtc.getCapableRes(jid,jsxc.webrtc.reqFileFeatures),resources=Object.keys(jsxc.storage.getUserItem("res",bid))||[];if(null===res&&1===resources.length&&1===fileCapableRes.length)res=fileCapableRes[0],jid=bid+"/"+res;else if(fileCapableRes.indexOf(res)<0)return void jsxc.gui.window.selectResource(bid,jsxc.t("Your_contact_uses_multiple_clients_"),function(data){"unavailable"===data.status?jsxc.gui.window.hideOverlay(bid):"selected"===data.status&&jsxc.gui.window.sendFile(bid+"/"+data.result)},fileCapableRes)}var msg=$('<div><div><label><input type="file" name="files" /><label></div></div>');msg.addClass("jsxc_chatmessage"),jsxc.gui.window.showOverlay(bid,msg,!0),msg.find("label").click(),msg.find('[type="file"]').change(function(ev){var file=ev.target.files[0];if(file){var attachment=$("<div>");if(attachment.addClass("jsxc_attachment"),attachment.addClass("jsxc_"+file.type.replace(/\//,"-")),attachment.addClass("jsxc_"+file.type.replace(/^([^\/]+)\/.*/,"$1")),msg.empty().append(attachment),FileReader&&file.type.match(/^image\//)){var img=$('<img alt="preview">').attr("title",file.name);img.attr("src",jsxc.options.get("root")+"/img/loading.gif"),img.appendTo(attachment);var reader=new FileReader;reader.onload=function(){img.attr("src",reader.result)},reader.readAsDataURL(file)}else attachment.text(file.name+" ("+file.size+" byte)");$("<button>").addClass("jsxc_btn jsxc_btn-primary").text(jsxc.t("Send")).click(function(){var sess=jsxc.webrtc.sendFile(jid,file);jsxc.gui.window.hideOverlay(bid);var message=jsxc.gui.window.postMessage({_uid:sess.sid+":msg",bid:bid,direction:"out",attachment:{name:file.name,size:file.size,type:file.type,data:file.type.match(/^image\//)?img.attr("src"):null}});sess.sender.on("progress",function(sent,size){jsxc.gui.window.updateProgress(message,sent,size)}),msg.remove()}).appendTo(msg),$("<button>").addClass("jsxc_btn jsxc_btn-default").text(jsxc.t("Abort")).click(function(){jsxc.gui.window.hideOverlay(bid)}).appendTo(msg)}})}},jsxc.help={currentTutorial:null,tutorials:{},getAllTutorials:function(){var self=jsxc.help,res={};return $.each(self.tutorials,function(index,element){res[index]=element()}),res},launchTutorial:function(name){var self=jsxc.help;if(jsxc.stats.addEvent("jsxc.help.tutorial."+name),jsxc.debug("Launching tutorial",name),"undefined"==typeof self.tutorials[name])throw new Error("Invalid tutorial name: "+name);var tutorial=self.tutorials[name](),tour=new Shepherd.Tour({defaults:{classes:"shepherd-theme-default jsxc-help-tutorial-message",scrollTo:!0,showCancelLink:!0,buttons:[{text:"x",action:function(){Shepherd.activeTour.cancel()}},{text:"<",action:function(){Shepherd.activeTour.back()}},{text:">",action:function(){Shepherd.activeTour.next()}}]}});$.each(tutorial.steps,function(index,step){"undefined"==typeof step.title&&(step.title=tutorial.description),tour.addStep(step)}),tour.start()},init:function(){var self=jsxc.help;self.tutorials["interface"]=function(){return{description:"Visite de l'interface",steps:[{text:"<p>Vous allez découvrir les principaux élements de l'interface de la messagerie.</p>",beforeShowPromise:self._setAllGuiVisible.bind(self,!1)},{attachTo:{element:"#jsxc-chat-sidebar-content",on:"left"},text:["<p>Le <b>panneau de conversation</b> est disponible en bas de l'écran. Cliquez sur le bandeau bleu ou sur la croix pour le masquer.</p>","<p>A partir de cet élément, vous pouvez voir vos contacts, commencer une discussion ou une vidéoconférence.</p>"],beforeShowPromise:self._setAllGuiVisible.bind(self,!0)},{attachTo:{element:".jsxc-toggle-mediapanel",on:"top"},text:["<p>Le <b>panneau multimédia</b> est disponible en haut de l'écran. Cliquez sur son icone pour le faire apparaitre ou le masquer.</p>","<p>Sur ce panneau vous pouvez visualiser les flux vidéos de vos contacts ainsi que d'autres médias.</p>"],beforeShowPromise:self._setAllGuiVisible.bind(self,!0),when:{show:function(){self._highlightElement(".jsxc-toggle-mediapanel")}}},{attachTo:{element:"#jsxc-new-gui-filter-conversations",on:"left"},text:["<p>Les <b>filtres</b> permettent d'afficher ou de masquer les utilisateurs et les discussions</p>"],beforeShowPromise:self._setAllGuiVisible.bind(self,!0),when:{show:function(){self._highlightElement("#jsxc-new-gui-filter-conversations"),self._highlightElement("#jsxc-new-gui-filter-users")}}},{attachTo:{element:"#jsxc-sidebar-content-viewport",on:"left"},text:["<p>La <b>liste de contact</b> vous montre quels utilisateurs sont liés à vous.</p>","<p>Ces utilisateurs sont informés de votre présence, et sont notifiés lorsque vous leur envoyez un message.</p>"],when:{"before-show":function(){$("#jsxc-new-gui-filter-users").trigger("click")},show:function(){self._highlightElement("#jsxc_buddylist")}},beforeShowPromise:self._setAllGuiVisible.bind(self,!0)},{attachTo:{element:"#jsxc-toggle-actions",on:"top"},text:["<p>Le <b>menu principal</b> vous permet d'intéragir avec vos contacts.</p>","<p>Vous pouvez créer des conversations, appeler vos contacts ou visualiser vos notifications.</p>"],when:{"before-show":function(){$("#jsxc-toggle-actions").trigger("click")},show:function(){self._highlightElement("#jsxc-toggle-actions")}},beforeShowPromise:self._setAllGuiVisible.bind(self,!0),tetherOptions:{targetOffset:"-20px 0"}},{attachTo:{element:"#jsxc-select-buddies",on:"left"},text:["<p>Le <b>bouton de sélection</b> vous permet de sélectionner des contacts avec lesquels intéragir.</p>","<p>Le mode sélection vous permet de sélectionner plusieurs contacts.</p>"],when:{"before-show":function(){jsxc.newgui.chatSidebarContent.showMainContent(),setTimeout(function(){$("#jsxc-select-buddies").trigger("click")},700)},show:function(){self._highlightElement("#jsxc-select-buddies")}},beforeShowPromise:self._setAllGuiVisible.bind(self,!0)},{attachTo:{element:"#jsxc-chat-sidebar .jsxc-toggle-settings",on:"top"},text:["<p>Le <b>menu de réglages</b> vous permet de modifier le comportement de la messagerie.</p>","<p>Vous pouvez couper le son de la messagerie, masquer les notifications ou bloquer les appels vidéo.</p>"],when:{"before-show":function(){$("#jsxc-chat-sidebar .jsxc-toggle-settings").trigger("click")},show:function(){self._highlightElement(".jsxc-toggle-settings")}},beforeShowPromise:self._setAllGuiVisible.bind(self,!0)},{attachTo:{element:"#jsxc-status-bar",on:"left"},text:["<p>Le <b>panneau de statut</b> vous permet de modifier la manière dont les autres utilisateurs vous perçoivent.</p>","<p>A partir de ce panneau vous pouvez également vous déconnecter.</p>"],beforeShowPromise:self._setAllGuiVisible.bind(self,!0),when:{show:function(){self._highlightElement("#jsxc-status-bar")}}},{text:["<p>C'est la fin de cette visite !</p>"],beforeShowPromise:self._setAllGuiVisible.bind(self,!0)}]}}},_setChatSidebarVisible:function(state){var p=new Promise(function(resolve){jsxc.newgui.toggleChatSidebar(state,function(){resolve()})});return p},_setMediapanelVisible:function(state){var p=new Promise(function(resolve){
jsxc.newgui.toggleMediapanel(state,function(){resolve()})});return p},_clearAllWindows:function(){var p=new Promise(function(resolve,reject){jsxc.gui.closeAllChatWindows().then(function(){resolve()}).fail(function(){reject()})});return p},_setAllGuiVisible:function(state){var self=jsxc.help,promises=[self._setChatSidebarVisible(state),self._setMediapanelVisible(state)];return state||promises.push(self._clearAllWindows()),Promise.all(promises)},_highlightElement:function(selector){var jq=$(selector);if(jq.length<1)throw new Error("Invalid selector: "+selector);var previous=jq.css("opacity"),howManyTimes=6,i=0,interval=setInterval(function(){return i>howManyTimes?(clearInterval(interval),void jq.css({opacity:previous||""})):(jq.animate({opacity:i%2===0?.1:1},400),void i++)},500)}},jsxc.localization={init:function(){var lang;lang=null!==jsxc.storage.getItem("lang")?jsxc.storage.getItem("lang"):jsxc.options.autoLang&&navigator.language?navigator.language.substr(0,2):jsxc.options.defaultLang,jsxc.stats.addEvent("jsxc.lang."+lang),jsxc.i18n=__webpack_require__(2),jsxc.t=jsxc.i18n.translate,jsxc.i18n.init({lng:lang,fallbackLng:"en",resStore:chatclient_I18next_ressource_store,useLocalStorage:!0,localStorageExpirationTime:864e5,debug:jsxc.storage.getItem("debug")===!0})},processHtmlString:function(str,options){var o=jsxc.i18n.options;return $(str).each(function(){jsxc.localization._localize($(this),options);var elements=$(this).find("["+o.selectorAttr+"]");elements.each(function(){jsxc.localization._localize($(this),options)})})},_parse:function(ele,key,options){var o=jsxc.i18n.options;if(0!==key.length){var attr="text";if(0===key.indexOf("[")){var parts=key.split("]");key=parts[1],attr=parts[0].substr(1,parts[0].length-1)}key.indexOf(";")===key.length-1&&(key=key.substr(0,key.length-2));var optionsToUse;if("html"===attr)optionsToUse=o.defaultValueFromContent?$.extend({defaultValue:ele.html()},options):options,ele.html(jsxc.t(key,optionsToUse));else if("text"===attr)optionsToUse=o.defaultValueFromContent?$.extend({defaultValue:ele.text()},options):options,ele.text(jsxc.t(key,optionsToUse));else if("prepend"===attr)optionsToUse=o.defaultValueFromContent?$.extend({defaultValue:ele.html()},options):options,ele.prepend(jsxc.t(key,optionsToUse));else if("append"===attr)optionsToUse=o.defaultValueFromContent?$.extend({defaultValue:ele.html()},options):options,ele.append(jsxc.t(key,optionsToUse));else if(0===attr.indexOf("data-")){var dataAttr=attr.substr("data-".length);optionsToUse=o.defaultValueFromContent?$.extend({defaultValue:ele.data(dataAttr)},options):options;var translated=jsxc.t(key,optionsToUse);ele.data(dataAttr,translated),ele.attr(attr,translated)}else optionsToUse=o.defaultValueFromContent?$.extend({defaultValue:ele.attr(attr)},options):options,ele.attr(attr,jsxc.t(key,optionsToUse))}},_localize:function(ele,options){var o=jsxc.i18n.options,key=ele.attr(o.selectorAttr);if(key||"undefined"==typeof key||key===!1||(key=ele.text()||ele.val()),key){var target=ele,targetSelector=ele.data("i18n-target");if(targetSelector&&(target=ele.find(targetSelector)||ele),options||o.useDataAttrOptions!==!0||(options=ele.data("i18n-options")),options=options||{},key.indexOf(";")>=0){var keys=key.split(";");$.each(keys,function(m,k){""!==k&&jsxc.localization._parse(target,k,options)})}else jsxc.localization._parse(target,key,options);o.useDataAttrOptions===!0&&ele.data("i18n-options",options)}}},jsxc.mmstream.testCases=[{name:"Video participants selection",testCase:function(assert){var self=jsxc.mmstream,remi="remi@heydjoe.xmpp/eeee",david="david@heydjoe.xmpp/eeee",yohann="yohann@heydjoe.xmpp/eeee",participants=[david,yohann],computed1={remi:jsxc.mmstream._whichUsersMustWeCall(remi,participants,remi),david:jsxc.mmstream._whichUsersMustWeCall(remi,participants,david),yohann:jsxc.mmstream._whichUsersMustWeCall(remi,participants,yohann)},result1={remi:["yohann@heydjoe.xmpp/eeee","david@heydjoe.xmpp/eeee"],david:[],yohann:["david@heydjoe.xmpp/eeee"]};assert.ok(JSON.stringify(computed1)===JSON.stringify(result1),"Destinations selection ok (demo)");var domain="@domain.xmpp",nodes=["a","b","c","d","f","g","h","i"];participants=[];var initiator="e"+domain;$.each(nodes,function(index,node){participants.push(node+domain)});var computed2={};$.each(participants.concat([initiator]),function(index,part){computed2[part]=self._whichUsersMustWeCall(initiator,participants,part)});var expected2={"a@domain.xmpp":["b@domain.xmpp","c@domain.xmpp","d@domain.xmpp"],"b@domain.xmpp":["c@domain.xmpp","d@domain.xmpp"],"c@domain.xmpp":["d@domain.xmpp"],"d@domain.xmpp":[],"f@domain.xmpp":["g@domain.xmpp","h@domain.xmpp","i@domain.xmpp","a@domain.xmpp","b@domain.xmpp","c@domain.xmpp","d@domain.xmpp"],"g@domain.xmpp":["h@domain.xmpp","i@domain.xmpp","a@domain.xmpp","b@domain.xmpp","c@domain.xmpp","d@domain.xmpp"],"h@domain.xmpp":["i@domain.xmpp","a@domain.xmpp","b@domain.xmpp","c@domain.xmpp","d@domain.xmpp"],"i@domain.xmpp":["a@domain.xmpp","b@domain.xmpp","c@domain.xmpp","d@domain.xmpp"],"e@domain.xmpp":["f@domain.xmpp","g@domain.xmpp","h@domain.xmpp","i@domain.xmpp","a@domain.xmpp","b@domain.xmpp","c@domain.xmpp","d@domain.xmpp"]};assert.ok(JSON.stringify(computed2)===JSON.stringify(expected2),"Destinations selection (complete)")}},{name:"Utility methods for videoconference",testCase:function(assert){var self=jsxc.mmstream,user="a@domain.xmpp/heyhey";self._setUserStatus(user,self.USER_STATUS.READY),assert.ok(self._isBuddyReady(user)===!0,"test status = READY"),self._setUserType(user,self.USER_TYPE.VIDEOCONF_INITIATOR),assert.ok(self._isBuddyParticipatingToVideoconference(user)===!0," test status = PARTICIPATING 1"),self._setUserType(user,self.USER_TYPE.VIDEOCONF_PARTICIPANT),assert.ok(self._isBuddyParticipatingToVideoconference(user)===!0," test status = PARTICIPATING 2"),self._setUserStatus(user,self.USER_STATUS.REJECTED),assert.ok(self._isBuddyParticipatingToVideoconference(user)!==!0," test status = PARTICIPATING 3"),delete self.multimediacache.users[user]}}],$(function(){}),jsxc.muc={conn:null,CONST:{AFFILIATION:{ADMIN:"statVisualition",MEMBER:"member",OUTCAST:"outcast",OWNER:"owner",NONE:"none"},ROLE:{MODERATOR:"moderator",PARTICIPANT:"participant",VISITOR:"visitor",NONE:"none"},ROOMSTATE:{INIT:0,ENTERED:1,EXITED:2,AWAIT_DESTRUCTION:3,DESTROYED:4},ROOMCONFIG:{INSTANT:"instant"}},init:function(o){var self=jsxc.muc;self.conn=jsxc.xmpp.conn;var options=o||jsxc.options.get("muc");return options&&"string"==typeof options.server?(jsxc.gui.roster.ready?self.initMenu():$(document).one("ready.roster.jsxc",jsxc.muc.initMenu),$(document).on("presence.jsxc",jsxc.muc.onPresence),$(document).on("error.presence.jsxc",jsxc.muc.onPresenceError),self.conn.addHandler(self.onGroupchatMessage,null,"message","groupchat"),self.conn.addHandler(self.onErrorMessage,null,"message","error"),void(self.conn.muc.roomNames=jsxc.storage.getUserItem("roomNames")||[])):(jsxc.debug("Discover muc service"),void setTimeout(function(){self.conn.disco.items(Strophe.getDomainFromJid(self.conn.jid),null,function(items){$(items).find("item").each(function(){var jid=$(this).attr("jid"),discovered=!1;return self.conn.disco.info(jid,null,function(info){var mucFeature=$(info).find('feature[var="'+Strophe.NS.MUC+'"]'),mucIdentity=$(info).find('identity[category="conference"][type="text"]');mucFeature.length>0&&mucIdentity.length>0&&(jsxc.debug("muc service found",jid),jsxc.options.set("muc",{server:jid,name:$(info).find("identity").attr("name")}),discovered=!0,self.init())}),!discovered})})},1e3))},initMenu:function(){var li=$("<li>").attr("class","jsxc_joinChat jsxc_groupcontacticon").text(jsxc.t("Join_chat"));li.click(jsxc.muc.showJoinChat),$("#jsxc_menu ul .jsxc_about").before(li)},showJoinChat:function(r,p){var self=jsxc.muc,dialog=jsxc.gui.dialog.open(jsxc.gui.template.get("joinChat"));dialog.find(".jsxc_join").hide(),"string"==typeof r&&dialog.find("#jsxc_room").val(r),"string"==typeof p&&dialog.find("#jsxc_password").val(p),dialog.find("#jsxc_server").val(jsxc.options.get("muc").server);var error_handler=function(event,condition,room){var msg;switch(condition){case"not-authorized":msg=jsxc.t("A_password_is_required");break;case"registration-required":msg=jsxc.t("You_are_not_on_the_member_list");break;case"forbidden":msg=jsxc.t("You_are_banned_from_this_room");break;case"conflict":msg=jsxc.t("Your_desired_nickname_");break;case"service-unavailable":msg=jsxc.t("The_maximum_number_");break;case"item-not-found":msg=jsxc.t("This_room_is_locked_");break;case"not-allowed":msg=jsxc.t("You_are_not_allowed_to_create_");break;default:jsxc.warn("Unknown muc error condition: "+condition),msg=jsxc.t("Error")+": "+condition}var roomIndex=self.conn.muc.roomNames.indexOf(room);roomIndex>-1&&(self.conn.muc.roomNames.splice(roomIndex,1),delete self.conn.muc.rooms[room]),dialog.find(".jsxc_warning").text(msg)};$(document).on("error.muc.jsxc",error_handler),$(document).on("close.dialog.jsxc",function(){$(document).off("error.muc.jsxc",error_handler)}),self.conn.muc.listRooms(jsxc.options.get("muc").server,function(stanza){$("#jsxc_roomlist option:last").remove(),$(stanza).find("item").each(function(){var r=$("<option>"),rjid=$(this).attr("jid").toLowerCase(),rnode=Strophe.getNodeFromJid(rjid),rname=$(this).attr("name")||rnode;r.text(rname),r.attr("data-jid",rjid),r.attr("value",rnode),$("#jsxc_roomlist select").append(r)});var set=$(stanza).find('set[xmlns="http://jabber.org/protocol/rsm"]');if(set.length>0){var count=set.find("count").text()||"?";dialog.find(".jsxc_inputinfo").removeClass("jsxc_waiting").text(jsxc.t("Could_load_only",{count:count}))}else dialog.find(".jsxc_inputinfo").hide()},function(){jsxc.warn("Could not load rooms"),dialog.find(".jsxc_inputinfo").hide()}),dialog.find("#jsxc_nickname").attr("placeholder",Strophe.getNodeFromJid(self.conn.jid)),dialog.find("#jsxc_bookmark").change(function(){$(this).prop("checked")?($("#jsxc_autojoin").prop("disabled",!1),$("#jsxc_autojoin").parent(".checkbox").removeClass("disabled")):($("#jsxc_autojoin").prop("disabled",!0).prop("checked",!1),$("#jsxc_autojoin").parent(".checkbox").addClass("disabled"))}),dialog.find(".jsxc_continue").click(function(ev){ev.preventDefault();var room=$("#jsxc_room").val()?jsxc.jidToBid($("#jsxc_room").val()):null,nickname=$("#jsxc_nickname").val()||Strophe.getNodeFromJid(self.conn.jid),password=$("#jsxc_password").val()||null;if(!room||!room.match(/^[^"&\'\/:<>@\s]+$/i))return $("#jsxc_room").addClass("jsxc_invalid").keyup(function(){$(this).val()&&$(this).removeClass("jsxc_invalid")}),!1;if(room.match(/@(.*)$/)||(room+="@"+jsxc.options.get("muc").server),jsxc.xmpp.conn.muc.roomNames.indexOf(room)<0){var discoReceived=function(roomName,subject){jsxc.gui.dialog.resize(),dialog.find(".jsxc_continue").hide(),dialog.find(".jsxc_join").show().effect("highlight",{color:"green"},4e3),dialog.find(".jsxc_join").click(function(ev){ev.preventDefault();var bookmark=$("#jsxc_bookmark").prop("checked"),autojoin=$("#jsxc_autojoin").prop("checked");return jsxc.gui.window.clear(room),jsxc.storage.setUserItem("member",room,{}),self.join(room,nickname,password,roomName,subject,bookmark,autojoin),!1})};dialog.find(".jsxc_msg").append($("<p>").text(jsxc.t("Loading_room_information")).addClass("jsxc_waiting")),jsxc.gui.dialog.resize(),self.conn.disco.info(room,null,function(stanza){dialog.find(".jsxc_msg").html("<p>"+jsxc.t("This_room_is")+"</p>");var table=$("<table>");$(stanza).find("feature").each(function(){var feature=$(this).attr("var");if(""!==feature&&jsxc.i18n.exists(feature)){var tr=$("<tr>");$("<td>").text(feature).appendTo(tr),tr.appendTo(table)}}),dialog.find(".jsxc_msg").append(table);var roomName=$(stanza).find("identity").attr("name"),subject=$(stanza).find('field[var="muc#roominfo_subject"]').attr("label");discoReceived(roomName,subject)},function(){dialog.find(".jsxc_msg").empty(),$("<p>").text(jsxc.t("Room_not_found_")).appendTo(dialog.find(".jsxc_msg")),discoReceived()})}else dialog.find(".jsxc_warning").text(jsxc.t("You_already_joined_this_room"));return!1}),dialog.find("input").keydown(function(ev){return 13!==ev.which?(dialog.find(".jsxc_warning").empty(),void(dialog.find(".jsxc_continue").is(":hidden")&&(dialog.find(".jsxc_continue").show(),dialog.find(".jsxc_join").hide().off("click"),dialog.find(".jsxc_msg").empty(),jsxc.gui.dialog.resize()))):void(dialog.find(".jsxc_continue").is(":hidden")?dialog.find(".jsxc_join").click():dialog.find(".jsxc_continue").click())})},showRoomConfiguration:function(room){var self=jsxc.muc;self.conn.muc.configure(room,function(stanza){var form=Strophe.x.Form.fromXML(stanza);window.f=form,self._showRoomConfiguration(room,form)},function(){jsxc.debug("Could not load room configuration")})},_showRoomConfiguration:function(room,config){var self=jsxc.muc,dialog=jsxc.gui.dialog.open(jsxc.muc.helper.formToHTML(config)),form=dialog.find("form"),submit=$("<button>");submit.addClass("btn btn-primary"),submit.attr("type","submit"),submit.text(jsxc.t("Join"));var cancel=$("<button>");cancel.addClass("btn btn-default"),cancel.attr("type","button"),cancel.text(jsxc.t("Cancel"));var formGroup=$("<div>");formGroup.addClass("form-group"),$("<div>").addClass("col-sm-offset-6 col-sm-6").appendTo(formGroup),formGroup.find(">div").append(cancel),formGroup.find(">div").append(submit),form.append(formGroup),form.submit(function(ev){ev.preventDefault();var config=Strophe.x.Form.fromHTML(form.get(0));return self.conn.muc.saveConfiguration(room,config,function(){jsxc.storage.updateUserItem("buddy",room,"config",config),jsxc.debug("Room configuration saved.")},function(){jsxc.warn("Could not save room configuration.")}),jsxc.gui.dialog.close(),!1}),cancel.click(function(){self.conn.muc.cancelConfigure(room),jsxc.gui.dialog.close()})},join:function(room,nickname,password,roomName,subject,bookmark,autojoin,additionnalDatas){var self=jsxc.muc;if("undefined"==typeof room)throw new Error("Illegal argument for room name: ",{arguments:arguments});var datas={jid:room,name:roomName||room,sub:"both",type:"groupchat",state:self.CONST.ROOMSTATE.INIT,subject:subject,bookmarked:bookmark||!1,autojoin:autojoin||!1,nickname:nickname,config:null};additionnalDatas&&$.extend(datas,additionnalDatas),jsxc.storage.setUserItem("buddy",room,datas),jsxc.xmpp.conn.muc.join(room,nickname,null,null,null,password),bookmark&&jsxc.xmpp.bookmarks.add(room,roomName,nickname,autojoin)},leave:function(room){var self=jsxc.muc,own=jsxc.storage.getUserItem("ownNicknames")||{},data=jsxc.storage.getUserItem("buddy",room)||{};data.state===self.CONST.ROOMSTATE.ENTERED?self.conn.muc.leave(room,own[room],function(){self.onExited(room)}):self.onExited(room)},onExited:function(room){var self=jsxc.muc,own=jsxc.storage.getUserItem("ownNicknames")||{},roomdata=jsxc.storage.getUserItem("buddy",room)||{};jsxc.storage.setUserItem("roomNames",self.conn.muc.roomNames),delete own[room],jsxc.storage.setUserItem("ownNicknames",own),jsxc.storage.removeUserItem("member",room),jsxc.storage.removeUserItem("chat",room),jsxc.gui.window.close(room),jsxc.storage.updateUserItem("buddy",room,"state",self.CONST.ROOMSTATE.EXITED),roomdata.bookmarked||jsxc.gui.roster.purge(room)},destroy:function(room,handler_cb,error_cb){var self=jsxc.muc,roomdata=jsxc.storage.getUserItem("buddy",room);jsxc.storage.updateUserItem("buddy",room,"state",self.CONST.ROOMSTATE.AWAIT_DESTRUCTION),jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("This_room_will_be_closed")});var iq=$iq({to:room,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("destroy");jsxc.muc.conn.sendIQ(iq.tree(),handler_cb,error_cb),roomdata.bookmarked&&jsxc.xmpp.bookmarks["delete"](room)},close:function(room){var self=jsxc.muc,roomdata=jsxc.storage.getUserItem("buddy",room)||{};self.emptyMembers(room);var roomIndex=self.conn.muc.roomNames.indexOf(room);roomIndex>-1&&(self.conn.muc.roomNames.splice(roomIndex,1),delete self.conn.muc.rooms[room]),jsxc.storage.setUserItem("roomNames",self.conn.muc.roomNames),roomdata.state===self.CONST.ROOMSTATE.AWAIT_DESTRUCTION&&self.onExited(room),roomdata.state=self.CONST.ROOMSTATE.DESTROYED,jsxc.storage.setUserItem("buddy",room,roomdata)},initWindow:function(event,win){var self=jsxc.muc;if(!jsxc.xmpp.conn)return void $(document).one("attached.jsxc",function(){self.initWindow(null,win)});var data=win.data(),bid=jsxc.jidToBid(data.jid),roomdata=jsxc.storage.getUserItem("buddy",bid);if("groupchat"===roomdata.type){win.addClass("jsxc_groupchat");var own=jsxc.storage.getUserItem("ownNicknames")||{},ownNickname=own[bid],mlIcon=$('<div class="jsxc_members"></div>');win.find(".jsxc_tools > .jsxc_settings").after(mlIcon);var ml=$('<div class="jsxc_memberlist"><ul></ul></div>');win.find(".jsxc_fade").prepend(ml),ml.on("wheel",function(ev){jsxc.muc.scrollMemberListBy(bid,ev.originalEvent.wheelDelta>0?50:-50)});var toggleMl=function(ev){ev&&ev.preventDefault();var slimOptions={},ul=ml.find("ul:first"),slimHeight=null;if(ml.toggleClass("jsxc_expand"),ml.hasClass("jsxc_expand")){$("body").click(),$("body").one("click",toggleMl),ul.mouseleave(function(){ul.data("timer",window.setTimeout(toggleMl,2e3))}).mouseenter(function(){window.clearTimeout(ul.data("timer"))}).css("left","0px");var maxHeight=.8*win.find(".jsxc_textarea").height(),innerHeight=ml.find("ul").height()+3;slimHeight=innerHeight>maxHeight?maxHeight:innerHeight,slimOptions={distance:"3px",height:slimHeight+"px",width:"100%",color:"#fff",opacity:"0.5"},ml.css("height",slimHeight+"px")}else slimOptions={destroy:!0},ul.attr("style",""),ml.css("height",""),window.clearTimeout(ul.data("timer")),$("body").off("click",null,toggleMl),ul.off("mouseleave mouseenter");return ul.slimscroll(slimOptions),!1};mlIcon.click(toggleMl),win.on("resize",function(){jsxc.muc.scrollMemberListBy(bid,0)});var settingsList=win.find(".jsxc_settings ul"),inviteLink=$('<a class="jsxc_inviteUsers"><span>Inviter des utilisateurs</span></a>');inviteLink.click(function(){jsxc.gui.showSelectContactsDialog().then(function(jids){jids.length<1&&jsxc.gui.feedback("Vous devez sélectionner au moins un contact"),jsxc.muc.inviteParticipants(win.data("bid"),jids);var invited=[];$.each(jids,function(index,jid){invited.push(Strophe.getNodeFromJid(jid))}),invited.length<2?jsxc.gui.feedback("<b>"+invited[0]+"</b> à été invité"):jsxc.gui.feedback("Les utilisateurs suivant ont été invités: <b>"+invited.join(", ")+"</b>")}).fail(function(){jsxc.gui.feedback("Opération annulée")})}),settingsList.prepend($("<li>").append(inviteLink));var padLink=$('<a class="jsxc_openpad"><span>Ouvrir un pad</span></a>');padLink.click(function(){jsxc.gui.feedback("Pad en cours d'ouverture ...");var padId=bid.substr(0,26).replace(/[^a-z0-9]+/gi,"")+"_"+jsxc.sha1.hash(bid).substr(0,22);padId=padId.toLocaleLowerCase(),jsxc.etherpad.openpad(padId)}),settingsList.prepend($("<li>").append(padLink));var destroy=$("<a>");if(destroy.text(jsxc.t("Destroy")),destroy.addClass("jsxc_destroy"),destroy.hide(),destroy.click(function(){self.destroy(bid)}),settingsList.append($("<li>").append(destroy)),roomdata.state>self.CONST.ROOMSTATE.INIT){var member=jsxc.storage.getUserItem("member",bid)||{};$.each(member,function(nickname,val){self.insertMember(bid,nickname,val),nickname===ownNickname&&val.affiliation===self.CONST.AFFILIATION.OWNER&&destroy.show()})}var leave=$("<a>");leave.text(jsxc.t("Leave")),leave.addClass("jsxc_leave"),leave.click(function(){self.leave(bid)}),win.find(".jsxc_settings ul").append($("<li>").append(leave))}},onPresence:function(event,from,status,presence){if(!from)return!0;var self=jsxc.muc,room=jsxc.jidToBid(from),roomdata=jsxc.storage.getUserItem("buddy",room),xdata=$(presence).find('x[xmlns^="'+Strophe.NS.MUC+'"]');if(self.conn.muc.roomNames.indexOf(room)<0||0===xdata.length)return!0;var res=Strophe.getResourceFromJid(from)||"",nickname=Strophe.unescapeNode(res),own=jsxc.storage.getUserItem("ownNicknames")||{},member=jsxc.storage.getUserItem("member",room)||{},codes=[];if(xdata.find("status").each(function(){var code=$(this).attr("code");jsxc.debug("[muc][code]",code),codes.push(code)}),roomdata.state===self.CONST.ROOMSTATE.INIT){if(jsxc.storage.setUserItem("roomNames",jsxc.xmpp.conn.muc.roomNames),jsxc.gui.roster.getItem(room).length<1){var bl=jsxc.storage.getUserItem("buddylist");bl.push(room),jsxc.storage.setUserItem("buddylist",bl),jsxc.gui.roster.add(room)}$("#jsxc_dialog").length>0&&(jsxc.gui.window.open(room),jsxc.gui.dialog.close())}var jid=xdata.find("item").attr("jid")||null;if(0===status)if(xdata.find("destroy").length>0)member={},jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("This_room_has_been_closed")}),self.close(room);else{delete member[nickname],self.removeMember(room,nickname);var newNickname=xdata.find("item").attr("nick");codes.indexOf("303")>-1&&newNickname?(newNickname=Strophe.unescapeNode(newNickname),member[newNickname]={},jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("is_now_known_as",{oldNickname:nickname,newNickname:newNickname,escapeInterpolation:!0})})):(0===codes.length||1===codes.length&&codes.indexOf("110")>-1)&&jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("left_the_building",{nickname:nickname,escapeInterpolation:!0})})}else!member[nickname]&&own[room]&&jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("entered_the_room",{nickname:nickname,escapeInterpolation:!0})}),member[nickname]={jid:jid,status:status,roomJid:from,affiliation:xdata.find("item").attr("affiliation"),role:xdata.find("item").attr("role")},self.insertMember(room,nickname,member[nickname]);return jsxc.storage.setUserItem("member",room,member),$.each(codes,function(index,code){"function"==typeof self.onStatus[code]&&self.onStatus[code].call(this,room,nickname,member[nickname]||{},xdata),$(document).trigger("status.muc.jsxc",[code,room,nickname,member[nickname]||{},presence])}),!0},onPresenceError:function(event,from,presence){if(!from)return!0;var self=jsxc.muc,xdata=$(presence).find('x[xmlns="'+Strophe.NS.MUC+'"]'),room=jsxc.jidToBid(from);if(0===xdata.length||self.conn.muc.roomNames.indexOf(room)<0)return!0;var error=$(presence).find("error"),condition=error.children()[0].tagName;return jsxc.debug("[muc][error]",condition),$(document).trigger("error.muc.jsxc",[condition,room]),!0},onStatus:{110:function(room,nickname,data){var self=jsxc.muc,own=jsxc.storage.getUserItem("ownNicknames")||{};own[room]=nickname,jsxc.storage.setUserItem("ownNicknames",own),data.affiliation===self.CONST.AFFILIATION.OWNER&&jsxc.gui.window.get(room).find(".jsxc_destroy").show();var roomdata=jsxc.storage.getUserItem("buddy",room);roomdata.state===self.CONST.ROOMSTATE.INIT&&(roomdata.state=self.CONST.ROOMSTATE.ENTERED,jsxc.storage.setUserItem("buddy",room,roomdata))},170:function(room){jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("Room_logging_is_enabled")})},171:function(room){jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("Room_logging_is_disabled")})},172:function(room){jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("Room_is_now_non-anoymous")})},173:function(room){jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("Room_is_now_semi-anonymous")})},201:function(room){var self=jsxc.muc,roomdata=jsxc.storage.getUserItem("buddy",room)||{};roomdata.autojoin&&roomdata.config===self.CONST.ROOMCONFIG.INSTANT?self.conn.muc.createInstantRoom(room):roomdata.autojoin&&"undefined"!=typeof roomdata.config&&null!==roomdata.config?self.conn.muc.saveConfiguration(room,roomdata.config,function(){jsxc.debug("Cached room configuration saved.")},function(){jsxc.warn("Could not save cached room configuration.")}):self.conn.muc.configure(room,function(stanza){self._configureChatRoom(room,stanza)},function(response){jsxc.warn("Error while loading room configuration",response),jsxc.gui.feedback("Erreur lors de la configuration de la discussion")})},301:function(room,nickname,data,xdata){var own=jsxc.storage.getUserItem("ownNicknames")||{};own[room]===nickname?(jsxc.muc.close(room),jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("muc_removed_banned")}),jsxc.muc.postReason(room,xdata)):jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("muc_removed_info_banned",{nickname:nickname,escapeInterpolation:!0})})},307:function(room,nickname,data,xdata){var own=jsxc.storage.getUserItem("ownNicknames")||{};own[room]===nickname?(jsxc.muc.close(room),jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("muc_removed_kicked")}),jsxc.muc.postReason(room,xdata)):jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("muc_removed_info_kicked",{nickname:nickname,escapeInterpolation:!0})})},321:function(room,nickname){var own=jsxc.storage.getUserItem("ownNicknames")||{};own[room]===nickname?(jsxc.muc.close(room),jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("muc_removed_affiliation")})):jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("muc_removed_info_affiliation",{nickname:nickname,escapeInterpolation:!0})})},322:function(room,nickname){var own=jsxc.storage.getUserItem("ownNicknames")||{};own[room]===nickname?(jsxc.muc.close(room),jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("muc_removed_membersonly")})):jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("muc_removed_info_membersonly",{nickname:nickname,escapeInterpolation:!0})})},332:function(room){jsxc.muc.close(room),jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("muc_removed_shutdown")})}},_configureChatRoom:function(room,stanza){var self=jsxc.muc,roomdata=jsxc.storage.getUserItem("buddy",room)||{},fieldValues={"muc#roomconfig_roomname":roomdata.name,"muc#roomconfig_roomdesc":roomdata.subject,"muc#roomconfig_changesubject":"0","muc#roomconfig_maxusers":"0","muc#roomconfig_presencebroadcast":"visitor","muc#roomconfig_publicroom":"0","muc#roomconfig_persistentroom":"1","muc#roomconfig_moderatedroom":"0","muc#roomconfig_membersonly":"0","muc#roomconfig_allowinvites":"1","muc#roomconfig_passwordprotectedroom":"0","muc#roomconfig_whois":"anyone","muc#roomconfig_enablelogging":"1","x-muc#roomconfig_canchangenick":"0","x-muc#roomconfig_registration":"0"},form=Strophe.x.Form.fromXML(stanza);form?$.each(form.fields,function(index,item){"undefined"!=typeof fieldValues[item["var"]]&&(item.values=[fieldValues[item["var"]]])}):form=fieldValues,self.conn.muc.saveConfiguration(room,form,function(){jsxc.storage.updateUserItem("buddy",room,"config",form)},function(response){jsxc.warn("Error while configuring room",response),jsxc.gui.feedback("Erreur lors de la création de la discussion")})},inviteParticipants:function(room,jidArray){var self=jsxc.muc;jsxc.debug("Invitation sent: ",{room:room,jidArray:jidArray}),$.each(jidArray,function(index,jid){jsxc.stats.addEvent("jsxc.muc.invitation.sent"),self.conn.muc.directInvite(room,jid,"Vous êtes invité à rejoindre une conversation")})},postReason:function(room,xdata){var actor={name:xdata.find("actor").attr("nick"),jid:xdata.find("actor").attr("jid")},reason=xdata.find("reason").text();""!==reason&&(reason=jsxc.t("Reason")+": "+reason,"string"==typeof actor.name||"string"==typeof actor.jid?jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.IN,msg:reason,sender:actor}):jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:reason}))},insertMember:function(room,nickname,memberdata){var self=jsxc.muc,win=jsxc.gui.window.get(room),jid=memberdata.jid,m=win.find('.jsxc_memberlist li[data-nickname="'+nickname+'"]');if(0===m.length){var title=jsxc.escapeHTML(nickname);if(m=$('<li><div class="jsxc_avatar"></div><div class="jsxc_name"/></li>'),m.attr("data-nickname",nickname),win.find(".jsxc_memberlist ul").append(m),"string"==typeof jid){m.find(".jsxc_name").text(jsxc.jidToBid(jid)),m.attr("data-bid",jsxc.jidToBid(jid)),title=title+"\n"+jsxc.jidToBid(jid);var data=jsxc.storage.getUserItem("buddy",jsxc.jidToBid(jid));null!==data&&"object"==typeof data?jsxc.gui.updateAvatar(m,jsxc.jidToBid(jid),data.avatar):jsxc.jidToBid(jid)===jsxc.jidToBid(self.conn.jid)&&jsxc.gui.updateAvatar(m,jsxc.jidToBid(jid),"own")}else m.find(".jsxc_name").text(nickname),jsxc.gui.avatarPlaceholder(m.find(".jsxc_avatar"),nickname);m.attr("title",title)}},removeMember:function(room,nickname){var win=jsxc.gui.window.get(room),m=win.find('.jsxc_memberlist li[data-nickname="'+nickname+'"]');m.length>0&&m.remove()},scrollMemberListBy:function(room,offset){var win=jsxc.gui.window.get(room);if(!win.find(".jsxc_memberlist").hasClass("jsxc_expand")){var el=win.find(".jsxc_memberlist ul:first"),scrollWidth=el.width(),width=win.find(".jsxc_memberlist").width(),left=parseInt(el.css("left"));left=isNaN(left)?0-offset:left-offset,width>scrollWidth||left>0?left=0:width-scrollWidth>left&&(left=width-scrollWidth),el.css("left",left+"px")}},emptyMembers:function(room){var win=jsxc.gui.window.get(room);win.find(".jsxc_memberlist").empty(),jsxc.storage.setUserItem("member",room,{})},onGroupchatMessage:function(message){var id=$(message).attr("id");if(id&&jsxc.el_exists(jsxc.Message.getDOM(id)))return!0;var from=$(message).attr("from"),body=$(message).find("body:first").text(),room=jsxc.jidToBid(from),nickname=Strophe.unescapeNode(Strophe.getResourceFromJid(from));if(""!==body){var delay=$(message).find('delay[xmlns="urn:xmpp:delay"]'),stamp=delay.length>0?new Date(delay.attr("stamp")):new Date;stamp=stamp.getTime();var member=jsxc.storage.getUserItem("member",room)||{},sender={};sender.name=nickname,member[nickname]&&"string"==typeof member[nickname].jid&&(sender.jid=member[nickname].jid),jsxc.gui.window.init(room),jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.IN,msg:body,stamp:stamp,sender:sender})}var subject=$(message).find("subject");if(subject.length>0){var roomdata=jsxc.storage.getUserItem("buddy",room);roomdata.subject=subject.text(),jsxc.storage.setUserItem("buddy",room,roomdata),jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("changed_subject_to",{nickname:nickname,subject:subject.text()})})}return!0},onErrorMessage:function(message){var room=jsxc.jidToBid($(message).attr("from"));return 0===jsxc.gui.window.get(room).length?!0:($(message).find("item-not-found").length>0?jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("message_not_send_item-not-found")}):$(message).find("forbidden").length>0?jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("message_not_send_forbidden")}):$(message).find("not-acceptable").length>0?jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("message_not_send_not-acceptable")}):jsxc.gui.window.postMessage({bid:room,direction:jsxc.Message.SYS,msg:jsxc.t("message_not_send")}),jsxc.debug("[muc] error message for "+room,$(message).find("error")[0]),!0)},createNewConversationWith:function(buddies,title,subject){jsxc.stats.addEvent("jsxc.muc.conversation.new"),jsxc.debug("New conversation created",{buddies:buddies,title:title,subject:subject});var d=new Date;if(!title||title.length<1){var userNodeArray=[jsxc.xmpp.getCurrentNode()];$.each(buddies,function(index,item){userNodeArray.push(Strophe.getNodeFromJid(item))}),userNodeArray.sort(),title=userNodeArray.join(", "),title+=" "+d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getUTCFullYear()}var datestamp=d.toISOString().replace(/[^0-9]+/gi,""),roomjid=datestamp+"_"+jsxc.xmpp.getCurrentNode()+"@"+jsxc.options.get("muc").server;roomjid=roomjid.toLowerCase();var initialParticipants=[];return $.each(buddies,function(index,item){initialParticipants.push(item)}),jsxc.gui.window.clear(roomjid),jsxc.storage.setUserItem("member",roomjid,{}),jsxc.muc.join(roomjid,jsxc.xmpp.getCurrentNode(),null,title,subject||"",!0,!0,{initialParticipants:initialParticipants
}),jsxc.gui.window.open(roomjid),jsxc.muc.inviteParticipants(roomjid,initialParticipants),roomjid},onAddRoster:function(event,room,data,bud){var self=jsxc.muc;if("groupchat"===data.type){var bo=$("<a>");$("<span>").addClass("jsxc_icon jsxc_bookmarkicon").appendTo(bo),$("<span>").text(jsxc.t("Bookmark")).appendTo(bo),bo.addClass("jsxc_bookmarkOptions"),bo.click(function(ev){return ev.preventDefault(),jsxc.xmpp.bookmarks.showDialog(room),!1}),bud.find(".jsxc_menu ul").append($("<li>").append(bo)),data.bookmarked&&bud.addClass("jsxc_bookmarked"),bud.off("click").click(function(){jsxc.gui.window.open(room)}),bud.find(".jsxc_delete").click(function(){return data.bookmarked&&jsxc.xmpp.bookmarks["delete"](room),self.leave(room),!1})}},helper:{formToHTML:function(form){if(form instanceof Strophe.x.Form){var html=$("<form>");if(html.attr("data-type",form.type),html.addClass("form-horizontal"),form.title&&html.append("<h3>"+form.title+"</h3>"),form.instructions&&html.append("<p>"+form.instructions+"</p>"),form.fields.length>0){var i;for(i=0;i<form.fields.length;i++)html.append(jsxc.muc.helper.fieldToHtml(form.fields[i]))}return $("<div>").append(html).html()}},fieldToHtml:function(field){var self=field||this;field=null;var el,val,opt,i,o,j,k,txt,line,_ref2,id="Strophe.x.Field-"+self.type+"-"+self["var"],html=$("<div>");if(html.addClass("form-group"),self.label){var label=$("<label>");label.attr("for",id),label.addClass("col-sm-6 control-label"),label.text(self.label),label.appendTo(html)}switch(self.type.toLowerCase()){case"list-single":case"list-multi":for(el=$("<select>"),"list-multi"===self.type&&el.attr("multiple","multiple"),i=0;i<self.options.length;i++)if(opt=self.options[i]){for(o=$(opt.toHTML()),j=0;j<self.values;j++)k=self.values[j],k.toString()===opt.value.toString()&&o.attr("selected","selected");o.appendTo(el)}break;case"text-multi":case"jid-multi":el=$("<textarea>"),txt=function(){var i,_results;for(_results=[],i=0;i<self.values.length;i++)line=self.values[i],_results.push(line);return _results}.call(this).join("\n"),txt&&el.text(txt);break;case"text-single":case"boolean":case"text-private":case"hidden":case"fixed":case"jid-single":switch(el=$("<input>"),self.values&&el.attr("value",self.values[0]),self.type.toLowerCase()){case"text-single":el.attr("type","text"),el.attr("placeholder",self.desc),el.addClass("form-control");break;case"boolean":el.attr("type","checkbox"),val=null!=(_ref2=self.values[0])&&"function"==typeof _ref2.toString?_ref2.toString():void 0,!val||"true"!==val&&"1"!==val||el.attr("checked","checked");break;case"text-private":el.attr("type","password"),el.addClass("form-control");break;case"hidden":el.attr("type","hidden");break;case"fixed":el.attr("type","text").attr("readonly","readonly"),el.addClass("form-control");break;case"jid-single":el.attr("type","email"),el.addClass("form-control")}break;default:el=$("<input type='text'>")}el.attr("id",id),el.attr("name",self["var"]),self.required&&el.attr("required",self.required);var inner=el;return el=$("<div>"),el.addClass("col-sm-6"),el.append(inner),html.append(el),html.get(0)}}},$(document).on("init.window.jsxc",jsxc.muc.initWindow),$(document).on("add.roster.jsxc",jsxc.muc.onAddRoster),$(document).one("attached.jsxc",function(){jsxc.muc.init()}),$(document).one("connected.jsxc",function(){jsxc.storage.removeUserItem("roomNames"),jsxc.storage.removeUserItem("ownNicknames")}),jsxc.notice={_num:0,load:function(){var self=this;$("#jsxc-notifications ul li").remove(),$("#jsxc-root .jsxc_menu_notif_number").text(""),jsxc.notice._num=0;var saved=jsxc.storage.getUserItem("notices")||[],key=null;for(key in saved)if(saved.hasOwnProperty(key)){var val=saved[key];jsxc.notice.add(val.msg,val.description,val.fnName,val.fnParams,key,!1)}self._showNoNoticeContent(),$(document).trigger("notice.jsxc")},_showNoNoticeContent:function(){$("#jsxc-notifications ul li").length<1?$("#jsxc-notifications ul").append("<li class='jsxc_noNotice'>Aucune notification</li>"):$("#jsxc-notifications .jsxc_noNotice").remove()},add:function(msg,description,fnName,fnParams,id,triggerEvent){var self=this;triggerEvent="undefined"==typeof triggerEvent;var nid=id||Date.now(),list=$("#jsxc-notifications ul"),notice=$("<li/>");if(notice.click(function(){return jsxc.notice.remove(nid),jsxc.exec(fnName,fnParams),$(document).trigger("notice.jsxc"),!1}),notice.text(msg+" "+description),notice.attr("title",description||""),notice.attr("data-nid",nid),list.append(notice),jsxc.notice._num++,self.updateNotificationNumbers(),!id){var saved=jsxc.storage.getUserItem("notices")||{};saved[nid]={msg:msg,description:description,fnName:fnName,fnParams:fnParams},jsxc.storage.setUserItem("notices",saved),jsxc.notification.notify(msg,description||"",null,!0,jsxc.CONST.SOUNDS.NOTICE)}self._showNoNoticeContent(),triggerEvent&&$(document).trigger("notice.jsxc")},updateNotificationNumbers:function(){$("#jsxc-root .jsxc_menu_notif_number").text(jsxc.notice._num)},getNotificationsNumber:function(){return jsxc.notice._num||0},remove:function(nid){var self=this,el=$("#jsxc-notifications li[data-nid="+nid+"]");el.remove(),$("#jsxc-root .jsxc_menu_notif_number").text(--jsxc.notice._num||"");var s=jsxc.storage.getUserItem("notices");delete s[nid],jsxc.storage.setUserItem("notices",s),self.updateNotificationNumbers(),self._showNoNoticeContent()},has:function(fnName){var saved=jsxc.storage.getUserItem("notices")||[],has=!1;return $.each(saved,function(index,val){return val.fnName===fnName?(has=!0,!1):void 0}),has}},jsxc.notification={audio:null,init:function(){$(document).on("postmessagein.jsxc",function(event,bid,msg){msg=msg&&msg.match(/^\?OTR/)?jsxc.t("Encrypted_message"):msg;var data=jsxc.storage.getUserItem("buddy",bid);jsxc.notification.notify({title:jsxc.t("New_message_from",{name:data.name}),msg:msg,soundFile:jsxc.CONST.SOUNDS.MSG,source:bid})})},notify:function(title,msg,d,force,soundFile,loop,source){if(!jsxc.options.notification||!jsxc.notification.hasPermission())return void jsxc.debug("Notification triggered, but disabled",{arguments:arguments});var o;if(o=null!==title&&"object"==typeof title?title:{title:title,msg:msg,duration:d,force:force,soundFile:soundFile,loop:loop,source:source},!jsxc.hasFocus()||o.force===!0){var icon=o.icon||jsxc.options.root+"/img/newgui/desktop-notification.png";if("string"==typeof o.source){var data=jsxc.storage.getUserItem("buddy",o.source),src=jsxc.storage.getUserItem("avatar",data.avatar);"string"==typeof src&&"0"!==src&&(icon=src)}jsxc.toNotification=setTimeout(function(){if("string"==typeof o.soundFile&&jsxc.notification.playSound(o.soundFile,o.loop,o.force),jsxc.notification.isNotificationShowed()===!0){var popup=new Notification(jsxc.t(o.title),{body:jsxc.t(o.msg),icon:icon}),duration=o.duration||jsxc.options.popupDuration;duration>0&&setTimeout(function(){popup.close()},duration)}},jsxc.toNotificationDelay)}},hasSupport:function(){if(window.webkitNotifications){window.Notification=function(title,opt){var popup=window.webkitNotifications.createNotification(null,title,opt.body);return popup.show(),popup.close=function(){popup.cancel()},popup};var permission;switch(window.webkitNotifications.checkPermission()){case 0:permission=jsxc.CONST.NOTIFICATION_GRANTED;break;case 2:permission=jsxc.CONST.NOTIFICATION_DENIED;break;default:permission=jsxc.CONST.NOTIFICATION_DEFAULT}return window.Notification.permission=permission,window.Notification.requestPermission=function(func){window.webkitNotifications.requestPermission(func)},!0}return!!window.Notification},prepareRequest:function(){jsxc.notice.has("gui.showRequestNotification")||$(document).one("postmessagein.jsxc",function(){setTimeout(function(){jsxc.notice.add(jsxc.t("Notifications")+"?",jsxc.t("Should_we_notify_you_"),"gui.showRequestNotification")},1e3)})},requestPermission:function(){window.Notification.requestPermission(function(status){window.Notification.permission!==status&&(window.Notification.permission=status),jsxc.notification.hasPermission()?$(document).trigger("notificationready.jsxc"):$(document).trigger("notificationfailure.jsxc")})},hasPermission:function(){return window.Notification.permission===jsxc.CONST.NOTIFICATION_GRANTED},playSound:function(soundFile,loop,force){if(jsxc.master&&jsxc.notification.isSoundMuted()!==!0&&(!jsxc.hasFocus()||force)){jsxc.notification.stopSound();var audio=new Audio(jsxc.options.root+"/sound/"+soundFile);audio.loop=loop||!1,audio.play(),jsxc.notification.audio=audio}},stopSound:function(){var audio=jsxc.notification.audio;"undefined"!=typeof audio&&null!==audio&&(audio.pause(),jsxc.notification.audio=null)},muteSound:function(external){external!==!0&&jsxc.options.set("muteNotification",!0)},unmuteSound:function(external){external!==!0&&jsxc.options.set("muteNotification",!1)},isSoundMuted:function(){return jsxc.options&&jsxc.options.get("muteNotification")},isNotificationShowed:function(){return jsxc.options&&jsxc.options.get("hideNotification")!==!0&&jsxc.notification.hasPermission()},hideNotifications:function(external){external!==!0&&jsxc.options.set("hideNotification",!0)},showNotifications:function(external){external!==!0&&jsxc.options.set("hideNotification",!1)}},jsxc.options={rest:{apiName:"",apiBaseUrl:"",apiKey:""},chromeExtensionURL:"screen-capture/chrome-extension.crx",stats:{enabled:!1,destinationUrl:"https://domain-without-trailing-slash.net/stats",autosend:!0,authorization:"key",sentLogLevels:["WARN","ERROR"]},app_name:"web applications",timeout:3e3,busyTimeout:15e3,otr:{enable:!0,ERROR_START_AKE:!1,debug:!1,SEND_WHITESPACE_TAG:!0,WHITESPACE_START_AKE:!0},etherpad:{enabled:!1,ressource:null},xmpp:{url:null,jid:null,domain:null,searchDomain:null,password:null,sid:null,rid:null,overwrite:!1,onlogin:null},priority:{online:0,chat:0,away:0,xa:0,dnd:0},formFound:null,loginForm:{enable:!0,form:null,jid:null,pass:null,preJid:function(jid){return jid},onConnecting:"dialog",onConnected:"submit",onAuthFail:"submit",attachIfFound:!0,ifFound:"attach",startMinimized:!1},logoutElement:null,numberOfMsg:10,defaultLang:"en",autoLang:!0,rosterAppend:"body",notification:!0,popupDuration:6e3,root:"",displayRosterMinimized:function(){return!1},hideOffline:!1,defaultAvatar:function(jid){jsxc.gui.avatarPlaceholder($(this).find(".jsxc_avatar"),jid)},loadSettings:null,saveSettinsPermanent:function(data,cb){cb(!0)},carbons:{enable:!1},getUsers:null,favicon:{enable:!0,bgColor:"#E59400",textColor:"#fff"},RTCPeerConfig:{url:null,iceServers:[]},onlineHelp:"http://www.jsxc.org/manual.html",viewport:{getSize:function(){var w=$(window).width()-$("#jsxc_windowListSB").width(),h=$(window).height();return{width:w,height:h}}},maxStorableSize:1e6,muteNotification:!1,hideNotification:!1},jsxc.otr={objects:{},dsaFallback:null,receiveMessage:function(d){var bid=d.bid;jsxc.otr.objects[bid].msgstate!==OTR.CONST.MSGSTATE_PLAINTEXT&&jsxc.otr.backup(bid),jsxc.otr.objects[bid].msgstate===OTR.CONST.MSGSTATE_PLAINTEXT||d.encrypted?jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.IN,msg:d.msg,encrypted:d.encrypted,forwarded:d.forwarded,stamp:d.stamp}):jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.SYS,msg:jsxc.t("Received_an_unencrypted_message")+". ["+d.msg+"]",encrypted:d.encrypted,forwarded:d.forwarded,stamp:d.stamp})},sendMessage:function(jid,msg,uid){0!==jsxc.otr.objects[jsxc.jidToBid(jid)].msgstate&&jsxc.otr.backup(jsxc.jidToBid(jid)),jsxc.xmpp._sendMessage(jid,msg,uid)},create:function(bid){if(!jsxc.otr.objects.hasOwnProperty(bid)&&jsxc.options.otr.priv){var ol=jsxc.storage.getUserItem("otrlist")||[];ol.indexOf(bid)<0&&(ol.push(bid),jsxc.storage.setUserItem("otrlist",ol)),jsxc.otr.objects[bid]=new OTR(jsxc.options.otr),jsxc.options.otr.SEND_WHITESPACE_TAG&&(jsxc.otr.objects[bid].SEND_WHITESPACE_TAG=!0),jsxc.options.otr.WHITESPACE_START_AKE&&(jsxc.otr.objects[bid].WHITESPACE_START_AKE=!0),jsxc.otr.objects[bid].on("status",function(status){var data=jsxc.storage.getUserItem("buddy",bid);if(null!==data){switch(status){case OTR.CONST.STATUS_SEND_QUERY:jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.SYS,msg:jsxc.t("trying_to_start_private_conversation")});break;case OTR.CONST.STATUS_AKE_SUCCESS:data.fingerprint=jsxc.otr.objects[bid].their_priv_pk.fingerprint(),data.msgstate=OTR.CONST.MSGSTATE_ENCRYPTED;var msg_state=jsxc.otr.objects[bid].trust?"Verified":"Unverified",msg=jsxc.t(msg_state+"_private_conversation_started");jsxc.gui.window.postMessage({bid:bid,direction:"sys",msg:msg});break;case OTR.CONST.STATUS_END_OTR:data.fingerprint=null,jsxc.otr.objects[bid].msgstate===OTR.CONST.MSGSTATE_PLAINTEXT?(data.msgstate=OTR.CONST.MSGSTATE_PLAINTEXT,jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.SYS,msg:jsxc.t("private_conversation_aborted")})):(data.msgstate=OTR.CONST.MSGSTATE_FINISHED,jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.SYS,msg:jsxc.t("your_buddy_closed_the_private_conversation_you_should_do_the_same")}));break;case OTR.CONST.STATUS_SMP_HANDLE:jsxc.keepBusyAlive()}jsxc.storage.setUserItem("buddy",bid,data),jsxc.gui.update(bid)}}),jsxc.otr.objects[bid].on("smp",function(type,data){switch(type){case"question":jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.SYS,msg:jsxc.t("Authentication_request_received")}),jsxc.gui.window.smpRequest(bid,data),jsxc.storage.setUserItem("smp",bid,{data:data||null});break;case"trust":jsxc.otr.objects[bid].trust=data,jsxc.storage.updateUserItem("buddy",bid,"trust",data),jsxc.otr.backup(bid),jsxc.gui.update(bid),data?jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.SYS,msg:jsxc.t("conversation_is_now_verified")}):jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.SYS,msg:jsxc.t("authentication_failed")}),jsxc.storage.removeUserItem("smp",bid),jsxc.gui.dialog.close("smp");break;case"abort":jsxc.gui.window.hideOverlay(bid),jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.SYS,msg:jsxc.t("Authentication_aborted")});break;default:jsxc.debug("[OTR] sm callback: Unknown type: "+type)}}),jsxc.otr.objects[bid].on("ui",function(msg,encrypted,meta){jsxc.otr.receiveMessage({bid:bid,msg:msg,encrypted:encrypted===!0,stamp:meta.stamp,forwarded:meta.forwarded})}),jsxc.otr.objects[bid].on("io",function(msg,uid){var jid=jsxc.gui.window.get(bid).data("jid")||jsxc.otr.objects[bid].jid;jsxc.otr.objects[bid].jid=jid,jsxc.otr.sendMessage(jid,msg,uid)}),jsxc.otr.objects[bid].on("error",function(err){"Received an unencrypted message."!==err&&jsxc.gui.window.postMessage({bid:bid,direction:jsxc.Message.SYS,msg:"[OTR] "+jsxc.t(err)}),jsxc.error("[OTR] "+err)}),jsxc.otr.restore(bid)}},onSmpQuestion:function(bid,data){jsxc.gui.showVerification(bid),$("#jsxc_dialog select").prop("selectedIndex",data?2:3).change(),$("#jsxc_dialog > div:eq(0)").hide(),data?($("#jsxc_dialog > div:eq(2)").find("#jsxc_quest").val(data).prop("disabled",!0),$("#jsxc_dialog > div:eq(2)").find(".jsxc_submit").text(jsxc.t("Answer")),$("#jsxc_dialog > div:eq(2)").find(".jsxc_explanation").text(jsxc.t("onsmp_explanation_question")),$("#jsxc_dialog > div:eq(2)").show()):($("#jsxc_dialog > div:eq(3)").find(".jsxc_explanation").text(jsxc.t("onsmp_explanation_secret")),$("#jsxc_dialog > div:eq(3)").show()),$("#jsxc_dialog .jsxc_close").click(function(){jsxc.storage.removeUserItem("smp",bid),jsxc.master&&jsxc.otr.objects[bid].sm.abort()})},sendSmpReq:function(bid,sec,quest){jsxc.keepBusyAlive(),jsxc.otr.objects[bid].smpSecret(sec,quest||"")},toggleTransfer:function(bid){"function"==typeof OTR&&(0===jsxc.storage.getUserItem("buddy",bid).msgstate?jsxc.otr.goEncrypt(bid):jsxc.otr.goPlain(bid))},goEncrypt:function(bid){jsxc.master?jsxc.otr.objects.hasOwnProperty(bid)&&jsxc.otr.objects[bid].sendQueryMsg():jsxc.storage.updateUserItem("buddy",bid,"transferReq",1)},goPlain:function(bid,cb){jsxc.master?jsxc.otr.objects.hasOwnProperty(bid)&&(jsxc.otr.objects[bid].endOtr.call(jsxc.otr.objects[bid],cb),jsxc.otr.objects[bid].init.call(jsxc.otr.objects[bid]),jsxc.otr.backup(bid)):jsxc.storage.updateUserItem("buddy",bid,"transferReq",0)},backup:function(bid){var o=jsxc.otr.objects[bid],r={};if(null!==o){var i,savekey=["jid","our_instance_tag","msgstate","authstate","fragment","their_y","their_old_y","their_keyid","their_instance_tag","our_dh","our_old_dh","our_keyid","sessKeys","storedMgs","oldMacKeys","trust","transmittedRS","ssid","receivedPlaintext","authstate","send_interval"];for(i=0;i<savekey.length;i++)r[savekey[i]]=JSON.stringify(o[savekey[i]]);null!==o.their_priv_pk&&(r.their_priv_pk=JSON.stringify(o.their_priv_pk.packPublic())),o.ake.otr_version&&""!==o.ake.otr_version&&(r.otr_version=JSON.stringify(o.ake.otr_version)),jsxc.storage.setUserItem("otr",bid,r)}},restore:function(bid){var o=jsxc.otr.objects[bid],d=jsxc.storage.getUserItem("otr",bid);if(null!==o||null!==d){var key;for(key in d)if(d.hasOwnProperty(key)){var val=JSON.parse(d[key]);"their_priv_pk"===key&&null!==val&&(val=DSA.parsePublic(val)),"otr_version"===key&&null!==val?o.ake.otr_version=val:o[key]=val}jsxc.otr.objects[bid]=o,1===o.msgstate&&null!==o.their_priv_pk&&o._smInit.call(jsxc.otr.objects[bid])}jsxc.otr.enable(bid)},createDSA:function(){if(!jsxc.options.otr.priv){if("function"!=typeof OTR)return jsxc.warn("OTR support disabled"),OTR={},void(OTR.CONST={MSGSTATE_PLAINTEXT:0,MSGSTATE_ENCRYPTED:1,MSGSTATE_FINISHED:2});if(null===jsxc.storage.getUserItem("key")){var msg=jsxc.t("Creating_your_private_key_"),worker=null;if(Worker)try{worker=new Worker(jsxc.options.root+"/lib/otr/lib/dsa-webworker.js")}catch(err){jsxc.warn("Couldn't create web-worker.",err)}jsxc.otr.dsaFallback=null===worker,jsxc.otr.dsaFallback?(jsxc.xmpp.conn.pause(),jsxc.gui.dialog.open(jsxc.gui.template.get("waitAlert",null,msg),{noClose:!0}),jsxc.debug("DSA key creation started in fallback mode."),setTimeout(function(){var dsa=new DSA;jsxc.otr.DSAready(dsa)},500)):(worker.onmessage=function(e){var type=e.data.type,val=e.data.val;"debug"===type?jsxc.debug("OTR: ",val):"data"===type&&jsxc.otr.DSAready(DSA.parsePrivate(val))},jsxc.debug("DSA key creation started."),worker.postMessage({imports:[jsxc.options.root+"/lib/otr/vendor/salsa20.js",jsxc.options.root+"/lib/otr/vendor/bigint.js",jsxc.options.root+"/lib/otr/vendor/crypto.js",jsxc.options.root+"/lib/otr/vendor/eventemitter.js",jsxc.options.root+"/lib/otr/lib/const.js",jsxc.options.root+"/lib/otr/lib/helpers.js",jsxc.options.root+"/lib/otr/lib/dsa.js"],seed:BigInt.getSeed(),debug:!0}))}else jsxc.debug("DSA key loaded"),jsxc.options.otr.priv=DSA.parsePrivate(jsxc.storage.getUserItem("key")),jsxc.otr._createDSA()}},_createDSA:function(){jsxc.storage.setUserItem("priv_fingerprint",jsxc.options.otr.priv.fingerprint()),$.each(jsxc.storage.getUserItem("windowlist")||[],function(index,val){jsxc.otr.create(val)})},DSAready:function(dsa){jsxc.storage.setUserItem("key",dsa.packPrivate()),jsxc.options.otr.priv=dsa,jsxc.otr.dsaFallback&&(jsxc.xmpp.conn.resume(),jsxc.gui.dialog.close()),jsxc.otr._createDSA()},enable:function(bid){jsxc.gui.window.get(bid).find(".jsxc_otr").removeClass("jsxc_disabled")}},jsxc.ressources={_log:function(message,data,level){jsxc.debug("[RESSOURCES] "+message,data,level)},processRessourcesInText:function(text){var self=jsxc.ressources,_resStack=[],manager={_resStack:[],saveRessource:function(res){_resStack.push(res)},isFree:function(res){return-1===_resStack.indexOf(res)}};return $.each(self.MEDIA_RESSOURCES,function(index,filter){if(filter.regex.constructor!==Array)throw new Error("'regex' must be an array");for(var name=filter.name,replaceFilter=function(match){return manager.isFree(match)?(manager.saveRessource(match),filter.getLink?filter.getLink.apply(self,arguments):self._getShowRessourceLink(match,name)):match},i=0;i<filter.regex.length;i++){var regex=filter.regex[i];text.match(regex)&&(text=text.replace(regex,replaceFilter))}}),text},MEDIA_RESSOURCES:[{name:"youtube",regex:[/https?:\/\/(www\.)?youtube\.[a-z]{1,6}\b([-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)/gi],getEmbedded:function(ressourceOnly){var self=jsxc.ressources,vid=ressourceOnly.match(/v=([^&]+)/i);return null===vid?self._getEmbeddedErrorBlock():'<iframe src="https://www.youtube.com/embed/'+vid[1]+'" frameborder="0" width="480" height="270" allowfullscreen></iframe>'}},{name:"dailymotion",regex:[/https?:\/\/(www\.)?dailymotion\.[a-z]{1,6}\b([-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)/gi],getEmbedded:function(ressourceOnly){var self=jsxc.ressources,vid=ressourceOnly.match(/video\/([^_]+)/i);return null===vid?self._getEmbeddedErrorBlock():'<iframe frameborder="0" width="480" height="270" src="//www.dailymotion.com/embed/video/'+vid[1]+'" allowfullscreen></iframe>'}},{name:"http/https",regex:[jsxc.CONST.REGEX.URL],getLink:function(match){var self=jsxc.ressources;return self._getTrueLink(match)}},{name:"etherpad",regex:[/\+\+(e|etherpad):([-_a-z0-9]+)/gi],getLink:function(match,prefix,etherpadId){var self=jsxc.ressources;return self._getEtherpadLink(etherpadId)}},{name:"spaceInvasion",regex:[/\+\+(spaceinvasion)/gi],getLink:function(){var self=jsxc.ressources;return self._getSpaceInvasionLink()}},{name:"user",regex:[/\+\+([-_a-z0-9]+)/gi],getLink:function(match,user){var self=jsxc.ressources;return self._getChatLink(user)}}],getEmbeddedFor:function(name,ressourceOnly){var self=jsxc.ressources,media=null;if($.each(self.MEDIA_RESSOURCES,function(index,element){return element.name===name?(media=element,!1):void 0}),!name||!media)throw new Error("Invalid ressource: "+name+" / "+ressourceOnly);return media.getEmbedded?media.getEmbedded(ressourceOnly):null},_getEmbeddedErrorBlock:function(ressource){return"<div class='jsxc-multimedia-error-block'>Erreur de traitement de la ressource: <br/>"+ressource+"</div>"},_getShowRessourceLink:function(ressource,prefix){if("undefined"==typeof ressource)throw new Error("Ressource cannot be undefined");if("undefined"==typeof prefix)throw new Error("Prefix cannot be undefined");var ressourceLabel=ressource.length<50?ressource:ressource.substr(0,17)+"...";ressource=prefix?prefix+":"+ressource:ressource;var title="Ouvrir: "+ressource;return'<a class="jsxc-media-ressource-link" title="'+title+'" onclick="jsxc.newgui.openMediaRessource(\''+ressource+"')\">"+ressourceLabel+"</a>"},_getChatLink:function(user){var ressourceLabel=user.length<50?user:user.substr(0,17)+"...",jid=user+"@"+jsxc.options.xmpp.domain,title="Discuter avec: "+user;return'<a class="jsxc-media-ressource-link" title="'+title+'" onclick="jsxc.api.openChatWindow(\''+jid+"')\">"+ressourceLabel+"</a>"},_getEtherpadLink:function(etherpadId){var ressourceLabel=etherpadId.length<50?etherpadId:etherpadId.substr(0,17)+"...",title="Ouvrir un pas: "+etherpadId;return'<a class="jsxc-media-ressource-link" title="'+title+'" onclick="jsxc.etherpad.openpad(\''+etherpadId+"')\">"+ressourceLabel+"</a>"},_getTrueLink:function(href){var ressourceLabel=href.length<50?href:href.substr(0,17)+"...",title="Ouvrir dans une nouvelle fenêtre: "+href;return'<a class="jsxc-media-ressource-link" title="'+title+'" target="_blank" href="'+href+'">'+ressourceLabel+"</a>"},_getSpaceInvasionLink:function(){return'<a class="jsxc-media-ressource-link" title="Space Invasion !" onclick="jsxc.api.spaceInvasion()">Space Invasion !</a>'}},jsxc.rest={init:function(){var self=jsxc.rest;self.openfire.apiBaseUrl=jsxc.options.get("rest").apiBaseUrl||"",self.openfire.apiKey=jsxc.options.get("rest").apiKey||""},openfire:{apiBaseUrl:"",apiKey:"",_checkAvailability:function(){var self=jsxc.rest.openfire;return""===self.apiBaseUrl?(jsxc.warn("Rest api not available: no base url found"),!1):""===self.apiKey?(jsxc.warn("Rest api not available: no api key found"),!1):!0},createUser:function(userNode){var self=jsxc.rest.openfire;if(self._checkAvailability()!==!0){var falsePromise=$.Deferred().promise();return falsePromise.fail("Openfire REST API unavailable"),falsePromise}return self._asyncRequest("POST","/users",{username:userNode.toLowerCase(),password:"azerty"})},_asyncRequest:function(type,url,data,headers){var self=jsxc.rest.openfire;if("undefined"==typeof type)throw new Error("Parameter cannot be undefined: "+type);if("undefined"==typeof url)throw new Error("Parameter cannot be undefined: "+url);var restUrl=self.apiBaseUrl+url,req={url:restUrl,type:type,dataType:"json",headers:{Authorization:self.apiKey,"Content-Type":"application/json"}};return"undefined"!=typeof data&&(req.data=JSON.stringify(data)),"undefined"!=typeof headers&&$.extend(req.headers,headers),$.ajax(req)}}},jsxc.stats={_statsManager:null,_statsOptions:null,_log:function(message,data,level){level=(level||"ERROR").toUpperCase().trim();var prefix=level+" [JSXC/Stats] ";"ERROR"===level?console.error(prefix+message,data):console.log(prefix+message,data)},init:function(){var self=jsxc.stats;self._statsOptions=jsxc.options.get("stats"),self._statsOptions&&self._statsOptions.enabled&&(self._statsManager=__webpack_require__(3)({debug:!1,destinationUrl:self._statsOptions.destinationUrl,authorization:self._statsOptions.authorization,interval:5e3,autosend:!0}),console.info("Some anonymous data are collected to improve user experience."),console.info("Data availables at: "+self._statsOptions.destinationUrl+"/visualization/"),console.info("Anonymous session id: "+self._statsManager.sessionId),setTimeout(function(){$.get(jsxc.options.get("stats").destinationUrl+"/visualization/").fail(function(){jsxc.error("Stats destination URL is unreachable")})},1e3))},addEvent:function(event,data){var self=jsxc.stats;null!==self._statsManager&&self._statsOptions&&self._statsOptions.enabled===!0&&self._statsManager.addEvent(event,data)},addLogEntry:function(text,level,data){var self=jsxc.stats;level=(level||"INFO").trim().toUpperCase(),null!==self._statsManager&&self._statsOptions&&self._statsOptions.enabled===!0&&-1!==self._statsOptions.sentLogLevels.indexOf(level)&&self._statsManager.addLogEntry(text,level,data)}},jsxc.storage={PREFIX:"jsxc",SEP:":",getPrefix:function(uk){var self=jsxc.storage;return uk&&!jsxc.bid&&jsxc.error("Unable to create user prefix",new Error),self.PREFIX+self.SEP+(uk&&jsxc.bid?jsxc.bid+self.SEP:"")},setItem:function(key,value,uk){jsxc.storageNotConform>0&&"rid"!==key&&(jsxc.storageNotConform>1&&null===jsxc.toSNC&&(jsxc.toSNC=window.setTimeout(function(){jsxc.storageNotConform=0,jsxc.storage.setItem("storageNotConform",0)},1e3)),jsxc.ls.push(JSON.stringify({key:key,value:value}))),"object"==typeof value&&(value=JSON.stringify(value,function(key,val){return val instanceof jQuery?void 0:val})),localStorage.setItem(jsxc.storage.getPrefix(uk)+key,value)},setUserItem:function(type,key,value){var self=jsxc.storage;return 2===arguments.length?(value=key,key=type,type=""):3===arguments.length&&(key=type+self.SEP+key),jsxc.storage.setItem(key,value,!0)},getItem:function(key,uk){key=jsxc.storage.getPrefix(uk)+key;var value=localStorage.getItem(key);try{return JSON.parse(value)}catch(e){return value}},getUserItem:function(type,key){var self=jsxc.storage;return 1===arguments.length?key=type:2===arguments.length&&(key=type+self.SEP+key),jsxc.storage.getItem(key,!0)},removeItem:function(key,uk){jsxc.storageNotConform&&"rid"!==key&&jsxc.ls.push(JSON.stringify({key:jsxc.storage.prefix+key,value:""})),localStorage.removeItem(jsxc.storage.getPrefix(uk)+key)},removeUserItem:function(type,key){var self=jsxc.storage;1===arguments.length?key=type:2===arguments.length&&(key=type+self.SEP+key),jsxc.storage.removeItem(key,!0)},updateItem:function(key,variable,value,uk){var data=jsxc.storage.getItem(key,uk)||{};"object"==typeof variable?$.each(variable,function(key,val){"undefined"==typeof data[key]&&jsxc.debug("Variable "+key+" doesn't exist in "+variable+". It was created."),data[key]=val}):("undefined"==typeof data[variable]&&jsxc.debug("Variable "+variable+" doesn't exist. It was created."),data[variable]=value),jsxc.storage.setItem(key,data,uk)},updateUserItem:function(type,key,variable,value){var self=jsxc.storage;return 4===arguments.length||3===arguments.length&&"object"==typeof variable?key=type+self.SEP+key:(value=variable,variable=key,key=type),jsxc.storage.updateItem(key,variable,value,!0)},ink:function(key,uk){jsxc.storage.setItem(key,Number(jsxc.storage.getItem(key,uk))+1,uk)},removeElement:function(key,name,uk){var item=jsxc.storage.getItem(key,uk);$.isArray(item)?item=$.grep(item,function(e){return e!==name}):"object"==typeof item&&null!==item&&delete item[name],jsxc.storage.setItem(key,item,uk)},removeUserElement:function(type,key,name){var self=jsxc.storage;return 2===arguments.length?(name=key,key=type):3===arguments.length&&(key=type+self.SEP+key),jsxc.storage.removeElement(key,name,!0)},onStorage:function(e){if(e.key!==jsxc.storage.PREFIX+jsxc.storage.SEP+"rid"){var re=new RegExp("^"+jsxc.storage.PREFIX+jsxc.storage.SEP+"(?:[^"+jsxc.storage.SEP+"]+@[^"+jsxc.storage.SEP+"]+"+jsxc.storage.SEP+")?(.*)","i"),key=e.key.replace(re,"$1");if(jsxc.storageNotConform>0&&jsxc.ls.length>0){var val=e.newValue;try{val=JSON.parse(val)}catch(err){}var index=$.inArray(JSON.stringify({key:key,value:val}),jsxc.ls);if(index>=0)return jsxc.storageNotConform>1&&(window.clearTimeout(jsxc.toSNC),jsxc.storageNotConform=1,jsxc.storage.setItem("storageNotConform",1)),void jsxc.ls.splice(index,1)}if(e.oldValue!==e.newValue){var n,o,bid=key.replace(new RegExp("[^"+jsxc.storage.SEP+"]+"+jsxc.storage.SEP+"(.*)","i"),"$1");if(jsxc.master&&"alive"===key)return jsxc.debug("Master request."),void jsxc.storage.ink("alive");if(!jsxc.master&&("alive"===key||"alive_busy"===key))return jsxc.to=$.grep(jsxc.to,function(timeout){return window.clearTimeout(timeout),!1}),jsxc.to.push(window.setTimeout(jsxc.checkMaster,("alive"===key?jsxc.options.timeout:jsxc.options.busyTimeout)+jsxc.random(60))),void(jsxc.role_allocation||jsxc.onSlave());if(key.match(/^notices/)&&jsxc.notice.load(),key.match(/^presence/)&&jsxc.xmpp.changeOwnPresence(e.newValue,!0),key.match(/^options/)&&e.newValue&&(n=JSON.parse(e.newValue),"undefined"!=typeof n.muteNotification&&n.muteNotification?jsxc.notification.muteSound(!0):jsxc.notification.unmuteSound(!0)),key.match(/^hidden/)&&(jsxc.master?clearTimeout(jsxc.toNotification):jsxc.isHidden()),key.match(/^focus/)&&(jsxc.master?clearTimeout(jsxc.toNotification):jsxc.hasFocus()),key.match(new RegExp("^history"+jsxc.storage.SEP)))for(var uid,el,message,history=JSON.parse(e.newValue);history.length>0;)uid=history.pop(),message=new jsxc.Message(uid),el=message.getDOM(),0===el.length?(jsxc.master&&message.direction===jsxc.Message.OUT&&jsxc.xmpp.sendMessage(message.bid,message.msg,message._uid),jsxc.gui.window._postMessage(message,!0)):message.isReceived()&&el.addClass("jsxc_received");else{if(key.match(new RegExp("^window"+jsxc.storage.SEP)))return e.newValue?e.oldValue?(n=JSON.parse(e.newValue),o=JSON.parse(e.oldValue),n.minimize!==o.minimize&&(n.minimize?jsxc.gui.window._hide(bid):jsxc.gui.window._show(bid)),jsxc.gui.window.setText(bid,n.text),void(n.unread!==o.unread&&(0===n.unread?jsxc.gui.readMsg(bid):jsxc.gui._unreadMsg(bid,n.unread)))):void jsxc.gui.window.open(bid):void jsxc.gui.window._close(bid);if(key.match(/^unreadMsg/)&&jsxc.gui.favicon&&jsxc.gui.favicon.badge(parseInt(e.newValue)||0),key.match(new RegExp("^smp"+jsxc.storage.SEP))){if(!e.newValue)return jsxc.gui.dialog.close("smp"),jsxc.gui.window.hideOverlay(bid),void(jsxc.master&&jsxc.otr.objects[bid].sm.abort());n=JSON.parse(e.newValue),"undefined"!=typeof n.data?jsxc.gui.window.smpRequest(bid,n.data):jsxc.master&&n.sec&&(jsxc.gui.dialog.close("smp"),jsxc.gui.window.hideOverlay(bid),jsxc.otr.sendSmpReq(bid,n.sec,n.quest))}if(!jsxc.master&&key.match(new RegExp("^buddy"+jsxc.storage.SEP))){if(!e.newValue)return void jsxc.gui.roster.purge(bid);if(!e.oldValue)return void jsxc.gui.roster.add(bid);n=JSON.parse(e.newValue),o=JSON.parse(e.oldValue),jsxc.gui.update(bid),o.status===n.status&&o.sub===n.sub||jsxc.gui.roster.reorder(bid)}if(jsxc.master&&key.match(new RegExp("^deletebuddy"+jsxc.storage.SEP))&&e.newValue&&(n=JSON.parse(e.newValue),jsxc.xmpp.removeBuddy(n.jid),jsxc.storage.removeUserItem(key)),jsxc.master&&key.match(new RegExp("^buddy"+jsxc.storage.SEP))&&(n=JSON.parse(e.newValue),
o=JSON.parse(e.oldValue),o.transferReq!==n.transferReq&&(jsxc.storage.updateUserItem("buddy",bid,"transferReq",-1),0===n.transferReq&&jsxc.otr.goPlain(bid),1===n.transferReq&&jsxc.otr.goEncrypt(bid)),o.name!==n.name&&jsxc.gui.roster._rename(bid,n.name)),"sid"===key)return void(e.newValue||jsxc.xmpp.logout());"friendReq"===key&&(n=JSON.parse(e.newValue),jsxc.master&&n.approve>=0&&jsxc.xmpp.resFriendReq(n.jid,n.approve)),jsxc.master&&key.match(new RegExp("^add"+jsxc.storage.SEP))&&(n=JSON.parse(e.newValue),jsxc.xmpp.addBuddy(n.username,n.alias)),jsxc.master&&key.match(new RegExp("^vcard"+jsxc.storage.SEP))&&null!==e.newValue&&e.newValue.match(/^request:/)&&jsxc.xmpp.loadVcard(bid,function(stanza){jsxc.storage.setUserItem("vcard",bid,{state:"success",data:$("<div>").append(stanza).html()})},function(){jsxc.storage.setUserItem("vcard",bid,{state:"error"})}),jsxc.master||!key.match(new RegExp("^vcard"+jsxc.storage.SEP))||null===e.newValue||e.newValue.match(/^request:/)||(n=JSON.parse(e.newValue),"undefined"!=typeof n.state&&$(document).trigger("loaded.vcard.jsxc",n),jsxc.storage.removeUserItem("vcard",bid))}}}},saveBuddy:function(bid,data){return jsxc.storage.getUserItem("buddy",bid)?(jsxc.storage.updateUserItem("buddy",bid,data),"updated"):(jsxc.storage.setUserItem("buddy",bid,$.extend({jid:"",name:"",status:0,sub:"none",msgstate:0,transferReq:-1,trust:!1,res:[],type:"chat"},data)),"created")},getLocaleBuddyListBJID:function(){var output=[];return $.each(jsxc.storage.getUserItem("buddylist")||[],function(index,item){output.push(jsxc.jidToBid(item))}),output}},jsxc.tests={isTestEnabled:function(){return"127.0.0.1"===window.location.hostname},runTests:function(tests){var self=jsxc.tests;return self.isTestEnabled()!==!0?!1:($.each(tests,function(index,element){QUnit.test(element.name,element.testCase)}),!0)},_addTestBox:function(){$("body").prepend('<div class="jsxc_testBox"><div id="qunit"></div><div id="qunit-fixture"></div></div>')},showTestBox:function(){$(".jsxc_testBox").css("display","block")}},$(function(){}),jsxc.xmpp.bookmarks={},jsxc.xmpp.bookmarks.remote=function(){return jsxc.xmpp.conn.caps&&jsxc.xmpp.hasFeatureByJid(jsxc.xmpp.conn.domain,Strophe.NS.PUBSUB+"#publish")},jsxc.xmpp.bookmarks.load=function(){jsxc.xmpp.bookmarks.loadFromRemote()},jsxc.xmpp.bookmarks.loadFromLocal=function(){jsxc.debug("Load bookmarks from local storage");var bookmarks=jsxc.storage.getUserItem("bookmarks")||[],bl=jsxc.storage.getUserItem("buddylist")||[];$.each(bookmarks,function(){var room=this,roomdata=jsxc.storage.getUserItem("buddy",room)||{};bl.push(room),jsxc.gui.roster.add(room),roomdata.autojoin&&(jsxc.debug("auto join "+room),jsxc.xmpp.conn.muc.join(room,roomdata.nickname))}),jsxc.storage.setUserItem("buddylist",bl)},jsxc.xmpp.bookmarks.loadFromRemote=function(){jsxc.debug("Load bookmarks from pubsub");var bookmarks=jsxc.xmpp.conn.bookmarks;bookmarks.get(function(stanza){var bl=jsxc.storage.getUserItem("buddylist");$(stanza).find("conference").each(function(){var conference=$(this),room=conference.attr("jid"),roomName=conference.attr("name")||room,autojoin=conference.attr("autojoin")||!1,nickname=conference.find("nick").text();nickname=nickname.length>0?nickname:Strophe.getNodeFromJid(jsxc.xmpp.conn.jid),"true"===autojoin?autojoin=!0:"false"===autojoin&&(autojoin=!1);var data=jsxc.storage.getUserItem("buddy",room)||{};data=$.extend(data,{jid:room,name:roomName,sub:"both",status:0,type:"groupchat",state:jsxc.muc.CONST.ROOMSTATE.INIT,subject:null,bookmarked:!0,autojoin:autojoin,nickname:nickname}),jsxc.storage.setUserItem("buddy",room,data),bl.push(room),jsxc.gui.roster.add(room),autojoin&&(jsxc.debug("auto join "+room),jsxc.xmpp.conn.muc.join(room,nickname))}),jsxc.storage.setUserItem("buddylist",bl)},function(stanza){var err=jsxc.xmpp.bookmarks.parseErr(stanza);"item-not-found"===err.reasons[0]?(jsxc.debug("create bookmark node"),bookmarks.createBookmarksNode()):jsxc.debug("[XMPP] Could not create bookmark: "+err.type,err.reasons)})},jsxc.xmpp.bookmarks.parseErr=function(stanza){var error=$(stanza).find("error"),type=error.attr("type"),reasons=error.children().map(function(){return $(this).prop("tagName")});return{type:type,reasons:reasons}},jsxc.xmpp.bookmarks["delete"]=function(room,soft){soft||jsxc.gui.roster.purge(room),jsxc.xmpp.bookmarks.deleteFromRemote(room,soft)},jsxc.xmpp.bookmarks.deleteFromRemote=function(room,soft){var bookmarks=jsxc.xmpp.conn.bookmarks;bookmarks["delete"](room,function(){jsxc.debug("Bookmark deleted "+room),soft&&(jsxc.gui.roster.getItem(room).removeClass("jsxc_bookmarked"),jsxc.storage.updateUserItem("buddy",room,"bookmarked",!1),jsxc.storage.updateUserItem("buddy",room,"autojoin",!1))},function(stanza){var err=jsxc.xmpp.bookmarks.parseErr(stanza);jsxc.debug("[XMPP] Could not delete bookmark: "+err.type,err.reasons)})},jsxc.xmpp.bookmarks.deleteFromLocal=function(room,soft){var bookmarks=jsxc.storage.getUserItem("bookmarks"),index=bookmarks.indexOf(room);index>-1&&bookmarks.splice(index,1),jsxc.storage.setUserItem("bookmarks",bookmarks),soft&&(jsxc.gui.roster.getItem(room).removeClass("jsxc_bookmarked"),jsxc.storage.updateUserItem("buddy",room,"bookmarked",!1),jsxc.storage.updateUserItem("buddy",room,"autojoin",!1))},jsxc.xmpp.bookmarks.add=function(room,alias,nick,autojoin){jsxc.xmpp.bookmarks.addToRemote(room,alias,nick,autojoin)},jsxc.xmpp.bookmarks.addToRemote=function(room,alias,nick,autojoin){var bookmarks=jsxc.xmpp.conn.bookmarks,success=function(){jsxc.debug("New bookmark created",room),jsxc.gui.roster.getItem(room).addClass("jsxc_bookmarked"),jsxc.storage.updateUserItem("buddy",room,"bookmarked",!0),jsxc.storage.updateUserItem("buddy",room,"autojoin",autojoin),jsxc.storage.updateUserItem("buddy",room,"nickname",nick)},error=function(){jsxc.warn("Could not create bookmark",room)};bookmarks.add(room,alias,nick,autojoin,success,error)},jsxc.xmpp.bookmarks.addToLocal=function(room,alias,nick,autojoin){jsxc.gui.roster.getItem(room).addClass("jsxc_bookmarked"),jsxc.storage.updateUserItem("buddy",room,"bookmarked",!0),jsxc.storage.updateUserItem("buddy",room,"autojoin",autojoin),jsxc.storage.updateUserItem("buddy",room,"nickname",nick);var bookmarks=jsxc.storage.getUserItem("bookmarks")||[];bookmarks.indexOf(room)<0&&(bookmarks.push(room),jsxc.storage.setUserItem("bookmarks",bookmarks))},jsxc.xmpp.bookmarks.showDialog=function(room){var dialog=jsxc.gui.dialog.open(jsxc.gui.template.get("bookmarkDialog")),data=jsxc.storage.getUserItem("buddy",room);$("#jsxc_room").val(room),$("#jsxc_nickname").val(data.nickname),$("#jsxc_bookmark").change(function(){$(this).prop("checked")?($("#jsxc_nickname").prop("disabled",!1),$("#jsxc_autojoin").prop("disabled",!1),$("#jsxc_autojoin").parent(".checkbox").removeClass("disabled")):($("#jsxc_nickname").prop("disabled",!0),$("#jsxc_autojoin").prop("disabled",!0).prop("checked",!1),$("#jsxc_autojoin").parent(".checkbox").addClass("disabled"))}),$("#jsxc_bookmark").prop("checked",data.bookmarked),$("#jsxc_autojoin").prop("checked",data.autojoin),$("#jsxc_bookmark").change(),dialog.find("form").submit(function(ev){ev.preventDefault();var bookmarked=$("#jsxc_bookmark").prop("checked"),autojoin=$("#jsxc_autojoin").prop("checked"),nickname=$("#jsxc_nickname").val();return bookmarked?jsxc.xmpp.bookmarks.add(room,data.name,nickname,autojoin):data.bookmarked&&jsxc.xmpp.bookmarks["delete"](room,!0),jsxc.gui.dialog.close(),!1})},jsxc.xmpp.search={conn:null,searchDomain:null,userSearchAvailable:!1,init:function(){var self=jsxc.xmpp.search;self.conn=jsxc.xmpp.conn;var xmppOpts=jsxc.options.get("xmpp");self.searchDomain=xmppOpts.searchDomain,"undefined"==typeof self.searchDomain&&(self.searchDomain=xmppOpts.domain,jsxc.warn("Search domain not found, domain will be used",xmppOpts.domain)),self.requestForSearchCapabilities().then(function(){jsxc.debug("XMPP search available")}).fail(function(){jsxc.warn("XMPP search unavailable")})},_searchDefers:{},_allUserTerms:"*",_checkIfBuddies:function(userArr){var buddies=jsxc.storage.getLocaleBuddyListBJID();return $.each(userArr,function(i,e){e._is_buddy=-1!==buddies.indexOf(jsxc.jidToBid(e.jid))}),userArr},getUserList:function(){var self=jsxc.xmpp.search;return self.searchUsers(self._allUserTerms).then(function(result){return JSON.parse(JSON.stringify(result))})},getFreshUserList:function(){var self=jsxc.xmpp.search;return delete self._searchDefers[self._allUserTerms],self.getUserList()},searchUsers:function(terms){var self=jsxc.xmpp.search;if(jsxc.stats.addEvent("jsxc.search.users"),!self.conn||self.conn.connected!==!0)return jsxc.warn("Search not available: not connected"),$.Deferred().promise().fail("Not connected");if(self._searchDefers[terms])return jsxc.debug("Search: return cached request"),self._searchDefers[terms].promise();var iq=$iq({type:"set",to:self.searchDomain}).c("query",{xmlns:"jabber:iq:search"}).c("x",{xmlns:"jabber:x:data",type:"submit"}).c("field",{type:"hidden","var":"FORM_TYPE"}).c("value","jabber:iq:search").up().up().c("field",{"var":"search",type:"text-single"}).c("value",terms).up().up().c("field",{"var":"Username",type:"boolean"}).c("value","1").up().up().c("field",{"var":"Name",type:"boolean"}).c("value","1").up().up();self._searchDefers[terms]=$.Deferred();var defer=self._searchDefers[terms];return self.conn.sendIQ(iq,function(stanza){if(jsxc.debug("Search: return fresh request"),$(stanza).find("error").length>0)return defer.reject(stanza),!1;var result=[];$(stanza).find("item").each(function(){var r={};$(this).find("field").each(function(){r[$(this).attr("var").toLowerCase()]=$(this).text()}),result.push(r)}),self._checkIfBuddies(result),defer.resolve(result)},function(){defer.reject(arguments)}),defer.promise()},requestForSearchCapabilities:function(){var capabilityRequestId,self=jsxc.xmpp.search,iq=$iq({type:"get",to:self.searchDomain}).c("query",{xmlns:"jabber:iq:search"}),defer=$.Deferred();return capabilityRequestId=self.conn.sendIQ(iq,function(stanza){self.userSearchAvailable=0===$(stanza).find("error").length,defer.resolve(self.userSearchAvailable)},function(){self.userSearchAvailable=!1,defer.reject(self.userSearchAvailable)}),defer.promise()}},$(function(){$(document).on("attached.jsxc",jsxc.xmpp.search.init)}),jsxc.gui.template.aboutDialog='<h3 data-i18n="hey_djoe"></h3>\n\n<p>\n  <b data-i18n="[html]heydjoe_description"></b>\n</p>\n\n<p data-i18n="about_free_description"></p>\n\n<p>\n  <span data-i18n="[html]more_information_on"></span><a href=\'http://hey-djoe.fr\' target="_blank">http://hey-djoe.fr</a>\n</p>\n\n<button class="btn btn-default pull-right jsxc_spaceInvasion">Space Invasion !</button>\n\n\n',jsxc.gui.template.alert='<h3 data-i18n="Alert"></h3>\n<div class="alert alert-info">\n   <strong data-i18n="Info"></strong> {{msg}}\n</div>\n',jsxc.gui.template.allowMediaAccess='<p data-i18n="Please_allow_access_to_microphone_and_camera"></p>\n',jsxc.gui.template.approveDialog='<h3 data-i18n="buddy_approve"></h3>\n<p>\n   <b class="jsxc_their_jid"></b> <span data-i18n="want_to_be_your_buddy"></span>\n</p>\n\n<button class="btn btn-primary jsxc_approve pull-right" data-i18n="Approve"></button>\n<button class="btn btn-default jsxc_deny pull-right" data-i18n="Deny"></button>\n',jsxc.gui.template.authFailDialog='<h3 data-i18n="Login_failed"></h3>\n<p data-i18n="Sorry_we_cant_authentikate_"></p>\n\n<button class="btn btn-primary jsxc_retry pull-right" data-i18n="Continue_without_chat"></button>\n<button class="btn btn-default jsxc_cancel pull-right" data-i18n="Retry"></button>\n',jsxc.gui.template.authenticationDialog='<h3>Verification</h3>\n<p data-i18n="Authenticating_a_buddy_helps_"></p>\n<div>\n   <p data-i18n="[html]How_do_you_want_to_authenticate_your_buddy"></p>\n\n   <div class="btn-group" role="group">\n      <button class="btn btn-default" data-i18n="Manual"></button>\n      <button class="btn btn-default" data-i18n="Question"></button>\n      <button class="btn btn-default" data-i18n="Secret"></button>\n   </div>\n</div>\n<hr />\n<div style="display: none">\n   <p data-i18n="To_verify_the_fingerprint_" class="jsxc_explanation"></p>\n   <p>\n      <strong data-i18n="Your_fingerprint"></strong>\n      <br /> <span style="text-transform: uppercase">{{my_priv_fingerprint}}</span>\n   </p>\n   <p>\n      <strong data-i18n="Buddy_fingerprint"></strong>\n      <br /> <span style="text-transform: uppercase">{{bid_priv_fingerprint}}</span>\n   </p>\n   <div class="jsxc_right">\n      <button class="btn btn-default jsxc_close" data-i18n="Close"></button>\n      <button class="btn btn-primary jsxc_submit" data-i18n="Compared"></button>\n   </div>\n</div>\n<div style="display: none" class="form-horizontal">\n   <p data-i18n="To_authenticate_using_a_question_" class="jsxc_explanation"></p>\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_quest" data-i18n="Question"></label>\n      <div class="col-sm-8">\n         <input type="text" name="quest" id="jsxc_quest" class="form-control" />\n      </div>\n   </div>\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_secret2" data-i18n="Secret"></label>\n      <div class="col-sm-8">\n         <input type="text" name="secret2" id="jsxc_secret2" class="form-control" />\n      </div>\n   </div>\n   <div class="form-group">\n      <div class="col-sm-offset-4 col-sm-8">\n         <button class="btn btn-default jsxc_close" data-i18n="Close"></button>\n         <button class="btn btn-primary jsxc_submit" data-i18n="Ask"></button>\n      </div>\n   </div>\n</div>\n<div style="display: none" class="form-horizontal">\n   <p class="jsxc_explanation" data-i18n="To_authenticate_pick_a_secret_"></p>\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_secret" data-i18n="Secret"></label>\n      <div class="col-sm-8">\n         <input type="text" name="secret" id="jsxc_secret" class="form-control" />\n      </div>\n   </div>\n   <div class="form-group">\n      <div class="col-sm-offset-4 col-sm-8">\n         <button class="btn btn-default jsxc_close" data-i18n="Close"></button>\n         <button class="btn btn-primary jsxc_submit" data-i18n="Compare"></button>\n      </div>\n   </div>\n</div>\n',jsxc.gui.template.bookmarkDialog='<h3 data-i18n="Edit_bookmark"></h3>\n<form class="form-horizontal">\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_room" data-i18n="Room"></label>\n      <div class="col-sm-8">\n         <input type="text" id="jsxc_room" class="form-control" required="required" readonly="readonly" />\n      </div>\n   </div>\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_nickname" data-i18n="Nickname"></label>\n      <div class="col-sm-8">\n         <input type="text" disabled="disabled" required="required" name="nickname" id="jsxc_nickname" class="form-control" />\n      </div>\n   </div>\n   <div class="form-group">\n      <div class="col-sm-offset-4 col-sm-8">\n         <div class="checkbox">\n            <label>\n               <input id="jsxc_bookmark" type="checkbox"><span data-i18n="Bookmark"></span>\n            </label>\n         </div>\n      </div>\n   </div>\n   <div class="form-group">\n      <div class="col-sm-offset-4 col-sm-8">\n         <div class="checkbox disabled">\n            <label>\n               <input disabled="disabled" id="jsxc_autojoin" type="checkbox"><span data-i18n="Auto-join"></span>\n            </label>\n         </div>\n      </div>\n   </div>\n   <div class="form-group">\n      <div class="col-sm-offset-4 col-sm-8">\n         <button type="button" class="btn btn-default jsxc_close" data-i18n="Close"></button>\n         <button type="submit" class="btn btn-primary jsxc_submit" data-i18n="Save"></button>\n      </div>\n   </div>\n</form>\n',jsxc.gui.template.chatWindow='<li class="jsxc_windowItem">\n  <div class="jsxc_window">\n    <div class="jsxc_bar">\n      <div class="jsxc_avatar"></div>\n      <div class="jsxc_tools">\n        <div class="jsxc_settings">\n          <div class="jsxc_more"></div>\n          <div class="jsxc_inner jsxc_menu">\n            <ul>\n              <li>\n                <a class="jsxc_clear">\n                  <span data-i18n="clear_history"></span>\n                </a>\n              </li>\n            </ul>\n          </div>\n        </div>\n        <div class="jsxc_close">×</div>\n      </div>\n      <div class="jsxc_caption">\n        <div class="jsxc_name"/>\n        <div class="jsxc_lastmsg">\n          <span class="jsxc_unread"/>\n          <span class="jsxc_text"/>\n        </div>\n      </div>\n    </div>\n    <div class="jsxc_fade">\n      <div class="jsxc_overlay">\n        <div>\n          <div class="jsxc_body"/>\n          <div class="jsxc_close"/>\n        </div>\n      </div>\n      <div class="jsxc_textarea"/>\n      <div class="jsxc_emoticons">\n        <div class="jsxc_inner">\n          <ul>\n            <li style="clear:both"></li>\n          </ul>\n        </div>\n      </div>\n      <input type="text" class="jsxc_textinput" data-i18n="[placeholder]Message"/>\n    </div>\n  </div>\n</li>\n',jsxc.gui.template.confirmDialog='<p>{{msg}}</p>\n\n<button class="btn btn-primary jsxc_confirm pull-right" data-i18n="Confirm"></button>\n<button class="btn btn-default jsxc_dismiss jsxc_close pull-right" data-i18n="Dismiss"></button>\n',jsxc.gui.template.contactDialog='<h3 data-i18n="Add_buddy"></h3>\n<p class=".jsxc_explanation" data-i18n="Type_in_the_full_username_"></p>\n<form class="form-horizontal">\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_username" data-i18n="Username"></label>\n      <div class="col-sm-8">\n         <input type="text" name="username" id="jsxc_username" class="form-control" list="jsxc_userlist" pattern="^[^\\x22&\'\\\\/:<>@\\s]+(@[.\\-_\\w]+)?" required="required" />\n      </div>\n   </div>\n   <datalist id="jsxc_userlist"></datalist>\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_alias" data-i18n="Alias"></label>\n      <div class="col-sm-8">\n         <input type="text" name="alias" id="jsxc_alias" class="form-control" />\n      </div>\n   </div>\n   <div class="form-group">\n      <div class="col-sm-offset-4 col-sm-8">\n         <button class="btn btn-default jsxc_close" type="button" data-i18n="Close"></button>\n         <button class="btn btn-primary" type="submit" data-i18n="Add"></button>\n      </div>\n   </div>\n</form>\n',jsxc.gui.template.etherpadCreation='<h3 data-i18n="etherpad_document"></h3>\n\n<p data-i18n="[html]etherpad_description"></p>\n\n<p data-i18n="[html]etherpad_wikipedia_link"></p>\n\n<p>\n  <b data-i18n="etherpad_document_name"></b>\n  <input type="text" class="jsxc-etherpad-name"/>\n</p>\n\n\n<p>\n  <b data-i18n="etherpad_invite_users"></b>\n  <div id="jsxc-etherpad-dialog-buddylist"></div>\n</p>\n\n<button class="btn btn-primary jsxc_confirm pull-right" data-i18n="Confirm"></button>\n<button class="btn btn-default jsxc_cancel jsxc_close pull-right" data-i18n="Cancel"></button>\n<button class="btn btn-default jsxc_refresh pull-right" data-i18n="refresh"></button>',jsxc.gui.template.fingerprintsDialog='<div>\n   <p class="jsxc_maxWidth" data-i18n="A_fingerprint_"></p>\n   <p>\n      <strong data-i18n="Your_fingerprint"></strong>\n      <br /> <span style="text-transform: uppercase">{{my_priv_fingerprint}}</span>\n   </p>\n   <p>\n      <strong data-i18n="Buddy_fingerprint"></strong>\n      <br /> <span style="text-transform: uppercase">{{bid_priv_fingerprint}}</span>\n   </p>\n</div>\n',jsxc.gui.template.incomingCall='<h3 data-i18n="Incoming_call"></h3>\n<p>\n   <span data-i18n="Do_you_want_to_accept_the_call_from"></span> <b>{{bid_name}}</b>?\n</p>\n\n<button class="btn btn-primary jsxc_accept pull-right" data-i18n="Accept"></button>\n<button class="btn btn-default jsxc_reject pull-right" data-i18n="Reject"></button>\n',jsxc.gui.template.incomingEtherpad='<h3 data-i18n="etherpad_invitation"></h3>\n<p><b>{{bid_name}}</b> <span data-i18n="invite_you_to_share_pad"></span></p>\n\n<button class="btn btn-primary jsxc_confirm pull-right" data-i18n="Accept"></button>\n<button class="btn btn-default jsxc_cancel jsxc_close pull-right" data-i18n="Reject"></button>\n',jsxc.gui.template.incomingScreensharing='<h3 data-i18n="screen_sharing"></h3>\n<p>\n  <span data-i18n="[html]do_you_want_to_view_screen_of"></span>\n   <b>{{bid_name}}</b>?\n</p>\n\n<button class="btn btn-primary jsxc_accept pull-right" data-i18n="Accept"></button>\n<button class="btn btn-default jsxc_reject pull-right" data-i18n="Reject"></button>\n',jsxc.gui.template.incomingVideoconference='<h3 data-i18n="videconference"></h3>\n<p>\n  <b>{{bid_name}}</b> <span data-i18n="want_to_invite_you_in_videoconference"></span>\n</p>\n\n<button class="btn btn-primary jsxc_accept pull-right" data-i18n="Accept"></button>\n<button class="btn btn-default jsxc_reject pull-right" data-i18n="Reject"></button>\n',jsxc.gui.template.installChromeExtension='<h3 data-i18n="install_chrome_screen_sharing_extension"></h3>\n\n<img id="jsxc_installationIllustration"/>\n\n<p data-i18n="install_chrome_extension_intro"></p>\n\n<ol>\n  <li data-i18n="open_dialog_in_chrome"></li>\n  <li>\n    <a id="jsxc-chrome-extension-link" data-i18n="click_here_to_download_extension"></a>\n     <span data-i18n="then_save_it_in_your_system"></span>\n  </li>\n  <li>\n    <a href="about:blank" target="_blank" data-i18n="open_a_new_tab"></a>\n  </li>\n  <li data-i18n="[html]then_go_to_settings"></li>\n  <li data-i18n="[html]drop_extension_on_page"></li>\n  <li data-i18n="[html]confirm_extension_installation"></li>\n  <li data-i18n="[html]then_refresh_page"></li>\n</ol>\n\n<button class="btn btn-default pull-right jsxc_closeInstallChromeExtension" data-i18n="Close"></button>\n<button class="btn btn-primary pull-right jsxc_reloadInstallChromeExtension" data-i18n="reload_page"></button>\n',jsxc.gui.template.joinChat='<h3 data-i18n="Join_chat"></h3>\n<p class=".jsxc_explanation" data-i18n="muc_explanation"></p>\n<div class="form-horizontal">\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_server" data-i18n="Server"></label>\n      <div class="col-sm-8">\n         <input type="text" name="server" id="jsxc_server" class="form-control" required="required" readonly="readonly" />\n      </div>\n   </div>\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_room" data-i18n="Room"></label>\n      <div class="col-sm-8">\n         <input type="text" name="room" id="jsxc_room" class="form-control" autocomplete="off" list="jsxc_roomlist" required="required" pattern="^[^\\x22&\'\\/:<>@\\s]+" />\n      </div>\n   </div>\n   <p class="jsxc_inputinfo jsxc_waiting jsxc_room" data-i18n="Rooms_are_loaded"></p>\n   <datalist id="jsxc_roomlist">\n      <p>\n         <label for="jsxc_roomlist_select"></label>\n         <select id="jsxc_roomlist_select">\n            <option></option>\n            <option>workaround</option>\n         </select>\n      </p>\n   </datalist>\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_nickname" data-i18n="Nickname"></label>\n      <div class="col-sm-8">\n         <input type="text" name="nickname" id="jsxc_nickname" class="form-control" />\n      </div>\n   </div>\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_password" data-i18n="Password"></label>\n      <div class="col-sm-8">\n         <input type="text" name="password" id="jsxc_password" class="form-control" />\n      </div>\n   </div>\n   <div class="form-group jsxc_bookmark">\n      <div class="col-sm-offset-4 col-sm-8">\n         <div class="checkbox">\n            <label>\n               <input id="jsxc_bookmark" type="checkbox"><span data-i18n="Bookmark"></span>\n            </label>\n         </div>\n      </div>\n   </div>\n   <div class="form-group jsxc_bookmark">\n      <div class="col-sm-offset-4 col-sm-8">\n         <div class="checkbox disabled">\n            <label>\n               <input disabled="disabled" id="jsxc_autojoin" type="checkbox"><span data-i18n="Auto-join"></span>\n            </label>\n         </div>\n      </div>\n   </div>\n   <div class="jsxc_msg"></div>\n   <div class="form-group">\n      <div class="col-sm-offset-4 col-sm-8">\n         <span class="jsxc_warning"></span>\n         <button class="btn btn-default jsxc_close" data-i18n="Close"></button>\n         <button class="btn btn-primary jsxc_continue" data-i18n="Continue"></button>\n         <button class="btn btn-success jsxc_join" data-i18n="Join"></button>\n      </div>\n   </div>\n</div>\n',jsxc.gui.template.joinConversationDialog='<h3 data-i18n="conversation_invitation"></h3>\n<p>\n   <b class="jsxc_buddyName"></b> <span data-i18n="invite_you_in_conversation"></span>\n</p>\n\n<button class="btn btn-primary jsxc_approve pull-right" data-i18n="Approve"></button>\n<button class="btn btn-default jsxc_deny pull-right" data-i18n="Deny"></button>\n',jsxc.gui.template.loginBox='<h3 data-i18n="Login"></h3>\n<form class="form-horizontal">\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_username" data-i18n="Username"></label>\n      <div class="col-sm-8">\n         <input type="text" name="username" id="jsxc_username" class="form-control" required="required" value="{{my_node}}" />\n      </div>\n   </div>\n   <div class="form-group">\n      <label class="col-sm-4 control-label" for="jsxc_password" data-i18n="Password"></label>\n      <div class="col-sm-8">\n         <input type="password" name="password" required="required" class="form-control" id="jsxc_password" />\n      </div>\n   </div>\n   <div class="jsxc_alert jsxc_alert-warning" data-i18n="Sorry_we_cant_authentikate_"></div>\n   <div class="form-group">\n      <div class="col-sm-offset-4 col-sm-9">\n         <button type="reset" class="btn btn-default jsxc_close" name="clear" data-i18n="Cancel" />\n         <button type="submit" class="btn btn-primary" name="commit" data-i18n="[data-jsxc-loading-text]Connecting...;Connect" />\n      </div>\n   </div>\n</form>\n',jsxc.gui.template.newgui_chatsidebar='<div id="jsxc-chat-sidebar">\n\n  <!--\n\n  Sidebar header, always visible\n\n  -->\n  <div id="jsxc-chat-sidebar-header">\n\n    <!-- toggle video -->\n    <span class="jsxc-toggle-mediapanel"></span>\n\n    <span class="jsxc-header-content"></span>\n\n    <!-- close chatsidebar -->\n    <span class="jsxc-close-chatsidebar"></span>\n\n    <!-- Open help menu -->\n    <span class="jsxc-toggle-help"></span>\n\n    <!-- open settings menu -->\n    <span class="jsxc-toggle-settings"></span>\n\n  </div>\n\n\n  <!-- Chat sidebar content -->\n  <div id="jsxc-chat-sidebar-content">\n\n\n    <!--\n\n    Head of content with filters and menu button, static\n\n    -->\n    <div id="jsxc-action-bar">\n\n      <a id="jsxc-new-gui-filter-users" data-i18n="users"></a>\n      <a id="jsxc-new-gui-filter-conversations" data-i18n="conversations"></a>\n\n      <a id="jsxc-select-buddies">\n        <span data-i18n="select"></span> <span class="jsxc-selected-number"></span></a>\n\n      <span id="jsxc-toggle-actions"></span>\n\n    </div>\n\n\n    <!--\n\n      Bottom of content, that can be changed by user\n\n    -->\n    <div id="jsxc-sidebar-content-viewport">\n\n\n      <!--\n\n      Parameters menu\n\n      -->\n\n      <div id="jsxc-settings-menu" class="jsxc-viewport-content">\n\n        <div class="jsxc-title" data-i18n="parameters"></div>\n\n        <a class="jsxc-action jsxc-action_toggleMuteMode" data-i18n="play_sounds"></a>\n        <a class="jsxc-action jsxc-action_toggleNotifications" data-i18n="display_notifications"></a>\n        <a class="jsxc-action jsxc-action_disableVideoCalls" data-i18n="disable_video_calls"></a>\n\n        <div class="jsxc-content-separator"></div>\n\n        <a class="jsxc-action jsxc-action_clearLocalHistory" data-i18n="clear_local_conversations_history"></a>\n        <a class="jsxc-action jsxc-action_installScreenSharingExtension" data-i18n="screensharing_extension"></a>\n\n        <div class="jsxc-content-separator"></div>\n\n        <a class="jsxc-action jsxc-action_showCollectedDatas" data-i18n="collected_datas"></a>\n\n        <a class="jsxc-action jsxc-show-about-dialog" data-i18n="About"></a>\n\n      </div>\n\n\n      <!--\n\n      Help menu\n\n      -->\n\n      <div id="jsxc-help-menu" class="jsxc-viewport-content">\n\n        <div class="jsxc-title" data-i18n="help"></div>\n\n        <ul id="jsxc-help-tutorial-list"></ul>\n\n      </div>\n\n\n      <!--\n\n      Main menu\n\n      -->\n\n      <div id="jsxc-main-menu" class="jsxc-viewport-content">\n\n        <div class="jsxc-title" data-i18n="menu"></div>\n\n        <a class="jsxc-action jsxc-action_search-user" data-i18n="search_user"></a>\n        <a class="jsxc-action jsxc-action_manage-notifications" data-i18n="notifications">\n          &nbsp;<span class="jsxc_menu_notif_number"></span></a>\n\n        <div class="jsxc-content-separator"></div>\n\n        <a class="jsxc-action jsxc-action_new-conversation" data-i18n="new_conversation"></a>\n        <a class="jsxc-action jsxc-action_invite-in-conversation" data-i18n="invite_in_conversation"></a>\n        <a class="jsxc-action jsxc-action_new-etherpad-document" data-i18n="open_etherpad"></a>\n\n        <div class="jsxc-content-separator"></div>\n\n        <a class="jsxc-action jsxc-action jsxc-action_video-call" data-i18n="video_call"></a>\n        <a class="jsxc-action jsxc-action_videoconference" data-i18n="videoconference"></a>\n        <a class="jsxc-action jsxc-action_screensharing" data-i18n="share_screen"></a>\n\n        <div class="jsxc-content-separator"></div>\n\n        <a class="jsxc-action jsxc-action_delete-buddies" data-i18n="delete"></a>\n\n      </div>\n\n      <!--\n\n      Search menu\n\n      -->\n\n      <div id="jsxc-search-users" class="jsxc-viewport-content">\n\n        <div class="jsxc-title" data-i18n="search"></div>\n\n        <input id="jsxc-chat-sidebar-search" placeholder="..." type="text"/>\n\n        <button id="jsxc-chat-sidebar-search-chat" class="btn btn-default" data-i18n="discuss"/>\n        <button id="jsxc-chat-sidebar-search-invite" class="btn btn-primary" data-i18n="invite"/>\n\n        <div class="jsxc-search-users-results">\n\n        </div>\n\n      </div>\n\n      <!--\n\n      Notification menu\n\n      -->\n      <div id="jsxc-manage-notifications" class="jsxc-viewport-content">\n\n        <div class="jsxc-title">\n          <span data-i18n="notifications"></span>&nbsp;\n          <span class="jsxc_menu_notif_number"></span></div>\n\n        <a class="jsxc-action jsxc-action_rejectAllNotifications" data-i18n="reject_all"></a>\n        <a class="jsxc-action jsxc-action_notificationsParameters" data-i18n="parameters"></a>\n\n        <div id="jsxc-notifications">\n          <ul></ul>\n        </div>\n\n      </div>\n\n      <!--\n\n      Connexion form\n\n      -->\n      <div id="jsxc-connexion-menu" class="jsxc-viewport-content">\n\n        <div class="jsxc-title" data-i18n="connection"></div>\n\n        <p data-i18n="login"></p>\n        <input type="text" id="jsxc-connexion-login"/>\n\n        <p data-i18n="password"></p>\n        <input type="password" id="jsxc-connexion-password"/>\n\n        <button id="jsxc-connexion-submit" class="btn btn-primary" data-i18n="connect_me">\n        </button>\n\n        <div id="jsxc-login-standby" data-i18n="please_stand_by">\n        </div>\n\n        <div id="jsxc-login-warning" data-i18n="connection_if_problem_persist">\n        </div>\n\n      </div>\n\n      <!--\n\n      Buddy list, where stored contacts AND buddies\n\n      -->\n      <div id="jsxc-buddy-list-container" class="jsxc-viewport-content">\n\n        <!-- We need to have a block before buddy list -->\n        <div>&nbsp;</div>\n\n        <ul id="jsxc_buddylist"></ul>\n\n      </div>\n\n    </div>\n\n\n    <!--\n\n    Status bar, bottom of content, static\n\n    -->\n\n    <div id="jsxc-status-bar">\n\n      <span class="jsxc-user-name"></span>\n\n      <select class="jsxc-select-status">\n        <option value="online" class="jsxc_online" data-i18n="Online"></option>\n        <option value="chat" class="jsxc_chat" data-i18n="Chatty"></option>\n        <option value="away" class="jsxc_away" data-i18n="Away"></option>\n        <option value="xa" class="jsxc_xa" data-i18n="Extended_away"></option>\n        <option value="dnd" class="jsxc_dnd" data-i18n="dnd"></option>\n      </select>\n\n      <span class="jsxc-login-button"></span>\n      <span class="jsxc-logout-button"></span>\n\n    </div>\n\n  </div>\n\n</div>',
jsxc.gui.template.newgui_mediapanel='<!-- Panel where are displayed videos -->\n<div id="jsxc-mediapanel">\n\n  <a class="jsxc-close-mediapanel"></a>\n\n  <div id="jsxc-mediapanel-left">\n\n    <div class="jsxc-header" data-i18n="multimedia_panel"></div>\n\n    <div>\n      <p data-i18n="local_video"></p>\n      <video id="jsxc-local-video"/>\n    </div>\n\n    <div>\n      <p data-i18n="participants"></p>\n      <ul class="jsxc_videoconferenceUsers"></ul>\n    </div>\n\n    <p>\n      <a class="jsxc_mmstreamTerminateAll" data-i18n="terminate_all_and_reset_multimedia"></a>\n    </p>\n\n  </div>\n\n  <div id="jsxc-mediapanel-right">\n\n  </div>\n\n</div>',jsxc.gui.template.pleaseAccept='<p data-i18n="Please_accept_"></p>\n',jsxc.gui.template.reinviteUser_emit='<h3 data-i18n="reinvitation"></h3>\n<p>\n   <span data-i18n="do_you_want_reinvite"></span> <b>{{bid_name}}</b> ?\n</p>\n\n<button class="btn btn-primary jsxc_accept pull-right" data-i18n="reinvite"></button>\n<button class="btn btn-default jsxc_reject pull-right" data-i18n="Cancel"></button>\n',jsxc.gui.template.reinviteUser_received='<h3 data-i18n="reinvitation"></h3>\n<p>\n  <b>{{bid_name}}</b> <span data-i18n="want_to_invite_you_again"></span>\n</p>\n\n<button class="btn btn-primary jsxc_accept pull-right" data-i18n="Accept"></button>\n<button class="btn btn-default jsxc_reject pull-right" data-i18n="Reject"></button>\n',jsxc.gui.template.removeDialog='<h3 data-i18n="Remove_buddy"></h3>\n<p class="jsxc_maxWidth" data-i18n="[html]You_are_about_to_remove_"></p>\n\n<button class="btn btn-primary jsxc_remove pull-right" data-i18n="Remove"></button>\n<button class="btn btn-default jsxc_cancel jsxc_close pull-right" data-i18n="Cancel"></button>\n',jsxc.gui.template.removeManyDialog='<h3 data-i18n="delete_many"></h3>\n\n<p class="jsxc_maxWidth" data-i18n="delete_many_description"></p>\n\n<ol class="jsxc_elementsToRemove"></ol>\n\n<button class="btn btn-primary jsxc_remove pull-right" data-i18n="Remove"></button>\n<button class="btn btn-default jsxc_cancel jsxc_close pull-right" data-i18n="Cancel"></button>\n',jsxc.gui.template.rosterBuddy='<li class="jsxc_rosteritem">\n\n  <div class="jsxc_avatar"></div>\n\n  <div class="jsxc_caption">\n\n    <div class="jsxc_name"/>\n\n    <div class="jsxc_lastmsg">\n      <span class="jsxc_unread"/>\n      <span class="jsxc_text"/>\n    </div>\n\n  </div>\n</li>\n',jsxc.gui.template.selectContacts='<h3 data-i18n="select_buddies"></h3>\n\n<div id="jsxc-invite-dialog-buddylist"></div>\n<div id="jsxc-invite-dialog-refresh"></div>\n\n<button class="btn btn-primary jsxc_confirm pull-right" data-i18n="select"></button>\n<button class="btn btn-default jsxc_cancel jsxc_close pull-right" data-i18n="Cancel"></button>\n<button class="btn btn-default jsxc_refresh pull-right" data-i18n="refresh"></button>',jsxc.gui.template.selectConversations='<h3 data-i18n="select_conversations"></h3>\n\n<div id="jsxc_dialogConversationList"></div>\n\n<button class="btn btn-primary jsxc_confirm pull-right" data-i18n="select"></button>\n<button class="btn btn-default jsxc_cancel jsxc_close pull-right" data-i18n="Cancel"></button>\n<button class="btn btn-default jsxc_refresh pull-right" data-i18n="refresh"></button>',jsxc.gui.template.settings='<form class="form-horizontal col-sm-6">\n   <fieldset class="jsxc_fieldsetXmpp jsxc_fieldset">\n      <h3 data-i18n="Login_options"></h3>\n      <p data-i18n="setting-explanation-xmpp"></p>\n      <div class="form-group">\n         <label class="col-sm-6 control-label" for="xmpp-url" data-i18n="BOSH_url"></label>\n         <div class="col-sm-6">\n            <input type="text" id="xmpp-url" class="form-control" readonly="readonly" />\n         </div>\n      </div>\n      <div class="form-group">\n         <label class="col-sm-6 control-label" for="xmpp-username" data-i18n="Username"></label>\n         <div class="col-sm-6">\n            <input type="text" id="xmpp-username" class="form-control" />\n         </div>\n      </div>\n      <div class="form-group">\n         <label class="col-sm-6 control-label" for="xmpp-domain" data-i18n="Domain"></label>\n         <div class="col-sm-6">\n            <input type="text" id="xmpp-domain" class="form-control" />\n         </div>\n      </div>\n      <div class="form-group">\n         <label class="col-sm-6 control-label" for="xmpp-resource" data-i18n="Resource"></label>\n         <div class="col-sm-6">\n            <input class="form-control" type="text" id="xmpp-resource" class="form-control" />\n         </div>\n      </div>\n      <div class="form-group">\n         <div class="col-sm-offset-6 col-sm-6">\n            <button class="btn btn-primary jsxc_continue" type="submit" data-i18n="Save"></button>\n         </div>\n      </div>\n   </fieldset>\n</form>\n\n<form class="form-horizontal col-sm-6">\n   <fieldset class="jsxc_fieldsetPriority jsxc_fieldset">\n      <h3 data-i18n="Priority"></h3>\n      <p data-i18n="setting-explanation-priority"></p>\n      <div class="form-group">\n         <label class="col-sm-6 control-label" for="priority-online" data-i18n="Online"></label>\n         <div class="col-sm-6">\n            <input type="number" value="0" id="priority-online" class="form-control" min="-128" max="127" step="1" required="required" />\n         </div>\n      </div>\n      <div class="form-group">\n         <label class="col-sm-6 control-label" for="priority-chat" data-i18n="Chatty"></label>\n         <div class="col-sm-6">\n            <input type="number" value="0" id="priority-chat" class="form-control" min="-128" max="127" step="1" required="required" />\n         </div>\n      </div>\n      <div class="form-group">\n         <label class="col-sm-6 control-label" for="priority-away" data-i18n="Away"></label>\n         <div class="col-sm-6">\n            <input type="number" value="0" id="priority-away" class="form-control" min="-128" max="127" step="1" required="required" />\n         </div>\n      </div>\n      <div class="form-group">\n         <label class="col-sm-6 control-label" for="priority-xa" data-i18n="Extended_away"></label>\n         <div class="col-sm-6">\n            <input type="number" value="0" id="priority-xa" class="form-control" min="-128" max="127" step="1" required="required" />\n         </div>\n      </div>\n      <div class="form-group">\n         <label class="col-sm-6 control-label" for="priority-dnd" data-i18n="dnd"></label>\n         <div class="col-sm-6">\n            <input type="number" value="0" id="priority-dnd" class="form-control" min="-128" max="127" step="1" required="required" />\n         </div>\n      </div>\n      <div class="form-group">\n         <div class="col-sm-offset-6 col-sm-6">\n            <button class="btn btn-primary jsxc_continue" type="submit" data-i18n="Save"></button>\n         </div>\n      </div>\n   </fieldset>\n</form>\n\n<form class="form-horizontal col-sm-6">\n   <fieldset class="jsxc_fieldsetLoginForm jsxc_fieldset">\n      <h3 data-i18n="On_login"></h3>\n      <p data-i18n="setting-explanation-login"></p>\n      <div class="form-group">\n         <div class="col-sm-12">\n            <div class="checkbox">\n               <label>\n                  <input type="checkbox" id="loginForm-enable"><span data-i18n="On_login"></span>\n               </label>\n            </div>\n         </div>\n      </div>\n      <div class="form-group">\n         <div class="col-sm-12">\n            <button class="btn btn-primary jsxc_continue" type="submit" data-i18n="Save"></button>\n         </div>\n      </div>\n   </fieldset>\n</form>\n\n<form class="form-horizontal col-sm-6" data-onsubmit="xmpp.carbons.refresh">\n   <fieldset class="jsxc_fieldsetCarbons jsxc_fieldset">\n      <h3 data-i18n="Carbon_copy"></h3>\n      <p data-i18n="setting-explanation-carbon"></p>\n      <div class="form-group">\n         <div class="col-sm-12">\n            <div class="checkbox">\n               <label>\n                  <input type="checkbox" id="carbons-enable"><span data-i18n="Enable"></span>\n               </label>\n            </div>\n         </div>\n      </div>\n      <div class="form-group">\n         <div class="col-sm-12">\n            <button class="btn btn-primary jsxc_continue" type="submit" data-i18n="Save"></button>\n         </div>\n      </div>\n   </fieldset>\n</form>\n',jsxc.gui.template.vCard='<h3>\n	<span data-i18n="Info_about"></span> <span>{{bid_name}}</span>\n</h3>\n<ul class="jsxc_vCard"></ul>\n<p>\n   <img src="{{root}}/img/loading.gif" alt="wait" width="32px" height="32px" /> <span data-i18n="Please_wait"></span>...\n</p>\n',jsxc.gui.template.videoStreamDialog='<h3 class="jsxc_from_jid"></h3>\n\n<div>\n  <video class="jsxc_fullscreenVideo"></video>\n</div>\n\n<div>\n  <button class="btn btn-default pull-right jsxc_hangUpCall" data-i18n="hang_up_call"></button>\n  <button class="btn btn-default pull-right jsxc_closeVideoDialog" data-i18n="close_dialog"></button>\n</div>',jsxc.gui.template.videoWindow='<div id="jsxc_webrtc">\n   <div class="jsxc_chatarea">\n      <ul></ul>\n   </div>\n   <div class="jsxc_videoContainer">\n      <video class="jsxc_localvideo" autoplay></video>\n      <video class="jsxc_remotevideo" autoplay></video>\n      <div class="jsxc_status"></div>\n      <div class="bubblingG">\n         <span id="bubblingG_1"> </span> <span id="bubblingG_2"> </span> <span id="bubblingG_3"> </span>\n      </div>\n      <div class="jsxc_noRemoteVideo">\n         <div>\n            <div></div>\n            <p data-i18n="No_video_signal"></p>\n            <div></div>\n         </div>\n      </div>\n      <div class="jsxc_controlbar jsxc_visible">\n         <div>\n            <div class="jsxc_hangUp jsxc_videoControl" />\n            <div class="jsxc_fullscreen jsxc_videoControl" />\n         </div>\n      </div>\n   </div>\n   <div class="jsxc_multi">\n      <div class="jsxc_snapshotbar">\n         <p>No pictures yet!</p>\n      </div>\n      <!--<div class="jsxc_chatarea">\n                   <ul></ul>\n               </div>-->\n      <div class="jsxc_infobar"></div>\n   </div>\n</div>\n',jsxc.gui.template.waitAlert='<h3>{{msg}}</h3>\n\n<div class="progress">\n   <div class="progress-bar progress-bar-striped active" style="width: 100%" data-i18n="Please_wait">\n   </div>\n</div>\n',jsxc.gui.template.windowList='<div id="jsxc_windowList">\n   <ul></ul>\n</div>\n<div id="jsxc_windowListSB">\n   <div class="jsxc_scrollLeft jsxc_disabled">&lt;</div>\n   <div class="jsxc_scrollRight jsxc_disabled">&gt;</div>\n   <div class="jsxc_closeAllWindows jsxc_disabled">X</div>\n</div>\n'}(jQuery)},function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__,Sha1={};Sha1.hash=function(msg){msg=msg.utf8Encode();var K=[1518500249,1859775393,2400959708,3395469782];msg+=String.fromCharCode(128);for(var l=msg.length/4+2,N=Math.ceil(l/16),M=new Array(N),i=0;N>i;i++){M[i]=new Array(16);for(var j=0;16>j;j++)M[i][j]=msg.charCodeAt(64*i+4*j)<<24|msg.charCodeAt(64*i+4*j+1)<<16|msg.charCodeAt(64*i+4*j+2)<<8|msg.charCodeAt(64*i+4*j+3)}M[N-1][14]=8*(msg.length-1)/Math.pow(2,32),M[N-1][14]=Math.floor(M[N-1][14]),M[N-1][15]=8*(msg.length-1)&4294967295;for(var a,b,c,d,e,H0=1732584193,H1=4023233417,H2=2562383102,H3=271733878,H4=3285377520,W=new Array(80),i=0;N>i;i++){for(var t=0;16>t;t++)W[t]=M[i][t];for(var t=16;80>t;t++)W[t]=Sha1.ROTL(W[t-3]^W[t-8]^W[t-14]^W[t-16],1);a=H0,b=H1,c=H2,d=H3,e=H4;for(var t=0;80>t;t++){var s=Math.floor(t/20),T=Sha1.ROTL(a,5)+Sha1.f(s,b,c,d)+e+K[s]+W[t]&4294967295;e=d,d=c,c=Sha1.ROTL(b,30),b=a,a=T}H0=H0+a&4294967295,H1=H1+b&4294967295,H2=H2+c&4294967295,H3=H3+d&4294967295,H4=H4+e&4294967295}return Sha1.toHexStr(H0)+Sha1.toHexStr(H1)+Sha1.toHexStr(H2)+Sha1.toHexStr(H3)+Sha1.toHexStr(H4)},Sha1.f=function(s,x,y,z){switch(s){case 0:return x&y^~x&z;case 1:return x^y^z;case 2:return x&y^x&z^y&z;case 3:return x^y^z}},Sha1.ROTL=function(x,n){return x<<n|x>>>32-n},Sha1.toHexStr=function(n){for(var v,s="",i=7;i>=0;i--)v=n>>>4*i&15,s+=v.toString(16);return s},"undefined"==typeof String.prototype.utf8Encode&&(String.prototype.utf8Encode=function(){return unescape(encodeURIComponent(this))}),"undefined"==typeof String.prototype.utf8Decode&&(String.prototype.utf8Decode=function(){try{return decodeURIComponent(escape(this))}catch(e){return this}}),"undefined"!=typeof module&&module.exports&&(module.exports=Sha1),__WEBPACK_AMD_DEFINE_ARRAY__=[],__WEBPACK_AMD_DEFINE_RESULT__=function(){return Sha1}.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__),!(void 0!==__WEBPACK_AMD_DEFINE_RESULT__&&(module.exports=__WEBPACK_AMD_DEFINE_RESULT__))},function(module,exports,__webpack_require__){!function(root,factory){module.exports=factory()}(this,function(){function _extend(target,source){if(!source||"function"==typeof source)return target;for(var attr in source)target[attr]=source[attr];return target}function _deepExtend(target,source){for(var prop in source)prop in target?_deepExtend(target[prop],source[prop]):target[prop]=source[prop];return target}function _each(object,callback,args){var name,i=0,length=object.length,isObj=void 0===length||"[object Array]"!==Object.prototype.toString.apply(object)||"function"==typeof object;if(args)if(isObj){for(name in object)if(callback.apply(object[name],args)===!1)break}else for(;length>i&&callback.apply(object[i++],args)!==!1;);else if(isObj){for(name in object)if(callback.call(object[name],name,object[name])===!1)break}else for(;length>i&&callback.call(object[i],i,object[i++])!==!1;);return object}function _escape(data){return"string"==typeof data?data.replace(/[&<>"'\/]/g,function(s){return _entityMap[s]}):data}function _ajax(options){var getXhr=function(callback){if(window.XMLHttpRequest)return callback(null,new XMLHttpRequest);if(window.ActiveXObject)try{return callback(null,new ActiveXObject("Msxml2.XMLHTTP"))}catch(e){return callback(null,new ActiveXObject("Microsoft.XMLHTTP"))}return callback(new Error)},encodeUsingUrlEncoding=function(data){if("string"==typeof data)return data;var result=[];for(var dataItem in data)data.hasOwnProperty(dataItem)&&result.push(encodeURIComponent(dataItem)+"="+encodeURIComponent(data[dataItem]));return result.join("&")},utf8=function(text){text=text.replace(/\r\n/g,"\n");for(var result="",i=0;i<text.length;i++){var c=text.charCodeAt(i);128>c?result+=String.fromCharCode(c):c>127&&2048>c?(result+=String.fromCharCode(c>>6|192),result+=String.fromCharCode(63&c|128)):(result+=String.fromCharCode(c>>12|224),result+=String.fromCharCode(c>>6&63|128),result+=String.fromCharCode(63&c|128))}return result},base64=function(text){var keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";text=utf8(text);var chr1,chr2,chr3,enc1,enc2,enc3,enc4,result="",i=0;do chr1=text.charCodeAt(i++),chr2=text.charCodeAt(i++),chr3=text.charCodeAt(i++),enc1=chr1>>2,enc2=(3&chr1)<<4|chr2>>4,enc3=(15&chr2)<<2|chr3>>6,enc4=63&chr3,isNaN(chr2)?enc3=enc4=64:isNaN(chr3)&&(enc4=64),result+=keyStr.charAt(enc1)+keyStr.charAt(enc2)+keyStr.charAt(enc3)+keyStr.charAt(enc4),chr1=chr2=chr3="",enc1=enc2=enc3=enc4="";while(i<text.length);return result},mergeHeaders=function(){for(var result=arguments[0],i=1;i<arguments.length;i++){var currentHeaders=arguments[i];for(var header in currentHeaders)currentHeaders.hasOwnProperty(header)&&(result[header]=currentHeaders[header])}return result},ajax=function(method,url,options,callback){"function"==typeof options&&(callback=options,options={}),options.cache=options.cache||!1,options.data=options.data||{},options.headers=options.headers||{},options.jsonp=options.jsonp||!1,options.async=void 0===options.async?!0:options.async;var payload,headers=mergeHeaders({accept:"*/*","content-type":"application/x-www-form-urlencoded;charset=UTF-8"},ajax.headers,options.headers);if(payload="application/json"===headers["content-type"]?JSON.stringify(options.data):encodeUsingUrlEncoding(options.data),"GET"===method){var queryString=[];if(payload&&(queryString.push(payload),payload=null),options.cache||queryString.push("_="+(new Date).getTime()),options.jsonp&&(queryString.push("callback="+options.jsonp),queryString.push("jsonp="+options.jsonp)),queryString=queryString.join("&"),queryString.length>1&&(url+=url.indexOf("?")>-1?"&"+queryString:"?"+queryString),options.jsonp){var head=document.getElementsByTagName("head")[0],script=document.createElement("script");return script.type="text/javascript",script.src=url,void head.appendChild(script)}}getXhr(function(err,xhr){if(err)return callback(err);xhr.open(method,url,options.async);for(var header in headers)headers.hasOwnProperty(header)&&xhr.setRequestHeader(header,headers[header]);xhr.onreadystatechange=function(){if(4===xhr.readyState){var data=xhr.responseText||"";if(!callback)return;callback(xhr.status,{text:function(){return data},json:function(){try{return JSON.parse(data)}catch(e){return f.error("Can not parse JSON. URL: "+url),{}}}})}},xhr.send(payload)})},http={authBasic:function(username,password){ajax.headers.Authorization="Basic "+base64(username+":"+password)},connect:function(url,options,callback){return ajax("CONNECT",url,options,callback)},del:function(url,options,callback){return ajax("DELETE",url,options,callback)},get:function(url,options,callback){return ajax("GET",url,options,callback)},head:function(url,options,callback){return ajax("HEAD",url,options,callback)},headers:function(headers){ajax.headers=headers||{}},isAllowed:function(url,verb,callback){this.options(url,function(status,data){callback(-1!==data.text().indexOf(verb))})},options:function(url,options,callback){return ajax("OPTIONS",url,options,callback)},patch:function(url,options,callback){return ajax("PATCH",url,options,callback)},post:function(url,options,callback){return ajax("POST",url,options,callback)},put:function(url,options,callback){return ajax("PUT",url,options,callback)},trace:function(url,options,callback){return ajax("TRACE",url,options,callback)}},methode=options.type?options.type.toLowerCase():"get";http[methode](options.url,options,function(status,data){200===status||0===status&&data.text()?options.success(data.json(),status,null):options.error(data.text(),status,null)})}function init(options,cb){"function"==typeof options&&(cb=options,options={}),options=options||{},f.extend(o,options),delete o.fixLng,o.functions&&(delete o.functions,f.extend(f,options.functions)),"string"==typeof o.ns&&(o.ns={namespaces:[o.ns],defaultNs:o.ns}),"string"==typeof o.fallbackNS&&(o.fallbackNS=[o.fallbackNS]),"string"!=typeof o.fallbackLng&&"boolean"!=typeof o.fallbackLng||(o.fallbackLng=[o.fallbackLng]),o.interpolationPrefixEscaped=f.regexEscape(o.interpolationPrefix),o.interpolationSuffixEscaped=f.regexEscape(o.interpolationSuffix),o.lng||(o.lng=f.detectLanguage()),languages=f.toLanguages(o.lng),currentLng=languages[0],f.log("currentLng set to: "+currentLng),o.useCookie&&f.cookie.read(o.cookieName)!==currentLng&&f.cookie.create(o.cookieName,currentLng,o.cookieExpirationTime,o.cookieDomain),o.detectLngFromLocalStorage&&"undefined"!=typeof document&&window.localStorage&&f.localStorage.setItem("i18next_lng",currentLng);var lngTranslate=translate;options.fixLng&&(lngTranslate=function(key,options){return options=options||{},options.lng=options.lng||lngTranslate.lng,translate(key,options)},lngTranslate.lng=currentLng),pluralExtensions.setCurrentLng(currentLng),$&&o.setJqueryExt&&addJqueryFunct();var deferred;if($&&$.Deferred&&(deferred=$.Deferred()),!o.resStore){var lngsToLoad=f.toLanguages(o.lng);"string"==typeof o.preload&&(o.preload=[o.preload]);for(var i=0,l=o.preload.length;l>i;i++)for(var pres=f.toLanguages(o.preload[i]),y=0,len=pres.length;len>y;y++)lngsToLoad.indexOf(pres[y])<0&&lngsToLoad.push(pres[y]);return i18n.sync.load(lngsToLoad,o,function(err,store){resStore=store,initialized=!0,cb&&cb(lngTranslate),deferred&&deferred.resolve(lngTranslate)}),deferred?deferred.promise():void 0}return resStore=o.resStore,initialized=!0,cb&&cb(lngTranslate),deferred&&deferred.resolve(lngTranslate),deferred?deferred.promise():void 0}function preload(lngs,cb){"string"==typeof lngs&&(lngs=[lngs]);for(var i=0,l=lngs.length;l>i;i++)o.preload.indexOf(lngs[i])<0&&o.preload.push(lngs[i]);return init(cb)}function addResourceBundle(lng,ns,resources,deep){"string"!=typeof ns?(resources=ns,ns=o.ns.defaultNs):o.ns.namespaces.indexOf(ns)<0&&o.ns.namespaces.push(ns),resStore[lng]=resStore[lng]||{},resStore[lng][ns]=resStore[lng][ns]||{},deep?f.deepExtend(resStore[lng][ns],resources):f.extend(resStore[lng][ns],resources)}function hasResourceBundle(lng,ns){"string"!=typeof ns&&(ns=o.ns.defaultNs),resStore[lng]=resStore[lng]||{};var res=resStore[lng][ns]||{},hasValues=!1;for(var prop in res)res.hasOwnProperty(prop)&&(hasValues=!0);return hasValues}function removeResourceBundle(lng,ns){"string"!=typeof ns&&(ns=o.ns.defaultNs),resStore[lng]=resStore[lng]||{},resStore[lng][ns]={}}function addResource(lng,ns,key,value){"string"!=typeof ns?(resource=ns,ns=o.ns.defaultNs):o.ns.namespaces.indexOf(ns)<0&&o.ns.namespaces.push(ns),resStore[lng]=resStore[lng]||{},resStore[lng][ns]=resStore[lng][ns]||{};for(var keys=key.split(o.keyseparator),x=0,node=resStore[lng][ns];keys[x];)x==keys.length-1?node[keys[x]]=value:(null==node[keys[x]]&&(node[keys[x]]={}),node=node[keys[x]]),x++}function addResources(lng,ns,resources){"string"!=typeof ns?(resource=ns,ns=o.ns.defaultNs):o.ns.namespaces.indexOf(ns)<0&&o.ns.namespaces.push(ns);for(var m in resources)"string"==typeof resources[m]&&addResource(lng,ns,m,resources[m])}function setDefaultNamespace(ns){o.ns.defaultNs=ns}function loadNamespace(namespace,cb){loadNamespaces([namespace],cb)}function loadNamespaces(namespaces,cb){var opts={dynamicLoad:o.dynamicLoad,resGetPath:o.resGetPath,getAsync:o.getAsync,customLoad:o.customLoad,ns:{namespaces:namespaces,defaultNs:""}},lngsToLoad=f.toLanguages(o.lng);"string"==typeof o.preload&&(o.preload=[o.preload]);for(var i=0,l=o.preload.length;l>i;i++)for(var pres=f.toLanguages(o.preload[i]),y=0,len=pres.length;len>y;y++)lngsToLoad.indexOf(pres[y])<0&&lngsToLoad.push(pres[y]);for(var lngNeedLoad=[],a=0,lenA=lngsToLoad.length;lenA>a;a++){var needLoad=!1,resSet=resStore[lngsToLoad[a]];if(resSet)for(var b=0,lenB=namespaces.length;lenB>b;b++)resSet[namespaces[b]]||(needLoad=!0);else needLoad=!0;needLoad&&lngNeedLoad.push(lngsToLoad[a])}lngNeedLoad.length?i18n.sync._fetch(lngNeedLoad,opts,function(err,store){var todo=namespaces.length*lngNeedLoad.length;f.each(namespaces,function(nsIndex,nsValue){o.ns.namespaces.indexOf(nsValue)<0&&o.ns.namespaces.push(nsValue),f.each(lngNeedLoad,function(lngIndex,lngValue){resStore[lngValue]=resStore[lngValue]||{},resStore[lngValue][nsValue]=store[lngValue][nsValue],todo--,0===todo&&cb&&(o.useLocalStorage&&i18n.sync._storeLocal(resStore),cb())})})}):cb&&cb()}function setLng(lng,options,cb){return"function"==typeof options?(cb=options,options={}):options||(options={}),options.lng=lng,init(options,cb)}function lng(){return currentLng}function reload(cb){resStore={},setLng(currentLng,cb)}function addJqueryFunct(){function parse(ele,key,options){if(0!==key.length){var attr="text";if(0===key.indexOf("[")){var parts=key.split("]");key=parts[1],attr=parts[0].substr(1,parts[0].length-1)}key.indexOf(";")===key.length-1&&(key=key.substr(0,key.length-2));var optionsToUse;if("html"===attr)optionsToUse=o.defaultValueFromContent?$.extend({defaultValue:ele.html()},options):options,ele.html($.t(key,optionsToUse));else if("text"===attr)optionsToUse=o.defaultValueFromContent?$.extend({defaultValue:ele.text()},options):options,ele.text($.t(key,optionsToUse));else if("prepend"===attr)optionsToUse=o.defaultValueFromContent?$.extend({defaultValue:ele.html()},options):options,ele.prepend($.t(key,optionsToUse));else if("append"===attr)optionsToUse=o.defaultValueFromContent?$.extend({defaultValue:ele.html()},options):options,ele.append($.t(key,optionsToUse));else if(0===attr.indexOf("data-")){var dataAttr=attr.substr("data-".length);optionsToUse=o.defaultValueFromContent?$.extend({defaultValue:ele.data(dataAttr)},options):options;var translated=$.t(key,optionsToUse);ele.data(dataAttr,translated),ele.attr(attr,translated)}else optionsToUse=o.defaultValueFromContent?$.extend({defaultValue:ele.attr(attr)},options):options,ele.attr(attr,$.t(key,optionsToUse))}}function localize(ele,options){var key=ele.attr(o.selectorAttr);if(key||"undefined"==typeof key||key===!1||(key=ele.text()||ele.val()),key){var target=ele,targetSelector=ele.data("i18n-target");if(targetSelector&&(target=ele.find(targetSelector)||ele),options||o.useDataAttrOptions!==!0||(options=ele.data("i18n-options")),options=options||{},key.indexOf(";")>=0){var keys=key.split(";");$.each(keys,function(m,k){""!==k&&parse(target,k,options)})}else parse(target,key,options);o.useDataAttrOptions===!0&&ele.data("i18n-options",options)}}$.t=$.t||translate,$.fn.i18n=function(options){return this.each(function(){localize($(this),options);var elements=$(this).find("["+o.selectorAttr+"]");elements.each(function(){localize($(this),options)})})}}function applyReplacement(str,replacementHash,nestedKey,options){if(!str)return str;if(options=options||replacementHash,str.indexOf(options.interpolationPrefix||o.interpolationPrefix)<0)return str;var prefix=options.interpolationPrefix?f.regexEscape(options.interpolationPrefix):o.interpolationPrefixEscaped,suffix=options.interpolationSuffix?f.regexEscape(options.interpolationSuffix):o.interpolationSuffixEscaped,unEscapingSuffix="HTML"+suffix,hash=replacementHash.replace&&"object"==typeof replacementHash.replace?replacementHash.replace:replacementHash;return f.each(hash,function(key,value){var nextKey=nestedKey?nestedKey+o.keyseparator+key:key;"object"==typeof value&&null!==value?str=applyReplacement(str,value,nextKey,options):options.escapeInterpolation||o.escapeInterpolation?(str=str.replace(new RegExp([prefix,nextKey,unEscapingSuffix].join(""),"g"),f.regexReplacementEscape(value)),str=str.replace(new RegExp([prefix,nextKey,suffix].join(""),"g"),f.regexReplacementEscape(f.escape(value)))):str=str.replace(new RegExp([prefix,nextKey,suffix].join(""),"g"),f.regexReplacementEscape(value))}),str}function applyReuse(translated,options){var comma=",",options_open="{",options_close="}",opts=f.extend({},options);for(delete opts.postProcess;-1!=translated.indexOf(o.reusePrefix)&&(replacementCounter++,!(replacementCounter>o.maxRecursion));){var index_of_opening=translated.lastIndexOf(o.reusePrefix),index_of_end_of_closing=translated.indexOf(o.reuseSuffix,index_of_opening)+o.reuseSuffix.length,token=translated.substring(index_of_opening,index_of_end_of_closing),token_without_symbols=token.replace(o.reusePrefix,"").replace(o.reuseSuffix,"");if(index_of_opening>=index_of_end_of_closing)return f.error("there is an missing closing in following translation value",translated),"";if(-1!=token_without_symbols.indexOf(comma)){var index_of_token_end_of_closing=token_without_symbols.indexOf(comma);if(-1!=token_without_symbols.indexOf(options_open,index_of_token_end_of_closing)&&-1!=token_without_symbols.indexOf(options_close,index_of_token_end_of_closing)){var index_of_opts_opening=token_without_symbols.indexOf(options_open,index_of_token_end_of_closing),index_of_opts_end_of_closing=token_without_symbols.indexOf(options_close,index_of_opts_opening)+options_close.length;try{opts=f.extend(opts,JSON.parse(token_without_symbols.substring(index_of_opts_opening,index_of_opts_end_of_closing))),token_without_symbols=token_without_symbols.substring(0,index_of_token_end_of_closing)}catch(e){}}}var translated_token=_translate(token_without_symbols,opts);translated=translated.replace(token,f.regexReplacementEscape(translated_token))}return translated}function hasContext(options){return options.context&&("string"==typeof options.context||"number"==typeof options.context)}function needsPlural(options,lng){return void 0!==options.count&&"string"!=typeof options.count}function needsIndefiniteArticle(options){return void 0!==options.indefinite_article&&"string"!=typeof options.indefinite_article&&options.indefinite_article}function exists(key,options){options=options||{};var notFound=_getDefaultValue(key,options),found=_find(key,options);return void 0!==found||found===notFound}function translate(key,options){return options=options||{},initialized?(replacementCounter=0,_translate.apply(null,arguments)):(f.log("i18next not finished initialization. you might have called t function before loading resources finished."),options.defaultValue||"")}function _getDefaultValue(key,options){return void 0!==options.defaultValue?options.defaultValue:key}function _injectSprintfProcessor(){for(var values=[],i=1;i<arguments.length;i++)values.push(arguments[i]);return{postProcess:"sprintf",sprintf:values}}function _translate(potentialKeys,options){if(options&&"object"!=typeof options?"sprintf"===o.shortcutFunction?options=_injectSprintfProcessor.apply(null,arguments):"defaultValue"===o.shortcutFunction&&(options={defaultValue:options}):options=options||{},"object"==typeof o.defaultVariables&&(options=f.extend({},o.defaultVariables,options)),void 0===potentialKeys||null===potentialKeys||""===potentialKeys)return"";"string"==typeof potentialKeys&&(potentialKeys=[potentialKeys]);var key=potentialKeys[0];if(potentialKeys.length>1)for(var i=0;i<potentialKeys.length&&(key=potentialKeys[i],!exists(key,options));i++);var parts,notFound=_getDefaultValue(key,options),found=_find(key,options),lngs=options.lng?f.toLanguages(options.lng,options.fallbackLng):languages,ns=options.ns||o.ns.defaultNs;key.indexOf(o.nsseparator)>-1&&(parts=key.split(o.nsseparator),ns=parts[0],key=parts[1]),void 0===found&&o.sendMissing&&"function"==typeof o.missingKeyHandler&&(options.lng?o.missingKeyHandler(lngs[0],ns,key,notFound,lngs):o.missingKeyHandler(o.lng,ns,key,notFound,lngs));var postProcessor=options.postProcess||o.postProcess;void 0!==found&&postProcessor&&postProcessors[postProcessor]&&(found=postProcessors[postProcessor](found,key,options));var splitNotFound=notFound;if(notFound.indexOf(o.nsseparator)>-1&&(parts=notFound.split(o.nsseparator),splitNotFound=parts[1]),splitNotFound===key&&o.parseMissingKey&&(notFound=o.parseMissingKey(notFound)),void 0===found&&(notFound=applyReplacement(notFound,options),notFound=applyReuse(notFound,options),postProcessor&&postProcessors[postProcessor])){var val=_getDefaultValue(key,options);found=postProcessors[postProcessor](val,key,options)}return void 0!==found?found:notFound}function _find(key,options){options=options||{};var optionWithoutCount,translated,notFound=_getDefaultValue(key,options),lngs=languages;if(!resStore)return notFound;if("cimode"===lngs[0].toLowerCase())return notFound;if(options.lngs&&(lngs=options.lngs),options.lng&&(lngs=f.toLanguages(options.lng,options.fallbackLng),!resStore[lngs[0]])){var oldAsync=o.getAsync;o.getAsync=!1,i18n.sync.load(lngs,o,function(err,store){f.extend(resStore,store),o.getAsync=oldAsync})}var ns=options.ns||o.ns.defaultNs;if(key.indexOf(o.nsseparator)>-1){var parts=key.split(o.nsseparator);ns=parts[0],key=parts[1]}if(hasContext(options)){optionWithoutCount=f.extend({},options),delete optionWithoutCount.context,optionWithoutCount.defaultValue=o.contextNotFound;var contextKey=ns+o.nsseparator+key+"_"+options.context;if(translated=translate(contextKey,optionWithoutCount),translated!=o.contextNotFound)return applyReplacement(translated,{context:options.context})}if(needsPlural(options,lngs[0])){optionWithoutCount=f.extend({lngs:[lngs[0]]},options),delete optionWithoutCount.count,delete optionWithoutCount.lng,optionWithoutCount.defaultValue=o.pluralNotFound;var pluralKey;if(pluralExtensions.needsPlural(lngs[0],options.count)){pluralKey=ns+o.nsseparator+key+o.pluralSuffix;var pluralExtension=pluralExtensions.get(lngs[0],options.count);pluralExtension>=0?pluralKey=pluralKey+"_"+pluralExtension:1===pluralExtension&&(pluralKey=ns+o.nsseparator+key)}else pluralKey=ns+o.nsseparator+key;if(translated=translate(pluralKey,optionWithoutCount),
translated!=o.pluralNotFound)return applyReplacement(translated,{count:options.count,interpolationPrefix:options.interpolationPrefix,interpolationSuffix:options.interpolationSuffix});if(!(lngs.length>1))return translated;var clone=lngs.slice();if(clone.shift(),options=f.extend(options,{lngs:clone}),delete options.lng,translated=translate(ns+o.nsseparator+key,options),translated!=o.pluralNotFound)return translated}if(needsIndefiniteArticle(options)){var optionsWithoutIndef=f.extend({},options);delete optionsWithoutIndef.indefinite_article,optionsWithoutIndef.defaultValue=o.indefiniteNotFound;var indefiniteKey=ns+o.nsseparator+key+(options.count&&!needsPlural(options,lngs[0])||!options.count?o.indefiniteSuffix:"");if(translated=translate(indefiniteKey,optionsWithoutIndef),translated!=o.indefiniteNotFound)return translated}for(var found,keys=key.split(o.keyseparator),i=0,len=lngs.length;len>i&&void 0===found;i++){for(var l=lngs[i],x=0,value=resStore[l]&&resStore[l][ns];keys[x];)value=value&&value[keys[x]],x++;if(void 0!==value){var valueType=Object.prototype.toString.apply(value);if("string"==typeof value)value=applyReplacement(value,options),value=applyReuse(value,options);else if("[object Array]"!==valueType||o.returnObjectTrees||options.returnObjectTrees){if(null===value&&o.fallbackOnNull===!0)value=void 0;else if(null!==value)if(o.returnObjectTrees||options.returnObjectTrees){if("[object Number]"!==valueType&&"[object Function]"!==valueType&&"[object RegExp]"!==valueType){var copy="[object Array]"===valueType?[]:{};f.each(value,function(m){copy[m]=_translate(ns+o.nsseparator+key+o.keyseparator+m,options)}),value=copy}}else o.objectTreeKeyHandler&&"function"==typeof o.objectTreeKeyHandler?value=o.objectTreeKeyHandler(key,value,l,ns,options):(value="key '"+ns+":"+key+" ("+l+")' returned an object instead of string.",f.log(value))}else value=value.join("\n"),value=applyReplacement(value,options),value=applyReuse(value,options);"string"==typeof value&&""===value.trim()&&o.fallbackOnEmpty===!0&&(value=void 0),found=value}}if(void 0===found&&!options.isFallbackLookup&&(o.fallbackToDefaultNS===!0||o.fallbackNS&&o.fallbackNS.length>0)){if(options.isFallbackLookup=!0,o.fallbackNS.length){for(var y=0,lenY=o.fallbackNS.length;lenY>y;y++)if(found=_find(o.fallbackNS[y]+o.nsseparator+key,options),found||""===found&&o.fallbackOnEmpty===!1){var foundValue=found.indexOf(o.nsseparator)>-1?found.split(o.nsseparator)[1]:found,notFoundValue=notFound.indexOf(o.nsseparator)>-1?notFound.split(o.nsseparator)[1]:notFound;if(foundValue!==notFoundValue)break}}else found=_find(key,options);options.isFallbackLookup=!1}return found}function detectLanguage(){var detectedLng,whitelist=o.lngWhitelist||[],userLngChoices=[];if("undefined"!=typeof window&&!function(){for(var query=window.location.search.substring(1),params=query.split("&"),i=0;i<params.length;i++){var pos=params[i].indexOf("=");if(pos>0){var key=params[i].substring(0,pos);key==o.detectLngQS&&userLngChoices.push(params[i].substring(pos+1))}}}(),o.useCookie&&"undefined"!=typeof document){var c=f.cookie.read(o.cookieName);c&&userLngChoices.push(c)}if(o.detectLngFromLocalStorage&&"undefined"!=typeof window&&window.localStorage&&userLngChoices.push(window.localStorage.getItem("i18next_lng")),"undefined"!=typeof navigator){if(navigator.languages)for(var i=0;i<navigator.languages.length;i++)userLngChoices.push(navigator.languages[i]);navigator.userLanguage&&userLngChoices.push(navigator.userLanguage),navigator.language&&userLngChoices.push(navigator.language)}return function(){for(var i=0;i<userLngChoices.length;i++){var lng=userLngChoices[i];if(lng.indexOf("-")>-1){var parts=lng.split("-");lng=o.lowerCaseLng?parts[0].toLowerCase()+"-"+parts[1].toLowerCase():parts[0].toLowerCase()+"-"+parts[1].toUpperCase()}if(0===whitelist.length||whitelist.indexOf(lng)>-1){detectedLng=lng;break}}}(),detectedLng||(detectedLng=o.fallbackLng[0]),detectedLng}Array.prototype.indexOf||(Array.prototype.indexOf=function(searchElement){"use strict";if(null==this)throw new TypeError;var t=Object(this),len=t.length>>>0;if(0===len)return-1;var n=0;if(arguments.length>0&&(n=Number(arguments[1]),n!=n?n=0:0!=n&&n!=1/0&&n!=-(1/0)&&(n=(n>0||-1)*Math.floor(Math.abs(n)))),n>=len)return-1;for(var k=n>=0?n:Math.max(len-Math.abs(n),0);len>k;k++)if(k in t&&t[k]===searchElement)return k;return-1}),Array.prototype.lastIndexOf||(Array.prototype.lastIndexOf=function(searchElement){"use strict";if(null==this)throw new TypeError;var t=Object(this),len=t.length>>>0;if(0===len)return-1;var n=len;arguments.length>1&&(n=Number(arguments[1]),n!=n?n=0:0!=n&&n!=1/0&&n!=-(1/0)&&(n=(n>0||-1)*Math.floor(Math.abs(n))));for(var k=n>=0?Math.min(n,len-1):len-Math.abs(n);k>=0;k--)if(k in t&&t[k]===searchElement)return k;return-1}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});var currentLng,$=void 0,i18n={},resStore={},replacementCounter=0,languages=[],initialized=!1,sync={};sync={load:function(lngs,options,cb){options.useLocalStorage?sync._loadLocal(lngs,options,function(err,store){for(var missingLngs=[],i=0,len=lngs.length;len>i;i++)store[lngs[i]]||missingLngs.push(lngs[i]);missingLngs.length>0?sync._fetch(missingLngs,options,function(err,fetched){f.extend(store,fetched),sync._storeLocal(fetched),cb(null,store)}):cb(null,store)}):sync._fetch(lngs,options,function(err,store){cb(null,store)})},_loadLocal:function(lngs,options,cb){var store={},nowMS=(new Date).getTime();if(window.localStorage){var todo=lngs.length;f.each(lngs,function(key,lng){var local=window.localStorage.getItem("res_"+lng);local&&(local=JSON.parse(local),local.i18nStamp&&local.i18nStamp+options.localStorageExpirationTime>nowMS&&(store[lng]=local)),todo--,0===todo&&cb(null,store)})}},_storeLocal:function(store){if(window.localStorage)for(var m in store)store[m].i18nStamp=(new Date).getTime(),f.localStorage.setItem("res_"+m,JSON.stringify(store[m]))},_fetch:function(lngs,options,cb){var ns=options.ns,store={};if(options.dynamicLoad){var loadComplete=function(err,data){cb(null,data)};if("function"==typeof options.customLoad)options.customLoad(lngs,ns.namespaces,options,loadComplete);else{var url=applyReplacement(options.resGetPath,{lng:lngs.join("+"),ns:ns.namespaces.join("+")});f.ajax({url:url,success:function(data,status,xhr){f.log("loaded: "+url),loadComplete(null,data)},error:function(xhr,status,error){f.log("failed loading: "+url),loadComplete("failed loading resource.json error: "+error)},dataType:"json",async:options.getAsync})}}else{var errors,todo=ns.namespaces.length*lngs.length;f.each(ns.namespaces,function(nsIndex,nsValue){f.each(lngs,function(lngIndex,lngValue){var loadComplete=function(err,data){err&&(errors=errors||[],errors.push(err)),store[lngValue]=store[lngValue]||{},store[lngValue][nsValue]=data,todo--,0===todo&&cb(errors,store)};"function"==typeof options.customLoad?options.customLoad(lngValue,nsValue,options,loadComplete):sync._fetchOne(lngValue,nsValue,options,loadComplete)})})}},_fetchOne:function(lng,ns,options,done){var url=applyReplacement(options.resGetPath,{lng:lng,ns:ns});f.ajax({url:url,success:function(data,status,xhr){f.log("loaded: "+url),done(null,data)},error:function(xhr,status,error){if(status&&200==status||xhr&&xhr.status&&200==xhr.status)f.error("There is a typo in: "+url);else if(status&&404==status||xhr&&xhr.status&&404==xhr.status)f.log("Does not exist: "+url);else{var theStatus=status?status:xhr&&xhr.status?xhr.status:null;f.log(theStatus+" when loading "+url)}done(error,{})},dataType:"json",async:options.getAsync})},postMissing:function(lng,ns,key,defaultValue,lngs){var payload={};payload[key]=defaultValue;var urls=[];if("fallback"===o.sendMissingTo&&o.fallbackLng[0]!==!1)for(var i=0;i<o.fallbackLng.length;i++)urls.push({lng:o.fallbackLng[i],url:applyReplacement(o.resPostPath,{lng:o.fallbackLng[i],ns:ns})});else if("current"===o.sendMissingTo||"fallback"===o.sendMissingTo&&o.fallbackLng[0]===!1)urls.push({lng:lng,url:applyReplacement(o.resPostPath,{lng:lng,ns:ns})});else if("all"===o.sendMissingTo)for(var i=0,l=lngs.length;l>i;i++)urls.push({lng:lngs[i],url:applyReplacement(o.resPostPath,{lng:lngs[i],ns:ns})});for(var y=0,len=urls.length;len>y;y++){var item=urls[y];f.ajax({url:item.url,type:o.sendType,data:payload,success:function(data,status,xhr){f.log("posted missing key '"+key+"' to: "+item.url);for(var keys=key.split("."),x=0,value=resStore[item.lng][ns];keys[x];)value=x===keys.length-1?value[keys[x]]=defaultValue:value[keys[x]]=value[keys[x]]||{},x++},error:function(xhr,status,error){f.log("failed posting missing key '"+key+"' to: "+item.url)},dataType:"json",async:o.postAsync})}},reload:reload};var o={lng:void 0,load:"all",preload:[],lowerCaseLng:!1,returnObjectTrees:!1,fallbackLng:["dev"],fallbackNS:[],detectLngQS:"setLng",detectLngFromLocalStorage:!1,ns:"translation",fallbackOnNull:!0,fallbackOnEmpty:!1,fallbackToDefaultNS:!1,nsseparator:":",keyseparator:".",selectorAttr:"data-i18n",debug:!1,resGetPath:"locales/__lng__/__ns__.json",resPostPath:"locales/add/__lng__/__ns__",getAsync:!0,postAsync:!0,resStore:void 0,useLocalStorage:!1,localStorageExpirationTime:6048e5,dynamicLoad:!1,sendMissing:!1,sendMissingTo:"fallback",sendType:"POST",interpolationPrefix:"__",interpolationSuffix:"__",defaultVariables:!1,reusePrefix:"$t(",reuseSuffix:")",pluralSuffix:"_plural",pluralNotFound:["plural_not_found",Math.random()].join(""),contextNotFound:["context_not_found",Math.random()].join(""),escapeInterpolation:!1,indefiniteSuffix:"_indefinite",indefiniteNotFound:["indefinite_not_found",Math.random()].join(""),setJqueryExt:!0,defaultValueFromContent:!0,useDataAttrOptions:!1,cookieExpirationTime:void 0,useCookie:!0,cookieName:"i18next",cookieDomain:void 0,objectTreeKeyHandler:void 0,postProcess:void 0,parseMissingKey:void 0,missingKeyHandler:sync.postMissing,shortcutFunction:"sprintf"},_entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},_cookie={create:function(name,value,minutes,domain){var expires;if(minutes){var date=new Date;date.setTime(date.getTime()+60*minutes*1e3),expires="; expires="+date.toGMTString()}else expires="";domain=domain?"domain="+domain+";":"",document.cookie=name+"="+value+expires+";"+domain+"path=/"},read:function(name){for(var nameEQ=name+"=",ca=document.cookie.split(";"),i=0;i<ca.length;i++){for(var c=ca[i];" "==c.charAt(0);)c=c.substring(1,c.length);if(0===c.indexOf(nameEQ))return c.substring(nameEQ.length,c.length)}return null},remove:function(name){this.create(name,"",-1)}},cookie_noop={create:function(name,value,minutes,domain){},read:function(name){return null},remove:function(name){}},f={extend:$?$.extend:_extend,deepExtend:_deepExtend,each:$?$.each:_each,ajax:$?$.ajax:"undefined"!=typeof document?_ajax:function(){},cookie:"undefined"!=typeof document?_cookie:cookie_noop,detectLanguage:detectLanguage,escape:_escape,log:function(str){o.debug&&"undefined"!=typeof console&&console.log(str)},error:function(str){"undefined"!=typeof console&&console.error(str)},getCountyIndexOfLng:function(lng){var lng_index=0;return"nb-NO"!==lng&&"nn-NO"!==lng&&"nb-no"!==lng&&"nn-no"!==lng||(lng_index=1),lng_index},toLanguages:function(lng){function applyCase(l){var ret=l;if("string"==typeof l&&l.indexOf("-")>-1){var parts=l.split("-");ret=o.lowerCaseLng?parts[0].toLowerCase()+"-"+parts[1].toLowerCase():parts[0].toLowerCase()+"-"+parts[1].toUpperCase()}else ret=o.lowerCaseLng?l.toLowerCase():l;return ret}var log=this.log,languages=[],whitelist=o.lngWhitelist||!1,addLanguage=function(language){!whitelist||whitelist.indexOf(language)>-1?languages.push(language):log("rejecting non-whitelisted language: "+language)};if("string"==typeof lng&&lng.indexOf("-")>-1){var parts=lng.split("-");"unspecific"!==o.load&&addLanguage(applyCase(lng)),"current"!==o.load&&addLanguage(applyCase(parts[this.getCountyIndexOfLng(lng)]))}else addLanguage(applyCase(lng));for(var i=0;i<o.fallbackLng.length;i++)-1===languages.indexOf(o.fallbackLng[i])&&o.fallbackLng[i]&&languages.push(applyCase(o.fallbackLng[i]));return languages},regexEscape:function(str){return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},regexReplacementEscape:function(strOrFn){return"string"==typeof strOrFn?strOrFn.replace(/\$/g,"$$$$"):strOrFn},localStorage:{setItem:function(key,value){if(window.localStorage)try{window.localStorage.setItem(key,value)}catch(e){f.log('failed to set value for key "'+key+'" to localStorage.')}}}};f.applyReplacement=applyReplacement;var _rules=[["ach","Acholi",[1,2],1],["af","Afrikaans",[1,2],2],["ak","Akan",[1,2],1],["am","Amharic",[1,2],1],["an","Aragonese",[1,2],2],["ar","Arabic",[0,1,2,3,11,100],5],["arn","Mapudungun",[1,2],1],["ast","Asturian",[1,2],2],["ay","Aymará",[1],3],["az","Azerbaijani",[1,2],2],["be","Belarusian",[1,2,5],4],["bg","Bulgarian",[1,2],2],["bn","Bengali",[1,2],2],["bo","Tibetan",[1],3],["br","Breton",[1,2],1],["bs","Bosnian",[1,2,5],4],["ca","Catalan",[1,2],2],["cgg","Chiga",[1],3],["cs","Czech",[1,2,5],6],["csb","Kashubian",[1,2,5],7],["cy","Welsh",[1,2,3,8],8],["da","Danish",[1,2],2],["de","German",[1,2],2],["dev","Development Fallback",[1,2],2],["dz","Dzongkha",[1],3],["el","Greek",[1,2],2],["en","English",[1,2],2],["eo","Esperanto",[1,2],2],["es","Spanish",[1,2],2],["es_ar","Argentinean Spanish",[1,2],2],["et","Estonian",[1,2],2],["eu","Basque",[1,2],2],["fa","Persian",[1],3],["fi","Finnish",[1,2],2],["fil","Filipino",[1,2],1],["fo","Faroese",[1,2],2],["fr","French",[1,2],9],["fur","Friulian",[1,2],2],["fy","Frisian",[1,2],2],["ga","Irish",[1,2,3,7,11],10],["gd","Scottish Gaelic",[1,2,3,20],11],["gl","Galician",[1,2],2],["gu","Gujarati",[1,2],2],["gun","Gun",[1,2],1],["ha","Hausa",[1,2],2],["he","Hebrew",[1,2],2],["hi","Hindi",[1,2],2],["hr","Croatian",[1,2,5],4],["hu","Hungarian",[1,2],2],["hy","Armenian",[1,2],2],["ia","Interlingua",[1,2],2],["id","Indonesian",[1],3],["is","Icelandic",[1,2],12],["it","Italian",[1,2],2],["ja","Japanese",[1],3],["jbo","Lojban",[1],3],["jv","Javanese",[0,1],13],["ka","Georgian",[1],3],["kk","Kazakh",[1],3],["km","Khmer",[1],3],["kn","Kannada",[1,2],2],["ko","Korean",[1],3],["ku","Kurdish",[1,2],2],["kw","Cornish",[1,2,3,4],14],["ky","Kyrgyz",[1],3],["lb","Letzeburgesch",[1,2],2],["ln","Lingala",[1,2],1],["lo","Lao",[1],3],["lt","Lithuanian",[1,2,10],15],["lv","Latvian",[1,2,0],16],["mai","Maithili",[1,2],2],["mfe","Mauritian Creole",[1,2],1],["mg","Malagasy",[1,2],1],["mi","Maori",[1,2],1],["mk","Macedonian",[1,2],17],["ml","Malayalam",[1,2],2],["mn","Mongolian",[1,2],2],["mnk","Mandinka",[0,1,2],18],["mr","Marathi",[1,2],2],["ms","Malay",[1],3],["mt","Maltese",[1,2,11,20],19],["nah","Nahuatl",[1,2],2],["nap","Neapolitan",[1,2],2],["nb","Norwegian Bokmal",[1,2],2],["ne","Nepali",[1,2],2],["nl","Dutch",[1,2],2],["nn","Norwegian Nynorsk",[1,2],2],["no","Norwegian",[1,2],2],["nso","Northern Sotho",[1,2],2],["oc","Occitan",[1,2],1],["or","Oriya",[2,1],2],["pa","Punjabi",[1,2],2],["pap","Papiamento",[1,2],2],["pl","Polish",[1,2,5],7],["pms","Piemontese",[1,2],2],["ps","Pashto",[1,2],2],["pt","Portuguese",[1,2],2],["pt_br","Brazilian Portuguese",[1,2],2],["rm","Romansh",[1,2],2],["ro","Romanian",[1,2,20],20],["ru","Russian",[1,2,5],4],["sah","Yakut",[1],3],["sco","Scots",[1,2],2],["se","Northern Sami",[1,2],2],["si","Sinhala",[1,2],2],["sk","Slovak",[1,2,5],6],["sl","Slovenian",[5,1,2,3],21],["so","Somali",[1,2],2],["son","Songhay",[1,2],2],["sq","Albanian",[1,2],2],["sr","Serbian",[1,2,5],4],["su","Sundanese",[1],3],["sv","Swedish",[1,2],2],["sw","Swahili",[1,2],2],["ta","Tamil",[1,2],2],["te","Telugu",[1,2],2],["tg","Tajik",[1,2],1],["th","Thai",[1],3],["ti","Tigrinya",[1,2],1],["tk","Turkmen",[1,2],2],["tr","Turkish",[1,2],1],["tt","Tatar",[1],3],["ug","Uyghur",[1],3],["uk","Ukrainian",[1,2,5],4],["ur","Urdu",[1,2],2],["uz","Uzbek",[1,2],1],["vi","Vietnamese",[1],3],["wa","Walloon",[1,2],1],["wo","Wolof",[1],3],["yo","Yoruba",[1,2],2],["zh","Chinese",[1],3]],_rulesPluralsTypes={1:function(n){return Number(n>1)},2:function(n){return Number(1!=n)},3:function(n){return 0},4:function(n){return Number(n%10==1&&n%100!=11?0:n%10>=2&&4>=n%10&&(10>n%100||n%100>=20)?1:2)},5:function(n){return Number(0===n?0:1==n?1:2==n?2:n%100>=3&&10>=n%100?3:n%100>=11?4:5)},6:function(n){return Number(1==n?0:n>=2&&4>=n?1:2)},7:function(n){return Number(1==n?0:n%10>=2&&4>=n%10&&(10>n%100||n%100>=20)?1:2)},8:function(n){return Number(1==n?0:2==n?1:8!=n&&11!=n?2:3)},9:function(n){return Number(n>=2)},10:function(n){return Number(1==n?0:2==n?1:7>n?2:11>n?3:4)},11:function(n){return Number(1==n||11==n?0:2==n||12==n?1:n>2&&20>n?2:3)},12:function(n){return Number(n%10!=1||n%100==11)},13:function(n){return Number(0!==n)},14:function(n){return Number(1==n?0:2==n?1:3==n?2:3)},15:function(n){return Number(n%10==1&&n%100!=11?0:n%10>=2&&(10>n%100||n%100>=20)?1:2)},16:function(n){return Number(n%10==1&&n%100!=11?0:0!==n?1:2)},17:function(n){return Number(1==n||n%10==1?0:1)},18:function(n){return Number(1==n?1:2)},19:function(n){return Number(1==n?0:0===n||n%100>1&&11>n%100?1:n%100>10&&20>n%100?2:3)},20:function(n){return Number(1==n?0:0===n||n%100>0&&20>n%100?1:2)},21:function(n){return Number(n%100==1?1:n%100==2?2:n%100==3||n%100==4?3:0)}},pluralExtensions={rules:function(){var l,rules={};for(l=_rules.length;l--;)rules[_rules[l][0]]={name:_rules[l][1],numbers:_rules[l][2],plurals:_rulesPluralsTypes[_rules[l][3]]};return rules}(),addRule:function(lng,obj){pluralExtensions.rules[lng]=obj},setCurrentLng:function(lng){if(!pluralExtensions.currentRule||pluralExtensions.currentRule.lng!==lng){var parts=lng.split("-");pluralExtensions.currentRule={lng:lng,rule:pluralExtensions.rules[parts[0]]}}},needsPlural:function(lng,count){var ext,parts=lng.split("-");return ext=pluralExtensions.currentRule&&pluralExtensions.currentRule.lng===lng?pluralExtensions.currentRule.rule:pluralExtensions.rules[parts[f.getCountyIndexOfLng(lng)]],ext&&ext.numbers.length<=1?!1:1!==this.get(lng,count)},get:function(lng,count){function getResult(l,c){var ext;if(ext=pluralExtensions.currentRule&&pluralExtensions.currentRule.lng===lng?pluralExtensions.currentRule.rule:pluralExtensions.rules[l]){var i;i=ext.noAbs?ext.plurals(c):ext.plurals(Math.abs(c));var number=ext.numbers[i];return 2===ext.numbers.length&&1===ext.numbers[0]&&(2===number?number=-1:1===number&&(number=1)),number}return 1===c?"1":"-1"}var parts=lng.split("-");return getResult(parts[f.getCountyIndexOfLng(lng)],count)}},postProcessors={},addPostProcessor=function(name,fc){postProcessors[name]=fc},sprintf=function(){function get_type(variable){return Object.prototype.toString.call(variable).slice(8,-1).toLowerCase()}function str_repeat(input,multiplier){for(var output=[];multiplier>0;output[--multiplier]=input);return output.join("")}var str_format=function(){return str_format.cache.hasOwnProperty(arguments[0])||(str_format.cache[arguments[0]]=str_format.parse(arguments[0])),str_format.format.call(null,str_format.cache[arguments[0]],arguments)};return str_format.format=function(parse_tree,argv){var arg,i,k,match,pad,pad_character,pad_length,cursor=1,tree_length=parse_tree.length,node_type="",output=[];for(i=0;tree_length>i;i++)if(node_type=get_type(parse_tree[i]),"string"===node_type)output.push(parse_tree[i]);else if("array"===node_type){if(match=parse_tree[i],match[2])for(arg=argv[cursor],k=0;k<match[2].length;k++){if(!arg.hasOwnProperty(match[2][k]))throw sprintf('[sprintf] property "%s" does not exist',match[2][k]);arg=arg[match[2][k]]}else arg=match[1]?argv[match[1]]:argv[cursor++];if(/[^s]/.test(match[8])&&"number"!=get_type(arg))throw sprintf("[sprintf] expecting number but found %s",get_type(arg));switch(match[8]){case"b":arg=arg.toString(2);break;case"c":arg=String.fromCharCode(arg);break;case"d":arg=parseInt(arg,10);break;case"e":arg=match[7]?arg.toExponential(match[7]):arg.toExponential();break;case"f":arg=match[7]?parseFloat(arg).toFixed(match[7]):parseFloat(arg);break;case"o":arg=arg.toString(8);break;case"s":arg=(arg=String(arg))&&match[7]?arg.substring(0,match[7]):arg;break;case"u":arg=Math.abs(arg);break;case"x":arg=arg.toString(16);break;case"X":arg=arg.toString(16).toUpperCase()}arg=/[def]/.test(match[8])&&match[3]&&arg>=0?"+"+arg:arg,pad_character=match[4]?"0"==match[4]?"0":match[4].charAt(1):" ",pad_length=match[6]-String(arg).length,pad=match[6]?str_repeat(pad_character,pad_length):"",output.push(match[5]?arg+pad:pad+arg)}return output.join("")},str_format.cache={},str_format.parse=function(fmt){for(var _fmt=fmt,match=[],parse_tree=[],arg_names=0;_fmt;){if(null!==(match=/^[^\x25]+/.exec(_fmt)))parse_tree.push(match[0]);else if(null!==(match=/^\x25{2}/.exec(_fmt)))parse_tree.push("%");else{if(null===(match=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(_fmt)))throw"[sprintf] huh?";if(match[2]){arg_names|=1;var field_list=[],replacement_field=match[2],field_match=[];if(null===(field_match=/^([a-z_][a-z_\d]*)/i.exec(replacement_field)))throw"[sprintf] huh?";for(field_list.push(field_match[1]);""!==(replacement_field=replacement_field.substring(field_match[0].length));)if(null!==(field_match=/^\.([a-z_][a-z_\d]*)/i.exec(replacement_field)))field_list.push(field_match[1]);else{if(null===(field_match=/^\[(\d+)\]/.exec(replacement_field)))throw"[sprintf] huh?";field_list.push(field_match[1])}match[2]=field_list}else arg_names|=2;if(3===arg_names)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";parse_tree.push(match)}_fmt=_fmt.substring(match[0].length)}return parse_tree},str_format}(),vsprintf=function(fmt,argv){return argv.unshift(fmt),sprintf.apply(null,argv)};return addPostProcessor("sprintf",function(val,key,opts){return opts.sprintf?"[object Array]"===Object.prototype.toString.apply(opts.sprintf)?vsprintf(val,opts.sprintf):"object"==typeof opts.sprintf?sprintf(val,opts.sprintf):val:val}),i18n.init=init,i18n.setLng=setLng,i18n.preload=preload,i18n.addResourceBundle=addResourceBundle,i18n.hasResourceBundle=hasResourceBundle,i18n.addResource=addResource,i18n.addResources=addResources,i18n.removeResourceBundle=removeResourceBundle,i18n.loadNamespace=loadNamespace,i18n.loadNamespaces=loadNamespaces,i18n.setDefaultNamespace=setDefaultNamespace,i18n.t=translate,i18n.translate=translate,i18n.exists=exists,i18n.detectLanguage=f.detectLanguage,i18n.pluralExtensions=pluralExtensions,i18n.sync=sync,i18n.functions=f,i18n.lng=lng,i18n.addPostProcessor=addPostProcessor,i18n.options=o,i18n})},function(module,exports){var WebStats=function(options){if(!options||!options.destinationUrl)throw"You must specify destination";var defaultOptions={debug:!1,destinationUrl:"http://127.0.0.1:3000",autosend:!1,interval:5e3,authorization:"secretkey",watchErrors:!1,sendSessionOnStart:!0};this._failedAttempt=0,this.options=$.extend(defaultOptions,options),this._log("Options:",this.options),this.options.persistEventUrl=options.destinationUrl+"/persist/event",this.options.persistLogUrl=options.destinationUrl+"/persist/log",this.options.persistSessionUrl=options.destinationUrl+"/persist/session",this.options.readUrl=options.destinationUrl+"/data",this.sessionId="",this.eventBuffer=[],this.logBuffer=[];var self=this;this.options.autosend===!0&&(this._sendInterval=setInterval(function(){self.sendDataBuffer()},this.options.interval)),this.options.watchErrors===!0&&self._watchWindowErrors(),this.options.sendSessionOnStart===!0&&this.sendSession()};WebStats.prototype.stopAutoSendingInterval=function(){clearInterval(this._sendInterval)},WebStats.prototype._log=function(message,datas,level){if(this.options.debug===!0){if(""===message)return void console.log();level=(level||"INFO").toLocaleUpperCase(),console.log("[WebStats] ["+level+"] "+message,datas||"")}},WebStats.prototype.addEvent=function(event,data){this._log("addEvent:",{arguments:arguments}),this.eventBuffer.push({event:event,data:data})},WebStats.prototype._hashString=function(string){var i,chr,len,hash=0;if(0===string.length)return hash;for(i=0,len=string.length;len>i;i++)chr=string.charCodeAt(i),hash=(hash<<5)-hash+chr,hash|=0;return hash},WebStats.prototype._createSessionId=function(){if(""!==this.sessionId)throw"Session id already exist";return this.sessionId=this._hashString(new Date+navigator.userAgent+Math.random()+"èèèèè!ù**$::;!;;!.§/;§/**/*e*eurh!yjyj"),this.sessionId},WebStats.prototype._resetSession=function(){this.sessionId=""},WebStats.prototype.sendSession=function(){var self=this;this._log("sendSession:",{arguments:arguments}),self._createSessionId();var datas={request_from:self.sessionId,navigator_language:navigator.language||"error",user_agent:navigator.userAgent||"error"};return self._makeAjax(self.options.persistSessionUrl,"POST",datas)},WebStats.prototype._watchWindowErrors=function(){this._log("Watching errors");var self=this;window.onerror=function(errorMsg,url,lineNumber,columnNumber,error){self.addLogEntry(errorMsg,"ERROR",{url:url,lineNumber:lineNumber,columnNumber:columnNumber,error:error})}},WebStats.prototype.sendDataBuffer=function(){var self=this;if(this._log("sendDataBuffer"),this._failedAttempt>20)return this._log("Max failed limit reach: "+this._failedAttempt),void this.stopAutoSendingInterval();if(self.eventBuffer.length<1&&self.logBuffer.length<1)return void this._log("Buffer is empty");if(self._sendingInProgress===!0)return void this._log("Already sending buffer, stop");self._sendingInProgress=!0;var _sendIsDone=function(){self._sendingInProgress=!1},p1=$.Deferred().resolve(),p2=$.Deferred().resolve();try{if(self.eventBuffer.length>0){var eventDatas={request_from:self.sessionId,datas:self.eventBuffer};p1=self._makeAjax(self.options.persistEventUrl,"POST",eventDatas).done(function(){self.eventBuffer=[]}).fail(function(){self._log("Fail sending events: ",{arguments:arguments}),self._failedAttempt++})}if(self.logBuffer.length>0){var logDatas={request_from:self.sessionId,datas:self.logBuffer};p2=self._makeAjax(self.options.persistLogUrl,"POST",logDatas).done(function(){self.logBuffer=[]}).fail(function(){self._log("Fail sending logs: ",{arguments:arguments}),self._failedAttempt++})}}catch(e){_sendIsDone(),this._failedAttempt++,self.log("Error while sending buffer: ",{error:e},"ERROR")}return this._log(" "),$.when(p1,p2).then(_sendIsDone).fail(_sendIsDone)},WebStats.prototype.addLogEntry=function(text,level,datas){level=level||"INFO";var dataStr;try{dataStr=JSON.stringify(datas)}catch(e){dataStr="Error while serializing JSON datas"}this.logBuffer.push({text:text,level:level,datas:dataStr})},WebStats.prototype.getEventList=function(){return this._makeAjax(this.options.readUrl+"/event/list","POST")},WebStats.prototype.getEventResume=function(){return this._makeAjax(this.options.readUrl+"/event/resume","POST")},WebStats.prototype.getEventTimeline=function(){return this._makeAjax(this.options.readUrl+"/event/timeline/hours","POST")},WebStats.prototype.getLastEvents=function(){return this._makeAjax(this.options.readUrl+"/event/last","POST")},WebStats.prototype.getLastLogs=function(){return this._makeAjax(this.options.readUrl+"/log/last","POST")},WebStats.prototype._makeAjax=function(url,method,datas,headers){var self=this,req={url:url,type:method,dataType:"json",data:JSON.stringify(datas),headers:{Authorization:self.options.authorization,"Content-Type":"application/json"},timeout:5e3};return"undefined"!=typeof headers&&$.extend(req.headers,headers),$.ajax(req)},"undefined"!=typeof module&&module.exports&&(module.exports=function(options){return new WebStats(options)})}]);
//# sourceMappingURL=jsxc.min.js.map